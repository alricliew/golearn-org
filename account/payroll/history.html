<!doctype html>
<html lang="en">

<head>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>GoLearn School</title>
  <meta name=description content="GoLearn School&trade; is Malaysia #1 teaching platform to run your tuition business and manage your lessons. Start now for Free!">
  <meta property=og:title content="GoLearn School">
  <meta property=og:site_name content="GoLearn School">
  <meta property=og:type content=website>
  <meta property=og:url content=https://org.golearn.com.my/school/payroll/history.html >
  <meta property=og:image content=https://org.golearn.com.my/assets/img/icon-apple-touch-180x180.png>
  <meta property=og:description content="GoLearn School&trade; is Malaysia #1 teaching platform to run your tuition business and manage your lessons. Start now for Free!">
  <link rel=apple-touch-icon sizes=180x180 href=https://org.golearn.com.my/assets/img/icon-apple-touch-180x180.png>
  <link rel=icon type=image/png sizes=32x32 href=https://org.golearn.com.my/assets/img/icon-32x32.png>
  <link rel=icon type=image/png sizes=16x16 href=https://org.golearn.com.my/assets/img/icon-16x16.png>
  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" rel="stylesheet" type="text/css" />
  <script src="https://kit.fontawesome.com/2bdd669e92.js" crossorigin="anonymous"></script>
  <!-- Material Kit CSS -->
  <link href="../../assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
  <!-- Firebase Init -->
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-firestore.js"></script>
  <script src="../../assets/js/firebase.js"></script>
  <script>
    const orgUrl = new URL(window.location.href).searchParams.get("url");
    const orgEnt = new URL(window.location.href).searchParams.get("ent");
    if (orgUrl === null || orgUrl === "" || orgEnt === null || orgEnt === "")
      window.location.href = 'http://org.golearn.com.mym.my/'+'?url=' + orgUrl + "&ent=" + orgEnt;
  </script>
  <!-- Tutor Portal specific CSS -->
  <link href="../../assets/css/tutor-portal.css" rel="stylesheet" />
  <!--GL Org CSS -->
  <link href="../../assets/css/golearn-org.css" rel="stylesheet" />
  <!--GL Org CSS -->
  <link href="../../assets/css/golearn-org.css" rel="stylesheet" />
  <link href="../../assets/css/multistepform.css" rel="stylesheet" />
  <link href="../../assets/css/multitabform.css" rel="stylesheet" />
  <link href="../../assets/css/mc-calendar.min.css" rel="stylesheet"/>
  <link href="../../assets/css/star-rating.css" media="all" rel="stylesheet" type="text/css"/>
  <style>
    .br {
      border-radius: 8px;
    }
    .w30 {
      width: 30%;
    }
    .w50 {
      width: 50%;
    }
    .w80 {
      width: 80%;
    }
    .card {
      border: 2px solid #fff;
      /* box-shadow:0px 0px 10px 0 #a9a9a9; */
      padding: 12px 20px;
      /* width: 80%; */
      /* margin: 50px auto; */
      margin-top: 0.2rem;
    }
    .card-shimmer-wrapper {
      width: 0px;
      animation: fullView 0.5s forwards cubic-bezier(0.250, 0.460, 0.450, 0.940);
    }
    .profilePic {
      height: 60px;
      width: 60px;
      border-radius: 50%;
    }
    .comment {
      height: 10px;
      background: #777;
      margin-top: 15px;
    }

    @keyframes fullView {
      100% {
        width: 100%;
      }
    }

    .animate {
      animation : shimmer 2s infinite linear;
      background: linear-gradient(to right, #eff1f3 4%, #e2e2e2 25%, #eff1f3 36%);
        background-size: 1000px 100%;
    }

    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }
  </style>
</head>

<body>

  <div class="hidden" name="lockscreen" style="height:100vh; width:100vw;  background: white; position: absolute; z-index: 1050;">
    <div class="container" style="background: transparent; height: 100vh; display: flex; vertical-align: middle; align-items: center; justify-content: center;">
      <div class="row align-items-center">
        <div class="col-md-6 text-center">
          <h2>Cannot reach!</h2>
          <p>This account is temporarily disabled. Please contact our <a href="https://golearn.com.my/contact-us">support</a> for more details. </p>
          <a href="https://org.golearn.com.my" class="btn btn-outline-primary btn-round"><i class="material-icons" style="color: #2e74b6; margin-right: 0.5em; padding-bottom: 0.2em;">west</i> Back to Home</a>
        </div>
        <div class="col-md-6 mr-auto" style="height: 400px; width: fit-content;">
          <a href="javascript:;" >
            <img class="img" id="tutorImgUrl3" style="height: 100%; width:100%; object-fit: cover; pointer-events: none; " src="https://org.golearn.com.my/assets/img/maintenance.gif"/>
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="wrapper">
    <div class="sidebar" data-color="purple" data-background-color="white" data-image="../../assets/img/sidebar-3.jpg">
      <div class="logo">
        <a href="../" class="simple-text logo-mini" style="padding: 0.5rem" id="logoName" name="param-link">
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav" style="margin-bottom: 50px;">
          <li class="nav-item" perm="home">
            <a class="nav-link" href="../" name="param-link">
              <i class="far fa-chart-bar fa-fw nav-icon"></i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="insight">
            <a class="nav-link" href="../report/" name="param-link">
              <i class="far fa-lightbulb fa-fw nav-icon"></i>
              <p>Insight</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="teach">
            <h4 class="nav-link" style="margin-left: 1rem;">Teaching</h4>
          </li>
          <li class="nav-item hidden" perm="teach-class">
            <a class="nav-link" href="../class/" name="param-link">
              <i class="fas fa-chalkboard fa-fw nav-icon"></i>
              <p>Classes</p>
            </a>
          </li>
		  		<li class="nav-item hidden" perm="teach-student">
            <a class="nav-link" href="../student/" name="param-link">
              <i class="fas fa-user-graduate fa-fw nav-icon"></i>
              <p>Students</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="teach-teacher">
            <a class="nav-link" href="../teacher/" name="param-link">
              <i class="fas fa-chalkboard-teacher fa-fw nav-icon"></i>
              <p>Teachers</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="fin">
            <h4 class="nav-link" style="margin-left: 1rem;">Financial</h4>
          </li>
          <li class="nav-item hidden" perm="fin-invoice">
            <a class="nav-link" href="../invoice/" name="param-link">
              <i class="fas fa-file-invoice-dollar fa-fw nav-icon"></i>
              <p>Invoices</p>
            </a>
          </li>
          <li class="nav-item hidden active" perm="fin-payroll">
            <a class="nav-link" href="../payroll/" name="param-link">
              <i class="fas fa-hand-holding-usd fa-fw nav-icon"></i>
              <p>Payroll <span style="visibility: hidden;">PRO</span></p>
            </a>
          </li>
          <li class="nav-item hidden" perm="fin-transaction">
            <a class="nav-link" href="../transaction/" name="param-link">
              <i class="fas fa-exchange-alt fa-fw nav-icon"></i>
              <p>Transactions</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:;">Payroll <span><i class="material-icons" style="color: gray;">chevron_right</i></span>History</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end">
            <form class="navbar-form">
              <!-- Put empty placeholder here -->
            </form>

            <ul class="navbar-nav">
              <li class="nav-item" id="activationNavItem">
                <a href="#" class="btn btn-primary btn-round btn-sm" style="visibility: hidden;" id="btnActivateAccount"></a>
              </li>
              <li class="nav-item">
                <a class="navbar-brand" href="javascript:;">
                   Hi <span id="user"></span> !
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link" href="javascript:;" id="navbarDropdownNotification" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">notifications</i> Notifications
                </a>
                <!-- <a class="nav-link" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">notifications</i>
                  <span class="notification">5</span>
                  <p class="d-lg-none d-md-block">
                    Some Actions
                  </p>
                </a> -->
								<div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
									<p style="padding: 1em;" >No notification</p>
                  <!-- <a class="dropdown-item" href="#">Mike John responded to your email</a>
                  <a class="dropdown-item" href="#">You have 5 new tasks</a>
                  <a class="dropdown-item" href="#">You're now friend with Andrew</a>
                  <a class="dropdown-item" href="#">Another Notification</a>
                  <a class="dropdown-item" href="#">Another One</a> -->
                </div>
              </li>
              <!-- your navbar here -->

			  			<li class="nav-item dropdown">
                <a class="nav-link" href="javascript:;" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">person</i>
                  <p class="d-lg-none d-md-block">
                    Account
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
                  <a class="dropdown-item hidden" href="../settings/" name="param-link" perm="settings">Update Information</a>
                  <a class="dropdown-item hidden" href="../team/" name="param-link" perm="team">Team</a>
									<div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="../../">Back to Home</a>
                  <a class="dropdown-item" href="javascript:;" data-toggle="modal" data-target="#signOutModal" onclick="signOutFunction()" id="btn-logout">Log out</a>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->

			<!-- Modal Start -->

      <!-- Edit Payroll modal -->
      <div class="row">
        <div class="modal fade" id="editPayrollModal" tabindex="-1" role="dialog" aria-labelledby="editPayrollModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editPayrollModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div id="inPayrollId" value=""></div>

                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payroll Name</span>
                  <input type="text" class="form-control" id="inPayrollName" oninput="checkEditPayrollModalFields();"  maxlength="40">
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger hidden" data-dismiss="modal" data-toggle="modal" data-target="#delPayrollModal" perm='fin-payroll-del'>Delete</button>
                <button type="button" class="btn btn-primary hidden" data-dismiss="modal" id="btnUpdatePayrollModalUpdate"  perm='fin-payroll-edit' disabled>Update</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Payroll modal -->
      <div class="row">
        <div class="modal fade" id="delPayrollModal" tabindex="-1" role="dialog" aria-labelledby="delPayrollModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="delPayrollModalLabel">Are you absolutely sure? </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btnDelClassModalClose1">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <p>This action cannot be <strong style="color: red;">undone</strong>. This will permanently delete this payroll entry, and remove all payslips created under this payroll.</p>
                <p>Your teachers will not be able to view the payslips issued to them, unless they have downloaded a copy of them.</p>

                <p>Please type <strong>DELETE</strong> to confirm.</p>

                <input type="text" class="form-control" id="delPayrollModalIn">

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger hidden" perm='fin-payroll-del' data-dismiss="modal" id="btnDelPayrollModalUpdate" style="white-space: normal; word-wrap: break-word;" disabled>I understand the consequences. Delete this payroll.</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sign-out modal -->
      <div class="row">
        <div class="modal fade" id="signOutModal" tabindex="-1" role="dialog" aria-labelledby="signOutModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="signOutLabel">Logging Out</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="signOutModalBody">
                Are you sure you want to continue?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnSignOutModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>


      <div class="content">

        <div class="container-fluid" >
          <!-- Back button -->
          <div class="row d-flex">
            <div class="p-2">
              <a href="./" class="btn btn-outline-primary btn-round" name="param-link" ><i class="material-icons" style="color: #2e74b6; margin-right: 0.5em;">west</i> Back</a>
            </div>
          </div>

          <div class="row" id="card-all-students" style="margin-top: 1rem;">

            <div class="col-md-12 card-student">
              <div class="row" >
                <div class="col-md-12" style="padding: 0;">
                  <div class="row" style="margin: 0;">
                    <div class="col-md-4">
                      <h6 style="font-weight: 600; color: #2e74b6; font-size: 0.8rem; margin: 0;" data-toggle="tooltip" title="No info">Payroll</h6>
                    </div>
                    <div class="col-md-2">
                      <h6 style="font-weight: 600; color: #2e74b6; font-size: 0.8rem; margin: 0;" data-toggle="tooltip" title="No info">Start</h6>
                    </div>
                    <div class="col-md-2">
                      <h6 style="font-weight: 600; color: #2e74b6; font-size: 0.8rem; margin: 0;" data-toggle="tooltip" title="No info">End</h6>
                    </div>
                    <div class="col-md-2">
                      <h6 style="font-weight: 600; color: #2e74b6; font-size: 0.8rem; margin: 0;" data-toggle="tooltip" title="No info">Payslip Amount</h6>
                    </div>
                    <div class="col-md-2">
                      <h6 style="font-weight: 600; color: #2e74b6; font-size: 0.8rem; margin: 0;" data-toggle="tooltip" title="No info">Total </h6>
                    </div>
                    <!-- <div class="col-md-1">
                      <h6 style="font-weight: 600; color: #2e74b6; font-size: 0.8rem; margin: 0;" data-toggle="tooltip" title="No info">Status</h6>
                    </div> -->
                  </div>
                </div>
                <!-- <div class="col-md-1">
                  <h6 style="font-weight: 600; color: #2e74b6; font-size: 0.8rem; margin: 0;" data-toggle="tooltip" title="No info">Action</h6>
                </div> -->

              </div>
            </div>

            <!-- Loading block -->
            <div class="card br" id="card-load">
              <div class="card-shimmer-wrapper">
                <div class="comment br animate w80"></div>
                <div class="comment br animate w30"></div>
              </div>
            </div>

            <!-- No data placeholder -->
            <div class="col-md-12 text-center" style="display: none; margin: 1rem;" id="noDataPlaceholder">
              <p>No data</p>
            </div>

            <!-- Student List Start -->
            <!-- <div class="col-md-12 card-student-item">
              <div class="row">
                <div class="col-md-11" style="padding: 0;">
                  <div class="row" style="margin: 0;">
                    <div class="col-md-3">
                      <p>Alric Liew</p>
                    </div>
                    <div class="col-md-1">
                      <p>Male</p>
                    </div>
                    <div class="col-md-3">
                      <p >A Bong</p>
                    </div>
                    <div class="col-md-2">
                      <p>+60138252818</p>
                    </div>
                    <div class="col-md-1">
                      <p class="card-student-status-label active">ACTIVE</p>
                    </div>
                    <div class="col-md-2">
                      <p>12/2/2021</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-1">
                  <a href="#" style="margin: 0; padding: 0.3em;" class="btn btn-sm btn-outline-danger btn-round" id="btnDelStudent" data-toggle="modal" data-target="#delStuModal" data-id="stuId" ><i class="material-icons" style="color: red;">remove</i></a>
                </div>
              </div>
            </div> -->

          </div>

          <!-- Load More -->
          <div class="row">
            <div class="col-md-12 d-flex flex-row" style="margin-top: 1rem;">
              <a href="javascript:;" class="btn btn-outline-primary btn-round" id="btnLoadMore">Load More <i class="material-icons" style="color: #2e74b6; margin-left: 0.5em; padding-bottom: 0.2em;">expand_more</i></a>
            </div>
          </div>
        </div>
      </div>
      <footer class="footer">
        <div class="container-fluid">
          <nav class="float-left">
          <ul>
            <!-- <li>
            <a href="https://golearn.com.my/join-us" target="_blank">
              Visit GoLearn Tutor
            </a>
            </li> -->
          </ul>
          </nav>
          <!-- <div class="copyright float-right">
            &copy;
            <script>
              document.write(new Date().getFullYear())
            </script>
            , made with <i class="material-icons">favorite</i> by <a href="#" >GoLearn Team</a>
          </div> -->
          <!-- your footer here -->
        </div>
      </footer>
    </div>

  </div>


  <script src="../../assets/js/core/jquery.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap-material-design.min.js"></script>
  <script src="../../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="../../assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Material Dashboard -->
  <script src="../../assets/js/material-dashboard.js?v=2.1.2" type="text/javascript"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.min.js" integrity="sha384-lpyLfhYuitXl2zRZ5Bn2fqnhNAKOAaM/0Kr9laMspuaMiZfGmfwRNFh8HlMy49eQ" crossorigin="anonymous"></script>
  <!-- Common constants -->
  <script src="../../assets/js/common.js" type="text/javascript"></script>
  <!-- General Info -->
  <script src="../../assets/js/const.js" type="text/javascript"></script>
  <!-- Core Js -->
  <script src="../../assets/js/org-core.js" type="text/javascript"></script>
  <!-- Datepicker -->
  <script src="../../assets/js/mc-calendar.min.js" type="text/javascript"></script>
  <!-- ClockPicker -->
  <script src="../../assets/js/bootstrap-clockpicker.min.js" type="text/javascript" ></script>
  <script src="../../assets/js/star-rating.js" type="text/javascript"></script>
  <script src="../../assets/js/star-rating-theme.js" type="text/javascript"></script>

  <script>

    var latestPayrollDoc = null;// Store last document - Used for Class Load More btn

    // Reset sessionstorage for payroll
    sessionStorage.setItem(SESSION_STORAGE_PAYROLL_ALL_DOCS_KEY, null);
    sessionStorage.setItem(SESSION_STORAGE_PAYROLL_CURRENT_DOC_KEY, null);

    // Initialization
    AuthCheck();

    // Page Specific Initialization
    function loadPageInitFunc(){

      loadAllPayrollInfo();

    }

    //---------- Load all details ----------//
    // Load More Button - Init
    const btnLoadMore = document.querySelector('#btnLoadMore');
    btnLoadMore.style.visibility='hidden';
    const loadMoreHandleClick = () =>{
      loadAllPayrollInfo();
    }
    btnLoadMore.addEventListener('click', loadMoreHandleClick );

    function loadAllPayrollInfo(){

      let today = new Date(2100, 12, 31);// Set a big date


      let docRef = db.collection("dev")
          .doc("v2")
          .collection("Payroll")
          .where(PAYROLL_ADMIN_ID, '==', ent_id)
          .where(PAYROLL_STATUS, '==', true)
          .orderBy(PAYROLL_DATE_START, 'desc')
          .startAfter(latestPayrollDoc || today)
          .limit(25);

      docRef
      .get()
      .then((querySnapshot) => {

        // Session Storage data
        let docsObj = [];

        document.getElementById("card-load").style.display = "none";

        if ((querySnapshot.docs.length== null || querySnapshot.docs.length == 0) && latestPayrollDoc == null){
          document.getElementById("noDataPlaceholder").style.display = 'initial';
        }else{
          document.getElementById("noDataPlaceholder").style.display = 'none';
        }

        querySnapshot.forEach((doc) => {
          // console.log(doc.data())
          docsObj.push(doc.data());
          renderAllActivePayroll(doc)

        });

        // Store all docs to sessionStorage. If loadmore is clicked, we concat the newly loaded and previous docs.
        let allObjList = null;
        // Set the fields
        allObjList = JSON.parse(sessionStorage.getItem(SESSION_STORAGE_PAYROLL_ALL_DOCS_KEY));
        if (allObjList == null ){
          // console.log("First time loading the data");
          sessionStorage.setItem(SESSION_STORAGE_PAYROLL_ALL_DOCS_KEY, JSON.stringify(docsObj));
          sessionStorage.setItem(SESSION_STORAGE_PAYROLL_CURRENT_DOC_KEY, null);
        }
        else{
          // console.log("Nth time loading the data");
          allObjList = allObjList.concat(docsObj);
          sessionStorage.setItem(SESSION_STORAGE_PAYROLL_ALL_DOCS_KEY, JSON.stringify(allObjList));
          sessionStorage.setItem(SESSION_STORAGE_PAYROLL_CURRENT_DOC_KEY, null);
        }


        // console.log(JSON.parse(sessionStorage.getItem(SESSION_STORAGE_PAYROLL_ALL_DOCS_KEY)).length)

        // Load more handling
        latestPayrollDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
        // console.log(querySnapshot.docs.length)
        // console.log(latestPayrollDoc.data())

        // Handle Lesson Load more btn
        if (querySnapshot.empty){
          btnLoadMore.removeEventListener('click', loadMoreHandleClick );
        }
        if (querySnapshot.docs.length == 25){
          btnLoadMore.style.visibility='visible';
        }else{
          btnLoadMore.style.visibility='hidden';
        }

      });

    };


    function renderAllActivePayroll(doc){
    // <div class="col-md-12 card-student-item">
    //   <div class="row">
    //     <div class="col-md-4">
    //       <p>December 2021 Payroll</p>
    //     </div>
    //     <div class="col-md-2">
    //       <p>1/12/2021</p>
    //     </div>
    //     <div class="col-md-2">
    //       <p >31/12/2021</p>
    //     </div>
    //     <div class="col-md-2">
    //       <p>12</p>
    //     </div>
    //     <div class="col-md-2">
    //       <p>12/2/2021</p>
    //     </div>
    //   </div>
    // </div>

      // Payroll Name
      let payroll_p = document.createElement('p');
      payroll_p.textContent = doc.data()[PAYROLL_NAME];
      payroll_p.setAttribute("style", "font-size:1rem; font-weight:400;")

      let payroll_div = document.createElement('div');
      payroll_div.className = "col-md-4";
      payroll_div.appendChild(payroll_p);

      // Start
      let start_p = document.createElement('p');
      start_p.textContent = doc.data()[PAYROLL_DATE_START].toDate().toLocaleDateString("en-gb");
      let start_div = document.createElement('div');
      start_div.className = "col-md-2 col-4";
      start_div.appendChild(start_p);
      // End
      let end_p = document.createElement('p');
      end_p.textContent = doc.data()[PAYROLL_DATE_END].toDate().toLocaleDateString("en-gb");
      let end_div = document.createElement('div');
      end_div.className = "col-md-2 col-4";
      end_div.appendChild(end_p);

      // Payslip Number
      let payslipNo_p = document.createElement('p');
      payslipNo_p.textContent = doc.data()[PAYROLL_DOC_ID_ARR].length;
      let payslipNo_div = document.createElement('div');
      payslipNo_div.className = "col-md-2";
      payslipNo_div.appendChild(payslipNo_p);

      // Amount
      let amount_p = document.createElement('p');
      amount_p.textContent = "RM" + parseFloat(doc.data()[PAYROLL_TOTAL]).toFixed(2);
      let amount_div = document.createElement('div');
      amount_div.className = "col-md-2";
      amount_div.appendChild(amount_p);

      // Student Detail
      let detail_div = document.createElement('div');
      detail_div.className = 'row';
      detail_div.setAttribute("style","margin: 0;");
      detail_div.appendChild(payroll_div);
      detail_div.appendChild(start_div);
      detail_div.appendChild(end_div);
      detail_div.appendChild(payslipNo_div);
      detail_div.appendChild(amount_div);
      let detail_top_div = document.createElement('div');
      detail_top_div.className = "col-md-12";
      detail_top_div.setAttribute("style"," padding: 12px 0px 12px 0px;");
      detail_top_div.setAttribute("onclick","editPayrollFunction(this)");
      detail_top_div.setAttribute("data-id", doc.data().id);
      detail_top_div.appendChild(detail_div);

      //Del btn
      let blogsHtml_btn = '';
      blogsHtml_btn += "<span class='fa-stack' style='vertical-align: middle; font-size: 73%; color: red; cursor: pointer; margin-right: 0.5rem;'><i class='fas fa-circle fa-stack-2x' style='text-shadow: 2px 2px 4px rgba(46, 46, 46, 0.8);'></i><i class='fas fa-minus fa-stack-1x fa-inverse'></i></span>";

      // blogsHtml_btn += "<i class='material-icons' style='color: red;''>remove</i>";
      let btn_a = document.createElement('a');
      btn_a.innerHTML = blogsHtml_btn;
      // btn_a.className = "btn btn-sm btn-outline-danger btn-round";
      btn_a.setAttribute("id","btnDelStudent");
      btn_a.setAttribute("href","javascript:;");
      btn_a.setAttribute("style","margin: 0; padding: 0.4em; ");

      btn_a.setAttribute("data-toggle","modal");
      btn_a.setAttribute("data-target","#delStuModal");
      btn_a.setAttribute("data-id", doc.data().id);
      btn_a.setAttribute("data-studentname",  doc.data().childName);
      let btn_div = document.createElement('div');
      // btn_div.className = "col-md-1 align-self-center";

      btn_div.className = "col-1";
      btn_div.setAttribute("style"," margin-bottom: 12px; padding-top: 12px; padding-left: 0;padding-right: 0; border-top: solid thin #f8f8f8; minwidth: fix-content;");
      // btn_div.setAttribute("style"," margin-bottom: 12px; margin-top: 12px;border-top: solid thin #fafafa");

      btn_div.appendChild(btn_a);

      // Student Top
      let card_div = document.createElement('div');
      card_div.className = "row"
      card_div.appendChild(detail_top_div);
      // card_div.appendChild(btn_div);

      // Card top
      let card_top_div = document.createElement('div');
      card_top_div.className = "col-md-12 card-student-item"

      card_top_div.setAttribute("data-toggle","modal");
      card_top_div.setAttribute("data-target","#editPayrollModal");
      card_top_div.setAttribute("data-id", doc.data()[PAYROLL_ID]);
      card_top_div.setAttribute("data-payrollname", doc.data()[PAYROLL_NAME]);
      card_top_div.appendChild(card_div);

      const card_all_students = document.getElementById("card-all-students");
      card_all_students.appendChild(card_top_div);
    }

    // Check if the payroll name valid
    function checkEditPayrollModalFields(){

      let payrollName = document.getElementById('inPayrollName').value;

      if (payrollName == null || payrollName == ''){
        document.getElementById('btnUpdatePayrollModalUpdate').setAttribute('disabled', true);
      }
      else{
        document.getElementById('btnUpdatePayrollModalUpdate').removeAttribute('disabled');
      }
    }

    // Reload view
    function reload(){
      let card_student_item = document.getElementsByClassName("card-student-item");

      Array.from(card_student_item).forEach((row) => {
        row.remove();
      });

      latestPayrollDoc = null;// Store last document - Used for Class Load More btn

      // Reset sessionstorage for payroll
      sessionStorage.setItem(SESSION_STORAGE_PAYROLL_ALL_DOCS_KEY, null);
      sessionStorage.setItem(SESSION_STORAGE_PAYROLL_CURRENT_DOC_KEY, null);

      console.log("loadAllPayrollInfo "+ ent_id)
      loadAllPayrollInfo(ent_id);


    }

    // Edit Student Function
    function editPayrollFunction(elem){
      // Get attribute and
      if (JSON.parse(sessionStorage.getItem(SESSION_STORAGE_PAYROLL_ALL_DOCS_KEY)) == null ){
        console.log("Error: Impossible to reach this state");
        // Because this func only trigger when there's active class loaded
        return;
      }else{

        let Obj = null;
        let allList = null;

        // Set the fields
        allList = JSON.parse(sessionStorage.getItem(SESSION_STORAGE_PAYROLL_ALL_DOCS_KEY));
        allList.forEach((item) => {
          if (item.id === elem.getAttribute('data-id')){
            sessionStorage.setItem(SESSION_STORAGE_PAYROLL_CURRENT_DOC_KEY, JSON.stringify(item));

            // window.location = './edit-student.html';

          }

        });

      }
		}


  </script>
  <script>
    // Edit Lesson Modal
    // Extract info from data-* attributes
    var PAYROLLNAME = "";
    var PAYROLLID = "";
    var START = "";
    $( document ).ready(function() {

      //Edit Payrollt Modal
      $('#editPayrollModal').on('show.bs.modal', function (event) {
        let button = $(event.relatedTarget) // Button that triggered the modal
        PAYROLLID = button.data('id')
        PAYROLLNAME = button.data('payrollname')

        // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
        // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
        var modal = $(this)
        modal.find('.modal-title').text('Edit '+ PAYROLLNAME);
        document.getElementById("inPayrollId").setAttribute('value', PAYROLLID);

        document.getElementById('inPayrollName').value = PAYROLLNAME;

      });

      $('#editPayrollModal').on('hide.bs.modal', function (event) {
        document.getElementById("inPayrollId").setAttribute('value', "");
        document.getElementById('inPayrollName').value = "";
      });

      $('#btnUpdatePayrollModalUpdate').on('click', function (e) {

        let inPayrollId = document.getElementById("inPayrollId").getAttribute('value');


        if (inPayrollId == null || inPayrollId == ""){
          func.showNotification('top','center', 'danger', 'error_outline', "Unable to update payroll. Please reload this page and try again.");
        }
        let docRef = db.collection("dev")
          .doc("v2")
          .collection("Payroll")
          .doc(inPayrollId);


        let data = {
          [PAYROLL_NAME]: document.getElementById('inPayrollName').value,
        }
        // console.log("Update Payroll Name");
        // console.log(data);

        docRef.update(data )
        .then(() => {
          func.showNotification('top','center', 'success', 'check_circle', "Updated successfully!");

          // Clear session storage  before reloading
          sessionStorage.removeItem(SESSION_STORAGE_PAYROLL_ALL_DOCS_KEY);
          sessionStorage.removeItem(SESSION_STORAGE_PAYROLL_CURRENT_DOC_KEY);

          window.location.reload();

        }).catch((error) => {
          console.log("Error getting document:", error);
        });


      });


      // Delete Teacher
      $('#delPayrollModalIn').on('input', function(){
        if (this.value === 'DELETE'){
          $('#btnDelPayrollModalUpdate').prop('disabled', false);
        }
        else{
          $('#btnDelPayrollModalUpdate').prop('disabled', true);
        }
      });

      // Clear fields
      $('#delPayrollModal').on('hide.bs.modal', function (event) {
        $('#btnDelPayrollModalUpdate').prop('disabled', true);
        document.getElementById('delPayrollModalIn').value = "";
      });


      $('#btnDelPayrollModalUpdate').on('click', function (e) {

        console.log("Deleting Payroll")
        let payrollCurrentObj = JSON.parse(sessionStorage.getItem(SESSION_STORAGE_PAYROLL_CURRENT_DOC_KEY));
        console.log(payrollCurrentObj.id)
        console.log(payrollCurrentObj.docIdArr)

        var promiseAll = [];

        // Delete Payroll if it is not null
        if (payrollCurrentObj != null){

          let docRef = db.collection("dev")
            .doc("v2")
            .collection("Payroll")
            .doc(payrollCurrentObj[PAYROLL_ID]);

          var payrollData = {
            [PAYROLL_STATUS]: false,
          }

          if (payrollCurrentObj.docIdArr.length == 0){
            promiseAll.push(docRef.delete());
          }
          else {
            promiseAll.push(docRef.update(payrollData));
          }

          // // batch.delete(docRef);
          // docRef.delete().then(() => {
          //   // reload();
          //   console.log("Payroll deleted! " + payrollCurrentObj[PAYROLL_ID]);
          // }).catch((error) => {
          //   console.error("Error removing document: ", error);
          // });



          // Get all payslips
          let payslipdocRef = db.collection("dev")
          .doc("v2")
          .collection("Payslip")
          .where(PAY_PAYROLL_ID, "==", payrollCurrentObj[PAYROLL_ID]);

          promiseAll.push(payslipdocRef.get());

          Promise.all(promiseAll).then((snapshots) => {

            var promiseLayer1 = []
            // Get all payslips
            if (snapshots[1].size == 0){
              reload();
              func.showNotification('top','center', 'success', 'check_circle', "Payroll deleted!");
            }
            else {

              snapshots[1].forEach((doc) => {
                console.log("Deleting deleted! " + payrollCurrentObj[PAYROLL_ID]);
                // console.log(doc.data()[PAY_ID])
                // console.log(doc.data()[PAY_TRANS_ID])

                let payslipRef = db.collection("dev")
                  .doc("v2")
                  .collection("Payslip")
                  .doc(doc.data()[PAY_ID]);
                var payData = {
                  [PAY_DATE_DEL]:  new Date(),
                  [PAY_STATUS]: false,
                }

                // promiseLayer1.push(payslipRef.delete())
                promiseLayer1.push(payslipRef.update(payData))

                let transactionRef = db.collection("dev")
                  .doc("v2")
                  .collection("Transaction")
                  .doc(doc.data()[PAY_TRANS_ID]);
                var transData = {
                  [TRANS_DATE_EDIT]: new Date(),
                  [TRANS_STATUS]: false,
                }

                // promiseLayer1.push(transactionRef.delete())
                promiseLayer1.push(transactionRef.update(transData))


              });


            }

            return Promise.all(promiseLayer1)

          })
          .then(() => {
            reload();
            func.showNotification('top','center', 'success', 'check_circle', "Payroll and linked payslip(s) deleted!");

          })
          .catch((error) => {

            reload();
            func.showNotification('top','center', 'success', 'check_circle', "Failed to delete this payroll and linked payslip(s)");

            console.error("Error removing document: ", error);
          })


          // payslipdocRef.get()
          // .then((querySnapshot) => {

          //   var batch = db.batch();

          //   console.log("payslip found")
          //   if (querySnapshot.empty){
          //     reload();
          //     func.showNotification('top','center', 'success', 'check_circle', "Payroll deleted!");

          //   }
          //   else {

          //     querySnapshot.forEach((doc) => {
          //       console.log("Deleting deleted! " + payrollCurrentObj[PAYROLL_ID]);
          //       console.log(doc.data()[PAY_ID])
          //       console.log(doc.data()[PAY_TRANS_ID])

          //       let payslipRef = db.collection("dev")
          //         .doc("v2")
          //         .collection("Payslip")
          //         .doc(doc.data()[PAY_ID]);

          //       batch.delete(payslipRef);

          //       let transactionRef = db.collection("dev")
          //         .doc("v2")
          //         .collection("Transaction")
          //         .doc(doc.data()[PAY_TRANS_ID]);

          //       batch.delete(transactionRef);


          //     });

          //     // Delete both trans and payslip doc. Reload
          //     batch.commit().then(() => {
          //       reload();
          //       func.showNotification('top','center', 'success', 'check_circle', "Payroll deleted!");
          //     });

          //   }

          // }).catch((error) => {
          //   // Error loading payslips. Reload
          //   reload();
          //   func.showNotification('top','center', 'success', 'check_circle', "Payroll deleted!");

          //   console.error("Error removing document: ", error);
          // });


        }
        else{
          func.showNotification('top','center', 'danger', 'error_outline', "Unable to delete payroll. Please reload this page and try again.");
        }



      });


    });

  </script>

</body>

</html>