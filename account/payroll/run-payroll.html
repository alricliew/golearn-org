<!doctype html>
<html lang="en">

<head>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>GoLearn School</title>
  <meta name=description content="GoLearn School&trade; is Malaysia #1 teaching platform to run your tuition business and manage your lessons. Start now for Free!">
  <meta property=og:title content="GoLearn School">
  <meta property=og:site_name content="GoLearn School">
  <meta property=og:type content=website>
  <meta property=og:url content=https://app.golearn.com.my/school/payroll/run-payroll.html >
  <meta property=og:image content=https://app.golearn.com.my/assets/img/icon-apple-touch-180x180.png>
  <meta property=og:description content="GoLearn School&trade; is Malaysia #1 teaching platform to run your tuition business and manage your lessons. Start now for Free!">
  <link rel=apple-touch-icon sizes=180x180 href=https://app.golearn.com.my/assets/img/icon-apple-touch-180x180.png>
  <link rel=icon type=image/png sizes=32x32 href=https://app.golearn.com.my/assets/img/icon-32x32.png>
  <link rel=icon type=image/png sizes=16x16 href=https://app.golearn.com.my/assets/img/icon-16x16.png>
  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" rel="stylesheet" type="text/css" />
  <script src="https://kit.fontawesome.com/2bdd669e92.js" crossorigin="anonymous"></script>
  <!-- Material Kit CSS -->
  <link href="../../assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
  <!-- Firebase Init -->
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-firestore.js"></script>
  <script src="../../assets/js/firebase.js"></script>
  <script>
    const orgUrl = new URL(window.location.href).searchParams.get("url");
    const orgEnt = new URL(window.location.href).searchParams.get("ent");
    if (orgUrl === null || orgUrl === "" || orgEnt === null || orgEnt === "")
      window.location.href = 'http://127.0.0.1:8080/'+'?url=' + orgUrl + "&ent=" + orgEnt;
  </script>
  <!-- Tutor Portal specific CSS -->
  <link href="../../assets/css/tutor-portal.css" rel="stylesheet" />
  <!-- GL Org CSS -->
  <link href="../../assets/css/golearn-org.css" rel="stylesheet" />
  <!-- Date rage picker -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <!-- International Telephone Input -->
  <link href="../../assets/css/intlTelInput.css" rel="stylesheet" >

  <style>

    .table {
        border: 1px solid #ccc;
        border-collapse: collapse;
    }
    .table th,
    .table td {
        border: 1px solid #ccc;
    }
    .table th,
    .table td {
        padding: 0.5rem;
    }
    .draggable {
        cursor: move;
        user-select: none;
    }
    .placeholder {
        background-color: #edf2f7;
        border: 2px dashed #cbd5e0;
    }
    .clone-list {
        border-top: 1px solid #ccc;
    }
    .clone-table {
        border-collapse: collapse;
        border: none;
    }
    .clone-table th{
        border: 1px solid #ccc;
        border-top: none;
        padding: 0.5rem;
        font-size: 1.2em;
        font-weight: 300;
    }

    .clone-table td {
        border: 1px solid #ccc;
        border-top: none;
        padding: 0.5rem;

        font-weight: 300;
    }
    .dragging {
        background: #fff;
        border-top: 1px solid #ccc;
        z-index: 999;
    }

    /* page view for A4  */
    page {
      background: white;
      display: block;
      margin: 0 auto;
      /* margin-bottom: 0.5cm; */
      /* box-shadow: 0 0 0.5cm rgba(0,0,0,0.5); */
    }
    page[size="A4"] {
      width: 21cm;
      height: auto;
      min-height: 29.65cm;
      /* Use a  height value slightly lower than 29.7 to avoid page break  */
      /* height: 29.7cm;  */
    }
    page[size="A4"][layout="landscape"] {
      width: 29.7cm;
      height: 21cm;
    }

    .icon {
      background: url('../../assets/img/salary.png');
      background-size: contain;
      background-repeat: no-repeat;
      height: 32px;
      /* font-size: x-large; */
      /* max-height: 100%; */
      width: 32px;
      /* max-width: 100%; */
      display: block;
      /* Other styles here */
    }
  </style>
</head>

<body>

  <div class="wrapper ">
    <div class="sidebar" data-color="purple" data-background-color="white" data-image="../../assets/img/sidebar-3.jpg">
      <div class="logo">
        <a href="../" class="simple-text logo-mini" style="padding: 0.5rem" id="logoName" name="param-link">
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav" style="margin-bottom: 50px;">
          <li class="nav-item" perm="home">
            <a class="nav-link" href="../" name="param-link">
              <i class="far fa-chart-bar fa-fw nav-icon"></i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="insight">
            <a class="nav-link" href="../report/" name="param-link">
              <i class="far fa-lightbulb fa-fw nav-icon"></i>
              <p>Insight</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="teach">
            <h4 class="nav-link" style="margin-left: 1rem;">Teaching</h4>
          </li>
          <li class="nav-item hidden" perm="teach-class">
            <a class="nav-link" href="../class/" name="param-link">
              <i class="fas fa-chalkboard fa-fw nav-icon"></i>
              <p>Classes</p>
            </a>
          </li>
		  		<li class="nav-item hidden" perm="teach-student">
            <a class="nav-link" href="../student/" name="param-link">
              <i class="fas fa-user-graduate fa-fw nav-icon"></i>
              <p>Students</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="teach-teacher">
            <a class="nav-link" href="../teacher/" name="param-link">
              <i class="fas fa-chalkboard-teacher fa-fw nav-icon"></i>
              <p>Teachers</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="fin">
            <h4 class="nav-link" style="margin-left: 1rem;">Financial</h4>
          </li>
          <li class="nav-item hidden" perm="fin-invoice">
            <a class="nav-link" href="../invoice/" name="param-link">
              <i class="fas fa-file-invoice-dollar fa-fw nav-icon"></i>
              <p>Invoices</p>
            </a>
          </li>
          <li class="nav-item hidden active" perm="fin-payroll">
            <a class="nav-link" href="../payroll/" name="param-link">
              <i class="fas fa-hand-holding-usd fa-fw nav-icon"></i>
              <p>Payroll <span style="visibility: hidden;">PRO</span></p>
            </a>
          </li>
          <li class="nav-item hidden" perm="fin-transaction">
            <a class="nav-link" href="../transaction/" name="param-link">
              <i class="fas fa-exchange-alt fa-fw nav-icon"></i>
              <p>Transactions</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:;">Payroll <span><i class="material-icons" style="color: gray;">chevron_right</i></span> Run Payroll</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end">
            <form class="navbar-form">
              <!-- Put empty placeholder here -->
            </form>

            <ul class="navbar-nav">
              <li class="nav-item" id="activationNavItem">
                <a href="#" class="btn btn-primary btn-round btn-sm" style="visibility: hidden;" id="btnActivateAccount"></a>
              </li>
              <li class="nav-item">
                <a class="navbar-brand" href="javascript:;">
                   Hi <span id="user"></span> !
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link" href="javascript:;" id="navbarDropdownNotification" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">notifications</i> Notifications
                </a>
                <!-- <a class="nav-link" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">notifications</i>
                  <span class="notification">5</span>
                  <p class="d-lg-none d-md-block">
                    Some Actions
                  </p>
                </a> -->
								<div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
									<p style="padding: 1em;" >No notification</p>
                  <!-- <a class="dropdown-item" href="#">Mike John responded to your email</a>
                  <a class="dropdown-item" href="#">You have 5 new tasks</a>
                  <a class="dropdown-item" href="#">You're now friend with Andrew</a>
                  <a class="dropdown-item" href="#">Another Notification</a>
                  <a class="dropdown-item" href="#">Another One</a> -->
                </div>
              </li>
              <!-- your navbar here -->

			  			<li class="nav-item dropdown">
                <a class="nav-link" href="javascript:;" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">person</i>
                  <p class="d-lg-none d-md-block">
                    Account
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
                  <a class="dropdown-item hidden" href="../settings/" name="param-link" perm="settings">Update Information</a>
                  <a class="dropdown-item hidden" href="../team/" name="param-link" perm="team">Team</a>
									<div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="javascript:;" data-toggle="modal" data-target="#signOutModal" onclick="signOutFunction()" id="btn-logout">Log out</a>
									<div class="dropdown-divider"></div>
									<a style="font-weight: 500 ;padding: 0.5em ;text-align: center; width: 200px; background-color: #428dd4 ;display: block; color: #fff;" href="https://golearn.com.my/pricing/" target="_blank">Upgrade to Pro</a>

                </div>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->

			<!-- Modal Start -->

      <!-- Preview modal -->
      <div class="row" >
        <div class="modal fade" tabindex="-1" role="dialog" id="previewModal" aria-labelledby="staticBackdropLabel" aria-hidden="true"  >
          <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 22cm!important;">
            <div class="modal-content" style="background-color: transparent; box-shadow: none; border: none;">
              <div class="modal-body" style="background-color: transparent; box-shadow: none; border: none;">
               <!-- Preview -->
               <div class="row" style="overflow-y:auto;">
                <div class="col-12" style="overflow-x:auto; padding: 1rem;">
                  <a href="javascript:;" class="btn btn-primary btn-round" style="text-transform: none; background-color: white; color: #2e74b6;" onclick="generatePDFeKoopmans('invTemplate')">Download As PDF</a>

                  <span id="netpayview_preview" style="color: white;"></span>

                  <page size="A4" id="invTemplate" style="position: relative;">

                    <div class="card-body" >
                      <div class="row">
                        <div class="col-4 text-center">

                          <div class="form-group">
                            <!-- <canvas id="myCanvas" style="height: 150px;width: 225px; object-fit: cover;" ></canvas> -->
                            <div style="height: 115px;width: auto; display: inline-block; position: relative; overflow: hidden; cursor: pointer;">
                              <img id="previewTutorImgUrl" style="height: 100%; width: auto; " src="../../assets/img/empty-photo.png" crossorigin="anonymous" alt = ""/>
                              <!-- <canvas id="myCanvas" ></canvas> -->
                            </div>
                          </div>
                        </div>

                        <div class="col-2">
                          <!--  Do nothing -->
                        </div>

                        <div class="col-6 text-right">
                          <h4 style="font-size: xx-large;margin-top: 1rem;">PAYSLIP</h4>
                          <h5 id="previewTitle"  style="font-weight: 500;">Payslip of November 2021</h5>
                          <h4 id="previewBizName" style="font-weight: 500;">Your Name</h4>
                          <h6 id="previewBizDetails" style="text-transform: none; font-weight: 300;">Your Biz Details</p>
                        </div>
                      </div>
                    </div>

                    <hr style="margin: 0rem">
                    <div class="card-body" style="position: relative; bottom: 35px; width: 100%; margin-top: 2rem;">
                      <div class="row">
                        <div class="col-4">
                          <h6>Paid To:</h6>
                          <h4 id="previewClientName" style="font-weight: 500;">Tutor's Name</h4>
                          <h6 id="previewClientPosition"  style="text-transform: none; font-weight: 300;"> Tutor </h6>
                        </div>

                        <div class="col-4"></div>
                        <div class="col-4">
                          <div class="row">
                            <div class="col-6 text-right" style="padding-right: 0;">
                              <h6>Ref No</h6>
                              <h6>Date</h6>
                              <h6>Status</h6>
                            </div>
                            <div class="col-6 text-right">
                              <h6 id="previewRefNo" style="font-weight: normal;"> - </h6>
                              <h6 id="previewDate"> - </h6>
                              <h6 id="previewStatus"> - </h6>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div style="margin-top: 1rem;"></div>

                      <div class="row">
                        <div class="col-12"  style="overflow-x:auto;">
                          <span class="" style="font-size: x-small; font-weight: 300; color: gray; margin-bottom: 0;">Note*: Quantity - Number of hour of lessons conducted, number of classes, or relevant other items</span>
                          <table id="tablePreview" class="table-light table-sm" cellspacing="0" width="100%" >
                            <thead id='thead_item_preview' style="background-color: grey; color: white;">
                              <tr>
                                <th style="min-width: 200px; font-size: small;">Items</th>
                                <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Quantity</th>
                                <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Price</th>
                                <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Amount</th>
                              </tr>
                            </thead>
                            <tbody id="tbody_item_preview">
                              <tr class="subtotal" id='previewItemSubtotal'>
                                <td></td>
                                <td></td>
                                <td style="text-align: right; font-weight: 500; font-size: small;">Subtotal</td>
                                <td style="text-align: right; font-weight: 500; font-size: small;" id="grosspay_preview"></td>
                              </tr>
                            </tbody>
                          </table>

                          <table id="table_additem_preview" class="table-light table-sm" cellspacing="0" width="100%">
                            <thead id='thead_additem_preview' style="visibility: collapse;">
                              <tr>
                                <th style="min-width: 200px;">Items</th>
                                <th style="width: 100px; min-width: 100px;text-align: right;">Quantity</th>
                                <th style="width: 100px; min-width: 100px;text-align: right;">Price</th>
                                <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
                              </tr>
                            </thead>
                            <tbody id="tbody_additem_preview">
                              <tr class="additional">
                                <td></td>
                                <td></td>
                                <td style="text-align: right; font-size: small;"></td>
                                <td style="text-align: right; font-size: small;"></td>
                              </tr>
                            </tbody>
                          </table>
                        </div>

                        <div class="col-12">
                          <h4 style="text-align: right; font-weight: 500;">Net Pay <span style="margin-left: 2rem;" id="netpay_preview">RM0.00</span></h4>
                        </div>

                        <!-- <div class="col-12">
                          <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin: 0;">Notes</span>
                          <span id="previewInvNotes"></span>
                        </div> -->
                      </div>
                    </div>

                    <hr style="margin: 0rem">
                    <div class="card-body" >
                      <div class="row">
                        <div class="col-6">
                          <div class="row">
                            <div class="col-4 text-left" style="padding-right: 0;">
                              <h6>Bank Name:</h6>
                              <h6>AC No:</h6>
                            </div>

                            <div class="col-8 text-left">
                              <h6 id="previewBankName" style="font-weight: normal; text-transform: none;"> - </h6>
                              <h6 id="previewAcNo" style="font-weight: normal; text-transform: none;"> - </h6>
                            </div>
                          </div>
                        </div>

                        <div class="col-6">
                          <div class="row">
                            <div class="col-4 text-left" style="padding-right: 0;">
                              <h6 id='previewEpfTitle' style="display: none;">EPF No:</h6>
                              <h6 id='previewSocsoTitle' style="display: none;">Socso:</h6>
                            </div>
                            <div class="col-8 text-left">
                              <h6 id="previewEpf" style="display: none; font-weight: normal; text-transform: none;"> - </h6>
                              <h6 id="previewSocso" style="display: none; font-weight: normal; text-transform: none;"> - </h6>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <hr style="margin: 0rem">

                    <!-- <div class="card-body" id="preview-footer" style="padding-top: 0; margin-top: 0; position: absolute; bottom: 0; width: 100%;">
                      <p id="previewInvFooterNotes"></p>
                    </div> -->

                  </page>


                </div>
              </div>
              </div>
            </div>


          </div>
        </div>
      </div>

      <!-- List All Admin's Employee modal -->
      <div class="row">
        <div class="modal fade" id="myTeacherModal" tabindex="-1" role="dialog" aria-labelledby="myTeacherModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="myTeacherModalLabel">My Teachers / Employees</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btnMyTeacherModalClose1">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="myTeacherModalBody">
                <div class="row">
                  <div class="col-md-12" id="studentTop">

                    <div class="container" id="add-tutor-modal-container">
                      <!-- Tutor header -->
                      <div class="row lesson-header text-center">
                        <div class="col-md-2">
                        </div>
                        <div class="col-md-3">
                          <p>Tutor Name</p>
                        </div>
                        <div class="col-md-3">
                          <p>Phone</p>
                        </div>
                        <div class="col-md-2">
                          <p>Age</p>
                        </div>
                        <div class="col-md-2">
                          <p>Action</p>
                        </div>
                      </div>
                      <!-- Myself -->
                      <div class="row tutor-wrapper text-center">
                        <div class="col-md-2">
                          <div style="height: 50px; width: 50px; display: inline-block; position: relative; overflow: hidden; border-radius: 50%;">
                            <img id="viewTutorMySelfImgUrl" style="height: 100%;width: 100%; object-fit: cover;" src="../../assets/img/empty-photo.png"/>
                          </div>
                        </div>
                        <div class="col-md-8">
                          <p class="tutor-item">Select this option for unregistered employees or external personnel.</p>
                        </div>
                        <!-- <div class="col-md-3">
                          <p class="tutor-item" id="viewTutorMySelfName"></p>
                        </div>
                        <div class="col-md-3">
                          <p class="tutor-item" id="viewTutorMySelfPhone"></p>
                        </div>
                        <div class="col-md-2">
                          <p class="tutor-item" id="viewTutorMySelfAge"></p>
                        </div> -->
                        <div class="col-md-2">
                          <button type="button" class="btn btn-success btn-sm" data-dismiss="modal" data-toggle="modal" data-target='#addCustomEmployeeModal' id="btnSelectMyself">New</button>
                        </div>
                      </div>

                      <!-- Tutor List Start -->

                      <!-- <div class="row tutor-wrapper text-center">
                        <div class="col-md-2">
                          <div style="height: 50px; width: 50px; display: inline-block; position: relative; overflow: hidden; border-radius: 50%;">
                            <img id="viewTutorImgUrl" style="height: 100%;width: 100%; object-fit: cover;" src="../../assets/img/test.jpg"/>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <p class="tutor-item">Alric Liew</p>
                        </div>
                        <div class="col-md-3">
                          <p class="tutor-item">Phone</p>
                        </div>
                        <div class="col-md-2">
                          <p class="tutor-item">12</p>
                        </div>

                        <div class="col-md-2">
                          <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal" id="btnSelectTutor">Select</button>
                        </div>
                      </div> -->

                    </div>


                    <div class="row">
                      <div class="col-md-12 text-center">
                        <button type="button" class="btn btn-outline-primary btn-sm btn-round" id="btnAddTeacherModalLoadMore" >Load More</button>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary"  data-dismiss="modal" id="btnMyTeacherModalClose2">Close</button>
                <!-- <a type="button" class="btn btn-success" data-dismiss="modal" data-toggle="modal" data-target="#addTeacherModal" id="btnAddTeacherModal">Add New Teacher</a> -->
                <!-- <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnMyTeacherModalUpdate">Add</button> -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Employee modal -->
      <div class="row">
        <div class="modal fade" id="addCustomEmployeeModal" tabindex="-1" role="dialog" aria-labelledby="addCustomEmployeeModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add Unregistered Employee</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" >
                <div id="addEmployeeId" value =''></div>

                <h5 class="">Employee Details</h5>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Name*</span>
                      <input type="text" class="form-control" id="inCustomEmployeeName" data-compulsory="true" oninput="checkNewEmployeeValidity()"  maxlength="40">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Contact*</span>
                      <div class="input-group">
                        <input id="inClientContact" name="phone" type="tel"  class="form-control" data-compulsory="true" oninput="this.className = 'form-control'" >
                        <span id="valid-msg" class="hide" style="color: #42ba96;">✓ Valid</span>
                        <span id="error-msg" class="hide" style="color: #F32013;"></span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Position</span>
                      <input type="text" class="form-control" id="inCustomEmployeePosition" data-compulsory="false" maxlength="40">
                    </div>
                  </div>
                  <div class="col-md-6"></div>
                </div>

                <h5 class="" style="margin-top: 1rem;">Employment Details</h5>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Name</span>
                      <input type="text" class="form-control" id="inCustomBankName" data-compulsory="false" maxlength="40">
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Account No</span>
                      <input type="text" class="form-control" id="inCustomBankAccNum" data-compulsory="false" maxlength="40">
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">EPF No</span>
                      <input type="text" class="form-control" id="inCustomEPF" data-compulsory="false" maxlength="40">
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Socso No</span>
                      <input type="text" class="form-control" id="inCustomSocso" data-compulsory="false" maxlength="40">
                    </div>
                  </div>
                </div>

              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnAddCustomEmployeeModalUpdate" disabled>Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add All Employee modal -->
      <div class="row">
        <div class="modal fade" id="addAllEmployeeModal" tabindex="-1" role="dialog" aria-labelledby="addAllEmployeeModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add All Employees</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" >

                This will <strong>clear the existing records</strong> and reload a new set of employees. Are you sure you want to continue?


              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnaddAllEmployeeModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Payslip modal -->
      <div class="row">
        <div class="modal fade" id="editPayslipModal" tabindex="-1" role="dialog" aria-labelledby="editPayslipModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="overflow-y:auto;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editPayslipModalTitle">Edit Payslip</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="editPayslipModalBody">
                <!-- View Switcher -->
                <div class="row d-flex">
                  <div class="p-2">
                  </div>
                  <div class="ml-auto p-2">
                    <div class="form-check">
                      <label class="form-check-label">
                        <input class="form-check-input" type="checkbox" value="" id="advanced_check" data-compulsory="false" onchange="showAdvancedColumns(this); calculateAmount(); ">
                        <span class="form-check-sign">
                          <span class="check"></span>
                        </span>
                        Advanced
                      </label>
                    </div>
                  </div>
                </div>
                <span class="" style="font-size: x-small; font-weight: 300; color: gray; margin-bottom: 0;">Note*: Quantity - Number of hour of lessons conducted, number of classes, or other relevant units</span>

                <!-- Tables -->
                <div class="row" style="overflow-x:auto;">
                  <!-- Simple -->
                  <div class="col-12" id="viewSimple" >
                    <table id="tableSimple" class="table-light table-sm" cellspacing="0" width="100%">
                      <thead  style="background-color: grey; color: white;">
                        <tr>
                          <th style="width: 30px; min-width: 30px;"></th>
                          <th style="min-width: 200px;">Items</th>
                          <!-- <th style="width: 100px; min-width: 100px;text-align: right;">Quantity*</th> -->
                          <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
                          <!-- <th style="width: 100px; min-width: 100px;text-align: right;">Payout (%)</th> -->
                          <th style="width: 100px; min-width: 100px;text-align: right;">Earning</th>
                          <th style="width: 30px; min-width: 30px;"></th>
                        </tr>
                      </thead>
                      <tbody id="itemBody">
                        <tr class="item">
                          <td><i class="fas fa-grip-vertical"></i></td>
                          <td><input type="text" class="form-control" style="border: solid #2e74b6 thin;padding-left: 0.5rem;" placeholder=" Enter item and description" oninput="sync(this);"></td>
                          <!-- <td name="advanced"><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="calculateAmount();"></td> -->
                          <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;padding-left: 0.5rem;" value="-" oninput="sync(this); calculateAmount();"></td>
                          <!-- <td name="advanced"><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="calculateAmount();"></td> -->
                          <td style="text-align: right;"></td>
                          <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeRow(this); calculateAmount();"></i></td>
                        </tr>
                        <tr class="subtotal">
                          <td></td>
                          <!-- <td name="advanced"></td> -->
                          <td></td>
                          <!-- <td name="advanced"></td> -->
                          <td style="text-align: right; font-weight: 500;">Gross Pay</td>
                          <td style="text-align: right; font-weight: 500;" id="subtotalItem"></td>
                          <td></td>
                        </tr>
                      </tbody>
                    </table>

                    <table id="tableAdditionalItem" class="table-light table-sm" cellspacing="0" width="100%">
                      <thead style="visibility: collapse;">
                        <tr>
                          <th style="min-width: 130px;"></th>
                          <th style="width: 100px; min-width: 100px;">Items</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Items Name</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Earning</th>
                          <th style="width: 30px; min-width: 30px;"></th>

                        </tr>
                      </thead>
                      <tbody id="additionalItemBody">
                        <tr class="additional">
                          <td style="text-align: right;">
                            <div class="dropdown">
                              <a class="btn btn-primary dropdown-toggle bg-white text-dark text-right" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="text-transform: none; padding: 0.6rem; margin: 0;">Select one</a>
                              <div class="dropdown-menu" aria-labelledby="SortBy" id="sort-dropdown-menu">
                                <a class="dropdown-item" href="javascript:;" onclick="disabledAdditionalItem(this); calculateAmount();" style="text-transform: none;">Select one</a>
                                <a class="dropdown-item" href="javascript:;" onclick="enabledAdditionalItem(this, 'Earning'); calculateAmount();" style="text-transform: none;">Earning ( + )</a>
                                <a class="dropdown-item" href="javascript:;" onclick="enabledAdditionalItem(this, 'Discount'); calculateAmount();" style="text-transform: none;">Discount ( - )</a>

                              </div>
                            </div>
                          </td>
                          <td>
                            <input type="text" class="form-control" style="border: solid #2e74b6 thin; text-align: right; padding-right: 1rem;" placeholder='Item' oninput='syncAdditional(this);' readonly>
                          </td>
                          <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="0" oninput="syncAdditional(this); calculateAmount();" readonly></td>
                          <td style="text-align: right;"></td>
                          <td></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Advanced -->
                  <div class="col-12" id="viewAdv" style="display: none;">
                    <table id="tableAdv" class="table-light table-sm" cellspacing="0" width="100%">
                      <thead  style="background-color: grey; color: white;">
                        <tr>
                          <th style="width: 30px; min-width: 30px;"></th>
                          <th style="min-width: 200px;">Items</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Quantity*</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Payout (%)</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Earning</th>
                          <th style="width: 30px; min-width: 30px;"></th>
                        </tr>
                      </thead>
                      <tbody id="itemBodyAdv">
                        <tr class="item">
                          <td><i class="fas fa-grip-vertical"></i></td>
                          <td><input type="text" class="form-control" style="border: solid #2e74b6 thin; padding-left: 0.5rem;" placeholder=" Enter item and description" oninput="sync(this);"></td>
                          <td name="advanced"><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="sync(this); calculateAmount();"></td>
                          <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="sync(this); calculateAmount();"></td>
                          <td name="advanced"><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="sync(this); calculateAmount();"></td>
                          <td style="text-align: right;"></td>
                          <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeRow(this); calculateAmount();"></i></td>
                        </tr>
                        <tr class="subtotalAdv">
                          <td></td>
                          <td name="advanced"></td>
                          <td></td>
                          <td name="advanced"></td>
                          <td style="text-align: right; font-weight: 500;">Gross Pay</td>
                          <td style="text-align: right; font-weight: 500;" id="subtotalItemAdv"></td>
                          <td></td>
                        </tr>
                      </tbody>
                    </table>

                    <table id="tableAdditionalItemAdv" class="table-light table-sm" cellspacing="0" width="100%">
                      <thead style="visibility: collapse;">
                        <tr>
                          <th style="width: 30px; min-width: 30px;"></th>
                          <th style="min-width: 200px;">Items</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Quantity</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Price</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Payout (%)</th>
                          <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
                          <th style="width: 30px; min-width: 30px;"></th>

                        </tr>
                      </thead>
                      <tbody id="additionalItemBodyAdv">
                        <tr class="additional">
                          <td></td>
                          <td></td>
                          <td style="text-align: right;">
                            <div class="dropdown">
                              <a class="btn btn-primary dropdown-toggle bg-white text-dark text-right" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="text-transform: none; padding: 0.6rem; margin: 0;">Select one</a>
                              <div class="dropdown-menu" aria-labelledby="SortBy" id="sort-dropdown-menu">
                                <a class="dropdown-item" href="javascript:;" onclick="disabledAdditionalItem(this); calculateAmount();" style="text-transform: none;">Select one</a>
                                <a class="dropdown-item" href="javascript:;" onclick="enabledAdditionalItem(this, 'Earning'); calculateAmount();" style="text-transform: none;">Earning ( + )</a>
                                <a class="dropdown-item" href="javascript:;" onclick="enabledAdditionalItem(this, 'Discount'); calculateAmount();" style="text-transform: none;">Discount ( - )</a>
                              </div>
                            </div>
                          </td>
                          <td><input type="text" class="form-control" style="border: solid #2e74b6 thin; text-align: right; padding-right: 1rem;" placeholder='Item' oninput='syncAdditional(this);' readonly></td>
                          <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="0" oninput="syncAdditional(this); calculateAmount();" readonly></td>
                          <td style="text-align: right;"></td>
                          <td></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                </div>

                <div class="row">
                  <div class="col-12">
                    <h3 style="text-align: right; font-weight: 500;">Net Pay <span style="margin-left: 2rem;" id="grandTotal">RM0.00</span></h3>
                    <a href="javascript:;" class="btn btn-primary btn-round" id="addRow" style="text-transform: none;">Add New Item <i class="fas fa-plus-circle" style="color: #fff; margin-left: 0.5em; padding-bottom: 0.2em;"></i></a>
                    <a href="javascript:;" class="btn btn-primary btn-round" id="addAdditionalRow" style="text-transform: none;">Add New Additional Item <i class="fas fa-plus-circle" style="color: #fff; margin-left: 0.5em; padding-bottom: 0.2em;"></i></a>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnEditPayslipModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Payslip Details modal -->
      <div class="row">
        <div class="modal fade" id="editPayslipEmployeeModal" tabindex="-1" role="dialog" aria-labelledby="editPayslipEmployeeModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editPayslipEmployeeModalTitle">Update Payslip Details for This Teacher</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="editPayslipEmployeeModalBody">

                <h5 class="">General</h5>
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payslip Title</span>
                      <input type="text" class="form-control" id="editPayslipEmployeeTitle" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40">
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payslip No</span>
                      <input type="text" class="form-control" id="editPayslipEmployeeRefNo" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="15">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Date</span>
                      <input type="text" class="form-control" id="editPayslipEmployeeDate" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40">
                    </div>
                  </div>

                </div>


                <h5 class="">Employee Details</h5>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Name</span>
                      <input type="text" class="form-control" id="editPayslipEmployeeName" data-compulsory="false" oninput="this.className = 'form-control'" readonly>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <div class="form-group">
                        <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Position</span>
                        <input type="text" class="form-control" id="editPayslipEmployeePosition" data-compulsory="true" oninput="this.className = 'form-control'" >
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">EPF No</span>
                      <input type="text" class="form-control" id="editPayslipEmployeeEPF" data-compulsory="false" readonly>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Socso No</span>
                      <input type="text" class="form-control" id="editPayslipEmployeeSocso" data-compulsory="false" readonly>
                    </div>
                  </div>
                </div>

                <h5 class="">Banking Information</h5>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Name</span>
                      <input type="text" class="form-control" id="editPayslipEmployeeBankName" data-compulsory="false" readonly>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Account Number</span>
                      <input type="text" class="form-control" id="editPayslipEmployeeAcNo" data-compulsory="false" readonly>
                    </div>
                  </div>
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnEditPayslipEmployeeModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Record Payment modal -->
      <div class="row">
        <div class="modal fade" id="recordPaymentModal" tabindex="-1" role="dialog" aria-labelledby="recordPaymentModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="recordPaymentModalTitle">Record Payment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payment Date*</span>
                  <input type="text" class="form-control" id="inPaymentDate" style="cursor: pointer; cursor: pointer;">

                </div>
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payment Amount (RM)</span>
                  <input type="number" class="form-control" id="inPaymentAmount" oninput="checkRecordPaymentModalFields();"  maxlength="40">
                </div>
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Notes / Memo</span>
                  <textarea class="form-control" maxlength="200" rows="4"  id="inPaymentNotes" data-compulsory="false"></textarea>
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnRecordPaymentModalUpdate" disabled>Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Confirm Employee modal -->
      <div class="row">
        <div class="modal fade" id="confirmEmployeeModal" tabindex="-1" role="dialog" aria-labelledby="confirmEmployeeModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="confirmEmployeeModalTitle">Create Payslip for This Teacher</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="confirmEmployeeModalBody">
                <div id="confirmEmployeeCardId" value=""></div>
                Are you sure you want to continue?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary hidden" data-dismiss="modal" id="btnConfirmEmployeeModalUpdate" perm="fin-payslip-edit">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Remove Employee modal -->
      <div class="row">
        <div class="modal fade" id="removeEmployeeModal" tabindex="-1" role="dialog" aria-labelledby="removeEmployeeModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="removeEmployeeModalTitle">Remove This Teacher</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="removeEmployeeModalBody">
                <div id="employeeCardId" value=""></div>
                Are you sure you want to continue?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary hidden" data-dismiss="modal" id="btnRemoveEmployeeModalUpdate" perm="fin-payslip-del">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Create Payroll modal -->
      <div class="row">
        <div class="modal fade" id="createPayrollModal" tabindex="-1" role="dialog" aria-labelledby="createPayrollModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="createPayrollModalTitle">Create A Payroll</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="createPayrollModalBody">
                Are the payroll period correct? Are you sure you want to continue?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnCreatePayrollModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Load Previous Payroll modal -->
      <div class="row">
        <div class="modal fade" id="loadPayrollModal" tabindex="-1" role="dialog" aria-labelledby="loadPayrollModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document" style="overflow-y: auto;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="loadPayrollModalTitle">All Payrolls</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="loadPayrollModalBody">
                <div class="row" id="payrollFullList" style="padding: 1rem;">
                  <!-- <div class="col-md-12" id="payrollFullList"> -->
                    <!-- <a href="javascript:;" style="margin-right: 0.5rem;">1/10/2021 - 31/10/2021(12)</a>
                    <a href="javascript:;" style="margin-right: 0.5rem;">1/11/2021 - 30/11/2021(5)</a>
                    <a href="javascript:;" style="margin-right: 0.5rem;">1/12/2021 - 31/12/2021(23)</a> -->
                  <!-- </div> -->
                </div>

                <div class="row">
                  <div class="col-md-12" >
                    <a class="btn btn-sm btn-outline-primary btn-round" id="btnLoadPayrollModalLoadMore">Load More <i class="material-icons" style="color: #2e74b6; padding-bottom: 0.2em;">expand_more</i></a>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnLoadPayrollModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sign-out modal -->
      <div class="row">
        <div class="modal fade" id="signOutModal" tabindex="-1" role="dialog" aria-labelledby="signOutModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="signOutLabel">Logging Out</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="signOutModalBody">
                Are you sure you want to continue?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnSignOutModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- View Tutor Modal -->
       <div class="row">
        <div class="modal fade" id="viewTutorModal" tabindex="-1" role="dialog" aria-labelledby="viewTutorModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="viewTutorModalLabel">Tutor Profile</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-4 text-center">
                    <div style="height: 140px;width: 140px; display: inline-block; position: relative; overflow: hidden; border-radius: 50%;">
                      <img id="viewTutorImgUrl" style="height: 100%;width: 100%; object-fit: cover;" src="../../assets/img/empty-photo.png"/>
                    </div>

                  </div>

                  <div class="col-md-8">
                    <span class="" style="font-size: smaller; font-weight: 300; color: gray; padding-right: 2rem;">Name</span>
                    <input id="viewTutorName"  type="text" value='' class="form-control" style="pointer-events: none;" readonly>

                    <div class="row">
                      <div class="col-md-6">
                        <span class="" style="font-size: smaller; font-weight: 300; color: gray; padding-right: 2rem;">Phone</span>
                        <input id="viewTutorPhone"  type="text" value='' class="form-control" style="pointer-events: none;" readonly>

                      </div>
                      <div class="col-md-6">
                        <span class="" style="font-size: smaller; font-weight: 300; color: gray; padding-right: 2rem;">Email</span>
                        <input id="viewTutorEmail"  type="text" value='' class="form-control" style="pointer-events: none;" readonly>

                      </div>
                    </div>


                    <div class="row">
                      <div class="col-md-6">
                        <span class="" style="font-size: smaller; font-weight: 300; color: gray; padding-right: 2rem;">Gender</span>
                        <div class="form-group">
                          <div class="form-check form-check-radio form-check-inline">
                            <label class="form-check-label">
                              <input class="form-check-input" type="radio" name="tutorGender" id="viewTutorGenderRadioMale" value="optionActive" data-compulsory="false" disabled>
                              Male
                              <span class="circle">
                                <span class="check"></span>
                              </span>
                            </label>
                          </div>
                          <div class="form-check form-check-radio form-check-inline">
                            <label class="form-check-label">
                              <input class="form-check-input" type="radio" name="tutorGender" id="viewTutorGenderRadioFemale" value="optionInactive" data-compulsory="false" disabled>
                              Female
                              <span class="circle">
                                <span class="check"></span>
                              </span>
                            </label>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <span class="" style="font-size: smaller; font-weight: 300; color: gray; padding-right: 2rem;">Age</span>
                        <input id="viewTutorAge"  type="text" value='' class="form-control" style="pointer-events: none;" readonly>

                      </div>
                    </div>

                  </div>

                </div>
              </div>
              <div class="modal-footer">
                <a type="button" class="btn btn-primary" href="#" id="btnViewTutorModalFullProfile" disabled>View Full Profile</a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <!-- <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnViewTutorModalUpdate">Update</button> -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main content -->
      <div class="content">

        <div class="container-fluid" >
          <div class="row d-flex">
            <div class="p-2">
              <a href="./" class="btn btn-outline-primary btn-round" id="btnBack" name="param-link"><i class="material-icons" style="color: #2e74b6; margin-right: 0.5em; padding-bottom: 0.2em;">west</i> Back</a>
            </div>
          </div>


          <div class="row">
            <div class="col-md-12">
              <!-- Step 1 -->
              <div class="card"   style="margin-top: 0;">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="social">
                        <h4 style="font-size: x-large;"><span> <button  id="btnStep1" class="btn btn-primary btn-just-icon btn-round" style="margin-right: 1rem;">
                          <p>1</p>
                          <!-- <i class="fas fa-check-circle"></i> -->
                          </button></span>
                          Select payroll period
                        </h4>
                        <!-- <h4 style="font-size: x-large;">Create single payslip</h4> -->

                        <!-- <p>Create payslip for each teacher.</p> -->
                      </div>

                      <div class="row">
                        <div class="col-md-12" id="payrollList">
                          <!-- <a href="javascript:;" style="margin-right: 0.5rem;">1/10/2021 - 31/10/2021</a>
                          <a href="javascript:;" style="margin-right: 0.5rem;">1/11/2021 - 30/11/2021</a>
                          <a href="javascript:;" style="margin-right: 0.5rem;">1/12/2021 - 31/12/2021</a> -->
                          <!-- <a href="javascript:;" style="margin-right: 0.5rem;" data-target="#loadPayrollModal" data-toggle="modal">All payrolls</a> -->
                          <a class="hidden" href="javascript:;" style="margin-right: 0.5rem;" onclick="window.location.reload(); //enableStep1();" perm="fin-payroll-add">New</a>
                        </div>
                      </div>



                    </div>

                    <div class="col-md-6">

                      <div class="row">

                        <div class="col-md-12">
                          <div class="form-group">
                            <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payroll period</span>

                            <input class="form-control" type="text" name="daterange" id='daterange' value="Select date range"/>
                          </div>
                        </div>

                        <!-- <div class="col-md-6">
                          <div class="form-group">
                            <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payroll Title</span>
                            <input class="form-control" type="text" id='payrollTitle'/>
                          </div>
                        </div> -->

                      </div>

                      <div class="row">
                        <div class="col-md-12 text-right">
                          <a id="btnCreatePayroll" href="javascript:;" class="btn btn-primary btn-round hidden" data-toggle="modal" data-target="#createPayrollModal" perm="fin-payroll-add">Create Payroll <i class="material-icons" style="color: white; margin-left: 0.5em; padding-bottom: 0.2em;">east</i></a>
                        </div>
                      </div>

                    </div>
                  </div>

                </div>

              </div>

              <!-- Step 2 -->
              <div class="card">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="social">
                        <h4 style="font-size: x-large;"><span> <button  id="btnStep2" class="btn btn-default btn-just-icon btn-round" style="margin-right: 1rem;">
                          <p>2</p>
                          <!-- <i class="fas fa-check-circle"></i> -->
                          </button></span>
                          Select employee
                        </h4>
                        <!-- <h4 style="font-size: x-large;">Create single payslip</h4> -->
                        <p>Update your employees' hours and additional earnings.</p>
                      </div>
                    </div>

                    <div class="col-md-4 align-self-center text-right">

                      <a id='btnAddEmployee' href="javascript:;" class="btn btn-outline-default btn-round hidden" style="background-color: #999999; color: white; pointer-events: none;" data-toggle="modal" data-target="#myTeacherModal" onclick="appendModal('myTeacherModal')" perm='fin-payslip-add'>Add Employee </a>

                      <!-- <a id='btnAddAllEmployee' href="javascript:;" class="btn btn-outline-default btn-round" style="pointer-events: none;" data-toggle="modal" data-target="#addAllEmployeeModal">Add All Employees</a> -->

                    </div>
                  </div>

                  <!-- All Teachers -->
                  <div class="row" id="card-main">

                    <!-- No data placeholder -->
                    <div class="col-md-12 text-center" style="display: none; margin: 1rem;" id="noDataPlaceholder">
                      <p>No data</p>

                    </div>


                    <!-- Employee List Start -->

                    <div class="col-md-12">
                      <div class="accordion" id="accordionTutor">

                        <!-- card 1 -->
                        <!-- <div class="card" id='wwwwww'>
                          <div class="card-header" id="headingOne" style="padding: 0; margin: 0; ">
                            <div class="row" >
                              <div class="col-md-10">
                                <a class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse1" aria-expanded="false" aria-controls="collapseOne" style="text-transform: none; white-space: normal; font-size: medium;">
                                  Aishah Aishah Aishah Aishah &middot; <span id="netpayview_wwwwwww">RM1028.70</span> <span class="card-student-status-label active" id="paymentstatus_wwwwww" style="font-size: small;">New</span>
                                </a>
                              </div>
                              <div class="col-md-2  align-self-center text-center">

                                <span class="fa-stack" style="vertical-align: top; font-size: 73%; color: #2e74b6; cursor: pointer; margin-right: 0.5rem;" data-target="#recordPaymentModal" data-toggle="modal" data-employeecardid="wwwwww" data-employeecardname="aishas">
                                  <i class="fas fa-circle fa-stack-2x"></i>
                                  <i class="fas fa-pen fa-stack-1x fa-inverse"></i>
                                </span>
                                <i class="fas fa-check-circle fa-lg" name='update' style="color: #42ba96; cursor: pointer; margin-right: 0.5rem;" data-target="#confirmEmployeeModal" data-toggle="modal" data-employeecardid="wwwwww" data-employeecardname="aishas"></i>
                                <i class="fas fa-minus-circle fa-lg" name='remove' style="color: red; cursor: pointer;" data-target="#removeEmployeeModal" data-toggle="modal" data-employeecardid="wwwwww" data-employeecardname="aishas"></i>
                              </div>
                            </div>
                          </div>
                          <div id="collapse1" class="collapse" aria-labelledby="headingOne" data-parent="#accordionTutor" style="padding: 0; margin: 0; ">
                            <div class="card-body">
                              <div class="row d-flex">
                                <div class="ml-auto p-2">
                                  <button href="javascript:;" class="btn btn-primary btn-round" data-toggle="modal" data-target="#previewModal" onclick=""> <i class="fas fa-eye" style="margin-right: 0.5rem;"></i> Preview</button>
                                </div>
                                <div class="p-2">
                                  <button href="javascript:;" class="btn btn-primary btn-round" data-toggle="modal" data-target="#editPayslipModal" data-cardid='wwwwww'> <i class="fas fa-pen-square" style="margin-right: 0.5rem;"></i> Edit</button>
                                </div>
                              </div>
                              <div class="row">
                                <div class="col-12"  style="overflow-x:auto;">
                                  <span class="" style="font-size: x-small; font-weight: 300; color: gray; margin-bottom: 0;">Note*: Quantity - Number of hour of lessons conducted, number of classes, or relevant other items</span>
                                  <table id="table_item_wwwwww" class="table-light table-sm" cellspacing="0" width="100%" >
                                    <thead id='thead_item_wwwwww' style="background-color: grey; color: white;">
                                      <tr>
                                        <th style="min-width: 200px; font-size: small;">Items</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Quantity*</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Amount</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Payout</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Earning</th>
                                      </tr>
                                    </thead>
                                    <tbody id="tbody_item_wwwwww">
                                      <tr class="item">
                                        <td style="font-size: small;">Standard 3 English</td>
                                        <td style="text-align: right; font-size: small;">1</td>
                                        <td style="text-align: right; font-size: small;">100</td>
                                        <td style="text-align: right; font-size: small;">100</td>
                                        <td style="text-align: right; font-size: small;">RM100</td>
                                      </tr>
                                      <tr class="subtotal" id='previewItemSubtotal'>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td style="text-align: right; font-weight: 500; font-size: small;">Gross Pay</td>
                                        <td style="text-align: right; font-weight: 500; font-size: small;" id="previewSubtotalItem">RM100</td>
                                      </tr>
                                    </tbody>
                                  </table>
                                  <table id="table_additem_wwwwww" class="table-light table-sm" cellspacing="0" width="100%">
                                    <thead id="thead_additem_wwwwww" style="visibility: collapse;">
                                      <tr>
                                        <th style="min-width: 200px;">Items</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right;">Quantity</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right;">Price</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right;">Payout</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
                                      </tr>
                                    </thead>
                                    <tbody id="tbody_additem_wwwwww">
                                      <tr class="additional">
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td style="text-align: right; font-size: small;" data-selector='Earning ( + )' data-item='Extra Cash' data-value='10'>Extra Cash</td>
                                        <td style="text-align: right; font-size: small;">+ RM10</td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                                <div class="col-12">
                                  <h4 style="text-align: right; font-weight: 500;">Net Pay <span style="margin-left: 2rem;" id="netpay_wwwwww">RM100.00</span></h4>
                                </div>
                              </div>

                              <div class="row"  style="margin-top: 1rem">
                                <div class="col-md-12 text-right">
                                  <button href="javascript:;" class="btn btn-primary btn-round" data-toggle="modal" data-target="#editPayslipEmployeeModal" data-cardid='wwwwww'> <i class="fas fa-pen-square" style="margin-right: 0.5rem;"></i> Edit Details</button>
                                </div>
                              </div>


                              <div class="row">
                                <div class="col-md-4">
                                  <h5>General</h5>
                                  <div class="row">
                                    <div class="col-md-12">
                                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payslip Title</span>
                                      <p name="title">Payslip of November</p>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-md-12">
                                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payslip No</span>
                                      <p name="refNo">PV9128391890</p>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-md-12">
                                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Date</span>
                                      <p name="date">12/2/2021</p>
                                    </div>
                                  </div>
                                </div>

                                <div class="col-md-4">
                                  <h5>Employee Details</h5>
                                  <div id='employeeid' value=''></div>
                                  <div class="row">
                                    <div class="col-md-12">
                                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Name</span>
                                      <p name="name">Alric Liew</p>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-md-12">
                                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Position</span>
                                      <p name="position">Tutor</p>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-md-12">
                                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">EPF No</span>
                                      <p name="epf">8946146465</p>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-md-12">
                                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Socso No</span>
                                      <p name="socso">64631894616584</p>
                                    </div>
                                  </div>
                                </div>
                                <div class="col-md-4">
                                  <h5>Banking Information</h5>
                                  <div class="row">
                                    <div class="col-md-12">
                                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Name</span>
                                      <p name="bankName">CIMB Bank</p>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-md-12">
                                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Account Number</span>
                                      <p name="acNo">98s5ew5xdfle</p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div> -->

                        <!-- card 2 -->
                        <!-- <div class="card" id='wwwwwv'>
                          <div class="card-header" id="headingOne" style="padding: 0; margin: 0; ">
                            <div class="row" >
                              <div class="col-md-11">
                                <a class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse2" aria-expanded="false" aria-controls="collapseOne" style="text-transform: none; white-space: normal; font-size: medium;">
                                  Chang Ai Ling (RM128.30)
                                </a>
                              </div>
                              <div class="col-md-1  align-self-center text-center">
                                <i class="far fa-check-circle fa-lg" style="color: #42ba96; cursor: pointer; margin-right: 0.5rem;" data-target="#confirmEmployeeModal" data-toggle="modal" data-employeecardid="wwwwww" data-employeecardname="aishas"></i>
                                <i class="fas fa-minus-circle" style="color: red; cursor: pointer;" data-target="#removeEmployeeModal" data-toggle="modal" data-employeecardid="wwwwwv" data-employeecardname="aishas"></i>
                              </div>
                            </div>
                          </div>
                          <div id="collapse2" class="collapse" aria-labelledby="headingOne" data-parent="#accordionTutor" style="padding: 0; margin: 0; ">
                            <div class="card-body">
                              <div class="row d-flex" id="desciption-row" >
                                <div class="ml-auto p-2">
                                  <button href="javascript:;" class="btn btn-primary btn-round" data-toggle="modal" data-target="#previewModal" onclick=""> <i class="fas fa-eye" style="margin-right: 0.5rem;"></i> Preview</button>
                                </div>
                                <div class="p-2">
                                  <button href="javascript:;" class="btn btn-primary btn-round" data-toggle="modal" data-target="#editPayslipModal" onclick=""> <i class="fas fa-pen-square" style="margin-right: 0.5rem;"></i> Edit</button>
                                </div>
                              </div>
                              <div style="margin-top: 1rem;"></div>

                              <div class="row">
                                <div class="col-12"  style="overflow-x:auto;">
                                  <span class="" style="font-size: x-small; font-weight: 300; color: gray; margin-bottom: 0;">Note*: Quantity - Number of hour of lessons conducted, number of classes, or relevant other items</span>
                                  <table id="table_item_wwwwww" class="table-light table-sm" cellspacing="0" width="100%" >
                                    <thead style="background-color: grey; color: white;">
                                      <tr>
                                        <th style="min-width: 200px; font-size: small;">Items</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Price</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Amount</th>
                                      </tr>
                                    </thead>
                                    <tbody id="previewItemBody">
                                      <tr class="item">
                                        <td style="font-size: small;">Food</td>
                                        <td style="text-align: right; font-size: small;">20</td>
                                        <td style="text-align: right; font-size: small;">RM20</td>
                                      </tr>
                                      <tr class="subtotal" id='previewItemSubtotal'>
                                        <td></td>
                                        <td style="text-align: right; font-weight: 500; font-size: small;">Gross Earning</td>
                                        <td style="text-align: right; font-weight: 500; font-size: small;" id="previewSubtotalItem">RM20</td>
                                      </tr>
                                    </tbody>
                                  </table>

                                  <table id="table_additem_wwwwww" class="table-light table-sm" cellspacing="0" width="100%">
                                    <thead style="visibility: collapse;">
                                      <tr>
                                        <th style="min-width: 200px;">Items</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right;">Price</th>
                                        <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
                                      </tr>
                                    </thead>
                                    <tbody id="previewAdditionalItemBody">
                                      <tr class="additional">
                                        <td></td>
                                        <td style="text-align: right; font-size: small;">Extra</td>
                                        <td style="text-align: right; font-size: small;">+ RM10</td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>

                                <div class="col-12">
                                  <h4 style="text-align: right; font-weight: 500;">Net Pay <span style="margin-left: 2rem;" id="previewGrandTotal">RM30.00</span></h4>
                                </div>
                              </div>
                            </div>
                          </div>


                        </div> -->

                      </div>
                    </div>


                  </div>

                </div>

              </div>

              <!-- <div class="card">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="social">
                        <h4 style="font-size: x-large;"><span> <button  id="btnStep1" class="btn btn-primary btn-just-icon btn-round" style="margin-right: 1rem;">
                          <p>3</p>
                          </button></span>
                          Confirmation
                        </h4>
                        <p>Everything looks good!</p>
                      </div>
                    </div>
                    <div class="col-md-4 align-self-center text-right">
                      <a href="javascript:;" class="btn btn-primary btn-round" style="background-color: #2e74b6;">Submit Payroll <i class="material-icons" style="color: white; margin-left: 0.5em; padding-bottom: 0.2em;">east</i></a>
                    </div>
                  </div>
                </div>
              </div> -->
            </div>
          </div>
        </div>


        <footer class="footer">
          <div class="container-fluid">
            <nav class="float-left">
            <ul>
              <!-- <li>
              <a href="https://golearn.com.my/join-us" target="_blank">
                Visit GoLearn Tutor
              </a>
              </li> -->
            </ul>
            </nav>
          </div>
        </footer>
      </div>
    </div>

  </div>

  <script src="../../assets/js/core/jquery.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap-material-design.min.js"></script>
  <script src="../../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!-- Plugin for the momentJs  -->
  <script src="../../assets/js/plugins/moment.min.js"></script>
  <!--  Plugin for Sweet Alert -->
  <script src="../../assets/js/plugins/sweetalert2.js"></script>
  <!-- Forms Validations Plugin -->
  <script src="../../assets/js/plugins/jquery.validate.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="../../assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../../assets/js/material-dashboard.js?v=2.1.2" type="text/javascript"></script>

  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.min.js" integrity="sha384-lpyLfhYuitXl2zRZ5Bn2fqnhNAKOAaM/0Kr9laMspuaMiZfGmfwRNFh8HlMy49eQ" crossorigin="anonymous"></script> -->
  <!-- Common constants -->
  <script src="../../assets/js/common.js" type="text/javascript"></script>
  <!-- General Info -->
  <script src="../../assets/js/const.js" type="text/javascript"></script>
  <!-- Core Js -->
  <script src="../../assets/js/org-core.js" type="text/javascript"></script>
  <!-- Date range picker -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <!-- International Telephone Input -->
  <script src="../../assets/js/plugins/intlTelInput/intlTelInput.js"></script>
  <!-- Html 2 PDF -->
  <!-- <script src="https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>  -->
  <script src="../../assets/js/html2pdf.js" type="text/javascript"></script>


	<script>

    //  Tutor Settings
    var bizName, bizPhone, bizEmail, bizAddr, bizImgUrl;

    // Payroll Data
    var payrollId,payrollTotal;
    var payrollDocIdArr = [];
    var payrollDocTotalArr = [];
    // Course-specific var
    var allCourseSize;

    var recordPaymentDate, recordPaymentAmount, recordPaymentNote;

    // Start and end of payroll period
    var payrollStart = moment().startOf('month').format('DD/MM/YYYY');
    var payrollEnd = moment().endOf('month').format('DD/MM/YYYY');
    var payrollName = moment().startOf('month').format('DD/MM/YYYY') + ' - ' + moment().endOf('month').format('DD/MM/YYYY');

    // document.getElementById('payrollTitle').value = payrollName;

    // Start and end of curent month
    var start = moment().startOf('month');
    var end = moment().endOf('month');

    var payrollDate = moment().startOf('month').format('DD/MM/YYYY'); // Date on payslip
    var payrollDateMonth = moment().startOf('month').format('MMMM YYYY'); // Date on payslip


		// var db = firebase.firestore();
		// db.settings({ timestampsInSnapshots: true });

    var latestAdminTutorDoc = null;// Store last document - Used for Admin's Tutor Load More btn in Add Teacher Modal

    // Item Table id
    const tableSimple = document.getElementById('tableSimple');
    const tableAdv = document.getElementById('tableAdv');

    // Additional Item Table id
    const tableAdditionalItem = document.getElementById('tableAdditionalItem');
    const tableAdditionalItemAdv = document.getElementById('tableAdditionalItemAdv');

    // Additional Items Body id
    const additionalItemBody = document.getElementById('additionalItemBody');
    const additionalItemBodyAdv = document.getElementById('additionalItemBodyAdv');

    // Initialization
    AuthCheck();

    // Page Specific Initialization
    function loadPageInitFunc(){

      // Load settings
      loadUserSettings(ent_id);

      // Load the most recent payrolls
      loadRecentPayroll();

      // test_loadLessonDateRange();
    }

    // Load recent payrolls
    function loadRecentPayroll(){
      let docRef = db.collection("dev")
          .doc("v2")
          .collection("Payroll")
          .where(PAYROLL_ADMIN_ID, '==', ent_id)
          .where(PAYROLL_STATUS, '==', true)
          .orderBy(PAYROLL_DATE_START, 'desc')
          .limit(2)

      docRef
      .get()
      .then((querySnapshot) => {

        if(querySnapshot.empty) {

          // console.log("Empty, Create a new payroll");

        }
        else {
          querySnapshot.forEach((doc) => {
            // console.log("Payroll found");
            // console.log(doc.data());

            renderRecentPayroll(doc);

          });

          if (querySnapshot.docs.length > 1)
            renderLoadAllPayroll();
        }


      }).catch((error) => {
          console.log("Error getting document:", error);
      });

    }

    // Render payroll
    function renderRecentPayroll(doc){
      // <div class="col-md-12" id="payrollList">
      //   <a href="javascript:;" style="margin-right:0.5rem">1/10/2021 - 31/10/2021 </a>
      //   <a href="javascript:;" style="margin-right:0.5rem">1/11/2021 - 30/11/2021 </a>
      //   <a href="javascript:;" style="margin-right:0.5rem">1/12/2021 - 31/12/2021 </a>
      //   <a href="javascript:;" style="margin-right:0.5rem">Other payrolls </a>
      // </div>
      // Card top
      let payroll_a = document.createElement('a');
      payroll_a.setAttribute('href', 'javascript:;');
      payroll_a.setAttribute('style', 'margin-right:1rem');
      payroll_a.setAttribute('onclick', 'loadPayrollSingle("'+doc.data()[PAYROLL_ID]+'");');
      payroll_a.textContent = doc.data()[PAYROLL_NAME]+" ("+doc.data()[PAYROLL_DOC_ID_ARR].length+")";

      const payrollList = document.getElementById("payrollList");
      payrollList.insertBefore( payroll_a, payrollList.children[0]);
      // payrollList.appendChild(payroll_a);

    }

    function renderLoadAllPayroll(){
      // <a href="javascript:;" style="margin-right: 0.5rem;" data-target="#loadPayrollModal" data-toggle="modal">All payrolls</a>

      let payroll_a = document.createElement('a');
      payroll_a.setAttribute('href', 'javascript:;');
      payroll_a.setAttribute('style', 'margin-right:1rem');
      payroll_a.setAttribute('data-target', '#loadPayrollModal');
      payroll_a.setAttribute('data-toggle', 'modal');
      payroll_a.textContent = 'All payrolls';

      const payrollList = document.getElementById("payrollList");
      // payrollList.appendChild(payroll_a);
      payrollList.insertBefore( payroll_a, payrollList.children[-2]);

    }


    // Load recent payrolls
    var latestPayrollDoc = null;
    function loadAllPayroll(){

      let today = new Date(2100, 12, 31);// Set a big date


      let docRef = db.collection("dev")
          .doc("v2")
          .collection("Payroll")
          .where(PAYROLL_ADMIN_ID, '==', ent_id)
          .where(PAYROLL_STATUS, '==', true)
          .orderBy(PAYROLL_DATE_START, 'desc')
          .startAfter(latestPayrollDoc || today)
          .limit(25);

      docRef
      .get()
      .then((querySnapshot) => {


        // if (( querySnapshot.docs.length== null || querySnapshot.docs.length == 0) && latestInvoiceDoc == null){
        //   document.getElementById("noDataPlaceholder").style.display = 'initial';
        // }else{
        //   document.getElementById("noDataPlaceholder").style.display = 'none';
        // }

        if(querySnapshot.empty) {

          // console.log("Empty, Create a new payroll");

        }
        else {
          querySnapshot.forEach((doc) => {
            // console.log("Payroll found");
            // console.log(doc.data());

            renderAllPayroll(doc);

          });

        }

        latestPayrollDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
        // Handle Lesson Load more btn
        if (querySnapshot.empty){
          payrollLoadmore.removeEventListener('click', payrollLoadmoreHandleClick );
        }
        if (querySnapshot.docs.length == 25){
          payrollLoadmore.style.visibility='visible';
        }else{
          payrollLoadmore.style.visibility='hidden';
        }

      }).catch((error) => {
          console.log("Error getting document:", error);
      });

    }

    // Render payroll
    function renderAllPayroll(doc){
      // <div class="col-md-12" id="payrollList">
      //   <a href="javascript:;" style="margin-right:0.5rem">1/10/2021 - 31/10/2021 </a>
      //   <a href="javascript:;" style="margin-right:0.5rem">1/11/2021 - 30/11/2021 </a>
      //   <a href="javascript:;" style="margin-right:0.5rem">1/12/2021 - 31/12/2021 </a>
      //   <a href="javascript:;" style="margin-right:0.5rem">Other payrolls </a>
      // </div>
      // Card top
      let payroll_a = document.createElement('a');
      payroll_a.setAttribute('href', 'javascript:;');
      payroll_a.setAttribute('style', 'margin-right:1rem');
      payroll_a.setAttribute('data-dismiss', 'modal');
      payroll_a.setAttribute('onclick', 'loadPayrollSingle("'+doc.data()[PAYROLL_ID]+'");');
      payroll_a.textContent = doc.data()[PAYROLL_NAME]+" ("+doc.data()[PAYROLL_DOC_ID_ARR].length+")";

      const payrollFullList = document.getElementById("payrollFullList");
      payrollFullList.insertBefore( payroll_a, payrollFullList.children[0]);
      // payrollList.appendChild(payroll_a);

    }

    // Payrolls Load More Button - Init
    const payrollLoadmore = document.querySelector('#btnLoadPayrollModalLoadMore');
    payrollLoadmore.style.visibility='hidden';

    const payrollLoadmoreHandleClick = () =>{
      loadAllPayroll();
    }
    payrollLoadmore.addEventListener('click', payrollLoadmoreHandleClick );


    // Load payroll based on payrollId
    function loadPayrollSingle(payroll_id){


      // Clear existing payslip item
      let existingCardList = document.getElementById('accordionTutor').querySelectorAll('div.card');
      // let existingCardIdList = [];

      existingCardList.forEach((row, index) => {
        row.remove();
      })


      var docRef = db.collection("dev")
          .doc("v2")
          .collection("Payroll")
          .doc(payroll_id);

      docRef
      .get()
      .then((doc) => {

        if(doc.empty) {

          console.log("Empty, Create a new payroll");
          func.showNotification('top','center', 'error', 'error_outline', "Payroll does not exist." );
          // var payrollDocRef = db.collection("dev")
          //   .doc("v2")
          //   .collection("Payroll")
          //   .doc();

          // payrollId = payrollDocRef.id;

          // var data = {
          //   [PAYROLL_ID]: payrollId,
          //   [PAYROLL_ADMIN_ID]: ent_id,
          //   [PAYROLL_NAME]: payrollName,
          //   [PAYROLL_DATE_START]: payrollStart,
          //   [PAYROLL_DATE_END]: payrollEnd,
          //   [PAYROLL_DOC_ID_ARR]: [],
          //   [PAYROLL_DOC_TOTAL_ARR]: [],
          //   [PAYROLL_TOTAL]: 0,
          //   [PAYROLL_STATUS]: true,
          // }

          // payrollDocRef.set(data, { merge: true })
          //   .then(() => {

          //     // Load all active tutor
          //     loadAllTutorInfo();

          //     // Enable Step 2
          //     enableStep2();

          //     func.showNotification('top','center', 'success', 'check_circle', "Created new payroll." );

          // });

        }
        else {

          console.log("Load Single Payroll: Payroll found");
          console.log(doc.data());

          // Get data from payroll
          payrollId = doc.data()[PAYROLL_ID];
          payrollName = doc.data()[PAYROLL_NAME];
          payrollStart = doc.data()[PAYROLL_DATE_START];
          payrollEnd = doc.data()[PAYROLL_DATE_END];
          payrollDocIdArr = doc.data()[PAYROLL_DOC_ID_ARR];
          payrollDocTotalArr = doc.data()[PAYROLL_DOC_TOTAL_ARR];
          payrollTotal = doc.data()[PAYROLL_TOTAL];

          // Load the payslip of each tutor.
          loadAllPayslips(payrollId);

          // console.log(payrollStart.toDate(), payrollEnd.toDate())
          let startDate_temp = moment(payrollStart.toDate());
          let endDate_temp = moment(payrollEnd.toDate());

          // console.log(startDate_temp, endDate_temp)

          $('input[name="daterange"]').daterangepicker({
            startDate: startDate_temp,
            endDate: endDate_temp,
            locale: {
              format: 'DD/MM/YYYY'
            },
            ranges: {
              //  'Today': [moment(), moment()],
              //  'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
              //  'Last 7 Days': [moment().subtract(6, 'days'), moment()],
              //  'Last 30 Days': [moment().subtract(29, 'days'), moment()],
              'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
              'This Month': [moment().startOf('month'), moment().endOf('month')],
              'Next Month': [moment().add(1, 'month').startOf('month'), moment().add(1, 'month').endOf('month')]
            }
          }, cb);

          cb(startDate_temp, endDate_temp);

          // Enable Step 2
          enableStep2();

          // func.showNotification('top','center', 'warning', 'error_outline', "Payroll already existed." );
        }

      }).catch((error) => {
          console.log("Error getting document:", error);
      });

    }


    // Lesson Load More Button - Init
    const tutorAdminLoadmore = document.querySelector('#btnAddTeacherModalLoadMore');
    tutorAdminLoadmore.style.visibility='hidden';

    const tutorAdminLoadMoreHandleClick = () =>{
      loadAllAdminTeachers();
    }
    tutorAdminLoadmore.addEventListener('click', tutorAdminLoadMoreHandleClick );

    // Load All Teachers that owned by class admin.
    var allTutorModuleDoc = []; // Reset all Tutors doc
    function loadAllAdminTeachers(){

      // Get the existing list of cardId.
      // If similar phoneId used, ban the number.
      let existingCardList = document.getElementById('accordionTutor').querySelectorAll('div.card');
      let existingCardIdList = [];

      existingCardList.forEach((row, index) => {
        existingCardIdList.push(row.getAttribute('id'));
      });

      allTutorModuleDoc = []; // Init All Tutors Doc array
      // STUDENT Module
      let docRef = db.collection("dev")
          .doc("v2")
          .collection("Tutor")
          .where(TUTOR_ADMIN_ID, "==", ent_id)
          .where(TUTOR_STATUS_ADMIN, "==", TUTOR_STATUS_TYPE_ACTIVE)
          .orderBy(TUTOR_TUTOR_NAME, 'asc')
          .startAfter(latestAdminTutorDoc)
          .limit(25);

      docRef
      .get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          // console.log(doc.data().id);


          allTutorModuleDoc.push(doc.data());

          if (existingCardIdList.includes(doc.data()[TUTOR_TUTOR_ID]))
            renderAllAdminTeachers(doc, true);
          else
            renderAllAdminTeachers(doc, false);

        });

        latestAdminTutorDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
        // console.log(querySnapshot.docs.length)
        // Handle Lesson Load more btn
        if (querySnapshot.empty){
          tutorAdminLoadmore.removeEventListener('click', tutorAdminLoadMoreHandleClick );
        }

        if (querySnapshot.docs.length == 25){
          tutorAdminLoadmore.style.visibility='visible';
        }else{
          tutorAdminLoadmore.style.visibility='hidden';
        }


      }).catch((error) => {
          console.log("Error getting document:", error);
      });


    }

    // Render all teachers view in Add Teachers Modal
    function renderAllAdminTeachers(doc, disableSelect){
      //  <div class="row tutor-wrapper text-center">
      //   <div class="col-md-2">
      //     <div style="height: 50px; width: 50px; display: inline-block; position: relative; overflow: hidden; border-radius: 50%;">
      //       <img style="height: 100%;width: 100%; object-fit: cover;" src="../../assets/img/test.jpg"/>
      //     </div>
      //   </div>
      //   <div class="col-md-3">
      //     <p class='tutor-item'>Alric Liew</p>
      //   </div>
      //   <div class="col-md-3">
      //     <p class='tutor-item'>Phone</p>
      //   </div>
      //   <div class="col-md-2">
      //     <p class='tutor-item'>12</p>
      //   </div>

      //   <div class="col-md-2">
      //     <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal" id="btnSelectTutor">Select</button>
      //   </div>
      // </div>


      // Image
      let img = document.createElement('img');
      img.setAttribute('style', 'height: 100%; width: 100%; object-fit: cover;');
      // img.src = doc.data()[TUTOR_TUTOR_IMG_URL];

      // Check if img is valid. If no, create a 2 chars avatar
      if (doc.data()[TUTOR_TUTOR_IMG_URL] == null || doc.data()[TUTOR_TUTOR_IMG_URL] == ""
      || doc.data()[TUTOR_TUTOR_IMG_URL] == "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D"
      || tutorImgUrlChecker(doc.data()[TUTOR_TUTOR_IMG_URL])){
        let AvatarText = doc.data()[TUTOR_TUTOR_NAME][0] + doc.data()[TUTOR_TUTOR_NAME][1];
        img.src = generateAvatar(AvatarText, "#eaeaea", "#f6f6f6", "100px");
      }
      else {
        img.src = doc.data()[TUTOR_TUTOR_IMG_URL];
      }

      let img_div = document.createElement('div');
      img_div.setAttribute('style', 'height: 50px; width: 50px; display: inline-block; position: relative; overflow: hidden; border-radius: 50%;');
      img_div.appendChild(img);
      let imgTop_div = document.createElement('div');
      imgTop_div.className = "col-md-2";
      imgTop_div.appendChild(img_div);


      let tutorName_p = document.createElement('p');
      tutorName_p.className = "tutor-item";
      tutorName_p.textContent = doc.data()[TUTOR_TUTOR_NAME];
      let tutorName_div = document.createElement('div');
      tutorName_div.className = "col-md-3";
      tutorName_div.appendChild(tutorName_p);

      let tutorPhone_p = document.createElement('p');
      tutorPhone_p.className = "tutor-item";
      tutorPhone_p.textContent = doc.data()[TUTOR_TUTOR_PHONE];
      let tutorPhone_div = document.createElement('div');
      tutorPhone_div.className = "col-md-3";
      tutorPhone_div.appendChild(tutorPhone_p);

      let tutorAge_p = document.createElement('p');
      tutorAge_p.className = "tutor-item";
      tutorAge_p.textContent = doc.data()[TUTOR_TUTOR_AGE];
      let tutorAge_div = document.createElement('div');
      tutorAge_div.className = "col-md-2";
      tutorAge_div.appendChild(tutorAge_p);

      let sel_btn = document.createElement('button');
      sel_btn.className = "btn btn-primary btn-sm";
      sel_btn.textContent = 'Select';
      sel_btn.setAttribute('data-dismiss','modal');
      sel_btn.setAttribute('type','button')
      // AddNewEmployee(ent_id, name, position, bankName, acNo, epf, socso)

      sel_btn.setAttribute('onclick',"AddNewEmployee(`"+ doc.data()[TUTOR_TUTOR_ID]+"`, `"+
        doc.data()[TUTOR_TUTOR_NAME]+"`, 'Tutor', `"+doc.data()[TUTOR_BANK_NAME]+"`, `"+
        doc.data()[TUTOR_AC_NO]+"`, `"+doc.data()[TUTOR_EPF]+"`, `"+doc.data()[TUTOR_SOCSO]+"`)");
      if (disableSelect)
        sel_btn.setAttribute('disabled', true);

      let sel_div = document.createElement('div');
      sel_div.className = "col-md-2";
      sel_div.appendChild(sel_btn);

      let tutorDetail_div = document.createElement('div');
      tutorDetail_div.className = 'row tutor-wrapper text-center';
      tutorDetail_div.appendChild(imgTop_div);
      tutorDetail_div.appendChild(tutorName_div);
      tutorDetail_div.appendChild(tutorPhone_div);
      tutorDetail_div.appendChild(tutorAge_div);
      tutorDetail_div.appendChild(sel_div);

      const add_tutor_modal_container = document.getElementById("add-tutor-modal-container");
      add_tutor_modal_container.appendChild(tutorDetail_div);

      // add_tutor_modal_container.insertBefore(tutorDetail_div, add_tutor_modal_container.children[1])
    }

    // Load Tutor Settings
    function loadUserSettings(ent_id){

      // Tutor Id must be a phone with +60, no spacing or other chars
      var docRef = db.collection("dev").doc("v2").collection("Financial").doc(ent_id);

      docRef.get().then((doc) => {

        if (doc.exists){

          bizName = (doc.data()[SET_BIZ_NAME] == null || doc.data()[SET_BIZ_NAME] == "") ? current_name : doc.data()[SET_BIZ_NAME];
          bizPhone = (doc.data()[SET_BIZ_PHONE] == null || doc.data()[SET_BIZ_PHONE] == "") ? current_phone : doc.data()[SET_BIZ_PHONE];
          bizEmail = (doc.data()[SET_BIZ_EMAIL] == null || doc.data()[SET_BIZ_EMAIL] == "") ? "" : doc.data()[SET_BIZ_EMAIL];
          bizAddr = (doc.data()[SET_BIZ_ADDR] == null || doc.data()[SET_BIZ_ADDR] == "") ? "" : doc.data()[SET_BIZ_ADDR];
          bizImgUrl = (doc.data()[SET_BIZ_IMG_URL] == null || doc.data()[SET_BIZ_IMG_URL] == "") ? "" : doc.data()[SET_BIZ_IMG_URL];
        }else {
          // If no business details, substitue it with user settings.

          bizName = current_name;
          bizPhone = current_phone;
          bizEmail = "";
          bizAddr = "";
          bizImgUrl = "";
        }


      })
    }

    function AddNewEmployee(tutor_id, name, position, bankName, acNo, epf, socso){

        // Create data modal for Tutor Module
        let payslipData = {
          tutor_id: tutor_id,
          name: name,
          position: position,
          bankName: bankName,
          acNo: acNo,
          epf: epf,
          socso: socso,
          payStatus: PAY_STATUS_NEW,
          title: 'Payslip For The Month Of '+ payrollDateMonth,
          payNo: '-',
          date: payrollDate,

        }

        // Generate placeholder new employee
        renderActiveTutorPlaceholder(payslipData);

        // Generate simple empty payslip
        // renderTableTemplate(tutor_id);

        // Load tutor Active Classes
        let tutorData = {
            tutor_id : tutor_id
        }
        LoadTutorActiveClasses(tutorData);

        // let grossPay = calculateGrossPayDuringInit(tutor_id);
        // // document.getElementById("netpayview_"+cardId).value = netPayTextAdv;
        // console.log('grossPay '+grossPay);
        // calculateNetPayDuringInit(tutor_id, grossPay);


    }


    function test_loadLessonDateRange(){
      new Date();
      let start = new Date('2021-11-04');
      let end = new Date('2021-11-13');

      // this.afs.collection('invoices', ref => ref
      //   .where('dueDate', '>', start)
      //   .where('dueDate', '<', end)
      // );

      let docRef = db.collection("dev")
          .doc("v2")
          .collection("Lesson")
          .where("classId", "==", 'huLBbCGbdRDJmRnxTJGl')
          .where("status", "==", true)
          .where("lesDate", ">", start)
          .where("lesDate", "<", end)
          // .orderBy('lesDate', 'desc')
          // .startAfter(latestLessonDoc || today)
          // .limit(10);

      docRef
      .get()
      .then((querySnapshot) => {
        console.log('Total Lessons Found: '+querySnapshot.docs.length);

        querySnapshot.forEach((doc) => {
          console.log(doc.data());
          // latestLessonDoc = doc.data()[LESSON_DATE];
          // console.log(latestLessonDoc);



        });



      }).catch((error) => {
          console.log("Error getting document:", error);
      });
    }

    function CreatePayroll(){
      // console.log("Payroll period")
      // console.log(payrollStart)
      // console.log(payrollEnd)

      // Check if payroll existed
      var docRef = db.collection("dev")
          .doc("v2")
          .collection("Payroll")
          .where(PAYROLL_ADMIN_ID, '==', ent_id)
          .where(PAYROLL_STATUS, '==', true)
          .where(PAYROLL_DATE_START, '==', payrollStart)
          .where(PAYROLL_DATE_END, '==', payrollEnd)
          // .limit(1);

      docRef
      .get()
      .then((querySnapshot) => {


        if(querySnapshot.empty) {

          console.log("Empty, Create a new payroll");

          var payrollDocRef = db.collection("dev")
            .doc("v2")
            .collection("Payroll")
            .doc();

          payrollId = payrollDocRef.id;

          var data = {
            [PAYROLL_ID]: payrollId,
            [PAYROLL_ADMIN_ID]: ent_id,
            [PAYROLL_NAME]: payrollName,
            [PAYROLL_DATE_START]: payrollStart,
            [PAYROLL_DATE_END]: payrollEnd,
            [PAYROLL_DOC_ID_ARR]: [],
            [PAYROLL_DOC_TOTAL_ARR]: [],
            [PAYROLL_TOTAL]: 0,
            [PAYROLL_STATUS]: true,
          }

          console.log(data);
          payrollDocRef.set(data, { merge: true })
            .then(() => {

              // Load all active tutor
              loadAllTutorInfo();

              // Enable Step 2
              enableStep2();

              func.showNotification('top','center', 'success', 'check_circle', "Created new payroll." );

          });

        }
        else {
          func.showNotification('top','center', 'warning', 'error_outline', "Payroll already existed." );

          querySnapshot.forEach((doc) => {
            console.log("Payroll found");
            // console.log(doc.data()[PAYROLL_NAME]);
            // console.log(doc.data()[PAYROLL_ID]);
            // console.log(doc.data()[PAYROLL_DATE_START].toDate());
            // console.log(doc.data()[PAYROLL_DATE_END].toDate());

            // Get data from payroll
            payrollId = doc.data()[PAYROLL_ID];
            payrollName = doc.data()[PAYROLL_NAME];
            payrollStart = doc.data()[PAYROLL_DATE_START];
            payrollEnd = doc.data()[PAYROLL_DATE_END];
            payrollDocIdArr = doc.data()[PAYROLL_DOC_ID_ARR];
            payrollDocTotalArr = doc.data()[PAYROLL_DOC_TOTAL_ARR];
            payrollTotal = doc.data()[PAYROLL_TOTAL];

            // Load the payslip of each tutor.
            loadAllPayslips(payrollId);

            // Enable Step 2
            enableStep2();


          });
        }

      }).catch((error) => {
          console.log("Error getting document:", error);
      });

    }

    // Payroll found. Load payslips in a payroll.
    function loadAllPayslips(payrollId){

      var docRef = db.collection("dev")
          .doc("v2")
          .collection("Payslip")
          .where(PAY_STATUS, '==', true)
          .where(PAY_PAYROLL_ID, '==', payrollId)
          .orderBy(PAY_RECEIVER_NAME, 'desc') // Sort by Asc of Receiver Name

      docRef
      .get()
      .then((querySnapshot) => {

        querySnapshot.forEach((doc) => {
          console.log("Payslip: ");
          console.log(doc.data());

          // Step 1: Create data modal for Tutor Module
          let payslipData = {
            tutor_id: doc.data()[PAY_RECEIVER_ID],
            name: doc.data()[PAY_RECEIVER_NAME],
            position: 'Tutor',
            bankName: doc.data()[PAY_RECEIVER_BANK_NAME],
            acNo: doc.data()[PAY_RECEIVER_AC_NO],
            epf: doc.data()[PAY_RECEIVER_EPF],
            socso: doc.data()[PAY_RECEIVER_SOCSO],
            payStatus: doc.data()[PAY_PAY_STATUS],
            title: doc.data()[PAY_TITLE],
            payNo:doc.data()[PAY_NUMBER],
            date: convertDate(doc.data()[PAY_DATE].toDate()),
          }

          // Convert firebase timestamp to DD/MM/YYY
          function convertDate(inputFormat) {
            function pad(s) { return (s < 10) ? '0' + s : s; }

            var d = new Date(inputFormat)

            return [pad(d.getDate()), pad(d.getMonth()+1), d.getFullYear()].join('/')
          }

          // Generate placeholder for each active tutor. If exist, ignore.
          renderActiveTutorPlaceholder(payslipData);


          // Step 2: Print Items & Additional Items
          let payslipDataArr = doc.data()[PAY_ITEMS_ARR];
          let itemStartIndex= payslipDataArr.indexOf('ITEM');
          let subtotalStartIndex= payslipDataArr.indexOf('GROSS');
          let additionalItemStartIndex= payslipDataArr.indexOf('ADDITIONAL_ITEM');
          let totalStartIndex= payslipDataArr.indexOf('NET');

          // console.log(itemStartIndex, additionalItemStartIndex, subtotalStartIndex, totalStartIndex)

          let type = payslipDataArr[0];
          let item = payslipDataArr.slice(itemStartIndex+1, subtotalStartIndex); //+1 to ignore the first indentifier
          let subTotal = payslipDataArr[subtotalStartIndex+1];
          let additionalItem = payslipDataArr.slice(additionalItemStartIndex+1, totalStartIndex); //+1 to ignore the first indentifier
          let total = payslipDataArr[totalStartIndex+1];

          let advanced = doc.data()[PAY_ITEMS_ARR][0] === 'ADVANCED';
          let grossPay = 0;

          if (advanced){
            // Generate Advanced empty payslip
            renderTableAdvTemplate(doc.data()[PAY_RECEIVER_ID]);

            // Print Items
            // Advanced Template
            item.reverse().forEach((document) => {
              let component = document.split(";; ");

              let payslipItemData={
                tutor_id: doc.data()[PAY_RECEIVER_ID],
                item: component[0],
                quantity: component[1],
                price: component[2],
                payout: component[3],
              }

              renderAllPayslipItemsAdv(payslipItemData);

            });

            // Print Additional Items
            //.reverse() to make sure we print from the last -> first
            additionalItem.reverse().forEach((document) => {

              let component = document.split(";; ");
              // Generate the additional item
              let payslipItemData={
                tutor_id: doc.data()[PAY_RECEIVER_ID],
                item: component[1],
                quantity: 0,
                price: component[2],
                payout: 0,
                selector: component[0],
              }
              renderAllPayslipAdditionalItemsAdv(payslipItemData);

            });

            // Calculate Gross & Net Pay
            grossPay = calculateGrossPayDuringInit(doc.data()[PAY_RECEIVER_ID]);
            calculateNetPayDuringInit(doc.data()[PAY_RECEIVER_ID], grossPay);

          }
          else{
            // Generate simple empty payslip
            renderTableTemplate(doc.data()[PAY_RECEIVER_ID]);

            // Print Items
            // Simple Template
            item.reverse().forEach((document) => {
              let component = document.split(";; ");

              let payslipItemData={
                tutor_id: doc.data()[PAY_RECEIVER_ID],
                item: component[0],
                quantity: component[1],
                price: component[2],
                payout: component[3],
              }

              console.log(payslipItemData);

              renderAllPayslipItems(payslipItemData);

            });

            // Print Additional Items
            //.reverse() to make sure we print from the last -> first
            additionalItem.reverse().forEach((document) => {

            let component = document.split(";; ");
            // Generate the additional item
            let payslipItemData={
              tutor_id: doc.data()[PAY_RECEIVER_ID],
              item: component[1],
              quantity: 0,
              price: component[2],
              payout: 0,
              selector: component[0],
            }
            renderAllPayslipAdditionalItems(payslipItemData);

            });

            // Calculate Gross & Net Pay
            grossPay = calculateGrossPayDuringInit(doc.data()[PAY_RECEIVER_ID]);
            calculateNetPayDuringInit(doc.data()[PAY_RECEIVER_ID], grossPay);
          }


          // Set the payslip status to true by default
          SetPayslipUpdateStatus(true, doc.data()[PAY_RECEIVER_ID]);

        });

      });

    }

    // Enable Step 1, Disable Step 2
    function enableStep1(){
      // Disabled Step 1
      document.getElementById('btnStep1').className = 'btn btn-primary btn-just-icon btn-round';

      document.getElementById('daterange').removeAttribute('readonly');
      document.getElementById('daterange').style.pointerEvents = 'auto';


      // document.getElementById('btnCreatePayroll').className = 'btn btn-primary btn-round';
      document.getElementById('btnCreatePayroll').classList.add('btn-primary');
      document.getElementById('btnCreatePayroll').classList.remove('btn-default');

      document.getElementById('btnCreatePayroll').style.pointerEvents = 'auto';

      // Enable Step 2
      document.getElementById('btnStep2').className = 'btn btn-default btn-just-icon btn-round';

      document.getElementById('btnAddEmployee').setAttribute('style', 'color: white;');
      // document.getElementById('btnAddEmployee').className = 'btn btn-outline-default btn-round';
      document.getElementById('btnAddEmployee').classList.add('btn-outline-default');
      document.getElementById('btnAddEmployee').classList.remove('btn-outline-primary');
      document.getElementById('btnAddEmployee').style.pointerEvents = 'none';

      // Clear existing payslip item
      let existingCardList = document.getElementById('accordionTutor').querySelectorAll('div.card');
      existingCardList.forEach((row, index) => {
        row.remove();
      })

    }

    // Enable Step 2, Disable Step 1
    function enableStep2(){
      // Disabled Step 1
      document.getElementById('btnStep1').className = 'btn btn-default btn-just-icon btn-round';

      document.getElementById('daterange').setAttribute('readonly', 'true');
      document.getElementById('daterange').style.pointerEvents = 'none';

      // document.getElementById('payrollTitle').setAttribute('readonly', 'true');
      // document.getElementById('payrollTitle').style.pointerEvents = 'none';

      // document.getElementById('btnCreatePayroll').className = 'btn btn-default btn-round';
      document.getElementById('btnCreatePayroll').classList.add('btn-default');
      document.getElementById('btnCreatePayroll').classList.remove('btn-remove');
      document.getElementById('btnCreatePayroll').style.pointerEvents = 'none';

      // Enable Step 2
      document.getElementById('btnStep2').className = 'btn btn-primary btn-just-icon btn-round';

      document.getElementById('btnAddEmployee').setAttribute('style', 'background-color: #2e74b6; color: white;');
      // document.getElementById('btnAddEmployee').className = 'btn btn-outline-primary btn-round';
      document.getElementById('btnAddEmployee').classList.add('btn-outline-primary');
      document.getElementById('btnAddEmployee').classList.remove('btn-outline-default');
      document.getElementById('btnAddEmployee').style.pointerEvents = 'auto';

      // document.getElementById('btnAddAllEmployee').className = 'btn btn-outline-primary btn-round';
      // document.getElementById('btnAddAllEmployee').style.pointerEvents = 'auto';

    }


    var activeTutorList = [];
    var activeClassList = [];
    var activeLessonList = [];
    // Load all active tutor
    function loadAllTutorInfo(){
      activeTutorList = []; // Init list
      let docRef = db.collection("dev")
          .doc("v2")
          .collection("Tutor")
          .where(TUTOR_ADMIN_ID, "==", ent_id)
          .where(TUTOR_STATUS_ADMIN, "==", TUTOR_STATUS_TYPE_ACTIVE)
          .orderBy(TUTOR_TUTOR_NAME, 'desc');

      docRef
      .get()
      .then((querySnapshot) => {

        querySnapshot.forEach((doc) => {


          // Create data modal for Tutor Module
          let payslipData = {
            tutor_id: doc.data()[TUTOR_TUTOR_ID],
            name: doc.data()[TUTOR_TUTOR_NAME],
            position: 'Tutor',
            bankName: doc.data()[TUTOR_BANK_NAME],
            acNo: doc.data()[TUTOR_AC_NO],
            epf: doc.data()[TUTOR_EPF],
            socso: doc.data()[TUTOR_SOCSO],
            payStatus: PAY_STATUS_NEW,
            title: 'Payslip For The Month Of '+ payrollDateMonth,
            payNo: '-',
            date: payrollDate,
          }

          // Generate placeholder for each active tutor. If exist, ignore.
          renderActiveTutorPlaceholder(payslipData);


          // Load all active class.
          activeTutorList.push(doc.data());

          let tutorData = {
            tutor_id : doc.data()[TUTOR_TUTOR_ID]
          }
          LoadTutorActiveClasses(tutorData);
          // console.log('Tutor Name: '+doc.data()[TUTOR_TUTOR_NAME]);

        });

        // console.log(activeTutorList);

      });

    };


    // Load all the active classes of a tutor
    // Doc is Tutor Module document
    function LoadTutorActiveClasses(tutorData) { // tutorDoc){
      // Data Model
      // let tutorData = {
      //   tutor_id : tutor_id,
      // }

      let docRef = db.collection("dev")
        .doc("v2")
        .collection("Class")
        .where(CLASS_ADMIN_ID, "==", ent_id) // Admin ID
        .where(CLASS_TUTOR_ID_ARR, "array-contains", tutorData.tutor_id) // Tutor's Id
        .where("status", "==", true);

      docRef
        .get()
        .then((querySnapshot) => {

          // console.log('Tutor Name: '+tutorDoc.data()[TUTOR_TUTOR_NAME]);
          // Check if there is any 'Per Hour' exist. If yes, use advanced template.
          let advanced = false;
          querySnapshot.forEach((doc) => {

            if (doc.data()[CLASS_FEES_TYPE_KEY] === FEES_TYPE_PER_HOUR_KEY){
              // Per month
              advanced = true;
            }else{
              // Per Hour
            }
          });
          // console.log('Advanced: '+advanced)

          if (advanced){
            // Render Advanced Teamplate for header, gross earnings and headers for additional items
            renderTableAdvTemplate(tutorData.tutor_id);

            // Advanced Template
            querySnapshot.forEach((doc) => {

              if (doc.data()[CLASS_FEES_TYPE_KEY] === FEES_TYPE_PER_MONTH_KEY){

                // Per month
                // tutor_id, className, firstClassDate,
                let payslipItemData={
                  tutor_id: tutorData.tutor_id,
                  item: doc.data()[CLASS_NAME],
                  quantity: '',
                  price: '',
                  payout: '',
                }
                renderAllPayslipItemsAdv(payslipItemData);
              }else{
                // Per Hour
                let classData = {
                  tutor_id: tutorData.tutor_id,
                  classId : doc.data()[CLASS_ID],
                  className : doc.data()[CLASS_NAME],
                  classFee : doc.data()[CLASS_FEES_KEY],
                  classFirstDate : doc.data()[CLASS_FIRST_CLASS_DATE].toDate().toLocaleDateString("en-GB"),
                }

                LoadLessonInfo(classData);

              }

            });
          }
          else{
            // Render Advanced Teamplate for header, gross earnings and headers for additional items
            renderTableTemplate(tutorData.tutor_id);

            // Simple Template
            querySnapshot.forEach((doc) => {
              // console.log('Tutor, Class Name  (Per Month) : '+tutorDoc.data()[TUTOR_TUTOR_NAME]+doc.data()[CLASS_NAME]);
              // console.log(doc.data());

              let payslipItemData={
                tutor_id: tutorData.tutor_id,
                item: doc.data()[CLASS_NAME],
                quantity: '',
                price: 0,
                payout: '',
              }
              renderAllPayslipItems(payslipItemData);
            });
          }

      });

    }

    // Render normal table template
    function renderTableTemplate(cardId){
      // <table id="table_item_wwwwww" class="table-light table-sm" cellspacing="0" width="100%" >
      //   <thead style="background-color: grey; color: white;">
      //     <tr>
      //       <th style="min-width: 200px; font-size: small;">Items</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Amount</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Earning</th>
      //     </tr>
      //   </thead>
      //   <tbody id="previewItemBody">
      //     <tr class="item">
      //       <td style="font-size: small;">Food</td>
      //       <td style="text-align: right; font-size: small;">20</td>
      //       <td style="text-align: right; font-size: small;">RM20</td>
      //     </tr>
      //     <tr class="subtotal" id='gross'>
      //       <td></td>
      //       <td style="text-align: right; font-weight: 500; font-size: small;">Gross Earning</td>
      //       <td style="text-align: right; font-weight: 500; font-size: small;" id="previewSubtotalItem">RM20</td>
      //     </tr>
      //   </tbody>
      // </table>
      // <table id="table_additem_wwwwww" class="table-light table-sm" cellspacing="0" width="100%">
      //   <thead style="visibility: collapse;">
      //     <tr>
      //       <th style="min-width: 200px;">Items</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right;">Earning</th>
      //     </tr>
      //   </thead>
      //   <tbody id="previewAdditionalItemBody">
      //     <tr class="additional">
      //       <td></td>
      //       <td style="text-align: right; font-size: small;">Extra</td>
      //       <td style="text-align: right; font-size: small;">+ RM10</td>
      //     </tr>
      //   </tbody>
      // </table>

      // Item Header
      let thItem1 = document.createElement('th');
      thItem1.setAttribute('style', 'min-width: 200px; font-size: small;');
      thItem1.textContent = 'Items';
      let thItem2 = document.createElement('th');
      thItem2.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;');
      thItem2.textContent = 'Amount';
      let thItem3 = document.createElement('th');
      thItem3.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;');
      thItem3.textContent = 'Earning';

      let thItemHeader = document.createElement('tr');
      thItemHeader.appendChild(thItem1);
      thItemHeader.appendChild(thItem2);
      thItemHeader.appendChild(thItem3);

      const theadItemHeader = document.getElementById("thead_item_"+cardId);
      theadItemHeader.appendChild(thItemHeader);

      // Item Gross Earning (subtotal)
      let grossItem1 = document.createElement('td');
      let grossItem2 = document.createElement('td');
      grossItem2.setAttribute('style', 'text-align: right; font-weight: 500; font-size: small;');
      grossItem2.textContent = 'Gross Pay';
      let grossItem3 = document.createElement('td');
      grossItem3.id = 'grosspay_' + cardId;
      grossItem3.setAttribute('style', 'text-align: right; font-weight: 500; font-size: small;');
      grossItem3.textContent = 'RM0.00';

      let grossItem = document.createElement('tr');
      grossItem.className = 'subtotal';
      grossItem.appendChild(grossItem1);
      grossItem.appendChild(grossItem2);
      grossItem.appendChild(grossItem3);

      const tbodyItem = document.getElementById("tbody_item_"+cardId);
      tbodyItem.appendChild(grossItem);

      // Additional Header
      let thAddItem1 = document.createElement('th');
      thAddItem1.setAttribute('style', 'min-width: 200px;');
      thAddItem1.textContent = 'Items';
      let thAddItem2 = document.createElement('th');
      thAddItem2.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right;');
      thAddItem2.textContent = 'Amount';
      let thAddItem3 = document.createElement('th');
      thAddItem3.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right;');
      thAddItem3.textContent = 'Earning';

      let thAddItemHeader = document.createElement('tr');
      thAddItemHeader.setAttribute('style', 'visibility: collapse');
      thAddItemHeader.appendChild(thAddItem1);
      thAddItemHeader.appendChild(thAddItem2);
      thAddItemHeader.appendChild(thAddItem3);

      const theadAddItemHeader = document.getElementById("thead_additem_"+cardId);
      theadAddItemHeader.appendChild(thAddItemHeader);

    }

    // Render advanced table template
    function renderTableAdvTemplate(cardId){
     // <table id="table_item_wwwwww" class="table-light table-sm" cellspacing="0" width="100%" >
      //   <thead style="background-color: grey; color: white;">
      //     <tr> (...start)
      //       <th style="min-width: 200px; font-size: small;">Items</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Quantity*</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Amount</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Payout</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Earning</th>
      //     </tr> (end ...)
      //   </thead>
      //   <tbody id="previewItemBody">
      //     <tr class="item">
      //       <td style="font-size: small;">Standard 3 English</td>
      //       <td style="text-align: right; font-size: small;">1</td>
      //       <td style="text-align: right; font-size: small;">100</td>
      //       <td style="text-align: right; font-size: small;">100</td>
      //       <td style="text-align: right; font-size: small;">RM100</td>
      //     </tr>
      //     <tr class="subtotal" id='previewItemSubtotal'> (...start)
      //       <td></td>
      //       <td></td>
      //       <td></td>
      //       <td style="text-align: right; font-weight: 500; font-size: small;">Gross Earning</td>
      //       <td style="text-align: right; font-weight: 500; font-size: small;" id="previewSubtotalItem">RM100</td>
      //     </tr> (end ...)
      //   </tbody>
      // </table>
      // <table id="table_additem_wwwwww" class="table-light table-sm" cellspacing="0" width="100%">
      //   <thead style="visibility: collapse;">
      //     <tr> (...start)
      //       <th style="min-width: 200px;">Items</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right;">Quantity</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right;">Price</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right;">Payout</th>
      //       <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
      //     </tr> (end ...)
      //   </thead>
      //   <tbody id="previewAdditionalItemBody">
      //     <tr class="additional">
      //       <td></td>
      //       <td></td>
      //       <td></td>
      //       <td style="text-align: right; font-size: small;">Extra Cash</td>
      //       <td style="text-align: right; font-size: small;">+ RM10</td>
      //     </tr>
      //   </tbody>
      // </table>
      // Item Header
      let thItem1 = document.createElement('th');
      thItem1.setAttribute('style', 'min-width: 200px; font-size: small;');
      thItem1.textContent = 'Items';
      let thItem2 = document.createElement('th');
      thItem2.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;');
      thItem2.textContent = 'Quantity';
      let thItem3 = document.createElement('th');
      thItem3.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;');
      thItem3.textContent = 'Amount';
      let thItem4 = document.createElement('th');
      thItem4.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;');
      thItem4.textContent = 'Payout (%)';
      let thItem5 = document.createElement('th');
      thItem5.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;');
      thItem5.textContent = 'Earning';

      let thItemHeader = document.createElement('tr');
      thItemHeader.appendChild(thItem1);
      thItemHeader.appendChild(thItem2);
      thItemHeader.appendChild(thItem3);
      thItemHeader.appendChild(thItem4);
      thItemHeader.appendChild(thItem5);

      const theadItemHeader = document.getElementById("thead_item_"+cardId);
      theadItemHeader.appendChild(thItemHeader);

      // Item Gross Earning (subtotal)
      let grossItem1 = document.createElement('td');
      let grossItem2 = document.createElement('td');
      let grossItem3 = document.createElement('td');
      let grossItem4 = document.createElement('td');
      grossItem4.setAttribute('style', 'text-align: right; font-weight: 500; font-size: small;');
      grossItem4.textContent = 'Gross Pay';
      let grossItem5 = document.createElement('td');
      grossItem5.id = 'grosspay_' +cardId;
      grossItem5.setAttribute('style', 'text-align: right; font-weight: 500; font-size: small;');
      grossItem5.textContent = 'RM0.00';

      let grossItem = document.createElement('tr');
      grossItem.className = 'subtotal';
      grossItem.appendChild(grossItem1);
      grossItem.appendChild(grossItem2);
      grossItem.appendChild(grossItem3);
      grossItem.appendChild(grossItem4);
      grossItem.appendChild(grossItem5);

      const tbodyItem = document.getElementById("tbody_item_"+cardId);
      tbodyItem.appendChild(grossItem);

      // Additional Header
      let thAddItem1 = document.createElement('th');
      thAddItem1.setAttribute('style', 'min-width: 200px;');
      thAddItem1.textContent = 'Items';
      let thAddItem2 = document.createElement('th');
      thAddItem2.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right;');
      thAddItem2.textContent = 'Quantity';
      let thAddItem3 = document.createElement('th');
      thAddItem3.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right;');
      thAddItem3.textContent = 'Amount';
      let thAddItem4 = document.createElement('th');
      thAddItem4.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right;');
      thAddItem4.textContent = 'Payout (%)';
      let thAddItem5 = document.createElement('th');
      thAddItem5.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right;');
      thAddItem5.textContent = 'Earning';

      let thAddItemHeader = document.createElement('tr');
      thAddItemHeader.setAttribute('style', 'visibility: collapse')
      thAddItemHeader.appendChild(thAddItem1);
      thAddItemHeader.appendChild(thAddItem2);
      thAddItemHeader.appendChild(thAddItem3);
      thAddItemHeader.appendChild(thAddItem4);
      thAddItemHeader.appendChild(thAddItem5);

      const theadAddItemHeader = document.getElementById("thead_additem_"+cardId);
      theadAddItemHeader.appendChild(thAddItemHeader);

    }

    function renderAllPayslipItems(data){
      //   <tbody id="tbody_item_<id>">
      //     <tr class="item">
      //       <td style="font-size: small;">Food</td>
      //       <td style="text-align: right; font-size: small;">20</td>
      //       <td style="text-align: right; font-size: small;">RM20</td>
      //     </tr>
      //     <tr class="subtotal" id='gross'>
      //       ....
      //     </tr>

      // Item
      let item1 = document.createElement('td');
      item1.setAttribute('style', 'min-width: 200px; font-size: small; font-weight: 300');
      item1.textContent = data.item;
      let item2 = document.createElement('td');
      item2.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item2.textContent = data.price;
      let item3 = document.createElement('td');
      item3.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item3.textContent = '';

      let item = document.createElement('tr');
      item.className = 'item'
      item.appendChild(item1);
      item.appendChild(item2);
      item.appendChild(item3);

      const tritem = document.getElementById("tbody_item_"+data.tutor_id);
      tritem.insertBefore(item, tritem.children[0])

      // tritem.appendChild(item);
    }


    function renderAllPayslipItemsAdv(data){
      //   <tbody id="previewItemBody">
      //     <tr class="item">
      //       <td style="font-size: small;">Standard 3 English</td>
      //       <td style="text-align: right; font-size: small;">1</td>
      //       <td style="text-align: right; font-size: small;">100</td>
      //       <td style="text-align: right; font-size: small;">100</td>
      //       <td style="text-align: right; font-size: small;">RM100</td>
      //     </tr>
      //     ....

      //  data={
      //   tutor_id: tutor_id,
      //   item: item,  // Shared between items and additional items
      //   quantity: '',
      //   price: 0, // Shared between items and additional items
      //   payout: '',
      //   selector: '', // Used for add items
      // }

      // Item
      let item1 = document.createElement('td');
      item1.setAttribute('style', 'min-width: 200px; font-size: small; font-weight: 300');
      // let firstClassDate_temp = (data.firstClassDate == null || data.firstClassDate == '') ? '' : '(First lesson: '+data.firstClassDate+')';
      item1.textContent = data.item; // + ' '+firstClassDate_temp;
      let item2 = document.createElement('td');
      item2.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item2.textContent = (data.quantity == null || data.quantity == "") ? "" : data.quantity;
      let item3 = document.createElement('td');
      item3.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item3.textContent = (data.price == null || data.price == "") ? "" : data.price;
      let item4 = document.createElement('td');
      item4.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item4.textContent = (data.payout == null || data.payout == "") ? "" : data.payout;
      let item5 = document.createElement('td');
      item5.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item5.textContent = '';

      let item = document.createElement('tr');
      item.className = 'item'
      item.appendChild(item1);
      item.appendChild(item2);
      item.appendChild(item3);
      item.appendChild(item4);
      item.appendChild(item5);

      const tritem = document.getElementById("tbody_item_"+data.tutor_id);
      tritem.insertBefore(item, tritem.children[0]);
      // tritem.appendChild(item);

    }

    // Render additional items for adv table
    function renderAllPayslipAdditionalItems(data){
      // <tbody id="tbody_additem_wwwwww">
      //   <tr class="additional">
      //     <td></td>
      //     <td style="text-align: right; font-size: small;" data-selector='Earning ( + )' data-item='Extra Cash' data-value='10'>Extra Cash</td>
      //     <td style="text-align: right; font-size: small;">+ RM10</td>
      //   </tr>
      // </tbody>

      //  data={
      //   tutor_id: tutor_id,
      //   item: item,  // Shared between items and additional items
      //   quantity: '',
      //   price: 0, // Shared between items and additional items
      //   payout: '',
      //   selector: '', // Used for add items
      // }

      // Item
      let item1 = document.createElement('td');
      let item2 = document.createElement('td');
      let item3 = document.createElement('td');
      let item4 = document.createElement('td');
      item4.setAttribute('style', 'text-align: right; font-size: small;');
      item4.setAttribute('data-selector', data.selector );
      item4.setAttribute('data-item', data.item);
      item4.setAttribute('data-value', data.price);
      item4.textContent = data.item;
      let item5 = document.createElement('td');
      item5.setAttribute('style', 'text-align: right; font-size: small;');
      item5.textContent = '';

      let item = document.createElement('tr');
      item.className = 'additional'
      // item.appendChild(item1);
      // item.appendChild(item2);
      item.appendChild(item3);
      item.appendChild(item4);
      item.appendChild(item5);

      const trAddItem = document.getElementById("tbody_additem_"+data.tutor_id);
      trAddItem.insertBefore(item, trAddItem.children[0])

      // tritem.appendChild(item);
    }

    // Render additional items for adv table
    function renderAllPayslipAdditionalItemsAdv(data){
      // <tbody id="tbody_additem_wwwwww">
      //   <tr class="additional">
      //     <td></td>
      //     <td></td>
      //     <td></td>
      //     <td style="text-align: right; font-size: small;" data-selector='Earning ( + )' data-item='Extra Cash' data-value='10'>Extra Cash</td>
      //     <td style="text-align: right; font-size: small;">+ RM10</td>
      //   </tr>
      // </tbody>

      //  data={
      //   tutor_id: tutor_id,
      //   item: item,  // Shared between items and additional items
      //   quantity: '',
      //   price: 0, // Shared between items and additional items
      //   payout: '',
      //   selector: '', // Used for add items
      // }

      // Item
      let item1 = document.createElement('td');
      // item1.setAttribute('style', 'min-width: 200px; font-size: small; font-weight: 300');
      // item1.textContent = data.item;
      let item2 = document.createElement('td');
      // item2.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      // item2.textContent = data.quantity;
      let item3 = document.createElement('td');
      // item3.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      // item3.textContent = data.price;
      let item4 = document.createElement('td');
      item4.setAttribute('style', 'text-align: right; font-size: small;');
      item4.setAttribute('data-selector', data.selector );
      item4.setAttribute('data-item', data.item);
      item4.setAttribute('data-value', data.price);
      item4.textContent = data.item;
      let item5 = document.createElement('td');
      item5.setAttribute('style', 'text-align: right; font-size: small;');
      item5.textContent = '';

      let item = document.createElement('tr');
      item.className = 'additional'
      item.appendChild(item1);
      item.appendChild(item2);
      item.appendChild(item3);
      item.appendChild(item4);
      item.appendChild(item5);

      const trAddItemAdv = document.getElementById("tbody_additem_"+data.tutor_id);
      trAddItemAdv.insertBefore(item, trAddItemAdv.children[0]);
      // tritem.appendChild(item);

    }


    // Doc is Class Module document
    function LoadLessonInfo(classData) {
      // Data Model
      // classData = {
      //   tutor_id : tutor_id,
      //   classId : classId,
      //   className : className,
      //   classFee : classFee,
      //   classFirstDate : classFirstDate,
      // }

      // console.log(classDoc.data())
      // let start = new Date('2021-11-04');
      // let end = new Date('2021-11-13');
      // payrollStart = new Date(start);
      // payrollEnd = new Date(end);
      console.log(payrollStart)
      console.log(payrollEnd)
      console.log(classData.classId )

      let docRef = db.collection("dev")
          .doc("v2")
          .collection("Lesson")
          .where("classId", "==", classData.classId)
          .where("status", "==", true)
          .where("lesDate", ">=", payrollStart)
          .where("lesDate", "<=", payrollEnd)
          // .orderBy('lesDate', 'desc')
          // .startAfter(latestLessonDoc || today)
          // .limit(10);

      docRef
      .get()
      .then((querySnapshot) => {
        // console.log('Tutor, Class Name  (Per Month) : '+tutorDoc.data()[TUTOR_TUTOR_NAME]+classDoc.data()[CLASS_NAME]);

        querySnapshot.forEach((doc) => {
          // console.log(doc.data()[LESSON_DATE]);
          // latestLessonDoc = doc.data()[LESSON_DATE];

          console.log('Lesson Date: '+doc.data()[LESSON_DATE].toDate().toLocaleDateString("en-GB"));

          let lesItemData = {
            tutor_id : classData.tutor_id,
            lesDate : doc.data()[LESSON_DATE].toDate().toLocaleDateString("en-GB"),
            lesStart : doc.data()[LESSON_START],
            lesEnd : doc.data()[LESSON_END],
            classFee : classData.classFee,
          }
          renderAllLessonAdv(lesItemData);

        });

        // Per Hour: Show the first class date so it easier to assign payout percentage.
        let payslipItemData={
          tutor_id: classData.tutor_id,
          item: classData.className + ' (First lesson: '+classData.classFirstDate+')',
          quantity: '',
          price: '',
          payout: '',
        }
        renderAllPayslipItemsAdv(payslipItemData);

        calculateGrossPayDuringInit(classData.tutor_id);


      }).catch((error) => {
          console.log("Error getting document:", error);
      });


    }

    function renderAllLessonAdv(lesItemData){ //, tutorDoc, classDoc, lessonDoc){
      //   <tbody id="">
      //     <tr class="item">
      //       <td style="font-size: small;">Standard 3 English</td>
      //       <td style="text-align: right; font-size: small;">1</td>
      //       <td style="text-align: right; font-size: small;">100</td>
      //       <td style="text-align: right; font-size: small;">100</td>
      //       <td style="text-align: right; font-size: small;">RM100</td>
      //     </tr>
      //     ....

      // Data model
      // lesItemData = {
      //   tutor_id : tutor_id,
      //   lesDate : lesDate,
      //   lesStart : lesStart,
      //   lesEnd : lesEnd,
      //   classFee : classFee,
      // }

      // Item
      let date = lesItemData.lesDate; //lessonDoc.data()[LESSON_DATE].toDate().toLocaleDateString("en-GB");
      let startTime, endTime = '';
      let timeslot = '';
      startTime = lesItemData.lesStart;// lessonDoc.data()[LESSON_START];
      endTime = lesItemData.lesEnd;// lessonDoc.data()[LESSON_END];
      startTime = tConvert (startTime);
      endTime = tConvert (endTime);
      // startTime = (parseInt(startTime.substring(0, 2))>12) ? (parseInt(startTime.substring(0, 2)) - 12) + startTime.substring(2, 5) + 'PM' : startTime + 'AM';
      // endTime = (parseInt(endTime.substring(0, 2))>12) ? (parseInt(endTime.substring(0, 2)) - 12) + endTime.substring(2, 5) + 'PM' : endTime + 'AM';
      timeslot = '  -  Lesson on '+ date+ ', '+startTime+'-'+endTime;

      let item1 = document.createElement('td');
      item1.setAttribute('style', 'min-width: 200px; font-size: small; font-weight: 300');
      item1.textContent = timeslot

      //create date format
      var timeStart = new Date("01/01/2007 " + lesItemData.lesStart);
      var timeEnd = new Date("01/01/2007 " + lesItemData.lesEnd);
      let timeEllapsed = (timeEnd - timeStart)/1000/60/60; // Convert from ms to Hour
      let quantity = isNaN(timeEllapsed) ? 1 : timeEllapsed;

      let item2 = document.createElement('td');
      item2.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item2.textContent = quantity;

      let classFee = isNaN(lesItemData.classFee) ? 0 : lesItemData.classFee;
      let item3 = document.createElement('td');
      item3.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item3.textContent = classFee;

      let payout = 100;
      let item4 = document.createElement('td');
      item4.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item4.textContent = payout;

      let earning = quantity * classFee * payout / 100;

      let earningText = (earning >= 0) ? 'RM'+earning.toFixed(2) : '- RM'+ Math.abs(earning).toFixed(2)

      let item5 = document.createElement('td');
      item5.setAttribute('style', 'width: 100px; min-width: 100px;text-align: right; font-size: small;font-weight: 300');
      item5.textContent = earningText;


      let item = document.createElement('tr');
      item.className = 'item'
      item.appendChild(item1);
      item.appendChild(item2);
      item.appendChild(item3);
      item.appendChild(item4);
      item.appendChild(item5);

      const tritem = document.getElementById("tbody_item_"+lesItemData.tutor_id);
      tritem.insertBefore(item, tritem.children[0])
    }

    // Render placeholder for active tutor
    function renderActiveTutorPlaceholder(payslipData){

      // Date model for payslip (Tutor Module)
      // payslipData = {
      //   tutor_id: tutor_id,
      //   name: tutorName,
      //   position: position,
      //   bankName: bankName,
      //   acNo: acNo,
      //   epf: epf,
      //   socso: socso,
      //   payStatus: new / paid,
      // }

      // <div class="card" id='wwwwww'>
      //   <div class="card-header" id="headingOne" style="padding: 0; margin: 0; ">
      //     <div class="row" >
      //       <div class="col-md-11">
      //         <a class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse1" aria-expanded="false" aria-controls="collapseOne" style="text-transform: none; white-space: normal; font-size: medium;">
      //           Aishah Aishah Aishah Aishah &middot; <span id="netpayview_wwwwwww">RM1028.70</span>
      //         </a>
      //       </div>
      //       <div class="col-md-1 align-self-center text-center">
      //         <i class="far fa-check-circle fa-lg" style="color: #42ba96; cursor: pointer; margin-right: 0.5rem;" data-target="#confirmEmployeeModal" data-toggle="modal" data-employeecardid="wwwwww" data-employeecardname="aishas"></i>
      //         <i class="fas fa-minus-circle" style="color: red; cursor: pointer;" data-target="#removeEmployeeModal" data-toggle="modal" data-employeecardid="wwwwww" data-employeecardname="aishas"></i>
      //       </div>
      //     </div>
      //   </div>
      //   <div id="collapse1" class="collapse" aria-labelledby="headingOne" data-parent="#accordionTutor" style="padding: 0; margin: 0; ">
      //     <div class="card-body">
      //       <!-- Buttons -->
      //       <div class="row">
      //         <div class="col-12">
      //           <div class="row d-flex" id="desciption-row" >
      //             <div class="ml-auto p-2">
      //               <button href="javascript:;" class="btn btn-primary btn-round" data-toggle="modal" data-target="#previewModal" onclick=""> <i class="fas fa-eye" style="margin-right: 0.5rem;"></i> Preview</button>
      //             </div>
      //             <div class="p-2">
      //               <button href="javascript:;" class="btn btn-primary btn-round" data-toggle="modal" data-target="#editPayslipModal" onclick=""> <i class="fas fa-pen-square" style="margin-right: 0.5rem;"></i> Edit</button>
      //             </div>
      //           </div>
      //         </div>
      //       </div>
      //       <!-- Payslip item preview -->
      //       <div class="row">
      //         <div class="col-12"  style="overflow-x:auto;">
      //           <span class="" style="font-size: x-small; font-weight: 300; color: gray; margin-bottom: 0;">Note*: Quantity - Number of hour of lessons conducted, number of classes, or relevant other items</span>
      //           <table id="table_item_wwwwww" class="table-light table-sm" cellspacing="0" width="100%" >
      //             <thead style="background-color: grey; color: white;">
      //               <tr>
      //                 <th style="min-width: 200px; font-size: small;">Items</th>
      //                 <th style="width: 100px; min-width: 100px; text-align: right; font-size: small;">Quantity*</th>
      //                 <th style="width: 100px; min-width: 100px; text-align: right; font-size: small;">Amount</th>
      //                 <th style="width: 100px; min-width: 100px; text-align: right; font-size: small;">Payout</th>
      //                 <th style="width: 100px; min-width: 100px; text-align: right; font-size: small;">Earning</th>
      //               </tr>
      //             </thead>
      //             <tbody id="previewItemBody">
      //               <tr class="item">
      //                 <td style="font-size: small;">Standard 3 English</td>
      //                 <td style="text-align: right; font-size: small;">1</td>
      //                 <td style="text-align: right; font-size: small;">100</td>
      //                 <td style="text-align: right; font-size: small;">100</td>
      //                 <td style="text-align: right; font-size: small;">RM100</td>
      //               </tr>
      //               <tr class="subtotal" id='previewItemSubtotal'>
      //                 <td></td>
      //                 <td></td>
      //                 <td></td>
      //                 <td style="text-align: right; font-weight: 500; font-size: small;">Gross Earning</td>
      //                 <td style="text-align: right; font-weight: 500; font-size: small;" id="previewSubtotalItem">RM100</td>
      //               </tr>
      //             </tbody>
      //           </table>
      //           <table id="table_additem_wwwwww" class="table-light table-sm" cellspacing="0" width="100%">
      //             <thead style="visibility: collapse;">
      //               <tr>
      //                 <th style="min-width: 200px;">Items</th>
      //                 <th style="width: 100px; min-width: 100px;text-align: right;">Quantity</th>
      //                 <th style="width: 100px; min-width: 100px;text-align: right;">Price</th>
      //                 <th style="width: 100px; min-width: 100px;text-align: right;">Payout</th>
      //                 <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
      //               </tr>
      //             </thead>
      //             <tbody id="previewAdditionalItemBody">
      //               <tr class="additional">
      //                 <td></td>
      //                 <td></td>
      //                 <td></td>
      //                 <td style="text-align: right; font-size: small;">Extra Cash</td>
      //                 <td style="text-align: right; font-size: small;">+ RM10</td>
      //               </tr>
      //             </tbody>
      //           </table>
      //         </div>
      //         <div class="col-12">
      //           <h4 style="text-align: right; font-weight: 500;">Net Pay <span style="margin-left: 2rem;" id="previewGrandTotal">RM100.00</span></h4>
      //         </div>
      //       </div>
      //       <div class="row">
      //         <div class="col-md-4">
      //           <h5>General</h5>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payslip Title</span>
      //               <p id="employee_title_[id]">Payslip of November</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payslip No</span>
      //               <p id="employee_ref_[id]">PV9128391890</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Date</span>
      //               <p id="employee_date_[id]">12/2/2021</p>
      //             </div>
      //           </div>
      //         </div>
      //         <div class="col-md-4">
      //           <h5>Employee Details</h5>
      //           <div id='employeeid' value=''></div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Name</span>
      //               <p id="employee_name_[id]">Alric Liew</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Position</span>
      //               <p id="employee_position_[id]">Tutor</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">EPF No</span>
      //               <p id="employee_epf_[id]">8946146465</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Socso No</span>
      //               <p id="employee_socso_[id]">64631894616584</p>
      //             </div>
      //           </div>
      //         </div>
      //         <div class="col-md-4">
      //           <h5>Banking Information</h5>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Name</span>
      //               <p id="employee_bank_name_[id]">CIMB Bank</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Account Number</span>
      //               <p id="employee_account_num_[id]">98s5ew5xdfle</p>
      //             </div>
      //           </div>
      //         </div>
      //       </div>
      //     </div>
      //   </div>
      // </div>

      let collapseBtn_html = '';
      if (payslipData.payStatus === PAY_STATUS_PAID)
        collapseBtn_html = payslipData.name + " &middot; <span id='netpayview_"+payslipData.tutor_id+"'></span> <span class='card-student-status-label active' id='paystatus_"+payslipData.tutor_id+"' style='font-size: small; visibility: visible'>Paid</span>";
      else
        collapseBtn_html = payslipData.name + " &middot; <span id='netpayview_"+payslipData.tutor_id+"'></span> <span class='card-student-status-label passive' id='paystatus_"+payslipData.tutor_id+"' style='font-size: small; visibility: hidden'>New</span>";

      let collapseBtn = document.createElement('a');
      collapseBtn.innerHTML = collapseBtn_html;
      collapseBtn.className = 'btn btn-link btn-block text-left';
      collapseBtn.type = 'button';
      collapseBtn.setAttribute('style', 'text-transform: none; white-space: normal; font-size: medium;');
      collapseBtn.setAttribute('data-toggle','collapse');
      collapseBtn.setAttribute('data-target','#collapse_'+payslipData.tutor_id);
      collapseBtn.setAttribute('aria-expanded','false');
      collapseBtn.setAttribute('aria-controls','collapse_'+payslipData.tutor_id);
      collapseBtn.setAttribute('perm','fin-payslip-view');
      let collapseBtnDiv = document.createElement('div');
      collapseBtnDiv.className = 'col-md-10';
      collapseBtnDiv.appendChild(collapseBtn);

      recordPaymentBtn_html = "<span class='fa-stack' style='vertical-align: top; font-size: 73%; color: #2e74b6; cursor: pointer; margin-right: 0.5rem;' data-target='#recordPaymentModal' data-toggle='modal' data-employeecardid='"+payslipData.tutor_id+"' data-employeecardname='"+payslipData.name+"'><i class='fas fa-circle fa-stack-2x'></i><i class='fas fa-pen fa-stack-1x fa-inverse'></i></span>";
      confirmBtn_html = `<i class='far fa-check-circle fa-lg hidden' name='update' style='color: #42ba96; cursor: pointer; margin-right: 0.5rem; ' data-target='#confirmEmployeeModal' data-toggle='modal' data-employeecardid='`+payslipData.tutor_id+`' data-employeecardname='`+payslipData.name+`' perm='fin-payslip-edit'></i>`;
      deleteBtn_html = `<i class='fas fa-minus-circle fa-lg hidden' name='remove' style='color: red; cursor: pointer;'' data-target='#removeEmployeeModal' data-toggle='modal' data-employeecardid='`+payslipData.tutor_id+`' data-employeecardname='`+payslipData.name+`' perm='fin-payslip-del'></i>`;
      deleteBtnDiv = document.createElement('div');
      deleteBtnDiv.className = 'col-md-2 align-self-center text-center';
      deleteBtnDiv.innerHTML = confirmBtn_html + deleteBtn_html;

      collapseDiv = document.createElement('div');
      collapseDiv.className = 'row';
      collapseDiv.appendChild(collapseBtnDiv);
      collapseDiv.appendChild(deleteBtnDiv);
      collapseDiv.appendChild(deleteBtnDiv);

      cardHeaderDiv = document.createElement('div');
      cardHeaderDiv.className = 'card-header';
      cardHeaderDiv.id = 'heading_'+payslipData.tutor_id;
      cardHeaderDiv.setAttribute('style', 'padding: 0; margin: 0;')
      cardHeaderDiv.appendChild(collapseDiv);

      // Body
      // TODO: Add the body item
      // previewBtn_html = "<i class='fas fa-eye' style='margin-right: 0.5rem;'></i> Preview";
      previewBtn_html = "Preview";
      previewBtn = document.createElement('button');
      previewBtn.innerHTML = previewBtn_html;
      previewBtn.setAttribute('class', 'btn btn-primary btn-round btn-sm');
      previewBtn.setAttribute('href', 'javascript:;');
      previewBtn.setAttribute('data-toggle', 'modal');
      previewBtn.setAttribute('data-target', '#previewModal');
      previewBtn.setAttribute('data-cardid', payslipData.tutor_id);
      previewBtn.setAttribute('onclick', "appendModal('previewModal')");
      previewBtnDiv = document.createElement('div');
      // previewBtnDiv.className = 'ml-auto p-2';
      previewBtnDiv.className = 'p-2';
      previewBtnDiv.setAttribute('style', 'margin-left:0; margin-right:5px; padding-right:0!important;');
      previewBtnDiv.appendChild(previewBtn);

      // editBtn_html = "<i class='fas fa-pen-square' style='margin-right: 0.5rem;'></i> Edit";
      editBtn_html = "Edit";
      editBtn = document.createElement('button');
      editBtn.innerHTML = editBtn_html;
      editBtn.setAttribute('class', 'btn btn-primary btn-round btn-sm hidden');
      editBtn.setAttribute('href', 'javascript:;');
      editBtn.setAttribute('data-toggle', 'modal');
      editBtn.setAttribute('data-target', '#editPayslipModal');
      editBtn.setAttribute('data-cardid', payslipData.tutor_id);
      editBtn.setAttribute('onclick', "appendModal('editPayslipModal')")
      editBtn.setAttribute('perm', "fin-payslip-edit");
      editBtnDiv = document.createElement('div');
      editBtnDiv.className = 'p-2'
      editBtnDiv.setAttribute('style', 'margin-left:0; margin-right:5px; padding-left:0!important; padding-right:0!important;');
      editBtnDiv.appendChild(editBtn);

      btnDiv = document.createElement('div');
      btnDiv.className = 'row d-flex';
      btnDiv.appendChild(previewBtnDiv);
      btnDiv.appendChild(editBtnDiv);

      // Table Items
      theadItem = document.createElement('thead');
      theadItem.id = 'thead_item_'+payslipData.tutor_id;
      theadItem.setAttribute('style', 'background-color: grey; color: white;');
      // Append header based on criteria

      tbodyItem = document.createElement('tbody');
      tbodyItem.id = 'tbody_item_'+payslipData.tutor_id;
      // Append body based on criteria

      tableItem = document.createElement('table');
      tableItem.id = 'table_item_'+payslipData.tutor_id;
      tableItem.className = 'table-light table-sm';
      tableItem.setAttribute('cellspacing', '0');
      tableItem.setAttribute('width', '100%');
      tableItem.appendChild(theadItem);
      tableItem.appendChild(tbodyItem);

      // Table Additional Items
      theadAddItem = document.createElement('thead');
      theadAddItem.id = 'thead_additem_'+payslipData.tutor_id;
      theadAddItem.setAttribute('style', 'visibility: collapse;');
      // Append header based on criteria

      tbodyAddItem = document.createElement('tbody');
      tbodyAddItem.id = 'tbody_additem_'+payslipData.tutor_id;
      // Append body based on criteria

      tableAddItem = document.createElement('table');
      tableAddItem.id = 'table_additem_'+payslipData.tutor_id;
      tableAddItem.className = 'table-light table-sm';
      tableAddItem.setAttribute('cellspacing', '0');
      tableAddItem.setAttribute('width', '100%');
      tableAddItem.appendChild(theadAddItem);
      tableAddItem.appendChild(tbodyAddItem);

      tableSpan = document.createElement('span');
      tableSpan.textContent = 'Note*: Quantity - Number of hour of lessons conducted, number of classes, or relevant other items';
      tableSpan.setAttribute('style', 'font-size: x-small; font-weight: 300; color: gray; margin-bottom: 0;');

      // Table Wrapper
      tableOverflow = document.createElement('div');
      tableOverflow.className = 'col-12';
      tableOverflow.setAttribute('style', 'overflow-x:auto;');
      tableOverflow.appendChild(tableSpan);
      tableOverflow.appendChild(tableItem);
      tableOverflow.appendChild(tableAddItem);

      NetPay_html = "Net Pay <span style='margin-left: 2rem;'' id='netpay_"+payslipData.tutor_id+"'>RM0.00</span>";
      NetPayH4 = document.createElement('h4');
      NetPayH4.innerHTML = NetPay_html;
      NetPayH4.setAttribute('style', 'text-align: right; font-weight: 500;');
      tableNetPay = document.createElement('div');
      tableNetPay.className = 'col-12';
      tableNetPay.appendChild(NetPayH4);

      tableTop = document.createElement('div');
      tableTop.className = 'row';
      tableTop.appendChild(tableOverflow);
      tableTop.appendChild(tableNetPay);



      // <div class="row"  style="margin-top: 1rem">
      //   <div class="col-md-12 text-right">
      //     <button href="javascript:;" class="btn btn-primary btn-round" data-toggle="modal" data-target="#editPayslipEmployeeModal" data-cardid='wwwwww'> <i class="fas fa-pen-square" style="margin-right: 0.5rem;"></i> Edit Details</button>
      //   </div>
      // </div>

      // editDetailsBtn_html = "<i class='fas fa-pen-square' style='margin-right: 0.5rem;'></i> Edit Details";
      editDetailsBtn_html = "Edit Details";
      editDetailsBtn = document.createElement('button');
      editDetailsBtn.innerHTML = editDetailsBtn_html;
      editDetailsBtn.setAttribute('class', 'btn btn-primary btn-round btn-sm hidden');
      editDetailsBtn.setAttribute('href', 'javascript:;');
      editDetailsBtn.setAttribute('data-toggle', 'modal');
      editDetailsBtn.setAttribute('data-target', '#editPayslipEmployeeModal');
      editDetailsBtn.setAttribute('data-cardid', payslipData.tutor_id);
      editDetailsBtn.setAttribute('perm', "fin-payslip-edit");
      editDetailsBtnDiv = document.createElement('div');
      // editDetailsBtnDiv.className = 'col-md-12 text-right';
      editDetailsBtnDiv.className = 'col-md-12';

      editDetailsBtnDiv.appendChild(editDetailsBtn);

      editDetailsBtnTopDiv  = document.createElement('div');
      editDetailsBtnTopDiv.className = 'row';
      editDetailsBtnTopDiv.setAttribute('style', 'margin-top: 1rem');
      editDetailsBtnTopDiv.appendChild(editDetailsBtnDiv);

      //       <div class="row">
      //         <div class="col-md-4">
      //           <h5>General</h5>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payslip Title</span>
      //               <p id="employee_title_[id]">Payslip of November</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Payslip No</span>
      //               <p id="employee_ref_[id]">PV9128391890</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Date</span>
      //               <p id="employee_date_[id]">12/2/2021</p>
      //             </div>
      //           </div>
      //         </div>
      //         <div class="col-md-4">
      //           <h5>Employee Details</h5>
      //           <div id='employeeid' value=''></div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Name</span>
      //               <p id="employee_name_[id]">Alric Liew</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Position</span>
      //               <p id="employee_position_[id]">Tutor</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">EPF No</span>
      //               <p id="employee_epf_[id]">8946146465</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Socso No</span>
      //               <p id="employee_socso_[id]">64631894616584</p>
      //             </div>
      //           </div>
      //         </div>
      //         <div class="col-md-4">
      //           <h5>Banking Information</h5>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Name</span>
      //               <p id="employee_bank_name_[id]">CIMB Bank</p>
      //             </div>
      //           </div>
      //           <div class="row">
      //             <div class="col-md-12">
      //               <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Bank Account Number</span>
      //               <p id="employee_account_num_[id]">98s5ew5xdfle</p>
      //             </div>
      //           </div>
      //         </div>
      //       </div>

      // General
      let general = document.createElement('h5');
      general.textContent = 'General';

      let titleSpan = document.createElement('span');
      titleSpan.textContent = 'Payslip Title';
      titleSpan.setAttribute('style', 'font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;');
      let titleP = document.createElement('p');
      // titleP.textContent = 'Payslip For The Month Of ' + payrollDateMonth;
      titleP.textContent = payslipData.title;
      titleP.setAttribute('name', 'title')
      let titleDiv = document.createElement('div');
      titleDiv.className = 'col-md-12';
      titleDiv.appendChild(titleSpan);
      titleDiv.appendChild(titleP);
      let titleDivTop = document.createElement('div');
      titleDivTop.className = 'row';
      titleDivTop.appendChild(titleDiv);

      let refNoSpan = document.createElement('span');
      refNoSpan.textContent = 'Payslip No';
      refNoSpan.setAttribute('style', 'font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;');
      let refNoP = document.createElement('p');
      // refNoP.textContent = '-';
      refNoP.textContent =  payslipData.payNo;
      refNoP.setAttribute('name', 'refNo')
      let refNoDiv = document.createElement('div');
      refNoDiv.className = 'col-md-12';
      refNoDiv.appendChild(refNoSpan);
      refNoDiv.appendChild(refNoP);
      let refNoDivTop = document.createElement('div');
      refNoDivTop.className = 'row';
      refNoDivTop.appendChild(refNoDiv);

      let dateSpan = document.createElement('span');
      dateSpan.textContent = 'Date';
      dateSpan.setAttribute('style', 'font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;');
      let dateP = document.createElement('p');
      // dateP.textContent = payrollDate;
      dateP.textContent =  payslipData.date;
      dateP.setAttribute('name', 'date')
      let dateDiv = document.createElement('div');
      dateDiv.className = 'col-md-12';
      dateDiv.appendChild(dateSpan);
      dateDiv.appendChild(dateP);
      let dateDivTop = document.createElement('div');
      dateDivTop.className = 'row';
      dateDivTop.appendChild(dateDiv);

      let generalDiv = document.createElement('div');
      generalDiv.className = 'col-md-4';
      generalDiv.appendChild(general);
      generalDiv.appendChild(titleDivTop);
      generalDiv.appendChild(refNoDivTop);
      generalDiv.appendChild(dateDivTop);

      // Employement Details
      let employment = document.createElement('h5');
      employment.textContent = 'Employement Details'

      let nameSpan = document.createElement('span');
      nameSpan.textContent = 'Name';
      nameSpan.setAttribute('style', 'font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;');
      let nameP = document.createElement('p');
      nameP.textContent = payslipData.name;
      nameP.setAttribute('name', 'name')
      let nameDiv = document.createElement('div');
      nameDiv.className = 'col-md-12';
      nameDiv.appendChild(nameSpan);
      nameDiv.appendChild(nameP);
      let nameDivTop = document.createElement('div');
      nameDivTop.className = 'row';
      nameDivTop.appendChild(nameDiv);

      let positionSpan = document.createElement('span');
      positionSpan.textContent = 'Position';
      positionSpan.setAttribute('style', 'font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;');
      let positionP = document.createElement('p');
      positionP.textContent =  payslipData.position;
      positionP.setAttribute('name', 'position')
      let positionDiv = document.createElement('div');
      positionDiv.className = 'col-md-12';
      positionDiv.appendChild(positionSpan);
      positionDiv.appendChild(positionP);
      let positionDivTop = document.createElement('div');
      positionDivTop.className = 'row';
      positionDivTop.appendChild(positionDiv);

      let epfSpan = document.createElement('span');
      epfSpan.textContent = 'EPF No';
      epfSpan.setAttribute('style', 'font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;');
      let epfP = document.createElement('p');
      epfP.textContent = payslipData.epf;
      epfP.setAttribute('name', 'epf')
      let epfDiv = document.createElement('div');
      epfDiv.className = 'col-md-12';
      epfDiv.appendChild(epfSpan);
      epfDiv.appendChild(epfP);
      let epfDivTop = document.createElement('div');
      epfDivTop.className = 'row';
      epfDivTop.appendChild(epfDiv);
      if (payslipData.epf === null || payslipData.epf ==='')
        epfDivTop.setAttribute('style', 'display: none');

      let socsoSpan = document.createElement('span');
      socsoSpan.textContent = 'Socso No';
      socsoSpan.setAttribute('style', 'font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;');
      let socsoP = document.createElement('p');
      socsoP.textContent = payslipData.socso;
      socsoP.setAttribute('name', 'socso')
      let socsoDiv = document.createElement('div');
      socsoDiv.className = 'col-md-12';
      socsoDiv.appendChild(socsoSpan);
      socsoDiv.appendChild(socsoP);
      let socsoDivTop = document.createElement('div');
      socsoDivTop.className = 'row';
      socsoDivTop.appendChild(socsoDiv);
      if (payslipData.socso === null || payslipData.socso ==='')
        socsoDivTop.setAttribute('style', 'display: none');

      let employmentDiv = document.createElement('div');
      employmentDiv.className = 'col-md-4';
      employmentDiv.appendChild(employment);
      employmentDiv.appendChild(nameDivTop);
      employmentDiv.appendChild(positionDivTop);
      employmentDiv.appendChild(epfDivTop);
      employmentDiv.appendChild(socsoDivTop);

      // Banking Information
      let bank = document.createElement('h5');
      bank.textContent = 'Banking Information'

      let bankNameSpan = document.createElement('span');
      bankNameSpan.textContent = 'Bank Name';
      bankNameSpan.setAttribute('style', 'font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;');
      let bankNameP = document.createElement('p');
      bankNameP.textContent = (payslipData.bankName == null || payslipData.bankName == "") ? "No information available": payslipData.bankName;
      bankNameP.setAttribute('name', 'bankName')
      let bankNameDiv = document.createElement('div');
      bankNameDiv.className = 'col-md-12';
      bankNameDiv.appendChild(bankNameSpan);
      bankNameDiv.appendChild(bankNameP);
      let bankNameDivTop = document.createElement('div');
      bankNameDivTop.className = 'row';
      bankNameDivTop.appendChild(bankNameDiv);

      let acNoSpan = document.createElement('span');
      acNoSpan.textContent = 'Bank Account No';
      acNoSpan.setAttribute('style', 'font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;');
      let acNoP = document.createElement('p');
      acNoP.textContent = (payslipData.acNo == null || payslipData.acNo == "") ? "No information available": payslipData.acNo;
      acNoP.setAttribute('name', 'acNo')
      let acNoDiv = document.createElement('div');
      acNoDiv.className = 'col-md-12';
      acNoDiv.appendChild(acNoSpan);
      acNoDiv.appendChild(acNoP);
      let acNoDivTop = document.createElement('div');
      acNoDivTop.className = 'row';
      acNoDivTop.appendChild(acNoDiv);

      let bankDiv = document.createElement('div');
      bankDiv.className = 'col-md-4';
      bankDiv.appendChild(bank);
      bankDiv.appendChild(bankNameDivTop);
      bankDiv.appendChild(acNoDivTop);

      let detailTopDiv = document.createElement('div');
      detailTopDiv.className = 'row';
      detailTopDiv.appendChild(generalDiv);
      detailTopDiv.appendChild(employmentDiv);
      detailTopDiv.appendChild(bankDiv);


      // Card Body
      cardBodyDiv = document.createElement('div');
      cardBodyDiv.className = 'card-body';
      cardBodyDiv.appendChild(btnDiv);
      cardBodyDiv.appendChild(tableTop);
      cardBodyDiv.appendChild(editDetailsBtnTopDiv);
      cardBodyDiv.appendChild(detailTopDiv);


      cardBodyTopDiv = document.createElement('div');
      cardBodyTopDiv.className = 'collapse';
      cardBodyTopDiv.id = 'collapse_'+payslipData.tutor_id;
      cardBodyTopDiv.setAttribute('style', 'padding: 0; margin: 0;')
      cardBodyTopDiv.setAttribute('aria-labelledby', 'heading_'+payslipData.tutor_id)
      cardBodyTopDiv.setAttribute('data-parent', '#accordionTutor')
      cardBodyTopDiv.appendChild(cardBodyDiv);

      // Tutor Card Top
      cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.id = payslipData.tutor_id;
      cardDiv.appendChild(cardHeaderDiv);
      cardDiv.appendChild(cardBodyTopDiv);


      const accordionTutor = document.getElementById("accordionTutor");
      // accordionTutor.appendChild(cardDiv);
      accordionTutor.insertBefore(cardDiv, accordionTutor.children[0]);

      // Update role view
      updateRoleView()

    }


    function calculateGrossPayDuringInit(cardId){
      // <div class="card" id='wwwwww'>
      //   <div class="card-header" id="headingOne" style="padding: 0; margin: 0; ">
      //     .....
      //   </div>
      //   <div id="collapse1" class="collapse" aria-labelledby="headingOne" data-parent="#accordionTutor" style="padding: 0; margin: 0; ">
      //     <div class="card-body">
      //       <!-- Buttons -->
      //       <div class="row">
      //         .....
      //       </div>
      //       <div class="row">
      //         <div class="col-12"  style="overflow-x:auto;">
      //           <span class="" style="font-size: x-small; font-weight: 300; color: gray; margin-bottom: 0;">Note*: Quantity - Number of hour of lessons conducted, number of classes, or relevant other items</span>
      //           <table id="table_item_wwwwww" class="table-light table-sm" cellspacing="0" width="100%" >
      //             <thead style="background-color: grey; color: white;">
      //               <tr>
      //                 <th style="min-width: 200px; font-size: small;">Items</th>
      //                 <th style="width: 100px; min-width: 100px; text-align: right; font-size: small;">Quantity*</th>
      //                 <th style="width: 100px; min-width: 100px; text-align: right; font-size: small;">Amount</th>
      //                 <th style="width: 100px; min-width: 100px; text-align: right; font-size: small;">Payout</th>
      //                 <th style="width: 100px; min-width: 100px; text-align: right; font-size: small;">Earning</th>
      //               </tr>
      //             </thead>
      //             <tbody id="previewItemBody">
      //               <tr class="item">
      //                 <td style="font-size: small;">Standard 3 English</td>
      //                 <td style="text-align: right; font-size: small;">1</td>
      //                 <td style="text-align: right; font-size: small;">100</td>
      //                 <td style="text-align: right; font-size: small;">100</td>
      //                 <td style="text-align: right; font-size: small;">RM100</td>
      //               </tr>

      // Get all the TR elem with class=item in respective table
      let itemTrEleArr = document.getElementById('tbody_item_'+cardId).querySelectorAll('tr.item');
      // console.log(itemTrEleArr);

      // If no item, return
      if (itemTrEleArr.length === 0){
        document.getElementById("grosspay_"+cardId).textContent = 'RM0.00';
        document.getElementById("netpay_"+cardId).textContent = 'RM0.00';
        document.getElementById("netpayview_"+cardId).textContent = 'RM0.00';
        return 0;
      }

      // Get the length of the item 0 to determine if simple or advanced template used.
      let itemTdEleLength = itemTrEleArr[0].querySelectorAll('td').length;

      // Var used for gross and net pay
      let grossEarning = 0;
      let grossEarningText = '';
      let grossEarningAdv = 0;
      let grossEarningTextAdv = '';

      if (itemTdEleLength === 5 ){
        // Advanced
        itemTrEleArr.forEach(function (row, index) {

          // Calculate the subtotal amount
          let item = row.getElementsByTagName("td")[0].value; // Unused: Input
          let quantity = parseFloat(row.getElementsByTagName("td")[1].textContent);
          let amount = parseFloat(row.getElementsByTagName("td")[2].textContent);
          let payout = parseFloat(row.getElementsByTagName("td")[3].textContent);

          // Set the value of Amount at 5th cell
          if (isNaN(quantity) && isNaN(amount) && isNaN(payout)){
            // If no input to quantity and value, clear the amount.
            // row.children[5].textContent = '';
          }
          else if (isNaN(quantity) || isNaN(amount) ||isNaN(payout)){
            // row.children[5].textContent = 'INVALID';
          }
          else {
            let earning = quantity * amount * payout / 100;
            grossEarningAdv += earning;
            row.getElementsByTagName("td")[4].textContent= (earning >= 0) ? 'RM'+earning.toFixed(2) : '- RM'+ Math.abs(earning).toFixed(2)
          }
        });


        if (isNaN(grossEarningAdv)){
          grossEarningTextAdv = 'INVALID';
          document.getElementById("grosspay_"+cardId).textContent = grossEarningTextAdv;
          document.getElementById("netpay_"+cardId).textContent = grossEarningTextAdv;
          document.getElementById("netpayview_"+cardId).textContent = grossEarningTextAdv;
          return 0;
        }
        else {
          grossEarningTextAdv = (grossEarningAdv >= 0) ? 'RM'+grossEarningAdv.toFixed(2) : '- RM'+ Math.abs(grossEarningAdv).toFixed(2);
          document.getElementById("grosspay_"+cardId).textContent = grossEarningTextAdv;
          document.getElementById("netpay_"+cardId).textContent = grossEarningTextAdv;
          document.getElementById("netpayview_"+cardId).textContent = grossEarningTextAdv;
          return grossEarningAdv;
        }
      }

      else{
        // simple
        itemTrEleArr.forEach(function (row, index) {

          // Calculate the subtotal amount
          let amount = parseFloat(row.getElementsByTagName("td")[1].textContent);

          // Set the value of Amount at 5th cell
          if (isNaN(amount)){
            // If no input to quantity and value, clear the amount.
            // row.children[5].textContent = '';
          }
          else {
            let earning = amount;
            grossEarning += earning;
            row.getElementsByTagName("td")[2].textContent= (earning >= 0) ? 'RM'+earning.toFixed(2) : '- RM'+ Math.abs(earning).toFixed(2)
          }
        });

        if (isNaN(grossEarning)){
          grossEarningText = 'INVALID';
          document.getElementById("grosspay_"+cardId).textContent = grossEarningText;
          document.getElementById("netpay_"+cardId).textContent = grossEarningText;
          document.getElementById("netpayview_"+cardId).textContent = grossEarningText;
          return 0;
        }
        else {
          grossEarningText = (grossEarning >= 0) ? 'RM'+grossEarning.toFixed(2) : '- RM'+ Math.abs(grossEarning).toFixed(2);
          document.getElementById("grosspay_"+cardId).textContent = grossEarningText;
          document.getElementById("netpay_"+cardId).textContent = grossEarningText;
          document.getElementById("netpayview_"+cardId).textContent = grossEarningText;

          return grossEarning;
        }

      }

    }


    function calculateNetPayDuringInit(cardId, grossPay){

      // Get the length of the header of additional table to determine if simple or advanced template used.
      let addItemHeaderTrEleArr = document.getElementById('thead_additem_'+cardId).querySelectorAll('tr');
      let addItemHeaderTrEleArrLength = addItemHeaderTrEleArr[0].querySelectorAll('th').length;

      // Get all the TR elem with class=additional in respective table
      let itemTrEleArr = document.getElementById('tbody_additem_'+cardId).querySelectorAll('tr.additional');

      // console.log(itemTrEleArr);

      // If no additional item, return with gross pay only.
      if (itemTrEleArr.length === 0){
        return grossPay;
      }

      // Var used for gross and net pay
      let netPay = grossPay;
      let netPayText = '';
      let netPayAdv = grossPay;
      let netPayTextAdv = '';

      let temp_amount = 0;
      if (addItemHeaderTrEleArrLength === 5 ){
        // Advanced
        itemTrEleArr.forEach(function (row, index) {

          // Calculate the net amount
          // let item = row.getElementsByTagName("td")[0].value; // Unused: Input
          // let quantity = parseFloat(row.getElementsByTagName("td")[1].textContent);
          // let amount = parseFloat(row.getElementsByTagName("td")[2].textContent);
          // let payout = parseFloat(row.getElementsByTagName("td")[3].textContent);

          let action = row.getElementsByTagName("td")[3].getAttribute('data-selector');
          let item = parseFloat(row.getElementsByTagName("td")[3].getAttribute('data-item'));
          let amount = parseFloat(row.getElementsByTagName("td")[3].getAttribute('data-value'));
          console.log('addItemHeaderTrEleArrLength: '+addItemHeaderTrEleArrLength)
          // console.log(action, item, amount)
          if (action === 'Discount ( - )'){
            temp_amount = -amount;
            netPayAdv = netPayAdv - amount;

          }else if(action === 'Earning ( + )'){
            temp_amount = amount
            netPayAdv = netPayAdv + amount;

          }else{
            // No change
            temp_amount = 0;
            netPayAdv = netPayAdv;

          }

          // Set the value of Amount at 5th cell
          if (isNaN(temp_amount)){
            row.getElementsByTagName("td")[4].textContent = 'INVALID';
          }
          else {
            row.getElementsByTagName("td")[4].textContent = (temp_amount >= 0) ? '+ RM'+temp_amount.toFixed(2) : '- RM'+ Math.abs(temp_amount).toFixed(2)
          }

        });


        if (isNaN(netPayAdv)){
          netPayTextAdv = 'INVALID';
          document.getElementById("netpay_"+cardId).textContent = netPayTextAdv;
          document.getElementById("netpayview_"+cardId).textContent = netPayTextAdv;

          return 0;
        }
        else {
          netPayTextAdv = (netPayAdv >= 0) ? 'RM'+netPayAdv.toFixed(2) : '- RM'+ Math.abs(netPayAdv).toFixed(2);
          document.getElementById("netpay_"+cardId).textContent = netPayTextAdv;
          document.getElementById("netpayview_"+cardId).textContent = netPayTextAdv;

          return netPayAdv;
        }
      }

      else{
        // Advanced
        itemTrEleArr.forEach(function (row, index) {

          // Calculate the net amount

          let action = row.getElementsByTagName("td")[1].getAttribute('data-selector');
          let item = parseFloat(row.getElementsByTagName("td")[1].getAttribute('data-item'));
          let amount = parseFloat(row.getElementsByTagName("td")[1].getAttribute('data-value'));
          console.log('addItemHeaderTrEleArrLength: '+addItemHeaderTrEleArrLength)

          // console.log(action, item, amount)
          if (action === 'Discount ( - )'){
            temp_amount = -amount;
            netPay = netPay - amount;

          }else if(action === 'Earning ( + )'){
            temp_amount = amount
            netPay = netPay + amount;

          }else{
            // No change
            temp_amount = 0;
            netPay = netPay;

          }

          // Set the value of Amount at 5th cell
          if (isNaN(temp_amount)){
            row.getElementsByTagName("td")[2].textContent = 'INVALID';
          }
          else {
            row.getElementsByTagName("td")[2].textContent = (temp_amount >= 0) ? '+ RM'+temp_amount.toFixed(2) : '- RM'+ Math.abs(temp_amount).toFixed(2)
          }

        });



        if (isNaN(netPay)){
          netPayText = 'INVALID';
          document.getElementById("netpay_"+cardId).textContent = netPayText;
          document.getElementById("netpayview_"+cardId).textContent = netPayText;

          return 0;
        }
        else {
          netPayText = (netPay >= 0) ? 'RM'+netPay.toFixed(2) : '- RM'+ Math.abs(netPay).toFixed(2);
          document.getElementById("netpay_"+cardId).textContent = netPayText;
          document.getElementById("netpayview_"+cardId).textContent = netPayText;

          return netPay;
        }

      }

    }


    // Render All Active Tutor
    function renderAllActiveTutor(doc){


      let img = document.createElement('img');
      img.setAttribute('style', 'height: 100%; width: 100%; object-fit: cover;');
      img.setAttribute('src', doc.data()[TUTOR_TUTOR_IMG_URL]);
      let img_div = document.createElement('div');
      img_div.setAttribute('style', 'height: 100px;width: 100px; display: inline-block; position: relative; overflow: hidden; border-radius: 50%;')
      img_div.appendChild(img)

      let name_h4 = document.createElement('h4');
      name_h4.textContent = doc.data()[TUTOR_TUTOR_NAME];
      let name_div = document.createElement('div');
      name_div.setAttribute('style', 'margin-top:1rem;');
      name_div.appendChild(name_h4);

      let tutor_div = document.createElement('div');
      tutor_div.className = "card-tutor text-center";
      tutor_div.appendChild(img_div);
      tutor_div.appendChild(name_div);

      let tutor_card_div = document.createElement('div');
      tutor_card_div.className = 'col-lg-2 col-md-3 col-6';
      tutor_card_div.setAttribute('onclick', 'viewTutorFunction(this)');
      tutor_card_div.setAttribute('data-target', '#viewTutorModal');
      tutor_card_div.setAttribute('data-toggle', 'modal');
      tutor_card_div.setAttribute('data-id', doc.data()[TUTOR_ID]);
      tutor_card_div.appendChild(tutor_div)

      const card_all_tutor = document.getElementById("card-all-tutor");
      card_all_tutor.appendChild(tutor_card_div);

    }

	  function viewTutorFunction(elem){
      // Get attribute and
      if (JSON.parse(sessionStorage.getItem(SESSION_STORAGE_TUTOR_ALL_DOCS_KEY)) == null ){
        console.log("Error: Impossible to reach this state");
        // Because this func only trigger when there's active class loaded
        return;
      }else{

        let allClassList = null;

        // Set the fields
        allClassList = JSON.parse(sessionStorage.getItem(SESSION_STORAGE_TUTOR_ALL_DOCS_KEY));
        allClassList.forEach((item) => {
          if (item.id === elem.getAttribute('data-id')){
            // Assign the data to viewTutorModal
            document.getElementById("viewTutorName").value = item[TUTOR_TUTOR_NAME];
            document.getElementById("viewTutorPhone").value = item[TUTOR_TUTOR_PHONE];
            document.getElementById("viewTutorEmail").value = item[TUTOR_TUTOR_EMAIL];
            document.getElementById("viewTutorGenderRadioMale").checked = item[TUTOR_TUTOR_GENDER] == 0 ? true: false;
            document.getElementById("viewTutorGenderRadioFemale").checked = item[TUTOR_TUTOR_GENDER] == 1 ? true: false;
            document.getElementById("viewTutorAge").value = item[TUTOR_TUTOR_AGE];
            document.getElementById("viewTutorImgUrl").src = item[TUTOR_TUTOR_IMG_URL];
            console.log(item[TUTOR_TUTOR_WEB_URL])
            if (item[TUTOR_TUTOR_WEB_URL] == null || item[TUTOR_TUTOR_WEB_URL] == ''){
              document.getElementById("btnViewTutorModalFullProfile").disabled = true;
              document.getElementById("btnViewTutorModalFullProfile").setAttribute('href','#');
              document.getElementById("btnViewTutorModalFullProfile").setAttribute('target','');
            }
            else{
              document.getElementById("btnViewTutorModalFullProfile").disabled = false;
              document.getElementById("btnViewTutorModalFullProfile").setAttribute('href','https://golearn.com.my/tutor/'+item[TUTOR_TUTOR_WEB_URL]);
              document.getElementById("btnViewTutorModalFullProfile").setAttribute('target','_blank');
            }

            // sessionStorage.setItem(SESSION_STORAGE_TUTOR_CURRENT_DOC_KEY, JSON.stringify(item));
            // sessionStorage.setItem(SESSION_STORAGE_CLASS_LOAD_KEY, true);
          }
          // window.location = './edit-class.html?id=';

          // console.log(item);
        });

      }
		}

    //-------- Item Table Handling Start-----------------/
    const table = document.getElementById('table');
    // const tableAdditionalItem = document.getElementById('tableAdditionalItem');
    let draggingEle;
    let draggingEleAdv;
    let draggingRowIndex;
    let placeholder;
    let placeholderAdv;
    let list;
    let listAdv;
    let isDraggingStarted = false;

    // The current position of mouse relative to the dragging element
    let x = 0;
    let y = 0;

    // Swap two nodes
    const swap = function (nodeA, nodeB) {
        const parentA = nodeA.parentNode;
        const siblingA = nodeA.nextSibling === nodeB ? nodeA : nodeA.nextSibling;

        // Move `nodeA` to before the `nodeB`
        nodeB.parentNode.insertBefore(nodeA, nodeB);

        // Move `nodeB` to before the sibling of `nodeA`
        parentA.insertBefore(nodeB, siblingA);
    };

    // Check if `nodeA` is above `nodeB`
    const isAbove = function (nodeA, nodeB) {
        // Get the bounding rectangle of nodes
        const rectA = nodeA.getBoundingClientRect();
        const rectB = nodeB.getBoundingClientRect();

        console.log(rectA.top, rectA.height / 2, rectB.top, rectB.height / 2, rectA.top + rectA.height / 2 < rectB.top + rectB.height / 2)
        return rectA.top + rectA.height / 2 < rectB.top + rectB.height / 2;
    };

    // Check if `nodeA` is below `nodeB`
    const isBelow = function (nodeA, nodeB) {
        // Get the bounding rectangle of nodes
        const rectA = nodeA.getBoundingClientRect();
        const rectB = nodeB.getBoundingClientRect();

        console.log(rectA.top, rectA.height / 2, rectB.top, rectB.height / 2, rectA.top + rectA.height / 2 < rectB.top + rectB.height / 2)

        return rectA.top + rectA.height / 2 > rectB.top + rectB.height / 2;
    };

    const cloneTable = function (elem) {
      const rect = elem.getBoundingClientRect();
      // console.log(rect)
      const width = parseInt(window.getComputedStyle(elem).width);

      list = document.createElement('div');
      list.classList.add('clone-list');
      list.style.position = 'fixed';
      // list.style.left = `${rect.left}px`;
      // list.style.top = `${rect.top}px`;
      elem.parentNode.insertBefore(list, elem);

      // Hide the original table
      elem.style.visibility = 'hidden';

      elem.querySelectorAll('tr').forEach(function (row) {
        // Create a new table from given row
        const item = document.createElement('div');
        item.classList.add('draggable');

        const newTable = document.createElement('table');
        // newTable.setAttribute('class', 'clone-table');
        newTable.setAttribute('class', 'table-light table-sm');
        newTable.setAttribute('cellspacing', "0");
        newTable.setAttribute('width',"100%");
        newTable.style.width = `${width}px`;

        const newRow = document.createElement('tr');
        const cells = [].slice.call(row.children);
        cells.forEach(function (cell) {
          const newCell = cell.cloneNode(true);
          newCell.style.width = `${parseInt(window.getComputedStyle(cell).width)}px`;
          newRow.appendChild(newCell);
        });

        newTable.appendChild(newRow);
        item.appendChild(newTable);
        list.appendChild(item);
      });
    };

    const cloneTableAdv = function (elem) {
      const rect = elem.getBoundingClientRect();
      // console.log(rect)
      const width = parseInt(window.getComputedStyle(elem).width);

      listAdv = document.createElement('div');
      listAdv.classList.add('clone-list');
      listAdv.style.position = 'fixed';
      // listAdv.style.left = `${rect.left}px`;
      // listAdv.style.top = `${rect.top}px`;
      elem.parentNode.insertBefore(listAdv, elem);

      // Hide the original table
      elem.style.visibility = 'hidden';

      elem.querySelectorAll('tr').forEach(function (row) {
        // Create a new table from given row
        const item = document.createElement('div');
        item.classList.add('draggable');

        const newTable = document.createElement('table');
        // newTable.setAttribute('class', 'clone-table');
        newTable.setAttribute('class', 'table-light table-sm');
        newTable.setAttribute('cellspacing', "0");
        newTable.setAttribute('width',"100%");
        newTable.style.width = `${width}px`;

        const newRow = document.createElement('tr');
        const cells = [].slice.call(row.children);
        cells.forEach(function (cell) {
          const newCell = cell.cloneNode(true);
          newCell.style.width = `${parseInt(window.getComputedStyle(cell).width)}px`;
          newRow.appendChild(newCell);
        });

        newTable.appendChild(newRow);
        item.appendChild(newTable);
        listAdv.appendChild(item);
      });
    };


    const mouseDownHandler = function (e) {
        // Get the original row
        // Layer 1
        let originalRow = e.target.parentNode;
        if (originalRow.nodeName.toLowerCase() === 'tr'){
          // Correct parents node. Do nothing
        }else {
          // Layer 2
          originalRow = originalRow.parentNode;
          if (originalRow.nodeName.toLowerCase() === 'tr'){
          // Correct parents node. Do nothing
          }else {
            // Layer 3
            originalRow = originalRow.parentNode;
            if (originalRow.nodeName.toLowerCase() === 'tr'){
            // Correct parents node. Do nothing
            }else {
              // Layer 4
              // Impossible to  reach here
              originalRow = originalRow.parentNode;
              if (originalRow.nodeName.toLowerCase() === 'tr'){
              // Correct parents node. Do nothing
              }else {
                // Layer 5
                // Impossible to  reach here
                originalRow = originalRow.parentNode;
                if (originalRow.nodeName.toLowerCase() === 'tr'){
                  // Correct parents node. Do nothing
                }else {
                  // Layer 6
                  // Impossible to  reach here
                  originalRow = originalRow.parentNode;
                  if (originalRow.nodeName.toLowerCase() === 'tr'){
                    // Correct parents node. Do nothing
                  }else {
                    // There must be so many nested tag inside a cell.
                    // Technically, it is impossible to reach here.
                    // In case you are here, just add more layers.
                  }
                }
              }
            }
          }

        }

        // console.log(originalRow);
        // OrignalRow refers to row in the tBody. To get the id of the table, we need to move up 2 more layers.
        let idTable = originalRow.parentNode.parentNode.id;
        // console.log(idTable);
        if (idTable === 'tableSimple'){
          draggingRowIndex = [].slice.call(tableSimple.querySelectorAll('tr')).indexOf(originalRow);
        }else{
          draggingRowIndex = [].slice.call(tableAdv.querySelectorAll('tr')).indexOf(originalRow);
        }

        // Determine the mouse position
        x = e.clientX;
        y = e.clientY;

        // Attach the listeners to `document`
        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('mouseup', mouseUpHandler);
    };

    const mouseMoveHandler = function (e) {
      if (!isDraggingStarted) {
        isDraggingStarted = true;

        cloneTable(tableSimple);
        // cloneTable(tableAdv);
        cloneTableAdv(tableAdv);
        // console.log(draggingRowIndex);
        // console.log([].slice.call(list.children));
        draggingEle = [].slice.call(list.children)[draggingRowIndex];
        draggingEle.classList.add('dragging');

        // Let the placeholder take the height of dragging element
        // So the next element won't move up
        placeholder = document.createElement('div');
        placeholder.classList.add('placeholder');
        draggingEle.parentNode.insertBefore(placeholder, draggingEle.nextSibling);
        placeholder.style.height = `${draggingEle.offsetHeight}px`;

        // Advanced Table
        draggingEleAdv = [].slice.call(listAdv.children)[draggingRowIndex];
        draggingEleAdv.classList.add('dragging');

        // Let the placeholder take the height of dragging element
        // So the next element won't move up
        placeholderAdv = document.createElement('div');
        placeholderAdv.classList.add('placeholder');
        draggingEleAdv.parentNode.insertBefore(placeholderAdv, draggingEleAdv.nextSibling);
        placeholderAdv.style.height = `${draggingEleAdv.offsetHeight}px`;
      }

      // Set position for dragging element
      draggingEle.style.position = 'fixed';
      draggingEle.style.top = `${draggingEle.offsetTop + e.clientY - y}px`;
      draggingEle.style.left = `${draggingEle.offsetLeft + e.clientX - x}px`;

      // Set position for dragging element
      draggingEleAdv.style.position = 'fixed';
      draggingEleAdv.style.top = `${draggingEleAdv.offsetTop + e.clientY - y}px`;
      draggingEleAdv.style.left = `${draggingEleAdv.offsetLeft + e.clientX - x}px`;
      // console.log(draggingEle.offsetTop, draggingEleAdv.offsetTop, e.clientY, e.clientX, y, x)
      // console.log(draggingEle.offsetTop + e.clientY - y, draggingEle.offsetTop + e.clientX - x)
      // console.log(draggingEleAdv.offsetTop + e.clientY - y, draggingEleAdv.offsetTop + e.clientX - x)

      // Reassign the position of mouse
      x = e.clientX;
      y = e.clientY;

      // The current order
      // prevEle
      // draggingEle
      // placeholder
      // nextEle
      const prevEle = draggingEle.previousElementSibling;
      const nextEle = placeholder.nextElementSibling;

      const prevEleAdv = draggingEleAdv.previousElementSibling;
      const nextEleAdv = placeholderAdv.nextElementSibling;


      // The dragging element is above the previous element
      // User moves the dragging element to the top
      // We don't allow to drop above the header
      // (which doesn't have `previousElementSibling`)
      if (prevEle && prevEle.previousElementSibling && isAbove(draggingEle, prevEle)) {
        // The current order    -> The new order
        // prevEle              -> placeholder
        // draggingEle          -> draggingEle
        // placeholder          -> prevEle
        swap(placeholder, draggingEle);
        swap(placeholder, prevEle);
        return;
      }

      // The dragging element is below the next element
      // User moves the dragging element to the bottom
      if (nextEle && isAbove(nextEle, draggingEle)) {
        // The current order    -> The new order
        // draggingEle          -> nextEle
        // placeholder          -> placeholder
        // nextEle              -> draggingEle
        swap(nextEle, placeholder);
        swap(nextEle, draggingEle);
      }

      // Advanced Table
      // The dragging element is above the previous element
      // User moves the dragging element to the top
      // We don't allow to drop above the header
      // (which doesn't have `previousElementSibling`)
      if (prevEleAdv && prevEleAdv.previousElementSibling && isAbove(draggingEleAdv, prevEleAdv)) {
        // The current order    -> The new order
        // prevEle              -> placeholder
        // draggingEle          -> draggingEle
        // placeholder          -> prevEle
        swap(placeholderAdv, draggingEleAdv);
        swap(placeholderAdv, prevEleAdv);
        return;
      }

      // The dragging element is below the next element
      // User moves the dragging element to the bottom
      if (nextEleAdv && isAbove(nextEleAdv, draggingEleAdv)) {
        // The current order    -> The new order
        // draggingEle          -> nextEle
        // placeholder          -> placeholder
        // nextEleAdv              -> draggingEle
        swap(nextEleAdv, placeholderAdv);
        swap(nextEleAdv, draggingEleAdv);
      }

    };

    const mouseUpHandler = function () {
        // Remove the placeholder
        placeholder && placeholder.parentNode.removeChild(placeholder);

        draggingEle.classList.remove('dragging');
        draggingEle.style.removeProperty('top');
        draggingEle.style.removeProperty('left');
        draggingEle.style.removeProperty('position');

        placeholderAdv && placeholderAdv.parentNode.removeChild(placeholderAdv);

        draggingEleAdv.classList.remove('dragging');
        draggingEleAdv.style.removeProperty('top');
        draggingEleAdv.style.removeProperty('left');
        draggingEleAdv.style.removeProperty('position');

        // Get the end index
        const endRowIndex = [].slice.call(list.children).indexOf(draggingEle);
        const endRowIndexAdv = [].slice.call(listAdv.children).indexOf(draggingEleAdv);
        let endRowIndexFinal = 0;

        // Check the active drag
        const advanced_check = document.getElementById('advanced_check');
        console.log('advanced_check.checked')
        console.log(advanced_check.checked)
        if (advanced_check.checked){
          // console.log('advanced_check.checked')
          endRowIndexFinal = endRowIndexAdv;
        }else {
          endRowIndexFinal = endRowIndex;
        }


        // console.log('endRowIndex: '+endRowIndex)
        // console.log('endRowIndexAdv: '+endRowIndexAdv)
        // console.log(endRowIndexFinal)

        console.log([].slice.call(list.children))
        console.log([].slice.call(listAdv.children))
        isDraggingStarted = false;

        // Remove the `list` element
        list.parentNode.removeChild(list);
        listAdv.parentNode.removeChild(listAdv);

        // Move the dragged row to `endRowIndex`
        let rows = [].slice.call(tableSimple.querySelectorAll('tr'));
        draggingRowIndex > endRowIndexFinal
            ? rows[endRowIndexFinal].parentNode.insertBefore(rows[draggingRowIndex], rows[endRowIndexFinal])
            : rows[endRowIndexFinal].parentNode.insertBefore(
                  rows[draggingRowIndex],
                  rows[endRowIndexFinal].nextSibling
              );

        let rowsAdv = [].slice.call(tableAdv.querySelectorAll('tr'));
        draggingRowIndex > endRowIndexFinal
            ? rowsAdv[endRowIndexFinal].parentNode.insertBefore(rowsAdv[draggingRowIndex], rowsAdv[endRowIndexFinal])
            : rowsAdv[endRowIndexFinal].parentNode.insertBefore(
                  rowsAdv[draggingRowIndex],
                  rowsAdv[endRowIndexFinal].nextSibling
              );

        // Bring back the table
        tableSimple.style.removeProperty('visibility');
        tableAdv.style.removeProperty('visibility');

        // Remove the handlers of `mousemove` and `mouseup`
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
    };

    // Run first
    const assignDraggable = function(){
      table.querySelectorAll('tr').forEach(function (row, index) {
        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
            return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // console.log(row)
        // console.log(row.className)
        const firstCell = row.firstElementChild;
        firstCell.classList.add('draggable');
        firstCell.addEventListener('mousedown', mouseDownHandler);
      });
    }

    // Find the parents node through while loops
    // ref: https://www.jsdiaries.com/how-to-loop-through-parent-nodes-in-javascript/
    const findAscendingTag = (el, tag) => {
        while (el.parentNode) {
          el = el.parentNode;
          // console.log(el.tagName)
          if (el.tagName === tag)
            return el;
          else{

          }
          // return el.tagName === tag ? el : null;
        }
      }

    // Calculate the amount for Normal Items based on quantity and unit price
    function calculateAmount(){

      let grossEarnings = calculateSubtotal();
      console.log(grossEarnings);
      // [grossEarning, grossEarningAdv]
      let total = calculateTotal(grossEarnings[0], grossEarnings[1]);

    }


    // Calculate the subtotal for all Normal Items
    function calculateSubtotal(){

      let grossEarning = 0;
      let grossEarningText = ''
      let grossEarningAdv = 0;
      let grossEarningTextAdv = ''
      tableSimple.querySelectorAll('tr').forEach(function (row, index) {

        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
          return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // console.log(row)
        // Calculate the subtotal amount
        let item = row.getElementsByTagName("input")[0].value; // Unused: Input
        // let quantity = row.getElementsByTagName("input")[1].value;
        let amount = parseFloat(row.getElementsByTagName("input")[1].value);
        // let payout = row.getElementsByTagName("input")[3].value;

        // Set the value of Amount at 5th cell
        if (isNaN(amount)){
          row.children[3].textContent = '';
        }
        else if (amount == ''){
          // If no input to quantity and value, clear the amount.
          row.children[3].textContent = '';
        }
        else {
          // let amount = quantity * price;
          grossEarning += amount;
          row.children[3].textContent= (amount >= 0) ? 'RM'+amount.toFixed(2) : '- RM'+ Math.abs(amount).toFixed(2)
        }
      });


      tableAdv.querySelectorAll('tr').forEach(function (row, index) {

        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
          return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // console.log(row)
        // Calculate the subtotal amount
        let item = row.getElementsByTagName("input")[0].value; // Unused: Input
        let quantity = parseFloat(row.getElementsByTagName("input")[1].value);
        let amount = parseFloat(row.getElementsByTagName("input")[2].value);
        let payout = parseFloat(row.getElementsByTagName("input")[3].value);

        console.log(quantity, amount, payout)

        // Set the value of Amount at 5th cell
        if (isNaN(quantity) && isNaN(amount) && isNaN(payout)){
          // If no input to quantity and value, clear the amount.
          row.children[5].textContent = '';
        }
        else if (isNaN(quantity) || isNaN(amount) ||isNaN(payout)){
          row.children[5].textContent = 'INVALID';
        }
        else {
          let earning = quantity * amount * payout / 100;
          grossEarningAdv += earning;
          row.children[5].textContent= (earning >= 0) ? 'RM'+earning.toFixed(2) : '- RM'+ Math.abs(earning).toFixed(2)
        }
      });


      if (isNaN(grossEarning) && isNaN(grossEarningAdv)){
        grossEarningText = 'INVALID';
        grossEarningTextAdv = 'INVALID';
        // console.log(subTotalText)
        document.getElementById("subtotalItem").textContent = grossEarningText;
        document.getElementById("subtotalItemAdv").textContent = grossEarningTextAdv;

        return [0, 0];
      }
      else if  (isNaN(grossEarning)){
        grossEarningText = 'INVALID';
        document.getElementById("subtotalItem").textContent = grossEarningText;

        grossEarningTextAdv = (grossEarningAdv >= 0) ? 'RM'+grossEarningAdv.toFixed(2) : '- RM'+ Math.abs(grossEarningAdv).toFixed(2);
        document.getElementById("subtotalItemAdv").textContent = grossEarningTextAdv;

        return [0, grossEarningAdv];
      }
      else if  (isNaN(grossEarningAdv)){
        grossEarningText = (grossEarning >= 0) ? 'RM'+grossEarning.toFixed(2) : '- RM'+ Math.abs(grossEarning).toFixed(2);
        document.getElementById("subtotalItemAdv").textContent = grossEarningText;

        grossEarningTextAdv = 'INVALID';
        document.getElementById("subtotalItem").textContent = grossEarningTextAdv;
        return [grossEarning, 0];
      }
      else {

        grossEarningText = (grossEarning >= 0) ? 'RM'+grossEarning.toFixed(2) : '- RM'+ Math.abs(grossEarning).toFixed(2);
        grossEarningTextAdv = (grossEarningAdv >= 0) ? 'RM'+grossEarningAdv.toFixed(2) : '- RM'+ Math.abs(grossEarningAdv).toFixed(2);

        // console.log(subTotalText)
        document.getElementById("subtotalItem").textContent = grossEarningText;
        document.getElementById("subtotalItemAdv").textContent = grossEarningTextAdv;

        return [grossEarning, grossEarningAdv];

      }

    }

    // Calculate the subtotal for all Normal + Additional Items
    function calculateTotal(grossEarning, grossEarningAdv){
      // subTotal
      let netPay = grossEarning;
      let netPayText = '';
      let netPayAdv = grossEarningAdv;
      let netPayTextAdv = '';
      let temp_amount = 0;

      tableAdditionalItem.querySelectorAll('tr').forEach(function (row, index) {

        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
          return;
        }
        // Ignore row with certain class name
        else if(row.className != 'additional'){
          return;
        }

        // console.log(row)
        // Get the Action: 2rd TF tag cell > div tag > first A tag
        let action = row.children[0].children[0].children[0].textContent;

        // Get input value
        let input = parseFloat(row.getElementsByTagName("input")[1].value);

        // console.log(action);
        // console.log(input);

        if (action === 'Discount ( - )'){
          temp_amount = -input;
          netPay = netPay - input;

        }else if(action === 'Earning ( + )'){
          temp_amount = input
          netPay = netPay + input;

        }else{
          // No change
          temp_amount = 0;
          netPay = netPay;

        }
        console.log('Total: '+netPay);
        // Set the value of Amount at 5th cell
        if (isNaN(temp_amount)){
          row.children[3].textContent = 'INVALID';
        }
        else {
          row.children[3].textContent = (temp_amount >= 0) ? '+ RM'+temp_amount.toFixed(2) : '- RM'+ Math.abs(temp_amount).toFixed(2)
        }

      });

      tableAdditionalItemAdv.querySelectorAll('tr').forEach(function (row, index) {

        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
          return;
        }
        // Ignore row with certain class name
        else if(row.className != 'additional'){
          return;
        }

        // console.log(row)
        // Get the Action: 2rd TF tag cell > div tag > first A tag
        let action = row.children[2].children[0].children[0].textContent;

        // Get input value
        let input = parseFloat(row.getElementsByTagName("input")[1].value);

        // console.log(action);
        // console.log(input);

        if (action === 'Discount ( - )'){
          temp_amount = -input;
          netPayAdv = netPayAdv - input;

        }else if(action === 'Earning ( + )'){
          temp_amount = input;
          netPayAdv = netPayAdv + input;

        }else{
          // No change
          temp_amount = 0;
          netPayAdv = netPayAdv;

        }
        // console.log('Total Advanced: '+netPayAdv);
        // Set the value of Amount at 5th cell
        if (isNaN(temp_amount)){
          row.children[5].textContent = 'INVALID';
        }
        else {
          row.children[5].textContent = (temp_amount >= 0) ? '+ RM'+temp_amount.toFixed(2) : '- RM'+ Math.abs(temp_amount).toFixed(2)
        }

      });


      let advanced_check = document.getElementById('advanced_check');
      if (advanced_check.checked){
        // Set the grand total.
        if (isNaN(netPayAdv) ){
          netPayTextAdv = 'INVALID';
          // console.log(netPayTextAdv)
          document.getElementById("grandTotal").textContent = netPayTextAdv;
          return 0;
        }
        else
        {
          netPayTextAdv = (netPayAdv >= 0) ? 'RM'+netPayAdv.toFixed(2) : '- RM'+ Math.abs(netPayAdv).toFixed(2)
          // console.log(netPayTextAdv)
          document.getElementById("grandTotal").textContent = netPayTextAdv;
          return netPayAdv;
        }

      }else {
        // Set the grand total.
        if (isNaN(netPay) ){
          netPayText = 'INVALID';
          // console.log(netPayText)
          document.getElementById("grandTotal").textContent = netPayText;
          return 0;
        }
        else
        {
          netPayText = (netPay >= 0) ? 'RM'+netPay.toFixed(2) : '- RM'+ Math.abs(netPay).toFixed(2)
          // console.log(netPayText)
          document.getElementById("grandTotal").textContent = netPayText;
          return netPay;
        }

      }

      // // Set the grand total.
      // if (isNaN(netPay) ){
      //     netPayText = 'INVALID';
      //     // console.log(netPayText)
      //     document.getElementById("grandTotal").textContent = netPayText;
      //     return 0;
      //   }
      // else
      // {
      //   netPayText = (netPay >= 0) ? 'RM'+netPay.toFixed(2) : '- RM'+ Math.abs(netPay).toFixed(2)
      //   // console.log(netPayText)
      //   document.getElementById("grandTotal").textContent = netPayText;
      //   return netPay;
      // }

    }

    // ------------- Utilities -------------//
    // Remove an item
    function removeElementBasedOnId(id){
      document.getElementById(id).remove();
    }

    //
    function showAdvancedColumns(elem){

      // $('#viewAdv').css('display', '');
      // a = document.getElementById("advanced").style;
      // console.log(a);
      // console.log($('th[name=advanced]').css())
      if (elem.checked){
        $('#viewSimple').css('display', 'none');
        $('#viewAdv').css('display', '');
        // $('#viewSimple').css('visibility', 'collapse');
        // $('#viewAdv').css('visibility', 'visible');

        // $('th[name=advanced]').css('display', '');
        // $('td[name=advanced]').css('display', '');
      }else{
        $('#viewSimple').css('display', '');
        $('#viewAdv').css('display', 'none');

        // $('#viewSimple').css('visibility', 'visible');
        // $('#viewAdv').css('visibility', 'collapse');
        // $('th[name=advanced]').css('display', 'none');
        // $('td[name=advanced]').css('display', 'none');
      }

    }

    // Enable / Disable the first additional item when 'Select one' is picked
    function enabledAdditionalItem(elem, itemName){
      // let selectedNode = elem.parentNode.parentNode.children[0];
      // selectedNode.value = elem.textContent;
      // selectedNode.textContent = elem.textContent;

      // Get the TR parents node
      var trParent = findAscendingTag(elem, "TR");

      // Setup 2nd cell: dropdown menu - find the first A tag
      // trParent.children[1].getElementsByTagName("a")[0].value = elem.textContent;
      // trParent.children[1].getElementsByTagName("a")[0].textContent = elem.textContent;
      trParent.getElementsByTagName("a")[0].value = elem.textContent;
      trParent.getElementsByTagName("a")[0].textContent = elem.textContent;

      // Setup 3rd cell: itemName input
      // trParent.children[2].getElementsByTagName("input")[0].removeAttribute("readonly");
      // trParent.children[2].getElementsByTagName("input")[0].value = itemName;
      trParent.getElementsByTagName("input")[0].removeAttribute("readonly");
      trParent.getElementsByTagName("input")[0].value = itemName;

      // Setup 4th cell: itemAmount input
      // trParent.children[3].getElementsByTagName("input")[0].removeAttribute("readonly");
      trParent.getElementsByTagName("input")[1].removeAttribute("readonly");

      var tbodyParent = findAscendingTag(elem, "TBODY");
      // console.log(tbodyParent.parentNode.id)

      let selectedRowIndex = [].slice.call(tbodyParent.querySelectorAll('tr')).indexOf(trParent)
      console.log(selectedRowIndex)

      // Get target Table
      let targetTableId = (tbodyParent.parentNode.id === 'tableAdditionalItem')? 'tableAdditionalItemAdv' : 'tableAdditionalItem';

      // Get the corresponding TR elem in other tables
      let targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=additional]');

      console.log(targetElem[selectedRowIndex])
      // Repeat the steps above.
      targetElem[selectedRowIndex].getElementsByTagName("a")[0].value = elem.textContent;
      targetElem[selectedRowIndex].getElementsByTagName("a")[0].textContent = elem.textContent;
      targetElem[selectedRowIndex].getElementsByTagName("input")[0].removeAttribute("readonly");
      targetElem[selectedRowIndex].getElementsByTagName("input")[0].value = itemName;
      targetElem[selectedRowIndex].getElementsByTagName("input")[1].removeAttribute("readonly");


    }


    function disabledAdditionalItem(elem){
      // let selectedNode = elem.parentNode.parentNode.children[0];
      // selectedNode.value = elem.textContent;
      // selectedNode.textContent = elem.textContent;

      // Get the TR parents node
      var trParent = findAscendingTag(elem, "TR");

      // Setup 2nd cell: dropdown menu - find the first A tag
      // trParent.children[1].getElementsByTagName("a")[0].value = elem.textContent;
      // trParent.children[1].getElementsByTagName("a")[0].textContent = elem.textContent;
      trParent.getElementsByTagName("a")[0].value = elem.textContent;
      trParent.getElementsByTagName("a")[0].textContent = elem.textContent;

      // Setup 3rd cell: itemName input
      trParent.getElementsByTagName("input")[0].setAttribute("readonly", true);
      trParent.getElementsByTagName("input")[0].value = '';

      // Setup 4th cell: itemAmount input
      // trParent.children[3].getElementsByTagName("input")[0].setAttribute("readonly", true);
      // trParent.children[3].getElementsByTagName("input")[0].value = 0;
      trParent.getElementsByTagName("input")[1].setAttribute("readonly", true);
      trParent.getElementsByTagName("input")[1].value = 0;

      var tableParent = findAscendingTag(elem, "TABLE");
      var tbodyParent = findAscendingTag(elem, "TBODY");

      let selectedRowIndex = [].slice.call(tbodyParent.querySelectorAll('tr')).indexOf(trParent)
      console.log(selectedRowIndex)

      // Get target Table
      let targetTableId = (tbodyParent.parentNode.id === 'tableAdditionalItem')? 'tableAdditionalItemAdv' : 'tableAdditionalItem';

      // Get the corresponding elem in other tables
      let targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=additional]');

      // console.log(targetElem)
      targetElem[selectedRowIndex].getElementsByTagName("a")[0].value = elem.textContent;
      targetElem[selectedRowIndex].getElementsByTagName("a")[0].textContent = elem.textContent;
      targetElem[selectedRowIndex].getElementsByTagName("input")[0].setAttribute("readonly", true);
      targetElem[selectedRowIndex].getElementsByTagName("input")[0].value = '';
      targetElem[selectedRowIndex].getElementsByTagName("input")[1].setAttribute("readonly", true);
      targetElem[selectedRowIndex].getElementsByTagName("input")[1].value = 0;

    }

    // Remove an item
    function removeRow2(elem){

      // console.log(elem)
      // Get the original row
      // Layer 1
      let originalRow = elem.parentNode;
      if (originalRow.nodeName.toLowerCase() === 'tr'){
        // Correct parents node. Do nothing
      }else {
        // Layer 2
        originalRow = originalRow.parentNode;
        if (originalRow.nodeName.toLowerCase() === 'tr'){
        // Correct parents node. Do nothing
        }else {
          // Layer 3
          originalRow = originalRow.parentNode;
          if (originalRow.nodeName.toLowerCase() === 'tr'){
          // Correct parents node. Do nothing
          }else {
            // Layer 4
            // Impossible to  reach here
            originalRow = originalRow.parentNode;
            if (originalRow.nodeName.toLowerCase() === 'tr'){
            // Correct parents node. Do nothing
            }else {
              // Layer 5
              // Impossible to  reach here
              originalRow = originalRow.parentNode;
              if (originalRow.nodeName.toLowerCase() === 'tr'){
                // Correct parents node. Do nothing
              }else {
                // Layer 6
                // Impossible to  reach here
                originalRow = originalRow.parentNode;
                if (originalRow.nodeName.toLowerCase() === 'tr'){
                  // Correct parents node. Do nothing
                }else {
                  // There must be so many nested tag inside a cell.
                  // Technically, it is impossible to reach here.
                  // In case you are here, just add more layers.
                }
              }
            }
          }
        }

      }


      // $( "#timeSlot-"+id ).remove();
      originalRow.parentNode.removeChild(originalRow);

      // After removing item, recalculate total
      calculateAmount();
    }

    // Add an item
    function addRow2(){
      // Table simple
      let draggableRowNormalLastIndex = document.getElementById("tableSimple").querySelectorAll('.draggable').length;
      // Create an empty <tr> element and add it to the last position of draggable items.
      var row = tableSimple.insertRow(draggableRowNormalLastIndex + 1);
      // console.log(draggableRowNormalLastIndex);

      // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
      var cell1 = row.insertCell(0); // Draggable
      var cell2 = row.insertCell(1); // Item
      var cell3 = row.insertCell(2); // Price
      var cell4 = row.insertCell(3); // Amount
      var cell5 = row.insertCell(4); // Delete

      row.className = 'item'
      // Add some text to the new cells:
      cell1.innerHTML = "<i class='fas fa-grip-vertical'></i>";
      cell2.innerHTML = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; padding-left: 0.5rem;' placeholder=' Enter item and description' oninput='sync(this);'>";
      // cell3.innerHTML = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='1' oninput='calculateAmount(this);'>";
      // cell4.innerHTML = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='0' oninput='calculateAmount(this);'>";
      cell3.innerHTML = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='0' oninput='sync(this); calculateAmount(this);'>";
      // cell6.innerHTML = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; text-align: right; padding-right: 0.5rem; ' value='0' oninput='//calculateAmount(this); '>";
      cell4.setAttribute('style', 'text-align: right;');
      cell5.innerHTML = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeRow(this); calculateAmount(this);'></i>";

      assignDraggableWithElem(tableSimple);

      // Table Advanced

      let draggableRowLastIndex = document.getElementById("tableAdv").querySelectorAll('.draggable').length;
      // Create an empty <tr> element and add it to the last position of draggable items.
      var row = tableAdv.insertRow(draggableRowLastIndex + 1);
      // console.log(draggableRowLastIndex);

      // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      var cell3 = row.insertCell(2);
      var cell4 = row.insertCell(3);
      var cell5 = row.insertCell(4);
      var cell6 = row.insertCell(5);
      var cell7 = row.insertCell(6);

      row.className = 'item'
      // Add some text to the new cells:
      cell1.innerHTML = "<i class='fas fa-grip-vertical'></i>";
      cell2.innerHTML = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; padding-left: 0.5rem;' placeholder=' Enter item and description' oninput='sync(this);'>";
      cell3.innerHTML = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='1' oninput='sync(this); calculateAmount(this);'>";
      cell4.innerHTML = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='0' oninput='sync(this); calculateAmount(this);'>";
      cell5.innerHTML = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='0' oninput='sync(this); calculateAmount(this);'>";
      // cell6.innerHTML = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; text-align: right; padding-right: 0.5rem; ' value='0' oninput='//calculateAmount(this);'>";
      cell6.setAttribute('style', 'text-align: right;');
      cell7.innerHTML = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeRow(this); calculateAmount(this);'></i>";

      assignDraggableWithElem(tableAdv);
    }


    // Add an item
    function addAdditionalRow2(){

      let draggableRowLastIndex = additionalItemBody.querySelectorAll('.additional').length;
      let draggableRowAdvLastIndex = additionalItemBodyAdv.querySelectorAll('.additional').length;

      // Create an empty <tr> element and add it to the last position of draggable items.
      var row = additionalItemBody.insertRow(draggableRowLastIndex);
      var rowAdv = additionalItemBodyAdv.insertRow(draggableRowAdvLastIndex);
      row.className = 'additional';
      rowAdv.className = 'additional';

      // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
      // var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(0);
      var cell3 = row.insertCell(1);
      var cell4 = row.insertCell(2);
      var cell5 = row.insertCell(3);
      var cell6 = row.insertCell(4);


      var cell1Adv = rowAdv.insertCell(0);
      var cell2Adv = rowAdv.insertCell(1);
      var cell3Adv = rowAdv.insertCell(2);
      var cell4Adv = rowAdv.insertCell(3);
      var cell5Adv = rowAdv.insertCell(4);
      var cell6Adv = rowAdv.insertCell(5);
      var cell7Adv = rowAdv.insertCell(6);

      // Add some text to the new cells:
      // cell1.innerHTML = "";
      cell1Adv.innerHTML = "";
      cell2Adv.innerHTML = "";


      let dropdown_selectone = document.createElement('a');
      dropdown_selectone.className = 'dropdown-item';
      dropdown_selectone.textContent = 'Select one';
      dropdown_selectone.setAttribute('href', 'javascript:;');
      dropdown_selectone.setAttribute('style', 'text-transform: none;');
      dropdown_selectone.setAttribute('onclick', "disabledAdditionalItem(this); calculateAmount();");
      let dropdown_discount = document.createElement('a');
      dropdown_discount.className = 'dropdown-item';
      dropdown_discount.textContent = 'Discount ( - )';
      dropdown_discount.setAttribute('href', 'javascript:;');
      dropdown_discount.setAttribute('style', 'text-transform: none;');
      dropdown_discount.setAttribute('onclick', "enabledAdditionalItem(this, 'Discount'); //calculateAmount(); printPreview();");
      let dropdown_earning = document.createElement('a');
      dropdown_earning.className = 'dropdown-item';
      dropdown_earning.textContent = 'Earning ( + )';
      dropdown_earning.setAttribute('href', 'javascript:;');
      dropdown_earning.setAttribute('style', 'text-transform: none;');
      dropdown_earning.setAttribute('onclick', "enabledAdditionalItem(this, 'Earning'); //calculateAmount(); printPreview();");
      let dropdown = document.createElement('div');
      dropdown.className = 'dropdown-menu';
      dropdown.appendChild(dropdown_selectone);
      dropdown.appendChild(dropdown_earning);
      dropdown.appendChild(dropdown_discount);
      let dropdown_btn = document.createElement('a');
      dropdown_btn.className = 'btn btn-primary dropdown-toggle bg-white text-dark text-right';
      dropdown_btn.type = 'Button';
      dropdown_btn.textContent = 'Select one';
      dropdown_btn.setAttribute('style', 'text-transform: none; padding: 0.6rem; margin: 0;');
      dropdown_btn.setAttribute('data-toggle', 'dropdown');
      dropdown_btn.setAttribute('aria-haspopup', 'true');
      dropdown_btn.setAttribute('aria-expanded', 'false');
      let dropdown_top = document.createElement('div');
      dropdown_top.className = 'dropdown';
      dropdown_top.appendChild(dropdown_btn);
      dropdown_top.appendChild(dropdown);

      cell2.setAttribute('style', "text-align: right");
      cell2.appendChild(dropdown_top);
      var dropdown_top2 = dropdown_top.cloneNode(true);
      cell3Adv.setAttribute('style', "text-align: right");
      cell3Adv.appendChild(dropdown_top2);

      let cell3_html = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; text-align: right; padding-right: 1rem;' oninput='syncAdditional(this);'placeholder='Item' readonly>";
      cell3.innerHTML = cell3_html;
      cell4Adv.innerHTML = cell3_html;

      let cell4_html = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='0' oninput='syncAdditional(this); calculateAmount();' readonly>";
      cell4.innerHTML = cell4_html;
      cell5Adv.innerHTML = cell4_html;

      cell5.setAttribute('style', 'text-align: right;');
      cell6Adv.setAttribute('style', 'text-align: right;');

      let cell6_html = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeRow(this); calculateAmount();'></i>";
      cell6.innerHTML = cell6_html;
      cell7Adv.innerHTML = cell6_html;

      assignDraggableWithElem(tableSimple);
      assignDraggableWithElem(tableAdv);
    }

    // Synchronize items description between tables
    function sync(elem){
      // console.log(elem)
      let inputVal = elem.value
      console.log(elem.value)

      var trParent = findAscendingTag(elem, "TR");
      var tbodyParent = findAscendingTag(elem, "TBODY");

      // Get the id of table a layer above.
      let activeTableId = tbodyParent.parentNode.id;

      // let selectedRowIndex = tbodyParent.index(trParent)
      let selectedRowIndex = [].slice.call(tbodyParent.querySelectorAll('tr')).indexOf(trParent)
      console.log(trParent)
      console.log(tbodyParent)
      // console.log([].slice.call(tbodyParent.querySelectorAll('tr')).indexOf(trParent))
      console.log(selectedRowIndex)
      console.log(activeTableId)

      // Get the inputs value and sync to corresponding elem in other tables
      let input1 = ''; // Items
      let input2 = ''; // Amount / Quantity
      let input3 = ''; // - / Amount
      let input4 = ''; // - / Payout (%)
      let targetElem = null;
      // let targetTableId = (activeTableId === 'tableSimple')? 'tableAdv' : 'tableSimple';
      if (activeTableId === 'tableSimple'){
        targetTableId = 'tableAdv';

        input1 =  trParent.getElementsByTagName("input")[0].value;
        input2 =  trParent.getElementsByTagName("input")[1].value;

        targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=item]');
        targetElem[selectedRowIndex].querySelectorAll('input')[0].value = input1;
        targetElem[selectedRowIndex].querySelectorAll('input')[2].value = input2;
      }
      else{
        targetTableId = 'tableSimple';

        input1 =  trParent.getElementsByTagName("input")[0].value;
        input2 =  trParent.getElementsByTagName("input")[1].value;
        input3 =  trParent.getElementsByTagName("input")[2].value;
        input4 =  trParent.getElementsByTagName("input")[3].value;

        targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=item]');
        targetElem[selectedRowIndex].querySelectorAll('input')[0].value = input1;
        targetElem[selectedRowIndex].querySelectorAll('input')[1].value = input3;
        // targetElem[selectedRowIndex].querySelectorAll('input')[2].value = input3;
        // targetElem[selectedRowIndex].querySelectorAll('input')[3].value = input4;
      }

      // Get the corresponding elem in other tables
      // let targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=item]');
      // targetElem[selectedRowIndex].querySelectorAll('input')[0].value = inputVal;

    }

    // Synchronize additional items between tables
    function syncAdditional(elem){
      // console.log(elem)
      let inputVal = elem.value
      console.log(elem.value)

      var trParent = findAscendingTag(elem, "TR");
      var tbodyParent = findAscendingTag(elem, "TBODY");

      // Get the id of table a layer above.
      let activeTableId = tbodyParent.parentNode.id;

      // let selectedRowIndex = tbodyParent.index(trParent)
      let selectedRowIndex = [].slice.call(tbodyParent.querySelectorAll('tr')).indexOf(trParent)
      console.log(trParent)
      console.log(tbodyParent)
      // console.log([].slice.call(tbodyParent.querySelectorAll('tr')).indexOf(trParent))
      console.log(selectedRowIndex)
      console.log(activeTableId)

      let targetTableId = (activeTableId === 'tableAdditionalItem')? 'tableAdditionalItemAdv' : 'tableAdditionalItem';

      // Get the corresponding elem in other tables
      let targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=additional]');
      // console.log(document.getElementById(targetTableId).children[1])
      // console.log(document.getElementById(targetTableId).children[1].querySelectorAll('tr[class=item]').length)
      console.log(targetElem)

      // Get the inputs value and sync to corresponding elem in other tables
      let input1 =  trParent.getElementsByTagName("input")[0].value;
      let input2 =  trParent.getElementsByTagName("input")[1].value;
      console.log(input1, input2)

      targetElem[selectedRowIndex].querySelectorAll('input')[0].value = input1;
      targetElem[selectedRowIndex].querySelectorAll('input')[1].value = input2;

    }

    // Remove an item
    function removeRow(elem){

      // Get the tr parents where the remove is clicked
      var trParent = findAscendingTag(elem, "TR");

      // Get the body ele of TR tag the remove is clicked
      var tbodyParent = findAscendingTag(elem, "TBODY");

      // Get the id of table a layer above.
      let activeTableId = tbodyParent.parentNode.id;

      // Get the index of the TR tag with 'item' class.
      let selectedRowIndex = [].slice.call(tbodyParent.querySelectorAll('tr[class=item], tr[class=additional]')).indexOf(trParent)
      console.log(trParent)
      console.log(tbodyParent)
      console.log(selectedRowIndex)
      console.log(activeTableId)
      console.log([].slice.call(tbodyParent.querySelectorAll('tr[class=item], tr[class=additional]')))
      // console.log(tbodyParent.querySelectorAll('.item'))


      // Get the existing table id and indentify the correspond table id. Same goes to tables for additional items
      // Get the corresponding TR elem in other tables
      // let targetTableId = (activeTableId === 'tableSimple')? 'tableAdv' : 'tableSimple';

      let targetTableId='';
      let targetElem = null;
      if (activeTableId === 'tableSimple'){
        targetTableId = 'tableAdv';
        targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=item], tr[class=additional]');

      }else if(activeTableId === 'tableAdv'){
        targetTableId = 'tableSimple';
        targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=item], tr[class=additional]');
      }
      else if(activeTableId === 'tableAdditionalItem'){
        targetTableId = 'tableAdditionalItemAdv';
        targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=item], tr[class=additional]');
      }
      else if(activeTableId === 'tableAdditionalItemAdv'){
        targetTableId = 'tableAdditionalItem';
        targetElem = document.getElementById(targetTableId).querySelectorAll('tr[class=item], tr[class=additional]');
      }

      // console.log(targetElem)

      // Remove the active rows
      trParent.remove();

      // Remove the corresponding rows
      targetElem[selectedRowIndex].remove();

    }

    function assignDraggableWithElem( elem){
      elem.querySelectorAll('tr').forEach(function (row, index) {
        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
            return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // console.log(row)
        // console.log(row.className)
        const firstCell = row.firstElementChild;
        firstCell.classList.add('draggable');
        firstCell.addEventListener('mousedown', mouseDownHandler);
      });
    }


    // Copy a text based on element ID
    function copyText(targetElemId){
      /* Get the text field */
      let copyText = document.getElementById(targetElemId);
      // console.log(copyText)
      // console.log(copyText.select())
      /* Select the text field */
      copyText.focus();
      copyText.select();
      copyText.setSelectionRange(0, 99999); /* For mobile devices */

      /* Copy the text inside the text field */
      navigator.clipboard.writeText(copyText.value);

    }


    // Get the payslip data and return in standard payroll format
    function getPayslipData(cardId){

      // Payslip Data Format
      // [0] TYPE:SIMPLE/ADVANCED
      // [1] ITEM
      // [...]
      // [M] GROSS
      // [N] ADDITIONAL_ITEM
      // [...]
      // [Z] NET

      let payItemsArr = [];

      // Get the length of the item header to determine if simple or advanced template used.
      let itemHeaderTrEleArr = document.getElementById('thead_item_'+cardId).querySelectorAll('tr');
      let itemHeaderTdEleLength = itemHeaderTrEleArr[0].querySelectorAll('th').length;
      // console.log(itemHeaderTdEleLength);

      // Get the item nodelist
      let itemTrEleArr = document.getElementById('tbody_item_'+cardId).querySelectorAll('tr.item');

      // Var used for gross and net pay
      let grossEarning = 0;
      let grossEarningText = ''
      let grossEarningAdv = 0;
      let grossEarningTextAdv = ''

      if (itemHeaderTdEleLength === 5 ){
        payItemsArr.push('ADVANCED');
        payItemsArr.push('ITEM');
        // Advanced
        itemTrEleArr.forEach(function (row, index) {

          // Calculate the subtotal amount
          let item = row.getElementsByTagName("td")[0].textContent; // Unused: Input
          let quantity = isNaN(parseFloat(row.getElementsByTagName("td")[1].textContent)) ? "" : parseFloat(row.getElementsByTagName("td")[1].textContent);
          let amount = isNaN(parseFloat(row.getElementsByTagName("td")[2].textContent)) ? "" : parseFloat(row.getElementsByTagName("td")[2].textContent);
          let payout = isNaN(parseFloat(row.getElementsByTagName("td")[3].textContent)) ? "" : parseFloat(row.getElementsByTagName("td")[3].textContent);

          payItemsArr.push(item+';; '+ quantity+';; '+  amount+';; '+  payout)
        });

        payItemsArr.push('GROSS');
        payItemsArr.push('ADDITIONAL_ITEM');

        let itemTrAddEleArr = document.getElementById('tbody_additem_'+cardId).querySelectorAll('tr.additional');
        itemTrAddEleArr.forEach(function (row, index) {

          // Calculate the subtotal amount
          let selector = row.getElementsByTagName("td")[3].getAttribute('data-selector');
          let item = row.getElementsByTagName("td")[3].getAttribute('data-item');
          let value = row.getElementsByTagName("td")[3].getAttribute('data-value');
          let textcontent = row.getElementsByTagName("td")[3].textContent; // Unused: Input

          let amount = row.getElementsByTagName("td")[4].textContent; // Unused: Input


          // let quantity = parseFloat(row.getElementsByTagName("td")[1].textContent);
          // let amount = parseFloat(row.getElementsByTagName("td")[2].textContent);
          // let payout = parseFloat(row.getElementsByTagName("td")[3].textContent);

          payItemsArr.push(selector+';; '+ item+';; '+  value+';; '+  null)
        });

        payItemsArr.push('NET');

        return payItemsArr;

      }
      else {
        // Simple
        payItemsArr.push('SIMPLE');
        payItemsArr.push('ITEM');

        itemTrEleArr.forEach(function (row, index) {

          // Calculate the subtotal amount
          let item = row.getElementsByTagName("td")[0].textContent; // Unused: Input
          let amount = parseFloat(row.getElementsByTagName("td")[1].textContent);

          payItemsArr.push(item+';; ' + null + ';; ' + amount+';; '+ null);
        });

        payItemsArr.push('GROSS');
        payItemsArr.push('ADDITIONAL_ITEM');

        let itemTrAddEleArr = document.getElementById('tbody_additem_'+cardId).querySelectorAll('tr.additional');
        itemTrAddEleArr.forEach(function (row, index) {

          // Calculate the subtotal amount
          let selector = row.getElementsByTagName("td")[1].getAttribute('data-selector');
          let item = row.getElementsByTagName("td")[1].getAttribute('data-item');
          let value = row.getElementsByTagName("td")[1].getAttribute('data-value');
          let textcontent = row.getElementsByTagName("td")[1].textContent; // Unused: Input

          let amount = row.getElementsByTagName("td")[2].textContent; // Unused: Input


          // let quantity = parseFloat(row.getElementsByTagName("td")[1].textContent);
          // let amount = parseFloat(row.getElementsByTagName("td")[2].textContent);
          // let payout = parseFloat(row.getElementsByTagName("td")[3].textContent);

          payItemsArr.push(selector+';; '+ item+';; '+  value+';; '+  null)
        });

        payItemsArr.push('NET');

        return payItemsArr;

      }


    }

    // Load the payslip modal with data
    function loadPayslipModal(payslipDataArr){

      // Print Items & Additional Items
      let itemStartIndex= payslipDataArr.indexOf('ITEM');
      let subtotalStartIndex= payslipDataArr.indexOf('GROSS');
      let additionalItemStartIndex= payslipDataArr.indexOf('ADDITIONAL_ITEM');
      let totalStartIndex= payslipDataArr.indexOf('NET');

      console.log(itemStartIndex, additionalItemStartIndex, subtotalStartIndex, totalStartIndex)

      let type = payslipDataArr[0];
      let item = payslipDataArr.slice(itemStartIndex+1, subtotalStartIndex); //+1 to ignore the first indentifier
      let subTotal = payslipDataArr[subtotalStartIndex+1];
      let additionalItem = payslipDataArr.slice(additionalItemStartIndex+1, totalStartIndex); //+1 to ignore the first indentifier
      let total = payslipDataArr[totalStartIndex+1];

      // Clear the rows and preview
      clearItems();

      // Print Items
      //.reverse() to make sure we print from the last -> first
      item.reverse().forEach(function (row){
        // console.log(row)
        let components = row.split(";; ");
        // desc, quantity, Amount, Payout
        renderAllPayslipItemsManual(components[0], components[1], components[2], components[3]);

        // printItem(components[0], components[1], components[2], components[3]);
        // console.log(components[0], components[1], components[2], components[3]);
      });


      // Print Additional Items
      //.reverse() to make sure we print from the last -> first
      additionalItem.reverse().forEach(function (row){
        // console.log(row)
        let components = row.split(";; ");
        // selector, item, value
        renderAllInvoiceAdditionalItemsManual(components[0], components[1], components[2])


        console.log(components[0], components[1], components[2], components[3]);
      });

      if (type == 'ADVANCED'){
        document.getElementById('advanced_check').checked = true;
        // showAdvancedColumns(this);
        $('#viewSimple').css('display', 'none');
        $('#viewAdv').css('display', '');
        calculateAmount();
      }else{
        // SIMPLE
        document.getElementById('advanced_check').checked = false;

        $('#viewSimple').css('display', '');
        $('#viewAdv').css('display', 'none');
        calculateAmount();
      }


    }

    // Edit Payslip modal: Render class components with manual input
    function renderAllPayslipItemsManual(desc, quantity, amount, payout){
      // <tr class="item">
      //   <td><i class="fas fa-grip-vertical"></i></td>
      //   <td><input type="text" class="form-control" style="border: solid #2e74b6 thin; padding-left: 0.5rem;" placeholder=" Enter item and description" oninput="sync(this);"></td>
      //   <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="sync(this); calculateAmount();"></td>
      //   <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="sync(this); calculateAmount();"></td>
      //   <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="sync(this); calculateAmount();"></td>
      //   <td style="text-align: right;"></td>
      //   <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeRow(this); calculateAmount();"></i></td>
      // </tr>

      let td1_html = '';
      td1_html = "<i class='fas fa-grip-vertical'></i>";
      let td1 = document.createElement('td');
      td1.innerHTML = td1_html;

      let td2_html = '';
      td2_html = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; padding-left: 0.5rem;' placeholder='Enter item and description' value='"+ desc +"' onclick='sync(this);'>";
      let td2 = document.createElement('td');
      td2.innerHTML = td2_html;

      let td3_html = '';
      td3_html = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' oninput='sync(this); calculateAmount();' value='"+ parseFloat(quantity) +"'>";
      let td3 = document.createElement('td');
      td3.innerHTML = td3_html;

      let td4_html = '';
      td4_html = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' oninput='sync(this); calculateAmount();' value='"+ parseFloat(amount) +"'>";
      let td4 = document.createElement('td');
      td4.innerHTML = td4_html;

      let td5_html = '';
      td5_html = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' oninput='sync(this); calculateAmount();' value='"+ parseFloat(payout) +"'>";
      let td5 = document.createElement('td');
      td5.innerHTML = td5_html;

      let td6 = document.createElement('td');
      td6.setAttribute('style', "text-align: right;");

      let td7_html = '';
      td7_html = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeRow(this); calculateAmount(this);'></i>";
      let td7 = document.createElement('td');
      td7.innerHTML = td7_html;

      // TR Adv top
      let trAdv = document.createElement('tr');
      trAdv.className = 'item';
      trAdv.appendChild(td1);
      trAdv.appendChild(td2);
      trAdv.appendChild(td3);
      trAdv.appendChild(td4);
      trAdv.appendChild(td5);
      trAdv.appendChild(td6);
      trAdv.appendChild(td7);

      const itemBodyAdv = document.getElementById('itemBodyAdv');
      itemBodyAdv.insertBefore(trAdv, itemBodyAdv.children[0])

      // TR Simple top
      td1_clone = td1.cloneNode(true);
      td2_clone = td2.cloneNode(true);
      td3_clone = td3.cloneNode(true);
      td4_clone = td4.cloneNode(true);
      td5_clone = td5.cloneNode(true);
      td6_clone = td6.cloneNode(true);
      td7_clone = td7.cloneNode(true);

      let tr = document.createElement('tr');
      tr.className = 'item';
      tr.appendChild(td1_clone);
      tr.appendChild(td2_clone);
      tr.appendChild(td4_clone);
      tr.appendChild(td6_clone);
      tr.appendChild(td7_clone);

      const itemBody = document.getElementById('itemBody');
      itemBody.insertBefore(tr, itemBody.children[0])

    }

    // Render additional item with manual input
    function renderAllInvoiceAdditionalItemsManual(selector, item, value){
    // <tr class="additional">
    //   <td></td>
    //   <td></td>
    //   <td style="text-align: right;">
    //     <div class="dropdown">
    //       <a class="btn btn-primary dropdown-toggle bg-white text-dark text-right" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="text-transform: none; padding: 0.6rem; margin: 0;">Select one</a>
    //       <div class="dropdown-menu" aria-labelledby="SortBy" id="sort-dropdown-menu">
    //         <a class="dropdown-item" href="javascript:;" onclick="disabledAdditionalItem(this); calculateAmount();" style="text-transform: none;">Select one</a>
    //         <a class="dropdown-item" href="javascript:;" onclick="enabledAdditionalItem(this, 'Earning'); calculateAmount();" style="text-transform: none;">Earning ( + )</a>
    //         <a class="dropdown-item" href="javascript:;" onclick="enabledAdditionalItem(this, 'Discount'); calculateAmount();" style="text-transform: none;">Discount ( - )</a>
    //       </div>
    //     </div>
    //   </td>
    //   <td><input type="text" class="form-control" style="border: solid #2e74b6 thin; text-align: right; padding-right: 1rem;" placeholder='Item' oninput='syncAdditional(this);' readonly></td>
    //   <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="0" oninput="syncAdditional(this); calculateAmount();" readonly></td>
    //   <td style="text-align: right;"></td>
    //   <td></td>
    // </tr>

      let td1 = document.createElement('td');
      let td2 = document.createElement('td');

      let dropdown_select = document.createElement('a');
      dropdown_select.className = 'dropdown-item';
      dropdown_select.textContent = 'Select one';
      dropdown_select.setAttribute('href', 'javascript:;');
      dropdown_select.setAttribute('style', 'text-transform: none;');
      dropdown_select.setAttribute('onclick', "disabledAdditionalItem(this); calculateAmount();");
      let dropdown_earning = document.createElement('a');
      dropdown_earning.className = 'dropdown-item';
      dropdown_earning.textContent = 'Earning ( + )';
      dropdown_earning.setAttribute('href', 'javascript:;');
      dropdown_earning.setAttribute('style', 'text-transform: none;');
      dropdown_earning.setAttribute('onclick', "enabledAdditionalItem(this, 'Earning'); calculateAmount();");
      let dropdown_discount = document.createElement('a');
      dropdown_discount.className = 'dropdown-item';
      dropdown_discount.textContent = 'Discount ( - )';
      dropdown_discount.setAttribute('href', 'javascript:;');
      dropdown_discount.setAttribute('style', 'text-transform: none;');
      dropdown_discount.setAttribute('onclick', "enabledAdditionalItem(this, 'Discount'); calculateAmount();");
      let dropdown = document.createElement('div');
      dropdown.className = 'dropdown-menu';
      dropdown.appendChild(dropdown_select);
      dropdown.appendChild(dropdown_earning);
      dropdown.appendChild(dropdown_discount);
      let dropdown_btn = document.createElement('a');
      dropdown_btn.className = 'btn btn-primary dropdown-toggle bg-white text-dark text-right';
      dropdown_btn.type = 'Button';

      dropdown_btn.textContent = selector;
      dropdown_btn.setAttribute('style', 'text-transform: none; padding: 0.6rem; margin: 0;');
      dropdown_btn.setAttribute('data-toggle', 'dropdown');
      dropdown_btn.setAttribute('aria-haspopup', 'true');
      dropdown_btn.setAttribute('aria-expanded', 'false');
      let dropdown_top = document.createElement('div');
      dropdown_top.className = 'dropdown';
      dropdown_top.appendChild(dropdown_btn);
      dropdown_top.appendChild(dropdown);

      let td3 = document.createElement('td');
      td3.setAttribute('style', "text-align: right");
      td3.appendChild(dropdown_top);

      let td4_html = '';
      td4_html = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; text-align: right; padding-right: 1rem;' oninput=''placeholder='Item' value='" + item +"'>";
      let td4 = document.createElement('td');
      td4.innerHTML = td4_html;

      let td5_html = '';
      td5_html = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;'  oninput='calculateAmount();' value='"+ parseFloat(value)+"'>";
      let td5 = document.createElement('td');
      td5.innerHTML = td5_html;

      let td6 = document.createElement('td');
      td6.setAttribute('style', "text-align: right;");

      let td7_html = '';
      td7_html = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeRow(this); calculateAmount();'></i>";
      let td7 = document.createElement('td');
      td7.innerHTML = td7_html;

      // TR top
      let trAdv = document.createElement('tr');
      trAdv.className = 'additional';
      trAdv.appendChild(td1);
      trAdv.appendChild(td2);
      trAdv.appendChild(td3);
      trAdv.appendChild(td4);
      trAdv.appendChild(td5);
      trAdv.appendChild(td6);
      trAdv.appendChild(td7);

      const additionalItemBodyAdv = document.getElementById('additionalItemBodyAdv');
      additionalItemBodyAdv.insertBefore(trAdv, additionalItemBodyAdv.children[0])
      // itemBody.appendChild(trAdv);

      // TR Simple top
      td1_clone = td1.cloneNode(true);
      td2_clone = td2.cloneNode(true);
      td3_clone = td3.cloneNode(true);
      td4_clone = td4.cloneNode(true);
      td5_clone = td5.cloneNode(true);
      td6_clone = td6.cloneNode(true);
      td7_clone = td7.cloneNode(true);

      let tr = document.createElement('tr');
      tr.className = 'additional';
      tr.appendChild(td3_clone);
      tr.appendChild(td4_clone);
      tr.appendChild(td5_clone);
      tr.appendChild(td6_clone);
      tr.appendChild(td7_clone);

      const additionalItemBody = document.getElementById('additionalItemBody');
      additionalItemBody.insertBefore(tr, additionalItemBody.children[0])

    }

    // Clear & Reset the items in Payslip modal
    function clearItems(){
      let itemBody = document.getElementById('itemBody');
      itemBody.querySelectorAll('tr[class=item]').forEach(function (row, index) {
        row.remove();
      });

      let itemBodyAdv = document.getElementById('itemBodyAdv');
      itemBodyAdv.querySelectorAll('tr[class=item]').forEach(function (row, index) {
        row.remove();
      });

      let additionalItemBody = document.getElementById('additionalItemBody');
      additionalItemBody.querySelectorAll('tr.additional').forEach(function (row, index) {
        row.remove();
      });

      let additionalItemBodyAdv = document.getElementById('additionalItemBodyAdv');
      additionalItemBodyAdv.querySelectorAll('tr.additional').forEach(function (row, index) {
        row.remove();
      });

      // Add back a default additional item.
      addAdditionalRow2();
    }


    // Save payslip data.
    function savePayslipModal(cardId){

      // document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=title]')[0].textContent = document.getElementById("editPayslipEmployeeTitle").value;

      printPreview(cardId);

    }

    // Print Preview
    function printPreview(cardId){
      // Clear unnecessary items first.
      // Remove item table header TR.
      document.getElementById("thead_item_"+cardId).querySelectorAll('tr').forEach(function (row, index){
        row.remove();
      });

      // Remove all item and gross pay.
      document.getElementById("tbody_item_"+cardId).querySelectorAll('tr').forEach(function (row, index){
        row.remove();
      });

      // Remove additonal item table header TR.
      document.getElementById("thead_additem_"+cardId).querySelectorAll('tr').forEach(function (row, index){
        row.remove();
      });

      // Remove all additional items in add table
      document.getElementById("tbody_additem_"+cardId).querySelectorAll('tr[class=additional]').forEach(function (row, index){
        row.remove();
      });


      // Check if advanced or simple
      if (document.getElementById('advanced_check').checked){

        // Render the adv table template (table header, gross pay, and table additional header)
        renderTableAdvTemplate(cardId)

        // Get the item nodeList in tableAdv in EditPayslipModal. Reverse the nodeList so we can print them orderly, from top to bottom.
        let nodelist = [].slice.call(tableAdv.querySelectorAll('tr'), 0).reverse();
        nodelist.forEach(function (row, index) {
          // Ignore the header
          // We don't want user to change the order of header
          if (index === 0) {
            return;
          }
          // Ignore row with class name other than 'item'
          else if(row.className != 'item'){
            return;
          }

          // Get the value of each item row
          let desc = row.children[1].getElementsByTagName("input")[0].value;
          let quantity = row.children[2].getElementsByTagName("input")[0].value;
          let price = row.children[3].getElementsByTagName("input")[0].value;
          let payout = row.children[4].getElementsByTagName("input")[0].value;

          let amount = row.children[5].textContent;
          // console.log(desc, quantity, price, payout, amount);

          // printItem(desc, quantity, price, payout, amount);
          // Generate the item
          let payslipItemData={
            tutor_id: cardId,
            item: desc,
            quantity: quantity,
            price: price,
            payout: payout,
          }

          // Render the paylip items to tutor view
          // console.log(payslipItemData)
          renderAllPayslipItemsAdv(payslipItemData);

        });

        let grossPay = calculateGrossPayDuringInit(cardId);
        // console.log('grossPay: '+grossPay);
        // Get the additem nodeList in tableAdditionalItemAdv in EditPayslipModal.
        // Reverse the nodeList so we can print them orderly, from top to bottom.
        let nodelistAddItem = [].slice.call(tableAdditionalItemAdv.querySelectorAll('tr.additional'), 0).reverse();

        // console.log(tableAdditionalItemAdv.querySelectorAll('tr.additional'));
        nodelistAddItem.forEach(function (row, index) {

          // Get the value of each additional item row
          let additionalSelector = row.children[2].getElementsByTagName("a")[0].textContent;
          let additionalItem = row.children[3].getElementsByTagName("input")[0].value;
          let additionalItemValue = row.children[4].getElementsByTagName("input")[0].value;
          let amount = row.children[5].textContent;

          // Generate the additional item
          let payslipItemData={
            tutor_id: cardId,
            item: additionalItem,
            quantity: 0,
            price: additionalItemValue,
            payout: 0,
            selector: additionalSelector,
          }

          if (additionalSelector === 'Select one'){
            // Do nothing
          }
          else if ((additionalSelector === 'Earning ( + )') || (additionalSelector === 'Discount ( - )')){

            renderAllPayslipAdditionalItemsAdv(payslipItemData);
          }
          else
          {
            // Do nothing
          }
        });

        // Calculate Net Pay
        calculateNetPayDuringInit(cardId, grossPay);

      }
      else {

        // Render the adv table template (table header, gross pay, and table additional header)
        renderTableTemplate(cardId)

        // Get the item nodeList in tableAdv in EditPayslipModal. Reverse the nodeList so we can print them orderly, from top to bottom.
        let nodelist = [].slice.call(tableSimple.querySelectorAll('tr'), 0).reverse();
        nodelist.forEach(function (row, index) {
          // Ignore the header
          // We don't want user to change the order of header
          if (index === 0) {
            return;
          }
          // Ignore row with certain class name
          else if(row.className != 'item'){
            return;
          }

          // Get the value of each item row
          let desc = row.children[1].getElementsByTagName("input")[0].value;
          let price = row.children[2].getElementsByTagName("input")[0].value;
          let amount = row.children[3].textContent;
          console.log(desc, price, amount);

          // Generate the item
          let payslipItemData={
            tutor_id: cardId,
            item: desc,
            quantity: '',
            price: price,
            payout: '',
          }
          renderAllPayslipItems(payslipItemData);

        });

        let grossPay = calculateGrossPayDuringInit(cardId);
        // console.log('grossPay: '+grossPay);


        let nodelistAddItem = [].slice.call(tableAdditionalItem.querySelectorAll('tr.additional'), 0).reverse();
        // console.log('grossPay: '+nodelistAddItem);
        nodelistAddItem.forEach(function (row, index) {

          // Get the value of each additional item row
          let additionalSelector = row.children[0].getElementsByTagName("a")[0].textContent;
          let additionalItem = row.children[1].getElementsByTagName("input")[0].value;
          let additionalItemValue = row.children[2].getElementsByTagName("input")[0].value;
          let amount = row.children[3].textContent;

          // Generate the item
          let payslipItemData={
            tutor_id: cardId,
            item: additionalItem,
            quantity: '',
            price: additionalItemValue,
            payout: '',
            selector: additionalSelector,
          }

          if (additionalSelector === 'Select one'){
            // Do nothing
          }
          else if ((additionalSelector === 'Earning ( + )') || (additionalSelector === 'Discount ( - )')){
            renderAllPayslipAdditionalItems(payslipItemData);
          }
          else
          {
            // Do nothing
          }

        });

        // Calculate Net Pay
        calculateNetPayDuringInit(cardId, grossPay);

      }

    }

    function printItem(desc, quantity, price, amount){
      // <tr class="item">
      //   <td style="font-size: small;"></td>
      //   <td style="text-align: right; font-size: small;"></td>
      //   <td style="text-align: right; font-size: small;"></td>
      //   <td style="text-align: right; font-size: small;"></td>
      // </tr>

      let td1 = document.createElement('td');
      td1.setAttribute('style', "font-size: small;");
      td1.textContent = desc

      let td2 = document.createElement('td');
      td2.setAttribute('style', "text-align: right; font-size: small;");
      td2.textContent = quantity

      let td3 = document.createElement('td');
      td3.setAttribute('style', "text-align: right; font-size: small;");
      td3.textContent = price

      let td4 = document.createElement('td');
      td4.setAttribute('style', "text-align: right; font-size: small;");
      td4.textContent = amount

      // Tr top
      let tr = document.createElement('tr');
      tr.className = 'item';
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);

      const previewItemBody = document.getElementById('previewItemBody');
      const previewItemSubtotal = document.getElementById('previewItemSubtotal');
      previewItemBody.insertBefore(tr, previewItemSubtotal)
      // previewItemBody.insertBefore('#previewItemBody tr:nth-last-child(2)')
      // $( "#previewItemBody tr:nth-last-child(2)" ).append(tr);

      // previewItemBody.appendChild(tr);
    }


    function printAdditionalItem(additionalItem, amount){
    // <tr class="additional">
    //   <td></td>
    //   <td></td>
    //   <td style="text-align: right; font-size: small;"></td>
    //   <td style="text-align: right; font-size: small;"></td>
    // </tr>

      let td1 = document.createElement('td');
      let td2 = document.createElement('td');
      let td3 = document.createElement('td');
      td3.setAttribute('style', "text-align: right; font-size: small;");
      td3.textContent = additionalItem

      let td4 = document.createElement('td');
      td4.setAttribute('style', "text-align: right; font-size: small;");
      td4.textContent = amount

      // Tr top
      let tr = document.createElement('tr');
      tr.className = 'additional';
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);

      const previewAdditionalItemBody = document.getElementById('previewAdditionalItemBody');
      // const previewItemSubtotal = document.getElementById('previewItemSubtotal');
      previewAdditionalItemBody.appendChild(tr);
    }


    // Preview payslip data.
    function previewPayslip(cardId, payslipDataArr){
     // Clear unnecessary items first.
      // Remove item table header TR.
      document.getElementById("thead_item_"+cardId).querySelectorAll('tr').forEach(function (row, index){
        row.remove();
      });

      // Remove all item and gross pay.
      document.getElementById("tbody_item_"+cardId).querySelectorAll('tr').forEach(function (row, index){
        row.remove();
      });

      // Remove additonal item table header TR.
      document.getElementById("thead_additem_"+cardId).querySelectorAll('tr').forEach(function (row, index){
        row.remove();
      });

      // Remove all additional items in add table
      document.getElementById("tbody_additem_"+cardId).querySelectorAll('tr[class=additional]').forEach(function (row, index){
        row.remove();
      });


      // Print Items & Additional Items
      let itemStartIndex= payslipDataArr.indexOf('ITEM');
      let subtotalStartIndex= payslipDataArr.indexOf('GROSS');
      let additionalItemStartIndex= payslipDataArr.indexOf('ADDITIONAL_ITEM');
      let totalStartIndex= payslipDataArr.indexOf('NET');

      console.log(itemStartIndex, additionalItemStartIndex, subtotalStartIndex, totalStartIndex)

      let type = payslipDataArr[0];
      let item = payslipDataArr.slice(itemStartIndex+1, subtotalStartIndex); //+1 to ignore the first indentifier
      let subTotal = payslipDataArr[subtotalStartIndex+1];
      let additionalItem = payslipDataArr.slice(additionalItemStartIndex+1, totalStartIndex); //+1 to ignore the first indentifier
      let total = payslipDataArr[totalStartIndex+1];

      let advanced = type === 'ADVANCED';
      let grossPay = 0;

      if (advanced){
        // Render the adv table template (table header, gross pay, and table additional header)
        renderTableAdvTemplate('preview')

        // Advanced Template
        item.reverse().forEach((document) => {
          let component = document.split(";; ");

          let payslipItemData={
            tutor_id: 'preview',
            item: component[0],
            quantity: component[1],
            price: component[2],
            payout: component[3],
          }

          renderAllPayslipItemsAdv(payslipItemData);

        });

        // Print Additional Items
        //.reverse() to make sure we print from the last -> first
        additionalItem.reverse().forEach((document) => {

          let component = document.split(";; ");
          // Generate the additional item
          let payslipItemData={
            tutor_id: 'preview',
            item: component[1],
            quantity: 0,
            price: component[2],
            payout: 0,
            selector: component[0],
          }
          renderAllPayslipAdditionalItemsAdv(payslipItemData);

        });

        // Calculate Gross & Net Pay
        grossPay = calculateGrossPayDuringInit('preview');
        calculateNetPayDuringInit('preview', grossPay);

      }
      else{
        // Generate simple empty payslip
        renderTableTemplate('preview');

        // Print Items
        // Simple Template
        item.reverse().forEach((document) => {
          let component = document.split(";; ");

          let payslipItemData={
            tutor_id: 'preview',
            item: component[0],
            quantity: component[1],
            price: component[2],
            payout: component[3],
          }

          console.log(payslipItemData);

          renderAllPayslipItems(payslipItemData);

        });

        // Print Additional Items
        //.reverse() to make sure we print from the last -> first
        additionalItem.reverse().forEach((document) => {

        let component = document.split(";; ");
        // Generate the additional item
        let payslipItemData={
          tutor_id: 'preview',
          item: component[1],
          quantity: 0,
          price: component[2],
          payout: 0,
          selector: component[0],
        }
        renderAllPayslipAdditionalItems(payslipItemData);

        });

        // Calculate Gross & Net Pay
        grossPay = calculateGrossPayDuringInit('preview');
        calculateNetPayDuringInit('preview', grossPay);

      }

    }


    // Create / Update payslip, transaction and payroll
    function CreatePayslip(cardId){

      let title = document.getElementById(cardId).querySelectorAll('p[name=title]')[0].textContent;
      let refNo = document.getElementById(cardId).querySelectorAll('p[name=refNo]')[0].textContent;
      let date = document.getElementById(cardId).querySelectorAll('p[name=date]')[0].textContent;
      let receiver_name = document.getElementById(cardId).querySelectorAll('p[name=name]')[0].textContent;
      let receiver_position = document.getElementById(cardId).querySelectorAll('p[name=position]')[0].textContent;
      let receiver_epf = document.getElementById(cardId).querySelectorAll('p[name=epf]')[0].textContent;
      let receiver_socso = document.getElementById(cardId).querySelectorAll('p[name=socso]')[0].textContent;
      let receiver_bankName = document.getElementById(cardId).querySelectorAll('p[name=bankName]')[0].textContent;
      let receiver_acNo = document.getElementById(cardId).querySelectorAll('p[name=acNo]')[0].textContent;

      let payslipData =  getPayslipData(cardId)
      let grossPay = calculateGrossPayDuringInit(cardId);

      let netPay =  calculateNetPayDuringInit(cardId, grossPay);

      // console.log(grossPay, netPay)

      // Payslip Date
      date = date.split("/");
      let newDate = new Date( date[2], date[1] - 1, date[0]);
      let finalDate = firebase.firestore.Timestamp.fromDate(newDate);
      // Payslip Sender Detail
      let bizDetail = '';
      bizDetail += (bizPhone == null || bizPhone == '') ? '' : bizPhone;
      bizDetail += (bizEmail == null || bizEmail == '') ? '' : ', ' + bizEmail;
      bizDetail += (bizAddr == null || bizAddr == '') ? '' : ', ' + bizAddr;

      // Check if the payslip existed

      let payDocId = '';
      let transDocId = '';

      // Local var to indicate if Create New Payslip(create) or Updated an existing payslip(update)
      let updateType = '';

      let payslipDocRef = db.collection("dev")
        .doc("v2")
        .collection("Payslip")
        .where(PAY_PAYROLL_ID, "==", payrollId)
        .where(PAY_RECEIVER_ID, "==", cardId);

      payslipDocRef
      .get()
      .then((querySnapshot) => {

        // Update button status
        document.getElementById('btnConfirmEmployeeModalUpdate').setAttribute('disabled', true);
        document.getElementById('btnConfirmEmployeeModalUpdate').textContent = "Almost done. Please wait ..."

        const promiseAll = [];

        let payrollDocRef = db.collection("dev")
          .doc("v2")
          .collection("Payroll")
          .doc(payrollId);

        if(querySnapshot.empty) {

          let payslipDocRef1 = db.collection("dev")
            .doc("v2")
            .collection("Payslip")
            .doc();

          let transDocRef = db.collection("dev")
            .doc("v2")
            .collection("Transaction")
            .doc();

          console.log("Empty, Create a new Payslip");

          payDocId = payslipDocRef1.id;

          transDocId = transDocRef.id;


          var data = {
            [PAY_ID]: payDocId,
            [PAY_SENDER_ID]: ent_id,
            [PAY_SENDER_NAME]: bizName,
            [PAY_SENDER_DETAILS]: bizDetail,
            [PAY_SENDER_IMG_URL]: bizImgUrl,

            [PAY_RECEIVER_ID]: cardId,
            [PAY_RECEIVER_NAME]: receiver_name,
            [PAY_RECEIVER_POSITION]: receiver_position,
            [PAY_RECEIVER_EPF]: receiver_epf,
            [PAY_RECEIVER_SOCSO]: receiver_socso,
            [PAY_RECEIVER_BANK_NAME]: receiver_bankName,
            [PAY_RECEIVER_AC_NO]: receiver_acNo,

            [PAY_TITLE]: title,
            [PAY_NUMBER]: refNo,
            [PAY_DATE]: finalDate,
            [PAY_PAY_STATUS]: PAY_STATUS_NEW,

            // Payslip Contents
            [PAY_ITEMS_ARR]: payslipData,
            [PAY_TOTAL]: netPay,

            [PAY_PAYMENT_DATE]: '',
            [PAY_PAYMENT_AMOUNT]: 0,
            [PAY_PAYMENT_NOTE]: '',

            [PAY_DATE_ADD]: new Date(),
            [PAY_DATE_EDIT]: '',
            [PAY_DATE_DEL]: '',
            [PAY_STATUS]: true,
            // Payroll Info
            [PAY_PAYROLL_ID]: payrollId,
            [PAY_PAYROLL_NAME]: payrollName,
            [PAY_TRANS_ID]:transDocId,
          }

          console.log("*Payslip Data...")
          console.log(data)


          var transData = {
            [TRANS_ID]: transDocId,
            [TRANS_DOC_ID]: payDocId,
            [TRANS_DOC_NUM]: refNo,
            [TRANS_SENDER_ID]: ent_id,
            [TRANS_RECEIVER_ID]: cardId,
            [TRANS_SENDER_NAME]: bizName,
            [TRANS_RECEIVER_NAME]: receiver_name,
            [TRANS_VIEWER_ARR]: [cardId, ent_id],
            [TRANS_DATE]: finalDate,
            [TRANS_TYPE]: TRANS_TYPE_PAY,
            [TRANS_DOC_STATUS] : TRANS_PAY_STATUS_NEW,
            [TRANS_TITLE]: title,
            [TRANS_TOTAL]: netPay,
            [TRANS_DATE_EDIT]: new Date(),
            [TRANS_STATUS]: true,
          }

          console.log("Transaction Data...")
          console.log(transData)

          payrollDocIdArr.push(payDocId);
          payrollDocTotalArr.push(netPay);

          // https://stackoverflow.com/questions/1230233/how-to-find-the-sum-of-an-array-of-numbers
          payrollTotal = payrollDocTotalArr.reduce((a, b) => a + b, 0)

          var payrollData = {
            // [PAYROLL_ID]: payrollId,
            // [PAYROLL_ADMIN_ID]: ent_id,
            // [PAYROLL_NAME]: payrollName,
            // [PAYROLL_DATE_START]: payrollStart,
            // [PAYROLL_DATE_END]: payrollEnd,
            [PAYROLL_DOC_ID_ARR]: payrollDocIdArr,
            [PAYROLL_DOC_TOTAL_ARR]: payrollDocTotalArr,
            [PAYROLL_TOTAL]: payrollTotal,
            // [PAYROLL_STATUS]: true,
          }
          console.log("Payroll Data...")
          console.log(payrollData);

          // Create Payslip
          // payslipDocRef1.set(data, { merge: true })
          // .then(() => {

          //   // Create Transaction
          //   transDocRef.set(transData, { merge: true })
          //   .then(() => {

          //     // Update Payroll
          //     payrollDocRef.set(payrollData, { merge: true })
          //     .then(() => {
          //       func.showNotification('top','center', 'success', 'check_circle', "Created new payslip." );
          //       SetPayslipUpdateStatus(true, cardId);
          //     });

          //   });


          // });

          promiseAll.push(payslipDocRef1.set(data, { merge: true }));
          promiseAll.push(transDocRef.set(transData, { merge: true }));
          promiseAll.push(payrollDocRef.set(payrollData, { merge: true }));

          updateType = 'create';
        }
        else {
          querySnapshot.forEach((doc) => {

            console.log("Payslip found, update exisiting payslip.");

            payDocId = doc.data()[PAY_ID];
            transDocId = doc.data()[PAY_TRANS_ID];

            let payslipDocRef1 = db.collection("dev")
              .doc("v2")
              .collection("Payslip")
              .doc(payDocId);

            let transDocRef = db.collection("dev")
              .doc("v2")
              .collection("Transaction")
              .doc(transDocId);


            var data = {
              // [PAY_ID]: payDocId,
              [PAY_SENDER_ID]: ent_id,
              [PAY_SENDER_NAME]: bizName,
              [PAY_SENDER_DETAILS]: bizDetail,
              [PAY_SENDER_IMG_URL]: bizImgUrl,

              [PAY_RECEIVER_ID]: cardId,
              [PAY_RECEIVER_NAME]: receiver_name,
              [PAY_RECEIVER_POSITION]: receiver_position,
              [PAY_RECEIVER_EPF]: receiver_epf,
              [PAY_RECEIVER_SOCSO]: receiver_socso,
              [PAY_RECEIVER_BANK_NAME]: receiver_bankName,
              [PAY_RECEIVER_AC_NO]: receiver_acNo,

              [PAY_TITLE]: title,
              [PAY_NUMBER]: refNo,
              [PAY_DATE]: finalDate,
              // [PAY_PAY_STATUS]: PAY_STATUS_NEW,

              // Payslip Contents
              [PAY_ITEMS_ARR]: payslipData,
              [PAY_TOTAL]: netPay,

              // [PAY_PAYMENT_DATE]: '',
              // [PAY_PAYMENT_AMOUNT]: 0,
              // [PAY_PAYMENT_NOTE]: '',

              // [PAY_DATE_ADD]: new Date(),
              [PAY_DATE_EDIT]: new Date(),
              // [PAY_DATE_DEL]: '',
              [PAY_STATUS]: true, // Some payslips maybe deleted, when updating these payslips, set True to make them visible again.

              // Payroll Info
              // [PAY_PAYROLL_ID]: payrollId,
              // [PAY_PAYROLL_NAME]: payrollName,
              // [PAY_TRANS_ID]:transDocId,
            }

            console.log("*Payslip Data...")
            console.log(data)


            var transData = {
              // [TRANS_ID]: transDocId,
              // [TRANS_DOC_ID]: payDocId,
              [TRANS_DOC_NUM]: refNo,
              [TRANS_SENDER_ID]: ent_id,
              [TRANS_RECEIVER_ID]: cardId,
              [TRANS_SENDER_NAME]: bizName,
              [TRANS_RECEIVER_NAME]: receiver_name,
              [TRANS_VIEWER_ARR]: [cardId, ent_id],
              [TRANS_DATE]: finalDate,
              // [TRANS_TYPE]: TRANS_TYPE_PAY,
              // [TRANS_DOC_STATUS] : TRANS_PAY_STATUS_NEW,
              [TRANS_TITLE]: title,
              [TRANS_TOTAL]: netPay,
              [TRANS_DATE_EDIT]: new Date(),
              [TRANS_STATUS]: true, // Some payslips maybe deleted, when updating these payslips, set True to make them visible again.
            }

            console.log("Transaction Data...")
            console.log(transData)

            // Get the index of the payslip doc no.
            let payslipDocIndex = payrollDocIdArr.indexOf(payDocId);
            // Remove the item and it's total in arrays
            if (payslipDocIndex > -1) {
              payrollDocIdArr.splice(payslipDocIndex, 1);
              payrollDocTotalArr.splice(payslipDocIndex, 1);
            }

            // push a new item and total into the arrays
            payrollDocIdArr.push(payDocId);
            payrollDocTotalArr.push(netPay);

            // Change the amount at the index
            // payrollDocTotalArr[payslipDocIndex] = netPay;

            // https://stackoverflow.com/questions/1230233/how-to-find-the-sum-of-an-array-of-numbers
            payrollTotal = payrollDocTotalArr.reduce((a, b) => a + b, 0)

            var payrollData = {
              // [PAYROLL_ID]: payrollId,
              // [PAYROLL_ADMIN_ID]: ent_id,
              // [PAYROLL_NAME]: payrollName,
              // [PAYROLL_DATE_START]: payrollStart,
              // [PAYROLL_DATE_END]: payrollEnd,
              [PAYROLL_DOC_ID_ARR]: payrollDocIdArr,
              [PAYROLL_DOC_TOTAL_ARR]: payrollDocTotalArr,
              [PAYROLL_TOTAL]: payrollTotal,
              // [PAYROLL_STATUS]: true,
            }
            console.log("Payroll Data...")
            console.log(payrollData);


            // Update Payslip
            // payslipDocRef1.set(data, { merge: true })
            // .then(() => {

            //   // Create Transaction
            //   transDocRef.set(transData, { merge: true })
            //   .then(() => {

            //     // Update Payroll
            //     payrollDocRef.set(payrollData, { merge: true })
            //     .then(() => {
            //       func.showNotification('top','center', 'success', 'check_circle', "Updated payslip." );
            //       SetPayslipUpdateStatus(true, cardId);
            //     });

            //   });


            // });

            promiseAll.push(payslipDocRef1.set(data, { merge: true }));
            promiseAll.push(transDocRef.set(transData, { merge: true }));
            promiseAll.push(payrollDocRef.set(payrollData, { merge: true }));

            updateType = 'update';
          });
        }

        return Promise.all(promiseAll);


      })
      .then(() => {

        // Notification
        if (updateType == 'create'){
          func.showNotification('top','center', 'success', 'check_circle', "Created new payslip." );
        } else if (updateType == 'update'){
          func.showNotification('top','center', 'success', 'check_circle', "Updated payslip." );
        }

        // Update button status
        document.getElementById('btnConfirmEmployeeModalUpdate').removeAttribute('disabled');
        document.getElementById('btnConfirmEmployeeModalUpdate').textContent = "Confirm";

        // Hide the model
        $('#confirmEmployeeModal').modal('hide');

        // Set the card status back to done.
        SetPayslipUpdateStatus(true, cardId);

      })
      .catch((error) => {
          console.log("Error getting document:", error);
      });

    }

    // Remove tutor's payslip, transaction and payroll
    function RemovePlayslip(cardId){

      let payDocId = '';
      let transDocId = '';

      let payslipDocRef = db.collection("dev")
        .doc("v2")
        .collection("Payslip")
        .where(PAY_PAYROLL_ID, "==", payrollId)
        .where(PAY_RECEIVER_ID, "==", cardId);


      payslipDocRef
      .get()
      .then((querySnapshot) => {

        let payrollDocRef = db.collection("dev")
          .doc("v2")
          .collection("Payroll")
          .doc(payrollId);

        if(querySnapshot.empty) {
          console.log("Empty payslip, Skipped");
          removeElementBasedOnId(cardId);
        }
        else
        {
          querySnapshot.forEach((doc) => {

            console.log("Payslip found, update exisiting payslip.");

            payDocId = doc.data()[PAY_ID];
            transDocId = doc.data()[PAY_TRANS_ID];

            let payslipDocRef1 = db.collection("dev")
              .doc("v2")
              .collection("Payslip")
              .doc(payDocId);

            let transDocRef = db.collection("dev")
              .doc("v2")
              .collection("Transaction")
              .doc(transDocId);


            var data = {
              [PAY_DATE_DEL]:  new Date(),
              [PAY_STATUS]: false,
            }

            var transData = {
              [TRANS_DATE_EDIT]: new Date(),
              [TRANS_STATUS]: false,
            }

            console.log("Transaction Data...")
            console.log(transData)

            // Get the index of the payslip doc no.
            let payslipDocIndex = payrollDocIdArr.indexOf(payDocId);

            // Remove the item and it's total in arrays
            if (payslipDocIndex > -1) {
              payrollDocIdArr.splice(payslipDocIndex, 1);
              payrollDocTotalArr.splice(payslipDocIndex, 1);
            }

            // https://stackoverflow.com/questions/1230233/how-to-find-the-sum-of-an-array-of-numbers
            payrollTotal = payrollDocTotalArr.reduce((a, b) => a + b, 0)

            var payrollData = {
              // [PAYROLL_ID]: payrollId,
              // [PAYROLL_ADMIN_ID]: ent_id,
              // [PAYROLL_NAME]: payrollName,
              // [PAYROLL_DATE_START]: payrollStart,
              // [PAYROLL_DATE_END]: payrollEnd,
              [PAYROLL_DOC_ID_ARR]: payrollDocIdArr,
              [PAYROLL_DOC_TOTAL_ARR]: payrollDocTotalArr,
              [PAYROLL_TOTAL]: payrollTotal,
              // [PAYROLL_STATUS]: true,
            }
            console.log("Payroll Data...")
            console.log(payrollData);

            // Update Payslip
            payslipDocRef1.set(data, { merge: true })
            .then(() => {

              // Create Transaction
              transDocRef.set(transData, { merge: true })
              .then(() => {

                // Update Payroll
                payrollDocRef.set(payrollData, { merge: true })
                .then(() => {
                  func.showNotification('top','center', 'success', 'check_circle', "Removed payslip." );
                  // SetPayslipUpdateStatus(true, cardId);
                  removeElementBasedOnId(cardId);
                });

              });


            });



          });
        }

      }).catch((error) => {
          console.log("Error getting document:", error);
      });

    }

    function checkNewEmployeeValidity(){
      // Get the existing list of cardId.
      // If similar phoneId used, ban the number.
      let existingCardList = document.getElementById('accordionTutor').querySelectorAll('div.card');
      let existingCardIdList = [];

      existingCardList.forEach((row, index) => {
        existingCardIdList.push(row.getAttribute('id'));
      });


      let inCustomEmployeeName = document.getElementById('inCustomEmployeeName').value;
      let inClientContactExist = existingCardIdList.includes(itiPhone.getNumber());
      let inClientContactValid = itiPhone.isValidNumber() && itiPhone.getNumber().length > 5;

      if (inCustomEmployeeName == null || inCustomEmployeeName =='' || inClientContactExist){
        document.getElementById('btnAddCustomEmployeeModalUpdate').setAttribute('disabled', true);
      }else if(!inClientContactValid) {
        document.getElementById('btnAddCustomEmployeeModalUpdate').setAttribute('disabled', true);
      }else{
        document.getElementById('btnAddCustomEmployeeModalUpdate').removeAttribute('disabled');
      }


    }

    function checkRecordPaymentModalFields(){

      let recordPaymentDate = document.getElementById('inPaymentDate').value;
      let recordPaymentAmount = document.getElementById('inPaymentAmount').value;

      if (recordPaymentDate == null || recordPaymentDate == '' || recordPaymentAmount == null || recordPaymentAmount == ''){
        document.getElementById('btnRecordPaymentModalUpdate').setAttribute('disabled', true);
      }
      else{
        document.getElementById('btnRecordPaymentModalUpdate').removeAttribute('disabled');
      }

    }


    function SetPayslipUpdateStatus(status, cardId){
      if (status){
        document.getElementById(cardId).querySelectorAll('i[name=update]')[0].className = 'fas fa-check-circle fa-lg';
      }
      else{
        document.getElementById(cardId).querySelectorAll('i[name=update]')[0].className = 'far fa-check-circle fa-lg';

      }

      // Update role view
      updateRoleView()
    }

    // Convert imgUrl to data
    function toDataURL(src, callback, outputFormat) {
      var img = new Image();
      // var img = document.getElementById("tutorImgUrl");
      var dataURL;
      img.crossOrigin = 'Anonymous';
      img.src = src;
      img.onload = function() {
        var canvas = document.createElement('CANVAS');
        var ctx = canvas.getContext('2d');

        canvas.height = this.naturalHeight;
        canvas.width = this.naturalWidth;
        ctx.drawImage(this, 0, 0);
        dataURL = canvas.toDataURL(outputFormat);
        // img.src = dataURL;
        // console.log(dataURL)
        var imgTarget = document.getElementById("previewTutorImgUrl");
        imgTarget.src = dataURL;
        callback(dataURL);
      };
      // img.src = src;
      // img.src = dataURL;
      if (img.complete || img.complete === undefined) {
        img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
        img.src = src;
      }
    }

    // Generate PDF
    // https://ekoopmans.github.io/html2pdf.js/
    function generatePDFeKoopmans(id){

      element = document.getElementById(id);

      var opt = {
        margin:       [0, 0, 0, 0],
        filename:     'myfile.pdf',
        pagebreak:    { before: '.beforeClass', after: ['#after1', '#after2'], avoid: 'img' },
        image:        { type: 'jpeg', quality: 0.95 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(element).save();
    }

    // This function check the validity of imgUrl. Return true when invalid.
    function tutorImgUrlChecker(imgUrl){
      // Tutor Panel
      let isHelloGifExist = false ;
      let helloGifArr =  imgUrl.match(/hello.gif/gi)
      if ( helloGifArr != null) {
        if (helloGifArr.length > 0){
          isHelloGifExist = true;
        }
      }
      let isEmptyPhotoPngExist = false;
      let emptyPhotoPngArr = imgUrl.match(/empty-photo.png/gi)
      if ( emptyPhotoPngArr != null) {
        if (emptyPhotoPngArr.length > 0){
          isEmptyPhotoPngExist = true;
        }
      }
      let isGeneratedAvatar = false;
      let generatedAvatarArr = imgUrl.match(/data:image\/png;base64,/gi)
      if ( generatedAvatarArr != null) {
        if (generatedAvatarArr.length > 0){
          isGeneratedAvatar = true;
        }
      }

      if (isHelloGifExist || isEmptyPhotoPngExist || isGeneratedAvatar)
        return true;
      else
        return false;
    }

    // Check correct time format and split into components
    function tConvert (time) {
      // 18:00:00 => "6:00:00PM"
      // 18:00 => "6:00PM"
      // 00:00 => "12:00AM"
      // 11:59:01 => "11:59:01AM"
      // 12:00:00 => "12:00:00PM"
      // 13:01:57 => "1:01:57PM"
      // 24:00 => "24:00"
      // sdfsdf => "sdfsdf"
      // 12:61:54 => "12:61:54"

      time = time.toString ().match (/^([01]\d|2[0-3])(:)([0-5]\d)(:[0-5]\d)?$/) || [time];

      if (time.length > 1) { // If time format correct
        time = time.slice (1);  // Remove full string match value
        time[5] = +time[0] < 12 ? 'AM' : 'PM'; // Set AM/PM
        time[0] = +time[0] % 12 || 12; // Adjust hours
      }
      return time.join (''); // return adjusted time or original string
    }

  </script>

  <script>

		$( document ).ready(function() {


      // Payroll Body specific

      $('#addRow').on( 'click', function () {
        addRow2();
      });

      $('#addAdditionalRow').on( 'click', function () {
        addAdditionalRow2();
      });

      $('#btnCreatePayrollModalUpdate').on( 'click', function () {

        CreatePayroll();

      });


      // Class Announcement
      // KEY, DATETIME, ID, JOB_STATUS and JOB_EXPLANATION var is global var used to simplify modal fire and hide.
      var KEY = ""; // Extract info from data-* attributes
      var DATETIME = ""; // Extract info from data-* attributes
      var ID = ""; // Extract info from data-* attributes
      var ANNOUNCEMENT = ""; // Extract info from data-* attributes

      var EMPLOYEE_CARD_ID = '';
      var EMPLOYEE_CARD_NAME = '';

      var PAYSLIP_CARD_ID = '';

      // Update Class Annoucement
      $('#btnEditClassModalUpdate').on('click', function (e) {
        var docData = {
          [CLASS_ANNOUNCEMENT]: document.getElementById("modalClassAnnouncement").value,
        }
        // Set data
        db.collection("dev")
          .doc("v2")
          .collection("Class")
          .doc(ID)
          .set(docData, {merge: true})
          .then(() => {
            window.location = './class.html';
          })
          .catch((error) => {
              console.error("Error writing document: ", error);
          });;

			  $('#editClassModal').modal('hide');
		  });

      $('#editClassModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) // Button/Components that triggered the modal
        ID = button.data('id') // Extract info from data-* attributes
        ANNOUNCEMENT = button.data('announcement') // Extract info from data-* attributes
        // Load Desription
        document.getElementById("modalClassAnnouncement").textContent = ANNOUNCEMENT;

      });

      // Clear key and fields in modal when modal dismiss
      $('#editClassModal').on('hide.bs.modal', function (event) {
        ID = "";
        ANNOUNCEMENT = "";
        document.getElementById("modalClassAnnouncement").textContent = "";
      });


      // Add a custome employee
      $('#btnAddCustomEmployeeModalUpdate').on('click', function (e) {

        let inCustomEmployeeId = itiPhone.getNumber();
        let inCustomEmployeeName = document.getElementById('inCustomEmployeeName').value;
        let inClientContact = itiPhone.getNumber();
        let inCustomEmployeePosition = document.getElementById('inCustomEmployeePosition').value;
        let inCustomBankName = document.getElementById('inCustomBankName').value;
        let inCustomBankAccNum = document.getElementById('inCustomBankAccNum').value;
        let inCustomEPF = document.getElementById('inCustomEPF').value;
        let inCustomSocso = document.getElementById('inCustomSocso').value;

        // console.log(inCustomEmployeeId, inCustomEmployeeName, inClientContact, inCustomEmployeePosition, inCustomBankName, inCustomBankAccNum,inCustomEPF, inCustomSocso)

        // Create data modal for Tutor Module
        let payslipData = {
          tutor_id: inCustomEmployeeId,
          name: inCustomEmployeeName,
          position: inCustomEmployeePosition,
          bankName: inCustomBankName,
          acNo: inCustomBankAccNum,
          epf: inCustomEPF,
          socso: inCustomSocso,
          payStatus: PAY_STATUS_NEW,
          title: 'Payslip For The Month Of '+ payrollDateMonth,
          payNo: '-',
          date: payrollDate,
        }

        // Generate placeholder new employee
        renderActiveTutorPlaceholder(payslipData);

        // Generate simple empty payslip
        renderTableTemplate(inCustomEmployeeId);

        let grossPay = calculateGrossPayDuringInit(inCustomEmployeeId);
        // document.getElementById("netpayview_"+cardId).value = netPayTextAdv;
        console.log('grossPay '+grossPay);
        calculateNetPayDuringInit(inCustomEmployeeId, grossPay);

      });

      // Add Employee modal clear fields
      $('#addCustomEmployeeModal').on('hide.bs.modal', function (e) {
        document.getElementById('inCustomEmployeeName').value = '';
        document.getElementById('inClientContact').value = '';
        document.getElementById('inCustomEmployeePosition').value = '';
        document.getElementById('inCustomBankName').value = '';
        document.getElementById('inCustomBankAccNum').value = '';
        document.getElementById('inCustomEPF').value = '';
        document.getElementById('inCustomSocso').value = '';
      });



      // Edit Payslip Modal View
      $('#editPayslipModal').on('show.bs.modal', function (e) {
        let button = $(e.relatedTarget) // Button/Components that triggered the modal
        PAYSLIP_CARD_ID = button.data('cardid') // Extract info from data-* attributes
        console.log(PAYSLIP_CARD_ID)
        // document.getElementById("confirmEmployeeCardId").setAttribute('value', EMPLOYEE_CARD_ID);
        // document.getElementById("confirmEmployeeModalTitle").textContent = 'Create payslip for '+ EMPLOYEE_CARD_NAME;

        let payslipData = getPayslipData(PAYSLIP_CARD_ID);
        console.log('payslipData: '+payslipData);
        loadPayslipModal(payslipData);
        assignDraggableWithElem(tableSimple);
        assignDraggableWithElem(tableAdv);
      });

      // Confirm Button Edit Payslip clicked
      $('#btnEditPayslipModalUpdate').on('click', function (e) {

        // TODO: Update the modal;
        // Update payslip
        savePayslipModal(PAYSLIP_CARD_ID);


        SetPayslipUpdateStatus(false, PAYSLIP_CARD_ID);
      });

      // Edit Payslip Modal Clear values
      $('#editPayslipModal').on('hide.bs.modal', function (e) {
        PAYSLIP_CARD_ID = '';
        clearItems();
      });

      // Edit Payslip Details Modal View
      $('#editPayslipEmployeeModal').on('show.bs.modal', function (e) {
        let button = $(e.relatedTarget) // Button/Components that triggered the modal
        PAYSLIP_CARD_ID = button.data('cardid') // Extract info from data-* attributes

        let title = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=title]')[0].textContent;
        let refNo = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=refNo]')[0].textContent;
        let date = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=date]')[0].textContent;
        let name = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=name]')[0].textContent;
        let position = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=position]')[0].textContent;
        let epf = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=epf]')[0].textContent;
        let socso = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=socso]')[0].textContent;
        let bankName = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=bankName]')[0].textContent;
        let acNo = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=acNo]')[0].textContent;

        document.getElementById("editPayslipEmployeeTitle").value = title;
        document.getElementById("editPayslipEmployeeRefNo").value = refNo;
        document.getElementById("editPayslipEmployeeDate").value = date;

        // Re-init daterangepicker
        $('#editPayslipEmployeeDate').daterangepicker({
          singleDatePicker: true,
          showDropdowns: true,
          locale: {
            format: 'DD/MM/YYYY'
          },
        }, function(start, end, label) {
        });

        document.getElementById("editPayslipEmployeeName").value = name;
        document.getElementById("editPayslipEmployeePosition").value = position;
        document.getElementById("editPayslipEmployeeEPF").value = epf;
        document.getElementById("editPayslipEmployeeSocso").value = socso;
        document.getElementById("editPayslipEmployeeBankName").value = bankName;
        document.getElementById("editPayslipEmployeeAcNo").value = acNo;

        // loadPayslipDetailsModal(payslipData);
      });


      // Confirm Button Edit Payslip Details clicked
      $('#btnEditPayslipEmployeeModalUpdate').on('click', function (e) {
        document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=title]')[0].textContent = document.getElementById("editPayslipEmployeeTitle").value;
        document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=refNo]')[0].textContent = document.getElementById("editPayslipEmployeeRefNo").value;
        document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=date]')[0].textContent = document.getElementById("editPayslipEmployeeDate").value;
        // document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=name]')[0].textContent = document.getElementById("editPayslipEmployeeName").value;
        document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=position]')[0].textContent = document.getElementById("editPayslipEmployeePosition").value;
        // document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=epf]')[0].textContent = document.getElementById("editPayslipEmployeeEPF").value;
        // document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=socso]')[0].textContent = document.getElementById("editPayslipEmployeeSocso").value;
        // document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=bankName]')[0].textContent = document.getElementById("editPayslipEmployeeBankName").value;
        // document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=acno]')[0].textContent = document.getElementById("editPayslipEmployeeAcNo").value;

        SetPayslipUpdateStatus(false, PAYSLIP_CARD_ID);
      });

      // Edit Payslip Modal Clear values
      $('#editPayslipEmployeeModal').on('hide.bs.modal', function (e) {
        document.getElementById("editPayslipEmployeeTitle").value = '';
        document.getElementById("editPayslipEmployeeRefNo").value = '';
        document.getElementById("editPayslipEmployeeDate").value = '';
        document.getElementById("editPayslipEmployeeName").value = '';
        document.getElementById("editPayslipEmployeePosition").value = '';
        document.getElementById("editPayslipEmployeeEPF").value = '';
        document.getElementById("editPayslipEmployeeSocso").value = '';
        document.getElementById("editPayslipEmployeeBankName").value = '';
        document.getElementById("editPayslipEmployeeAcNo").value = '';
        PAYSLIP_CARD_ID = '';
      });


      // Preview Modal Show
      $('#previewModal').on('show.bs.modal', function (e) {
        let button = $(e.relatedTarget) // Button/Components that triggered the modal
        PAYSLIP_CARD_ID = button.data('cardid') // Extract info from data-* attributes

        let payslipData = getPayslipData(PAYSLIP_CARD_ID);
        console.log('payslipData: ');
        console.log(payslipData);

        // Render Tables
        previewPayslip('preview', payslipData)

        // Render Fixed Params
        let title = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=title]')[0].textContent;
        let refNo = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=refNo]')[0].textContent;
        let date = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=date]')[0].textContent;
        let name = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=name]')[0].textContent;
        let position = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=position]')[0].textContent;
        let epf = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=epf]')[0].textContent;
        let socso = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=socso]')[0].textContent;
        let bankName = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=bankName]')[0].textContent;
        let acNo = document.getElementById(PAYSLIP_CARD_ID).querySelectorAll('p[name=acNo]')[0].textContent;

        document.getElementById("previewTitle").textContent = title;
        document.getElementById("previewRefNo").textContent = refNo;
        document.getElementById("previewDate").textContent = date;

        let bizDetail = '';
        bizDetail += (bizPhone == null || bizPhone == '') ? '' : bizPhone;
        bizDetail += (bizEmail == null || bizEmail == '') ? '' : ', ' + bizEmail;
        bizDetail += (bizAddr == null || bizAddr == '') ? '' : ', ' + bizAddr;

        document.getElementById("previewBizName").textContent = bizName;
        document.getElementById("previewBizDetails").textContent = bizDetail;

        if (bizImgUrl == null || bizImgUrl == ''|| bizImgUrl == "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D"){
          document.getElementById("previewTutorImgUrl").style.display = 'none';
          document.getElementById("previewTutorImgUrl").src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D';
        }
        else {
          toDataURL(
            bizImgUrl == null || bizImgUrl == '' ?  'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D' : 'https://murmuring-headland-66106.herokuapp.com/'+bizImgUrl,
            function(dataUrl) {
              // console.log('RESULT:', dataUrl)
            },
          );
        }

        document.getElementById("previewClientName").textContent = name;
        document.getElementById("previewClientPosition").textContent = position;

        if (epf == null || epf == ''){
          document.getElementById("previewEpf").style.display = 'none';
          document.getElementById("previewEpfTitle").style.display = 'none';

        }else{
          document.getElementById("previewEpf").style.display = '';
          document.getElementById("previewEpfTitle").style.display = '';

        }

        if (socso == null || socso == ''){
          document.getElementById("previewSocso").style.display = 'none';
          document.getElementById("previewSocsoTitle").style.display = 'none';

        }else{
          document.getElementById("previewSocso").style.display = '';
          document.getElementById("previewSocsoTitle").style.display = '';

        }
        document.getElementById("previewEpf").textContent = epf;
        document.getElementById("previewSocso").textContent = socso;

        document.getElementById("previewBankName").textContent = (bankName == null || bankName == "") ? "No information available" : bankName;
        document.getElementById("previewAcNo").textContent = (acNo == null || acNo == "") ? "No information available" : acNo;;
      });

      // Preview Modal Hide
      $('#previewModal').on('hide.bs.modal', function (e) {
        // TODO: Clear preview


      });



      // Load All Admin's Teachers
      $('#myTeacherModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) // Button that triggered the modal
        latestAdminTutorDoc = null;
        tutorAdminLoadmore.addEventListener('click', tutorAdminLoadMoreHandleClick );
        loadAllAdminTeachers();

        // Specific to myself
        // const btnSelectMyself = document.getElementById('btnSelectMyself');
        // btnSelectMyself.setAttribute('onclick', "AddNewEmployee('"+ tutor_id+"', '"+current_name+"', '"+current_phone+"', '"+current_imgUri+"')");

      });

      // Remove all Admin's Teachers when the List Teacher Modal close
      $('#myTeacherModal').on('hidden.bs.modal', function (event) {
        // NOTE: div:gt(5) - get the 6th div child in the parent node.
        // NOTE: div:gt(5) - get the 4th div child in the parent node. (myself)
        $('#add-tutor-modal-container div:gt(10)').remove();
      });


      // Populate record payment modal
      $('#loadPayrollModal').on('show.bs.modal', function (e) {
        // Load all payrolls
        latestPayrollDoc = null;
        loadAllPayroll();

      });

      $('#loadPayrollModal').on('hide.bs.modal', function (event) {

        let payrollFullList = document.getElementById('payrollFullList').querySelectorAll('a');
        payrollFullList.forEach((row, index) => {
          row.remove();
        });

      });

      // Record Payment
      $('#btnLoadPayrollModalLoadMore').on('click', function (event) {



      });




      // Populate record payment modal
      $('#recordPaymentModal').on('show.bs.modal', function (e) {
        let button = $(e.relatedTarget);
        EMPLOYEE_CARD_ID = button.data('employeecardid');
        EMPLOYEE_CARD_NAME = button.data('employeecardname');
        // document.getElementById("confirmEmployeeCardId").setAttribute('value', EMPLOYEE_CARD_ID);
        document.getElementById("recordPaymentModalTitle").textContent = 'Record payment for '+ EMPLOYEE_CARD_NAME;


        // let invPaymentDate = ''
        // if (currentInvoiceObj[INV_PAYMENT_DATE] == null || currentInvoiceObj[INV_PAYMENT_DATE] == ''){
        //   invPaymentDate = ' - ';
        // }else {
        //   invPaymentDate = new Date(currentInvoiceObj[INV_PAYMENT_DATE].seconds*1000).toLocaleDateString("en-GB");
        // }

        // document.getElementById("inPaymentDate").value = invPaymentDate;
        // document.getElementById("inPaymentAmount").value = currentInvoiceObj[INV_PAYMENT_AMOUNT];
        // document.getElementById("inPaymentNotes").value = currentInvoiceObj[INV_PAYMENT_NOTE];

      });

      $('#recordPaymentModal').on('hide.bs.modal', function (event) {
        EMPLOYEE_CARD_ID = '';
        EMPLOYEE_CARD_NAME = '';
        document.getElementById("inPaymentDate").value = '';
        document.getElementById("inPaymentAmount").value = '';
        document.getElementById("inPaymentNotes").value = '';

      });

      // Record Payment
      $('#btnRecordPaymentModalUpdate').on('click', function (event) {


        let inPaymentDate = document.getElementById("inPaymentDate").value ;
        let inPaymentAmount = document.getElementById("inPaymentAmount").value;
        let inPaymentNotes = document.getElementById("inPaymentNotes").value ;

        let payslipDocRef = db.collection("dev")
          .doc("v2")
          .collection("Payslip")
          .where(PAY_PAYROLL_ID, "==", payrollId)
          .where(PAY_RECEIVER_ID, "==", EMPLOYEE_CARD_ID);


        payslipDocRef
        .get()
        .then((querySnapshot) => {

          // let payrollDocRef = db.collection("dev")
          //   .doc("v2")
          //   .collection("Payroll")
          //   .doc(payrollId);

          if(querySnapshot.empty) {

            func.showNotification('top','center', 'danger', 'error_outline', "Cannot record payment for unsaved payslip." );

          }
          else
          {
            querySnapshot.forEach((doc) => {

              console.log("Payslip found, update exisiting payslip.");

              payDocId = doc.data()[PAY_ID];
              transDocId = doc.data()[PAY_TRANS_ID];
              console.log(payDocId, transDocId);
              let payslipDocRef1 = db.collection("dev")
                .doc("v2")
                .collection("Payslip")
                .doc(payDocId);

              let transDocRef = db.collection("dev")
                .doc("v2")
                .collection("Transaction")
                .doc(transDocId);

              // Payment date

              // let paymentDate = document.getElementById("inPaymentDate").value;
              let paymentDate = $('#inPaymentDate').data('daterangepicker').startDate.format('DD/MM/YYYY');

              console.log('paymentDate');
              console.log(paymentDate);
              paymentDate = paymentDate.split("/");
              let newPaymentDate = new Date( paymentDate[2], paymentDate[1] - 1, paymentDate[0]);
              let paymentDateFinal = firebase.firestore.Timestamp.fromDate(newPaymentDate);

              var data = {
                [PAY_PAYMENT_DATE]: paymentDateFinal,
                [PAY_PAYMENT_AMOUNT]: inPaymentAmount,
                [PAY_PAYMENT_NOTE]: inPaymentNotes,
                [PAY_DATE_EDIT]: new Date(),
              }

              console.log("*Payslip Data...")
              console.log(data)


              var transData = {
                [TRANS_DOC_STATUS] : TRANS_PAY_STATUS_PAID,
                [TRANS_DATE_EDIT]: new Date(),
              }

              console.log("Transaction Data...")
              console.log(transData)

              // Update Payslip

              payslipDocRef1.set(data, { merge: true })
              .then(() => {

                // Create Transaction
                transDocRef.set(transData, { merge: true })
                .then(() => {

                  func.showNotification('top','center', 'success', 'check_circle', "Payment recorded." );

                });


              });



            });
          }

        }).catch((error) => {
            console.log("Error getting document:", error);
        });


      });


      // Confirm employee view
      $('#confirmEmployeeModal').on('show.bs.modal', function (e) {
        let button = $(e.relatedTarget) // Button/Components that triggered the modal
        EMPLOYEE_CARD_ID = button.data('employeecardid') // Extract info from data-* attributes
        EMPLOYEE_CARD_NAME = button.data('employeecardname')
        // console.log(EMPLOYEE_CARD_ID)
        document.getElementById("confirmEmployeeCardId").setAttribute('value', EMPLOYEE_CARD_ID);
        document.getElementById("confirmEmployeeModalTitle").textContent = 'Create or update payslip for '+ EMPLOYEE_CARD_NAME;

      });
      // Clear values
      $('#confirmEmployeeModal').on('hide.bs.modal', function (e) {
        EMPLOYEE_CARD_ID = '';
        EMPLOYEE_CARD_NAME = '';
        document.getElementById("confirmEmployeeCardId").setAttribute('value', '');
        document.getElementById("confirmEmployeeModalTitle").textContent ='Create Payslip for This Teacher';

      });

      $('#btnConfirmEmployeeModalUpdate').on('click', function (e) {
        // removeElementBasedOnId(EMPLOYEE_CARD_ID);
        // alert('Created Payslip for this Teacher')

        document.getElementById('btnConfirmEmployeeModalUpdate').setAttribute('disabled', true);
        document.getElementById('btnConfirmEmployeeModalUpdate').textContent = "Updating. Please wait ..."

        CreatePayslip(EMPLOYEE_CARD_ID);

      });


      // Remove employee view
      $('#removeEmployeeModal').on('show.bs.modal', function (e) {
        let button = $(e.relatedTarget) // Button/Components that triggered the modal
        EMPLOYEE_CARD_ID = button.data('employeecardid') // Extract info from data-* attributes
        EMPLOYEE_CARD_NAME = button.data('employeecardname')
        // console.log(EMPLOYEE_CARD_ID)
        document.getElementById("employeeCardId").setAttribute('value', EMPLOYEE_CARD_ID);
        document.getElementById("removeEmployeeModalTitle").textContent = 'Remove '+ EMPLOYEE_CARD_NAME;

      });
      // Clear values
      $('#removeEmployeeModal').on('hide.bs.modal', function (e) {
        EMPLOYEE_CARD_ID = '';
        EMPLOYEE_CARD_NAME = '';
        document.getElementById("employeeCardId").setAttribute('value', '');
        document.getElementById("removeEmployeeModalTitle").textContent ='Remove This Teacher';

      });

      $('#btnRemoveEmployeeModalUpdate').on('click', function (e) {

        RemovePlayslip(EMPLOYEE_CARD_ID);


      });



		});

  </script>

  <!-- Table Handler -->
  <script>
    // https://htmldom.dev/drag-and-drop-table-row/
    document.addEventListener('DOMContentLoaded', function () {      tableSimple.querySelectorAll('tr').forEach(function (row, index) {
        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
            return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // console.log(row)
        // console.log(row.className)
        const firstCell = row.firstElementChild;
        firstCell.classList.add('draggable');
        firstCell.addEventListener('mousedown', mouseDownHandler);
      });

      tableAdv.querySelectorAll('tr').forEach(function (row, index) {
        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
            return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // console.log(row)
        // console.log(row.className)
        const firstCell = row.firstElementChild;
        firstCell.classList.add('draggable');
        firstCell.addEventListener('mousedown', mouseDownHandler);
      });

      // assignDraggable();

      assignDraggableWithElem( tableSimple);
      assignDraggableWithElem( tableAdv);
    });
  </script>

  <!-- Date range picker -->
  <script>


    function cb(start, end, label) {
        // $('input[name="daterange"]').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
        // console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
        // console.log(new Date(start), new Date(end), label);

        payrollStart = new Date(start);
        payrollEnd = new Date(end);
        payrollName = start.format('DD/MM/YYYY') + ' - ' + end.format('DD/MM/YYYY');

        payrollDate = start.format('DD/MM/YYYY');
        payrollDateMonth = start.format('MMMM YYYY');

        // console.log(payrollDate, payrollDateMonth, payrollName);



    }

    $('input[name="daterange"]').daterangepicker({
        startDate: start,
        endDate: end,
        locale: {
          format: 'DD/MM/YYYY'
        },
        ranges: {
          //  'Today': [moment(), moment()],
          //  'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
          //  'Last 7 Days': [moment().subtract(6, 'days'), moment()],
          //  'Last 30 Days': [moment().subtract(29, 'days'), moment()],
          'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
          'This Month': [moment().startOf('month'), moment().endOf('month')],
          'Next Month': [moment().add(1, 'month').startOf('month'), moment().add(1, 'month').endOf('month')]
        }
    }, cb);

    cb(start, end);


    // Payroll Single Date Picker
    $('#editPayslipEmployeeDate').daterangepicker({
      singleDatePicker: true,
      showDropdowns: true,
      locale: {
        format: 'DD/MM/YYYY'
      },
    }, function(start, end, label) {

      // Substitue the default payroll date(start date of the payroll period) to a newer value
      payrollDate = start.format('DD/MM/YYYY');
      payrollDateMonth = start.format('MMMM YYYY');
      // var years = moment().diff(start, 'years');
      // alert("You are " + years + " years old!");
    });


    // Record Payment Single Date Picker
    $('#inPaymentDate').daterangepicker({
      singleDatePicker: true,
      showDropdowns: true,
      locale: {
          format: 'DD/MM/YYYY'
      },
    }, function(start, end, label) {

      recordPaymentDate = start;

      // Check if the fields are filled.
      checkRecordPaymentModalFields();

    });



    var inputPhone = document.querySelector("#inClientContact");
    var itiPhone = intlTelInput(inputPhone, {
      // allowDropdown: false,
      autoHideDialCode: false,
      // autoPlaceholder: "off",
      // dropdownContainer: document.body,
      // excludeCountries: ["my"],
      // formatOnDisplay: false,
      // geoIpLookup: function(callback) {
      //   $.get("http://ipinfo.io", function() {}, "jsonp").always(function(resp) {
      //     var countryCode = (resp && resp.country) ? resp.country : "";
      //     callback(countryCode);
      //   });
      // },
      // hiddenInput: "full_number",
      // initialCountry: "auto",
      // localizedCountries: { 'de': 'Deutschland' },
      nationalMode: false,
      // onlyCountries: ['MY', 'SG', 'TH', 'ID', 'VN', 'PH', 'BN', 'US', 'GB', 'SA'],
      // placeholderNumberType: "MOBILE",
      preferredCountries: ['MY', 'SG'],
      separateDialCode: true,
      utilsScript: "../../assets/js/plugins/intlTelInput/utils.js",
    });

    var errorMsg = document.querySelector("#error-msg");
    var validMsg = document.querySelector("#valid-msg");

    // here, the index maps to the error code returned from getValidationError - see readme
    var errorMap = ["Invalid number", "Invalid country code", "Too short", "Too long", "Invalid number"];

    var reset = function() {
      inputPhone.classList.remove("error");
      errorMsg.innerHTML = "";
      errorMsg.classList.add("hide");
      validMsg.classList.add("hide");
    };

    // on blur: validate

    inputPhone.addEventListener('blur', function() {
      reset();

      // Get the existing list of cardId.
      // If similar phoneId used, ban the number.
      let existingCardList = document.getElementById('accordionTutor').querySelectorAll('div.card');
      let existingCardIdList = [];

      existingCardList.forEach((row, index) => {
        existingCardIdList.push(row.getAttribute('id'));
      });

      // Check validity of the fields in Add Employee Modal.
      checkNewEmployeeValidity();

      if (inputPhone.value.trim()) {
        if(existingCardIdList.includes(itiPhone.getNumber())){
          inputPhone.classList.add("error");
          // validMsg.classList.remove("hide");
          errorMsg.innerHTML = 'Phone number already used. Please use a different number.';
          errorMsg.classList.remove("hide");

          document.getElementById('btnAddCustomEmployeeModalUpdate').setAttribute('disabled', true);
        }

        else if (itiPhone.isValidNumber()) {
          validMsg.classList.remove("hide");
          document.getElementById('btnAddCustomEmployeeModalUpdate').removeAttribute('disabled');

        }

        else {
          inputPhone.classList.add("error");
          var errorCode = itiPhone.getValidationError();
          errorMsg.innerHTML = errorMap[errorCode];
          errorMsg.classList.remove("hide");
          document.getElementById('btnAddCustomEmployeeModalUpdate').setAttribute('disabled', true);
        }
      }


    });

    // on keyup / change flag: reset
    inputPhone.addEventListener('change', reset);
    inputPhone.addEventListener('keyup', reset);

  </script>

</body>

</html>