<!doctype html>
<html lang="en">

<head>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>GoLearn School</title>
  <meta name=description content="GoLearn School&trade; is Malaysia #1 teaching platform to run your tuition business and manage your lessons. Start now for Free!">
  <meta property=og:title content="GoLearn School">
  <meta property=og:site_name content="GoLearn School">
  <meta property=og:type content=website>
  <meta property=og:url content=https://org.golearn.com.my/school/invoice/create-invoice.html>
  <meta property=og:image content=https://org.golearn.com.my/assets/img/icon-apple-touch-180x180.png>
  <meta property=og:description content="GoLearn School&trade; is Malaysia #1 teaching platform to run your tuition business and manage your lessons. Start now for Free!">
  <link rel=apple-touch-icon sizes=180x180 href=https://org.golearn.com.my/assets/img/icon-apple-touch-180x180.png>
  <link rel=icon type=image/png sizes=32x32 href=https://org.golearn.com.my/assets/img/icon-32x32.png>
  <link rel=icon type=image/png sizes=16x16 href=https://org.golearn.com.my/assets/img/icon-16x16.png>
  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" rel="stylesheet" type="text/css" />
  <script src="https://kit.fontawesome.com/2bdd669e92.js" crossorigin="anonymous"></script>
  <!-- Material Kit CSS -->
  <link href="../../assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
  <!-- Firebase Init -->
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-firestore.js"></script>
  <script src="../../assets/js/firebase.js"></script>
  <script>
    const orgUrl = new URL(window.location.href).searchParams.get("url");
    const orgEnt = new URL(window.location.href).searchParams.get("ent");
    if (orgUrl === null || orgUrl === "" || orgEnt === null || orgEnt === "")
      window.location.href = 'http://org.golearn.com.my/'+'?url=' + orgUrl + "&ent=" + orgEnt;
  </script>
  <!-- Tutor Portal specific CSS -->
  <link href="../../assets/css/tutor-portal.css" rel="stylesheet" />
  <!--GL Org CSS -->
  <link href="../../assets/css/golearn-org.css" rel="stylesheet" />
  <!-- Date Picker -->
  <link href="../../assets/css/mc-calendar.min.css" rel="stylesheet"/>
  <link href="../../assets/css/intlTelInput.css" rel="stylesheet" >
  <!-- Tag input -->
  <link href="../../assets/css/tagsinput.css" rel="stylesheet" type="text/css">
  <!-- TinyMce -->
  <script src="../../assets/js/plugins/tinymce/tinymce.min.js" type="text/javascript"></script>
  <!-- Tinymce init -->
  <script>
    function initTinyMCE(){

      tinymce.init({
        mode : "exact",
        selector:'#invNotes',
        plugins: "link",
        max_chars: 400,
        setup: function (ed) {
          var allowedKeys = [8, 13, 16, 17, 18, 20, 33, 34, 35, 36, 37, 38, 39, 40, 46];
          ed.on('keydown', function (e) {
            console.log(tinymce_getContentLength());
            invNotesOnChangeHandler();
            if (allowedKeys.indexOf(e.keyCode) != -1){
              return true;
            }
            if (tinymce_getContentLength() + 1 > this.settings.max_chars) {
              func.showNotification('top','center', 'warning', 'error_outline', 'You have reach maximum allowed number of ' + ed.settings.max_chars + ' characters.' );
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
            return true;
          });
          ed.on('keyup', function (e) {
            invFooterNotesOnChangeHandler();
            tinymce_updateCharCounter(this, tinymce_getContentLength());
          });
        },

        init_instance_callback: function () { // initialize counter div
          // $('#' + this.id).prev().append('<div class="char_count" style="text-align:right"></div>');
          tinymce_updateCharCounter(this, tinymce_getContentLength());
          let invNotesContent = tinymce.get("invNotes").getContent({ format: "text" });
          document.getElementById("countNotes").textContent = invNotesContent.length + '/400';
        },
        paste_preprocess: function (plugin, args) {
          var editor = tinymce.get(tinymce.activeEditor.id);
          var len = editor.contentDocument.body.innerText.length;
          var text = $(args.content).text();
          if (len + text.length > editor.settings.max_chars) {
              func.showNotification('top','center', 'warning', 'error_outline', 'Pasting this exceeds the maximum allowed number of ' + editor.settings.max_chars + ' characters.' );
              args.content = '';
          } else {
              tinymce_updateCharCounter(editor, len + text.length);
          }
        }

      });
      tinymce.init({
        mode : "exact",
        selector:'#invFooterNotes',
        plugins: "link",
        max_chars: 200,
        setup: function (ed) {
          var allowedKeys = [8, 13, 16, 17, 18, 20, 33, 34, 35, 36, 37, 38, 39, 40, 46];

          ed.on('keydown', function (e) {
            console.log(tinymce_getContentLength());
            invFooterNotesOnChangeHandler();
            if (allowedKeys.indexOf(e.keyCode) != -1){
              return true;
            }
            if (tinymce_getContentLength() + 1 > this.settings.max_chars) {
              func.showNotification('top','center', 'warning', 'error_outline', 'You have reach maximum allowed number of ' + ed.settings.max_chars + ' characters.' );
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
            return true;
          });
          ed.on('keyup', function (e) {
            invFooterNotesOnChangeHandler();
            tinymce_updateCharCounter(this, tinymce_getContentLength());
          });
        },

        init_instance_callback: function () { // initialize counter div
          // $('#' + this.id).prev().append('<div class="char_count" style="text-align:right"></div>');
          tinymce_updateCharCounter(this, tinymce_getContentLength());

          let invFooterNotesContent = tinymce.get("invFooterNotes").getContent({ format: "text" });
          document.getElementById("countFooterNotes").textContent = invFooterNotesContent.length + '/200';
        },
        paste_preprocess: function (plugin, args) {
          var editor = tinymce.get(tinymce.activeEditor.id);
          var len = editor.contentDocument.body.innerText.length;
          var text = $(args.content).text();
          if (len + text.length > editor.settings.max_chars) {
              func.showNotification('top','center', 'warning', 'error_outline', 'Pasting this exceeds the maximum allowed number of ' + editor.settings.max_chars + ' characters.' );
              args.content = '';
          } else {
              tinymce_updateCharCounter(editor, len + text.length);
          }
        },
      });

      function tinymce_updateCharCounter(el, len) {
        // $('#' + el.id).prev().find('.char_count').text(len + '/' + el.settings.max_chars);
      }

      function tinymce_getContentLength() {
        return tinymce.get(tinymce.activeEditor.id).contentDocument.body.innerText.length;
      }
    }
  </script>

  <style>
    .table {
        border: 1px solid #ccc;
        border-collapse: collapse;
    }
    .table th,
    .table td {
        border: 1px solid #ccc;
    }
    .table th,
    .table td {
        padding: 0.5rem;
    }
    .draggable {
        cursor: move;
        user-select: none;
    }
    .placeholder {
        background-color: #edf2f7;
        border: 2px dashed #cbd5e0;
    }
    .clone-list {
        border-top: 1px solid #ccc;
    }
    .clone-table {
        border-collapse: collapse;
        border: none;
    }
    .clone-table th{
        border: 1px solid #ccc;
        border-top: none;
        padding: 0.5rem;
        font-size: 1.2em;
        font-weight: 300;
    }

    .clone-table td {
        border: 1px solid #ccc;
        border-top: none;
        padding: 0.5rem;

        font-weight: 300;
    }
    .dragging {
        background: #fff;
        border-top: 1px solid #ccc;
        z-index: 999;
    }

    /* page view for A4  */
    page {
      background: white;
      display: block;
      margin: 0 auto;
      /* margin-bottom: 0.5cm; */
      box-shadow: 0 0 0.5cm rgba(0,0,0,0.5);
    }
    page[size="A4"] {
      width: 21cm;
      height: auto;
      min-height: 29.65cm;
      /* Use a  height value slightly lower than 29.7 to avoid page break  */
      /* height: 29.7cm;  */
    }
    page[size="A4"][layout="landscape"] {
      width: 29.7cm;
      height: 21cm;
    }


    /* .card-body footer1 {
        position: fixed;
    }

    .card-body footer1 {
        bottom: 0;
    } */
    .textarea1 {
      display: block;
      width: 100%;
      overflow: hidden;
      resize: both;
      min-height: 40px;
      line-height: 20px;
    }

    .textarea[contenteditable]:empty::before {
      content: "Placeholder still possible";
      color: gray;
    }
  </style>
</head>

<body>

  <div class="wrapper">
    <div class="sidebar" data-color="purple" data-background-color="white" data-image="../../assets/img/sidebar-3.jpg">
      <div class="logo">
        <a href="../" class="simple-text logo-mini" style="padding: 0.5rem" id="logoName" name="param-link">
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav" style="margin-bottom: 50px;">
          <li class="nav-item" perm="home">
            <a class="nav-link" href="../" name="param-link">
              <i class="far fa-chart-bar fa-fw nav-icon"></i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="insight">
            <a class="nav-link" href="../report/" name="param-link">
              <i class="far fa-lightbulb fa-fw nav-icon"></i>
              <p>Insight</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="teach">
            <h4 class="nav-link" style="margin-left: 1rem;">Teaching</h4>
          </li>
          <li class="nav-item hidden" perm="teach-class">
            <a class="nav-link" href="../class/" name="param-link">
              <i class="fas fa-chalkboard fa-fw nav-icon"></i>
              <p>Classes</p>
            </a>
          </li>
		  		<li class="nav-item hidden" perm="teach-student">
            <a class="nav-link" href="../student/" name="param-link">
              <i class="fas fa-user-graduate fa-fw nav-icon"></i>
              <p>Students</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="teach-teacher">
            <a class="nav-link" href="../teacher/" name="param-link">
              <i class="fas fa-chalkboard-teacher fa-fw nav-icon"></i>
              <p>Teachers</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="fin">
            <h4 class="nav-link" style="margin-left: 1rem;">Financial</h4>
          </li>
          <li class="nav-item hidden active" perm="fin-invoice">
            <a class="nav-link" href="../invoice/" name="param-link">
              <i class="fas fa-file-invoice-dollar fa-fw nav-icon"></i>
              <p>Invoices</p>
            </a>
          </li>
          <li class="nav-item hidden" perm="fin-payroll">
            <a class="nav-link" href="../payroll/" name="param-link">
              <i class="fas fa-hand-holding-usd fa-fw nav-icon"></i>
              <p>Payroll <span style="visibility: hidden;">PRO</span></p>
            </a>
          </li>
          <li class="nav-item hidden" perm="fin-transaction">
            <a class="nav-link" href="../transaction/" name="param-link">
              <i class="fas fa-exchange-alt fa-fw nav-icon"></i>
              <p>Transactions</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:;">Invoices <span><i class="material-icons" style="color: gray;">chevron_right</i></span> Create</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end">
            <form class="navbar-form">
              <!-- Put empty placeholder here -->
            </form>

            <ul class="navbar-nav">
              <li class="nav-item" id="activationNavItem">
                <a href="#" class="btn btn-primary btn-round btn-sm" style="visibility: hidden;" id="btnActivateAccount"></a>
              </li>
              <li class="nav-item">
                <a class="navbar-brand" href="javascript:;">
                   Hi <span id="user"></span> !
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link" href="javascript:;" id="navbarDropdownNotification" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">notifications</i> Notifications
                </a>
                <!-- <a class="nav-link" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">notifications</i>
                  <span class="notification">5</span>
                  <p class="d-lg-none d-md-block">
                    Some Actions
                  </p>
                </a> -->
								<div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
									<p style="padding: 1em;" >No notification</p>
                  <!-- <a class="dropdown-item" href="#">Mike John responded to your email</a>
                  <a class="dropdown-item" href="#">You have 5 new tasks</a>
                  <a class="dropdown-item" href="#">You're now friend with Andrew</a>
                  <a class="dropdown-item" href="#">Another Notification</a>
                  <a class="dropdown-item" href="#">Another One</a> -->
                </div>
              </li>
              <!-- your navbar here -->

			  			<li class="nav-item dropdown">
                <a class="nav-link" href="javascript:;" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">person</i>
                  <p class="d-lg-none d-md-block">
                    Account
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
                  <a class="dropdown-item hidden" href="../settings/" name="param-link" perm="settings">Update Information</a>
                  <a class="dropdown-item hidden" href="../team/" name="param-link" perm="team">Team</a>
									<div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="../../">Back to Home</a>
                  <a class="dropdown-item" href="javascript:;" data-toggle="modal" data-target="#signOutModal" onclick="signOutFunction()" id="btn-logout">Log out</a>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->

			<!-- Modal Start -->
      <!-- Edit Item's Title and Tag -->
      <div class="row">
        <div class="modal fade" id="editItemModal" tabindex="-1" role="dialog" aria-labelledby="editItemModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editItemModalTitle">Edit Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btnEditItemModalClose1">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="editItemModalBody">

                <div id="inItemId" value=""></div>

                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Item Title* <span id="countName" style="color: grey; margin-left: 1rem;">0/40</span></span>
                      <input type="text" class="form-control" id="inItemTitle" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40">
                    </div>
                  </div>

                </div>

                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Category</span>
                      <span class="tooltiptext-trigger">?
                        <span class="tooltiptext-general">
                          <h6>Category</h6>
                          <p>Assign a category to this item. A non-class item will be categorized as 'Uncategorized' by default.</p>
                        </span>
                      </span>
                      <span style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0; margin-left: 5px;">
                        <a href="javascript:;" data-target="#addCategoryModal" data-toggle="modal" data-dismiss="modal">Create New</a>
                      </span>

                      <select class="form-control" name="tutor_course[]" id="category_drop" data-compulsory="false" oninput="this.className = 'form-control'">
                        <!-- <option value="uncategorized">Uncategorized</option> -->
                        <!-- <option value="1" >Pre-School</option>
                        <option value="2" >Lower Primary (Tahun 1-3)</option>
                        <option value="3" >Upper Primary (UPSR)</option>
                        <option value="4" >Form 1-3 (PT3)</option>
                        <option value="5" >Form 4-5 (SPM)</option>
                        <option value="6" >Primary (International Syllabus)</option>
                        <option value="7" >Lower Secondary (International Syllabus)</option>
                        <option value="8" >Year 10-11 (IGCSE)</option>
                        <option value="9" >Others</option> -->
                      </select>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12">

                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Tag</span>
                      <span class="tooltiptext-trigger">?
                        <span class="tooltiptext-general">
                          <h6>Tag</h6>
                          <p>Assign up to 5 tag keywords to identify this item, and receive better breakdowns in your analysis reports.</p>
                        </span>
                      </span>
                      <input type="text" class="form-control" id="inItemTag" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40">
                    </div>

                  </div>


                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnEditItemModalClose2">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnEditItemModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Category Modal -->
      <div class="row">
        <div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalTitle">Create New Category</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btnAddCategoryModalClose1">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="addCategoryModalBody">

                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Name* <span id="countCatName" style="color: grey; margin-left: 1rem;">0/40</span></span>
                      <input type="text" class="form-control" id="inCategoryName" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40">
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Slug <span id="countCatSlug" style="color: grey; margin-left: 1rem;">0/40</span></span>
                      <span class="tooltiptext-trigger">?
                        <span class="tooltiptext-general">
                          <h6>Slug</h6>
                          <p>The "slug" is the URL-friendly version of the name. It is usually all lowercase and contains only letters, numbers, and hyphens.</p>
                        </span>
                      </span>
                      <input type="text" class="form-control" id="inCategorySlug" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40">
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Description</span>
                      <textarea class="form-control" maxlength="250" rows="4"  id="inCategoryDesc" data-compulsory="false"></textarea>
                    </div>
                  </div>
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnAddCategoryModalClose2">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnAddCategoryModalUpdate" data-toggle="modal" data-target="#categoryCreateConfirmModal" disabled>Create</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Confirm modal -->
      <div class="row">
        <div class="modal fade" id="categoryCreateConfirmModal" tabindex="-1" role="dialog" aria-labelledby="categoryCreateConfirmModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                Are you sure you want to continue?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Not Now</button>
                <button type="button" class="btn btn-primary" id="btnCategoryCreateConfirmModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Invoice modal -->
      <div class="row">
        <div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="saveModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="saveLabel">Save Draft and Proceed</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btnSaveModalClose1">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="saveModalBody">
                Are you sure you want to continue?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnSaveModalClose2">Cancel</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnSaveModalUpdate">Save</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Selected Client modal -->
      <div class="row">
        <div class="modal fade" id="editClientModal" tabindex="-1" role="dialog" aria-labelledby="editClientModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editClientModalLabel">Edit Client Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btEeditClientModalClose1">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="editClientModalBody">
                <div id="inClientId" value =''></div>
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Name*</span>
                  <input type="text" class="form-control" id="inClientName" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40" readonly>
                </div>

                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Contact*</span>
                  <div class="input-group">
                    <input id="inClientContact" name="phone" type="tel"  class="form-control" data-compulsory="true" oninput="this.className = 'form-control'" >
                    <span id="valid-msg" class="hide" style="color: #42ba96;">✓ Valid</span>
                    <span id="error-msg" class="hide" style="color: #F32013;"></span>
                  </div>
                  <!-- <input type="text" class="form-control" id="inClientContact" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40" readonly> -->
                </div>
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Email (Optional)</span>
                  <input type="text" class="form-control" id="inClientEmail" data-compulsory="false" maxlength="40">
                </div>
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Address (Optional) </span>
                  <textarea class="form-control" maxlength="250" rows="4"  id="inClientAddr" data-compulsory="false"></textarea>
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnEditClientModalClose2">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnEditClientModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- List / Load Admin's Students Modal -->
      <div class="row">
        <div class="modal fade" id="addStudentModal" tabindex="-1" role="dialog" aria-labelledby="addStudentModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addStudentModalLabel">Select A Client (Parents / Guardian)</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-12" id="loadAdminStudentTop">

                    <div class="container" id="add-student-modal-container">
                      <!-- Student header -->
                      <div class="row lesson-header">
                        <div class="col-md-3">
                          <p>Guardian Name</p>
                        </div>
                        <div class="col-md-3">
                          <p>Guardian Phone</p>
                        </div>
                        <div class="col-md-3">
                          <p>Student Name</p>
                        </div>
                        <div class="col-md-3 text-center">
                          <p>Action</p>
                        </div>
                      </div>


                      <!-- <div class="row student-wrapper">
                        <div class="col-md-6">
                          <p class="student-item">+60138252818</p>
                        </div>
                        <div class="col-md-3">
                          <p class="student-item">Join as Student Parent</p>
                        </div>
                        <div class="col-md-3">
                          <p class="student-item">Join as Student</p>
                        </div>
                        <div class="col-md-3">
                        </div>
                      </div> -->

                      <!-- Student List Start -->

                    </div>

                  </div>
                </div>


                <div class="row">
                  <div class="col-md-12 text-center">
                    <button type="button" class="btn btn-outline-primary btn-sm btn-round" id="btnAddAdminStudentModalLoadMore" >Load More</button>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-success" data-dismiss="modal" data-toggle="modal" data-target="#editClientModal" type="button" data-gurid="" data-gurname="" data-gurphone="" data-guremail="" data-guraddr="">Add Unregistered Client</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <!-- <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnAddStudentModalUpdate" >Add</button> -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit business address and contact details modal -->
      <div class="row">
        <div class="modal fade" id="addBusinessDetailModal" tabindex="-1" role="dialog" aria-labelledby="addBusinessDetailModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addBusinessDetailModalLabel">Edit Business Address and Contact</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btnAddBusinessDetailModalClose1">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="addBusinessDetailModalBody">
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Personal / Business Name* <span id="countName" style="color: grey; margin-left: 1rem;">0/40</span></span>
                  <input type="text" class="form-control" id="inName" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40">
                </div>

                <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0; margin-top: 1rem;">Current Business Details</span>
                <p id="inDetails" style="padding : 1rem; border: solid thin #2e74b6;"></p>
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">New Business Contact </span>
                  <input type="text" class="form-control" id="inContact" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40">
                </div>
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">New Business Email </span>
                  <input type="text" class="form-control" id="inEmail" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40">
                </div>
                <div class="form-group">
                  <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">New Business Address </span>
                  <textarea class="form-control" maxlength="250" rows="4"  id="inAddr" data-compulsory="false"></textarea>
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnAddBusinessDetailModalClose2">Not Now</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnAddBusinessDetailModalUpdate" disabled>Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Modal -->
      <div class="row">
        <div class="modal fade" tabindex="-1" role="dialog" id="loadingModal" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered text-center" role="document">
            <div class="container-fluid">
              <div class="row d-flex">
                <span class="fa fa-spinner fa-spin fa-5x w-100" style="color: #fff ;"></span>
                <div class="col align-self-center">
                  <!-- <h5 class="modal-title" style="color: white;">Generating invoice in progress. </h5> -->
                  <!-- <h5 class="modal-title" style="color: white;"> Please do not close this window.</h5> -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sign-out modal -->
      <div class="row">
        <div class="modal fade" id="signOutModal" tabindex="-1" role="dialog" aria-labelledby="signOutModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="signOutLabel">Logging Out</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="signOutModalBody">
                Are you sure you want to continue?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnSignOutModalUpdate">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main content -->
      <div class="content">
        <div class="container-fluid">
          <!-- your content here -->

          <!-- Main content -->
          <!-- Button -->
          <div class="row d-flex" id="desciption-row" >
            <div class="p-2">
              <a href="./" class="btn btn-outline-primary btn-round" name="param-link"><i class="material-icons" style="color: #2e74b6; margin-right: 5px;">west</i> Back</a>
            </div>
            <div class="p-2">
              <!-- <button type="button" id="btnDownloadPdf"></button>  -->
              <!-- <a href="javascript:;" class="btn btn-outline-primary btn-round" id="" onclick="generatePDFeKoopmans('invTemplate')" disabled> Download as PDF</a> -->
            </div>
            <div class="ml-auto p-2">
              <button href="javascript:;" class="btn btn-outline-primary btn-round hidden" name="param-link" perm="fin-invoice-add" id="btnSave" data-toggle="" data-target="#saveModal" onclick="validateForm('accordionExample'); fieldChecker();" style="background-color: #2e74b6; color: #fff;" disabled>Done <i class="material-icons" style="color: #fff; margin-left: 5px;">east</i> </button>
            </div>
          </div>

          <!-- Main panel -->
          <div class="row">
            <div class="col-md-12">
              <div class="accordion" id="accordionExample" >
                <div class="card">
                  <div class="card-header" id="headingOne" style="padding: 0; margin: 0; ">
                    <h2 class="mb-0">
                      <a class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne" style="text-transform: none; font-size: medium;">
                        Add business details
                      </a>
                    </h2>
                  </div>

                  <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample" style="padding: 0; margin: 0;">
                    <div class="card-body" >
                      <div class="row">
                        <div class="col-md-4 text-center">

                          <div class="form-group">

                            <div style="height: 115px; width: 100%; display: inline-block; position: relative; overflow: hidden; cursor: pointer;">
                              <img id="tutorImgUrl" style="height: 100%; width: auto;" src="../../assets/img/empty-photo.png"/>
                            </div>
                            <input type="file" id="select_image" name="image" style="display:none" accept="image/x-png,image/jpeg"> </input>

                            <!-- <h6>Add Logo</h6> -->
                            <!-- <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0; line-height: 0">Maximum 5MB in size. JPEG or PNG formats. <br>Recommended size: 300 x 200 pixels</span>  -->
                          </div>
                        </div>

                        <div class="col-md-4">
                          <!--  Do nothing -->
                        </div>

                        <div class="col-md-4 text-right">
                          <h4 style="font-size: xx-large;margin-top: 1rem;">INVOICE</h4>

                          <div class="form-group">
                            <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin-bottom: 0;">Summary (e.g class name, description of invoice) <span id="countTitle" style="color: grey; margin-left: 1rem;">0/40</span></span>
                            <input type="text" class="form-control" id="invTitle" data-compulsory="false" oninput="this.className = 'form-control'"  maxlength="40" style="border: solid #dddddd thin; display: block;  padding-left: 0.5rem;">
                          </div>
                          <h4 id="invBizName" style="font-weight: 500;">Your Name</h4>
                          <h6 id="invBizDetails"  style="text-transform: none; font-weight: 300;"></h6>
                          <a href="javascript:;" data-toggle="modal" data-target="#addBusinessDetailModal">Edit Business Address and Contact</a>
                        </div>

                      </div>

                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-4">
                        <h6>Billed To:</h6>
                        <div id="invClientId" value=''></div>
                        <h4 id="invClientName" style="font-weight: 500;"></h4>
                        <h6 id="invClientDetails" style="text-transform: none; font-weight: 300;"></h6>
                        <div class="div">
                          <a id="invAllStudentLink" href="javascript:;" data-toggle="modal" data-target="" onclick="appendModal('addStudentModal')">Add Client*</a>
                        </div>
                      </div>

                      <div class="col-md-4"></div>
                      <div class="col-md-4">
                        <div class="row">
                          <div class="col-6 text-right" style="padding-right: 0;">
                            <div style="margin-top: 0.8rem;">
                              <p style="font-weight: 500; text-transform: uppercase;">Invoice No*</p>
                            </div>
                            <div style="margin-top: 0.8rem;">
                              <p style="font-weight: 500; text-transform: uppercase;">Invoice Date*</p>
                            </div>
                            <div style="margin-top: 0.8rem;">
                              <p style="font-weight: 500; text-transform: uppercase; color: red; ">Payment Due*</p>
                            </div>
                            <div style="margin-top: 0.8rem;">
                              <p style="font-weight: 500; text-transform: uppercase;">Status</p>
                            </div>
                          </div>
                          <div class="col-6 text-right">
                            <input type="text" class="form-control" id="invNum" data-compulsory="true" oninput="this.className = 'form-control'; enableSaveModal();"  maxlength="15" style="border: solid #dddddd thin; display: block; margin: 0.3rem; padding-left: 0.5rem;">
                            <input type="text" class="form-control" id="invIssueDate" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40" style="border: solid #dddddd thin; display: block; margin: 0.3rem; padding-left: 0.5rem; cursor: pointer;">
                            <input type="text" class="form-control" id="invPaymentDue" data-compulsory="true" oninput="this.className = 'form-control'"  maxlength="40" style="border: solid #dddddd thin; display: block; margin: 0.3rem; padding-left: 0.5rem; cursor: pointer;" >
                            <input type="text" class="form-control" id="invStatus" data-compulsory="false" oninput="this.className = 'form-control'"  maxlength="40" style="border: solid #dddddd thin; display: block; margin: 0.3rem; padding-left: 0.5rem;" value='New' readonly>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div style="margin-top: 1rem;"></div>

                    <div class="row">
                      <span class="" style="font-size: x-small; font-weight: 300; color: gray; margin: 0 auto 0 1rem;">Note*: Quantity - Number of hour of lessons conducted, number of classes, or relevant other items</span>

                      <div class="col-12" id="table-top" style="overflow-x:auto; padding: 0">

                        <!-- Header start here -->
                        <div class="row table-header" style="margin: auto 1rem auto 1rem;">
                          <div class="col-md-12" style="background-color: grey; color: white;">
                            <table id="table" class="table-light table-sm" cellspacing="0" width="100%" style="background-color: grey; color: white;">
                              <thead>
                                <tr>
                                  <!-- <th style="width: 30px; min-width: 30px;"></th> -->
                                  <th style="min-width: 200px;">Items</th>
                                  <th style="width: 100px; min-width: 100px;text-align: right;">Quantity*</th>
                                  <th style="width: 100px; min-width: 100px;text-align: right;">Price</th>
                                  <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
                                  <th style="width: 30px; min-width: 30px;"></th>
                                </tr>
                              </thead>
                              <tbody id="itemBody" style="visibility: collapse;">
                                <!-- <tr class="item">
                                  <td><i class="fas fa-grip-vertical"></i></td>
                                  <td><input type="text" class="form-control" style="border: solid #2e74b6 thin;" placeholder=" Enter item and description" oninput="printPreview();"></td>
                                  <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="calculateAmount(); printPreview();"></td>
                                  <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="-" oninput="calculateAmount(); printPreview();"></td>
                                  <td style="text-align: right;"></td>
                                  <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeRow(this); printPreview();"></i></td>
                                </tr>
                                <tr class="subtotal">
                                  <td></td>
                                  <td></td>
                                  <td></td>
                                  <td style="text-align: right; font-weight: 500;">Subtotal</td>
                                  <td style="text-align: right; font-weight: 500;" id="subtotalItem"></td>
                                  <td></td>
                                </tr> -->
                              </tbody>
                            </table>
                          </div>
                        </div>


                        <!-- Item start here -->

                        <!-- <div class="row table-item-top" name="aaa">
                          <div class="col-md-12 table-item" >
                            <span class="table-title" style="font-size: small; font-weight: 300; color: gray; margin-bottom: 0;">Standard 6 Mathematics</span>
                            <span class="" style="font-size: small; font-weight: 300; color: white; margin-bottom: 0; background-color: #2e74b6; border-radius: 6px; padding: 2px 6px 2px 6px;">seremban</span>
                            <span class="table-tag" style="font-size: small; font-weight: 300; color: white; margin-bottom: 0; background-color: #2e74b6; border-radius: 6px; padding: 2px 6px 2px 6px;">english</span>
                            <table name="table_aaa" class="table-light table-sm" cellspacing="0" width="100%">
                              <thead style="visibility: collapse;">
                                <tr>
                                  <th class="th-item"></th>
                                  <th class="th-quantity"></th>
                                  <th class="th-price"></th>
                                  <th class="th-amount"></th>
                                  <th class="th-action"></th>
                                  <th class="th-hidden" name="refId">crsathwer3dsef</th>
                                  <th class="th-hidden" name="cat">aaa</th>
                                  <th class="th-hidden" name="tag">seremban, grade1, home_tuition</th>
                                  <th class="th-hidden" name="name">Standard 6 Mathematics</th>

                                </tr>
                              </thead>
                              <tbody name="body_aaa" style="border-bottom: solid thin #eeeeee;">
                                <tr class="item">
                                  <td><input type="text" class="form-control" placeholder=" Enter item and description" oninput="//printPreview();"></td>
                                  <td><input type="number" class="form-control" value="-" oninput="calculateAmount2(); //printPreview();"></td>
                                  <td><input type="number" class="form-control" value="-" oninput="calculateAmount2(); //printPreview();"></td>
                                  <td class="td-amount"></td>
                                  <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeItem(this); //calculateAmount(); printPreview();"></i></td>
                                  <td class="td-hidden" name="amount">2325.034</td>
                                </tr>
                                <tr class="subtotal">
                                  <td>
                                    <a class="addrow" href="javascript:;" id="addRow" onclick="addRow(this);">Add new row</a>
                                  </td>
                                  <td></td>
                                  <td class="td-subtotal">Subtotal</td>
                                  <td class="td-subtotal" id="subtotalItem_aaa"></td>
                                  <td></td>
                                  <td class="td-hidden" name="subtotal">7675.096324</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div> -->

                        <!-- Uncategorized, Untagged item -->
                        <!-- <div class="row table-item-top" name="uncategorized">
                          <div class="col-md-12 table-item">
                            <span class="" style="font-size: small; font-weight: 300; color: gray; margin-bottom: 0;">New Item</span>
                            <table name="table_uncategorized" class="table-light table-sm" cellspacing="0" width="100%"  style="border-bottom: solid thin #eeeeee;">
                              <thead style="visibility: collapse;">
                                <tr>
                                  <td class="th-item"></td>
                                  <td class="th-quantity"></td>
                                  <td class="th-price"></td>
                                  <td class="th-amount"></td>
                                  <td class="th-action"></td>
                                  <td class="th-hidden" name="refId">uncategorized</td>
                                  <td class="th-hidden" name="cat"></td>
                                  <td class="th-hidden" name="tag"></td>
                                  <td class="th-hidden" name="name">New Item</td>
                                </tr>
                              </thead>
                              <tbody name="body_uncategorized" >
                                <tr class="item">
                                  <td><input type="text" class="form-control" placeholder=" Enter item and description" oninput="printPreview();"></td>
                                  <td><input type="number" class="form-control" value="-" oninput="calculateAmount2(); printPreview();"></td>
                                  <td><input type="number" class="form-control" value="-" oninput="calculateAmount2(); printPreview();"></td>
                                  <td class="td-amount"></td>
                                  <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeItem(this); printPreview(); //calculateAmount(); "></i></td>
                                  <td class="td-hidden" name="amount">2325.034</td>
                                </tr>
                                <tr class="subtotal">
                                  <td>
                                    <a class="addrow" href="javascript:;" id="addRow" onclick="addRow(this);">Add new row</a>
                                  </td>
                                  <td></td>
                                  <td class="td-subtotal">Subtotal</td>
                                  <td class="td-subtotal" id="subtotalItem_aaa"></td>
                                  <td></td>
                                  <td class="td-hidden" name="subtotal">7675.096324</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div> -->

                        <!-- New Design -->
                        <!-- <div class="row table-item-top" name="uncategorized">
                          <div class="col-md-12 table-item">
                            <span class="" style="font-size: small; font-weight: 300; color: gray; margin-bottom: 0;">New Design </span>
                            <span>
                              <a href="javascript:;" data-toggle="modal" data-target="#editItemModal" data-edititemtitle="New Design" data-edititemrefid="uncategorized" data-edititemcat="Uncategorized" data-edititemtag="selangor_kl, ksie, aksjdak,2342">
                                <i class="fas fa-pen"></i>
                              </a>
                            </span>
                            <table name="table_uncategorized" class="table-light table-sm" cellspacing="0" width="100%"  style="border-bottom: solid thin #eeeeee;">
                              <thead style="visibility: collapse;">
                                <tr>
                                  <td class="th-item"></td>
                                  <td class="th-quantity"></td>
                                  <td class="th-price"></td>
                                  <td class="th-amount"></td>
                                  <td class="th-action"></td>
                                  <td class="th-hidden" name="refId">uncategorized</td>
                                  <td class="th-hidden" name="cat">Uncategorized</td>
                                  <td class="th-hidden" name="tag"></td>
                                  <td class="th-hidden" name="name">New Design</td>
                                </tr>
                              </thead>
                              <tbody name="body_uncategorized" >
                                <tr class="item">
                                  <td><input type="text" class="form-control" placeholder=" Enter item and description" oninput="printPreview();"></td>
                                  <td><input type="number" class="form-control" value="-" oninput="calculateAmount2(); printPreview();"></td>
                                  <td><input type="number" class="form-control" value="-" oninput="calculateAmount2(); printPreview();"></td>
                                  <td class="td-amount"></td>
                                  <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeItem(this); printPreview(); //calculateAmount(); "></i></td>
                                  <td class="td-hidden" name="amount">2325.034</td>
                                </tr>
                                <tr class="subtotal">
                                  <td>
                                    <a class="addrow" href="javascript:;" id="addRow" onclick="addRow(this);">Add new row</a>
                                  </td>
                                  <td></td>
                                  <td class="td-subtotal">Subtotal</td>
                                  <td class="td-subtotal" id="subtotalItem_aaa"></td>
                                  <td></td>
                                  <td class="td-hidden" name="subtotal">7675.096324</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div> -->



                        <!-- Additional Items Start here -->
                        <div class="row table-subtotal" style="margin: 0.5rem 0 auto 0;">

                          <div class="col-md-12">

                            <table id="tableAdditionalItem" class="table-light table-sm" cellspacing="0" width="100%">
                              <thead style="visibility: collapse;">
                                <tr>
                                  <!-- <th style="width: 30px; min-width: 30px;"></th> -->
                                  <th style="min-width: 200px;">Items</th>
                                  <th style="width: 100px; min-width: 100px;text-align: right;">Quantity</th>
                                  <th style="width: 100px; min-width: 100px;text-align: right;">Price</th>
                                  <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
                                  <th style="width: 30px; min-width: 30px;"></th>

                                </tr>
                              </thead>
                              <tbody>
                                <tr class="additional">
                                  <!-- <td></td> -->
                                  <td style="text-align: right;">
                                    <div class="dropdown">
                                      <a class="btn btn-primary dropdown-toggle bg-white text-dark text-right" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="text-transform: none; padding: 0.6rem; margin: 0;">Select one</a>
                                      <div class="dropdown-menu" aria-labelledby="SortBy" id="sort-dropdown-menu">
                                        <a class="dropdown-item" href="javascript:;" onclick="disabledAdditionalItem(this); calculateAmount2(); printPreview();" style="text-transform: none;">Select one</a>
                                        <a class="dropdown-item" href="javascript:;" onclick="enabledAdditionalItem(this, 'Discount'); calculateAmount2(); printPreview();" style="text-transform: none;">Discount ( - )</a>
                                        <a class="dropdown-item" href="javascript:;" onclick="enabledAdditionalItem(this, 'Tax'); calculateAmount2(); printPreview();" style="text-transform: none;">Tax Rate (%)</a>
                                      </div>
                                    </div>
                                  </td>
                                  <td><input type="text" class="form-control" style="border: solid #dddddd thin; text-align: right; padding-right: 1rem;" placeholder='Item' oninput='printPreview();' readonly></td>
                                  <td><input type="number" class="form-control" style="border: solid #dddddd thin; text-align: right;" value="0" oninput="calculateAmount2(); printPreview();" readonly></td>
                                  <td style="text-align: right;"></td>
                                  <td></td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>


                      </div>

                      <div class="col-12">
                        <h3 style="text-align: right; font-weight: 500;">Total <span style="margin-left: 2rem;" id="grandTotal">RM0.00</span></h3>
                        <a href="javascript:;" class="btn btn-primary btn-round" id="addItem" style="text-transform: none;">Add New Item <i class="fas fa-plus-circle" style="color: #fff; margin-left: 0.5em; padding-bottom: 0.2em;"></i></a>
                        <a href="javascript:;" class="btn btn-primary btn-round" id="addAdditionalRow" style="text-transform: none;">Add New Additional Item <i class="fas fa-plus-circle" style="color: #fff; margin-left: 0.5em; padding-bottom: 0.2em;"></i></a>
                      </div>

                      <div class="col-12">
                        <div class="form-group">
                          <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin: 0;">Enter Notes <span id="countNotes" style="color: grey; margin-left: 1rem;">0/400</span></span>
                          <textarea class="form-control" maxlength="400" rows="5"  id="invNotes" data-compulsory="false" placeholder="Enter notes that are visible to your client. (e.g payment guidelines) " oninput="" ></textarea>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header" id="headingThree" style="padding: 0; margin: 0; ">
                    <h2 class="mb-0">
                      <a class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree" style="text-transform: none; font-size: medium;">
                        Footer
                      </a>
                    </h2>
                  </div>
                  <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample" style="padding: 0; margin: 0; ">
                    <div class="card-body" style="padding-top: 0; margin-top: 0; ">
                      <div class="form-group">
                        <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin: 0;">Enter Footer Notes <span id="countFooterNotes" style="color: grey; margin-left: 1rem;">0/200</span></span>
                        <textarea class="form-control" maxlength="200" rows="3"  id="invFooterNotes" data-compulsory="false" placeholder="Write something ..."></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 text-center">
              <h3> - Preview - </h3>
            </div>
          </div>
          <!-- Preview -->
          <div class="row">
            <div class="col-md-12" style="overflow-x:auto; padding: 1rem;" >
              <page size="A4" id="invTemplate" style="position: relative;">

                <div class="card-body" >
                  <div class="row">
                    <div class="col-4 text-center">

                      <div class="form-group">
                        <!-- <canvas id="myCanvas" style="height: 150px;width: 225px; object-fit: cover;" ></canvas> -->
                        <div style="height: 115px;width: auto; display: inline-block; position: relative; overflow: hidden; cursor: pointer;">
                          <img id="previewTutorImgUrl" style="height: 100%; width: auto; " src="../../assets/img/empty-photo.png" crossorigin="anonymous" alt = ""/>
                          <!-- <canvas id="myCanvas" ></canvas> -->
                        </div>
                      </div>
                    </div>

                    <div class="col-2">
                      <!--  Do nothing -->
                    </div>

                    <div class="col-6 text-right">
                      <h4 style="font-size: xx-large;margin-top: 1rem;">INVOICE</h4>
                      <h5 id="previewInvTitle"  style="font-weight: 500;"></h5>
                      <h4 id="previewInvBizName" style="font-weight: 500;">Your Name</h4>
                      <h6 id="previewInvBizDetails" style="text-transform: none; font-weight: 300;"></p>
                    </div>

                  </div>

                </div>

                <hr style="margin: 0rem">
                <!-- style="position: relative; bottom: 35px; width: 100%; margin-top: 2rem;" -->
                <div class="card-body" style="position: relative; bottom: 35px; width: 100%; margin-top: 2rem;">
                  <div class="row">
                    <div class="col-4">
                      <h6>Billed To:</h6>
                      <h4 id="previewInvClientName" style="font-weight: 500;"></h4>
                      <h6 id="previewInvClientDetails"  style="text-transform: none; font-weight: 300;"></h6>
                    </div>

                    <div class="col-4"></div>
                    <div class="col-4">
                      <div class="row">
                        <div class="col-6 text-right" style="padding-right: 0;">
                          <h6>Invoice No</h6>
                          <h6>Invoice Date</h6>
                          <h6 style="color: red;">Payment Due</h6>
                          <h6>Status</h6>

                          <!-- <p style="margin: 0.3rem; font-weight: bold;">Invoice No</p>
                          <p style="margin: 0.3rem; font-weight: bold;">Invoice Date</p>
                          <p style="margin: 0.3rem; font-weight: bold;">Payment Due</p>
                          <p style="margin: 0.3rem; font-weight: bold;">Status</p> -->
                        </div>
                        <div class="col-6 text-right">
                          <h6 id="previewInvNum" style="font-weight: normal; text-transform: none;"> - </h6>
                          <h6 id="previewInvIssueDate"style="font-weight: normal; text-transform: none;"> - </h6>
                          <h6 id="previewInvPaymentDue" style="color: red; font-weight: normal; text-transform: none;"> - </h6>
                          <h6 id="previewInvStatus" style="font-weight: normal; text-transform: none;"> New </h6>
                          <!-- <p style="margin: 0.3rem;">0100010101</p>
                          <p style="margin: 0.3rem;">Status</p>
                          <p style="margin: 0.3rem;">Status</p>
                          <p style="margin: 0.3rem;">Status</p>   -->
                         </div>
                      </div>
                    </div>
                  </div>

                  <div style="margin-top: 1rem;"></div>

                  <div class="row">
                    <div class="col-12"  style="overflow-x:auto;">
                      <span class="" style="font-size: x-small; font-weight: 300; color: gray; margin-bottom: 0;">Note*: Quantity - Number of hour of lessons conducted, number of classes, or relevant other items</span>
                      <table id="tablePreview" class="table-light table-sm" cellspacing="0" width="100%" >
                        <thead style="background-color: grey; color: white;">
                          <tr>
                            <th style="min-width: 200px; font-size: small;">Items</th>
                            <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Quantity</th>
                            <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Price</th>
                            <th style="width: 100px; min-width: 100px;text-align: right; font-size: small;">Amount</th>
                          </tr>
                        </thead>
                        <tbody id="previewItemBody">

                          <!-- <tr class="item">
                            <td style="font-size: small;">Primary class</td>
                            <td style="text-align: right; font-size: small;">1</td>
                            <td style="text-align: right; font-size: small;">25</td>
                            <td style="text-align: right; font-size: small;">RM25.00</td>
                          </tr>
                          <tr class="item">
                            <td style="font-size: small;"> - Lesson 1</td>
                            <td style="text-align: right; font-size: small;">1</td>
                            <td style="text-align: right; font-size: small;">25</td>
                            <td style="text-align: right; font-size: small;">RM25.00</td>
                          </tr>

                          <tr class="subtotal" style="border-bottom: solid #eeeeee thin;">
                            <td></td>
                            <td></td>
                            <td style="text-align: right; font-weight: 500; font-size: small;">Subtotal</td>
                            <td style="text-align: right; font-weight: 500; font-size: small;" id="previewSubtotalItem">RM50.00</td>
                          </tr>
                          <tr class="item">
                            <td style="font-size: small;">Primary class</td>
                            <td style="text-align: right; font-size: small;">1</td>
                            <td style="text-align: right; font-size: small;">25</td>
                            <td style="text-align: right; font-size: small;">RM25.00</td>
                          </tr>
                          <tr class="subtotal" id='previewItemSubtotal' style="border-bottom: solid #eeeeee thin;">
                            <td></td>
                            <td></td>
                            <td style="text-align: right; font-weight: 500; font-size: small;">Subtotal</td>
                            <td style="text-align: right; font-weight: 500; font-size: small;" id="previewSubtotalItem">RM50.00</td>
                          </tr> -->
                        </tbody>
                      </table>

                      <table id="tableAdditionalItemPreview" class="table-light table-sm" cellspacing="0" width="100%">
                        <thead style="visibility: collapse;">
                          <tr>
                            <th style="min-width: 200px;">Items</th>
                            <th style="width: 100px; min-width: 100px;text-align: right;">Quantity</th>
                            <th style="width: 100px; min-width: 100px;text-align: right;">Price</th>
                            <th style="width: 100px; min-width: 100px;text-align: right;">Amount</th>
                          </tr>
                        </thead>
                        <tbody id="previewAdditionalItemBody">
                          <!-- <tr class="additional">
                            <td></td>
                            <td></td>
                            <td style="text-align: right; font-size: small;">Tax(20%)</td>
                            <td style="text-align: right; font-size: small;">RM203.00</td>
                          </tr> -->
                        </tbody>
                      </table>
                    </div>

                    <div class="col-12">
                      <h4 style="text-align: right; font-weight: 500;">Total <span style="margin-left: 2rem;" id="previewGrandTotal">RM0.00</span></h4>
                    </div>

                    <div class="col-12">
                      <!-- <p><strong>Solution with JS (only deals with line breaks): </strong> <textarea class="textarea resize-ta"></textarea></p> -->

                      <!-- <div class="form-group"> -->
                        <span class="" style="font-size: smaller; font-weight: 300; color: gray; margin: 0;">Notes</span>
                        <span  id="previewInvNotes"></span>
                        <!-- <textarea class="form-control" maxlength="250" rows='3' oninput="console.log(this.scrollHeight); this.style.height = (this.scrollHeight) + 'px';// this.setAttribute('rows', 12)" style="height: 4300px; max-height: max-content; overflow: hidden;" id="previewInvNotes" data-compulsory="false" placeholder="Enter notes that are visible to your client. (e.g payment guidelines) " ></textarea> -->

                      <!-- </div> -->
                    </div>
                  </div>
                </div>

                <div class="card-body" id="preview-footer" style="padding-top: 0; margin-top: 0; position: absolute; bottom: 0; width: 100%;">
                  <p id="previewInvFooterNotes" ></p>
                </div>

              </page>
            </div>
          </div>



        </div>

        <footer class="footer">
          <div class="container-fluid">
            <nav class="float-left">
            <ul>
              <!-- <li>
              <a href="https://golearn.com.my/join-us" target="_blank">
                Visit GoLearn Tutor
              </a>
              </li> -->
            </ul>
            </nav>
          </div>
        </footer>
      </div>
    </div>
  </div>


  <script src="../../assets/js/core/jquery.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap-material-design.min.js"></script>
  <script src="../../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="../../assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Material Dashboard -->
  <script src="../../assets/js/material-dashboard.js?v=2.1.2" type="text/javascript"></script>
  <!-- Common constants -->
  <script src="../../assets/js/common.js" type="text/javascript"></script>
  <!-- General Info -->
  <script src="../../assets/js/const.js" type="text/javascript"></script>
  <!-- Core Js -->
  <script src="../../assets/js/org-core.js" type="text/javascript"></script>
  <!-- Datepicker -->
  <script src="../../assets/js/mc-calendar.min.js" type="text/javascript"></script>
  <!-- International Telephone Input -->
  <script src="../../assets/js/plugins/intlTelInput/intlTelInput.js"></script>
  <!-- pdf  -->
  <script src="https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>
  <!-- Tag input -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
  <script src="../../assets/js/tagsinput.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.min.js" integrity="sha384-lpyLfhYuitXl2zRZ5Bn2fqnhNAKOAaM/0Kr9laMspuaMiZfGmfwRNFh8HlMy49eQ"  crossorigin="anonymous"></script> -->


	<script>
    // Course-specific var
    var allCourseSize;

    var latestAdminStuDoc = null;// Store last document - Used for Admin's Student Load More btn in Add Student Modal

    var allItemsArr = [];

    var batch = db.batch();
    var batchUpdate = db.batch();

    var url_string = window.location.href;
    var url = new URL(url_string);
    var clientId = url.searchParams.get("cid");

    // Initialization
    AuthCheck();

    // Page Specific Initialization
    function loadPageInitFunc(){

      // Load Tutor Settings
      loadUserSettings();

      // Add a new item by default
      let uuid = create_UUID();
      addItem("New Item", uuid, 1, 0, 'uncategorized', 'Uncategorized', []);

      // Enable Add Student Modal
      document.getElementById("invAllStudentLink").setAttribute('data-target', '#addStudentModal');

      // Enable Save Inv Modal
      document.getElementById("btnSave").removeAttribute('disabled');

      // Auto Assign Client if available
      if (clientId == null || clientId == ""){
        // console.log('Null or empty cid ' )
      }
      else {
        try {
          let decodeId = decode64(clientId);
          autoAssignClient(decodeId);
        }
        catch(err) {
          console.log('Error: ' + err)
          window.location = "./";
        }
      }

    }

    // Load Tutor Settings
    function loadUserSettings(){

      // Tutor Id must be a phone with +60, no spacing or other chars
      var docRef = db.collection("Settings").doc("v1").collection("Financial").doc(ent_id);

      docRef.get().then((doc) => {

        if (doc.exists){
          console.log("Settings exist")
          updatePageContent(doc);
        }else {
          updatePageContent(null);
        }

        // $('#loadingModal').modal('hide');
      })
    }

    // Init Page View
    function updatePageContent(doc){

      if (doc != null){

        // Business Profile
        document.getElementById("invBizName").textContent = (doc.data()[SET_BIZ_NAME] == null || doc.data()[SET_BIZ_NAME] == '') ? ent_name : doc.data()[SET_BIZ_NAME];
        let bizDetail = '';
        bizDetail += (doc.data()[SET_BIZ_PHONE] == null || doc.data()[SET_BIZ_PHONE] == '') ? ent_phone : doc.data()[SET_BIZ_PHONE];
        bizDetail += (doc.data()[SET_BIZ_EMAIL] == null || doc.data()[SET_BIZ_EMAIL] == '') ? '' : ', <br>' + doc.data()[SET_BIZ_EMAIL];
        bizDetail += (doc.data()[SET_BIZ_ADDR] == null || doc.data()[SET_BIZ_ADDR] == '') ? '' : ', <br>' + doc.data()[SET_BIZ_ADDR];
        document.getElementById("invBizDetails").innerHTML = bizDetail;
        if (doc.data()[SET_BIZ_IMG_URL] == null || doc.data()[SET_BIZ_IMG_URL] == ''){
          document.getElementById("tutorImgUrl").style.display = 'none';
          document.getElementById("tutorImgUrl").src =  "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D";
        }
        else{
          document.getElementById("tutorImgUrl").src =  doc.data()[SET_BIZ_IMG_URL];
        }
        // document.getElementById("tutorImgUrl").src = doc.data()[SET_BIZ_IMG_URL] == null || doc.data()[SET_BIZ_IMG_URL] == '' ?  '../../assets/img/empty-photo.png' : doc.data()[SET_BIZ_IMG_URL];

        document.getElementById("invIssueDate").value = new Date().toLocaleDateString("en-GB");

        document.getElementById("invNotes").value = doc.data()[SET_INV_NOTE];
        // tinymce.get("invNotes").setContent(doc.data()[SET_INV_NOTE]);
        // let invNotesContent = tinymce.get("invNotes").getContent({ format: "text" });
        // document.getElementById("countNotes").textContent = invNotesContent.length + '/400';

        document.getElementById("invFooterNotes").value = doc.data()[SET_INV_FOOTER_NOTE]
        // tinymce.get("invFooterNotes").setContent(doc.data()[SET_INV_FOOTER_NOTE]);
        // let invFooterNotesContent = tinymce.get("invFooterNotes").getContent({ format: "text" });
        // document.getElementById("countFooterNotes").textContent = invFooterNotesContent.length + '/200';

        // Preview
        // document.getElementById("previewTutorImgUrl").src = doc.data()[SET_BIZ_IMG_URL] == null || doc.data()[SET_BIZ_IMG_URL] == '' ?  '../../assets/img/empty-photo.png' : doc.data()[SET_BIZ_IMG_URL];
        // document.getElementById("previewTutorImgUrl").src = 'https://golearn.com.my/wp-content/uploads/Home-3-Simple-Steps-Photo-1-1-1536x1257.png';
        // document.getElementById("previewTutorImgUrl").src = '../../assets/img/empty-photo.png';

        // Sample test img
        // https://www.gravatar.com/avatar/d50c83cc0c6523b4d3f6085295c953e0
        // https://golearn.com.my/wp-content/uploads/Home-3-Simple-Steps-Photo-1-1-1536x1257.png'
        // https://github.com/softius/php-cross-domain-proxy

        // NOTE: Getting img blob directly from firestore is disallowed. we need a proxy server to hold the image.
        let imgtxt = doc.data()[SET_BIZ_IMG_URL] == null || doc.data()[SET_BIZ_IMG_URL] == '' ?  'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D' : 'https://golearn.com.my/proxy.php?csurl='+doc.data()[SET_BIZ_IMG_URL];
        console.log(imgtxt)
        if (doc.data()[SET_BIZ_IMG_URL] == null || doc.data()[SET_BIZ_IMG_URL] == ''){
          document.getElementById("previewTutorImgUrl").style.display = 'none';
          document.getElementById("previewTutorImgUrl").src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D";
        }
        else {
          // NOTE: DEPRECIATED
          // toDataURL(
          //   // 'https://www.gravatar.com/avatar/d50c83cc0c6523b4d3f6085295c953e0',
          //   // 'https://murmuring-headland-66106.herokuapp.com/https://www.gravatar.com/avatar/d50c83cc0c6523b4d3f6085295c953e0',
          //   // 'https://murmuring-headland-66106.herokuapp.com/https://golearn.com.my/wp-content/uploads/Home-3-Simple-Steps-Photo-1-1-1536x1257.png',
          //   // 'https://golearn.com.my/wp-content/uploads/Home-3-Simple-Steps-Photo-1-1-1536x1257.png',
          //   // 'https://cors-anywhere.herokuapp.com/https://golearn.com.my/wp-content/uploads/Home-3-Simple-Steps-Photo-1-1-1536x1257.png',
          //   doc.data()[SET_BIZ_IMG_URL] == null || doc.data()[SET_BIZ_IMG_URL] == '' ?  'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D' : 'https://golearn.com.my/proxy.php?csurl='+doc.data()[SET_BIZ_IMG_URL],
          //   // doc.data()[SET_BIZ_IMG_URL] == null || doc.data()[SET_BIZ_IMG_URL] == '' ?  'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D' : 'https://murmuring-headland-66106.herokuapp.com/'+doc.data()[SET_BIZ_IMG_URL],

          //   function(dataUrl) {
          //     // var imgTarget = document.getElementById("previewTutorImgUrl");
          //     // imgTarget.src = dataURL;

          //     console.log('RESULT 1:', dataUrl)
          //   },
          //   'image/jpeg'
          // );

          // NOTE: NEW
          toDataURLNew(
          imgtxt,
          function(dataUrl) {
            var imgTarget = document.getElementById("previewTutorImgUrl");
            imgTarget.src = dataUrl;
            // console.log('RESULT:', dataUrl)
          }
        )

        }

        function toDataURLNew(url, callback) {
          var xhr = new XMLHttpRequest();
          console.log('xhr:')
          xhr.onload = function() {
            var reader = new FileReader();
            reader.onloadend = function() {
              callback(reader.result);
            }
            reader.readAsDataURL(xhr.response);
          };
          xhr.open('GET', url);
          xhr.responseType = 'blob';
          xhr.send();
        }



        // document.getElementById("previewInvTitle").textContent = doc.data()[SET_BIZ_NAME];
        document.getElementById("previewInvBizName").textContent = (doc.data()[SET_BIZ_NAME] == null || doc.data()[SET_BIZ_NAME] == '') ? ent_name : doc.data()[SET_BIZ_NAME];
        document.getElementById("previewInvBizDetails").innerHTML = bizDetail;
        document.getElementById("previewInvIssueDate").textContent = new Date().toLocaleDateString("en-GB");
        document.getElementById("previewInvNotes").innerHTML = doc.data()[SET_INV_NOTE];
        document.getElementById("previewInvFooterNotes").innerHTML = doc.data()[SET_INV_FOOTER_NOTE];

        // Fully populate the fields, Init MCE for notes and footer
        initTinyMCE();

      }
      // No business setting found
      else{
        // Business Profile
        document.getElementById("invBizName").textContent = (ent_name == null || ent_name == '') ? "Your Account Name" : ent_name;
        document.getElementById("invBizDetails").innerHTML = "";

        document.getElementById("tutorImgUrl").style.display = 'none';
        document.getElementById("tutorImgUrl").src =  "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D";

        document.getElementById("invIssueDate").value = new Date().toLocaleDateString("en-GB");

        document.getElementById("invNotes").value = "";
        // tinymce.get("invNotes").setContent("");
        // document.getElementById("countNotes").textContent = '0/400';

        document.getElementById("invFooterNotes").value = "";
        // tinymce.get("invFooterNotes").setContent("");
        // document.getElementById("countFooterNotes").textContent = '0/200';

        document.getElementById("previewTutorImgUrl").src =  "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D";
        document.getElementById("previewTutorImgUrl").style.display = 'none';

        document.getElementById("previewInvBizName").textContent = (ent_name == null || ent_name == '') ? "Your Account Name" : ent_name;
        document.getElementById("previewInvBizDetails").innerHTML = "";
        document.getElementById("previewInvIssueDate").textContent = new Date().toLocaleDateString("en-GB");
        document.getElementById("previewInvNotes").innerHTML = "";
        document.getElementById("previewInvFooterNotes").innerHTML = "";

        // Fully populate the fields, Init MCE for notes and footer
        initTinyMCE();

      }

    }

    function toDataURL(src, callback, outputFormat) {
      var img = new Image();
      // var img = document.getElementById("tutorImgUrl");
      var dataURL;
      img.crossOrigin = 'Anonymous';
      img.src = src;
      console.log(src)

      img.onload = function() {
        var canvas = document.createElement('CANVAS');
        var ctx = canvas.getContext('2d');

        canvas.height = this.naturalHeight;
        canvas.width = this.naturalWidth;
        ctx.drawImage(this, 0, 0);

        dataURL = canvas.toDataURL(outputFormat);
        // img.src = dataURL;
        console.log(dataURL)
        var imgTarget = document.getElementById("previewTutorImgUrl");
        imgTarget.src = dataURL;
        callback(dataURL);
      };
      // img.src = src;
      // img.src = dataURL;
      if (img.complete || img.complete === undefined) {
        img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
        img.src = src;
      }
    }

    // toDataURL(
    //   'https://www.gravatar.com/avatar/d50c83cc0c6523b4d3f6085295c953e0',
    //   function(dataUrl) {
        // console.log('RESULT:', dataUrl)
    //   }
    // )


    // Auto Assign Clients
    function autoAssignClient(decodeId) {

      $('#editClientModal').modal('show');

      // Disable Buttons first
      document.getElementById("inClientName").setAttribute('readonly', true);
      document.getElementById("inClientContact").setAttribute('readonly', true);
      document.getElementById("btnEditClientModalUpdate").setAttribute('disabled', true);
      document.getElementById("btnEditClientModalUpdate").textContent = "Loading. Please wait...";

      let clientDocRef = db.collection("Class")
        .doc("v1")
        .collection("Student")
        .where(STU_ADMIN_ID, "==", ent_id)
        .where(STU_GUR_ID, "==", decodeId)
        .where(STU_STATUS_ADMIN, "==", true)
        .limit(1);

      clientDocRef.get()
      .then((querySnapshot) => {

        if (querySnapshot != null && querySnapshot.docs.length > 0) {

          querySnapshot.forEach((doc) => {

            ID = decodeId;
            NAME = doc.data()[STU_GUR_NAME];
            PHONE = doc.data()[STU_GUR_PHONE];
            EMAIL = doc.data()[STU_GUR_EMAIL];
            ADDRESS = doc.data()[STU_GUR_ADDR];

            // Load Desription
            document.getElementById("inClientId").setAttribute('value', ID);
            document.getElementById("inClientName").value = NAME;
            // document.getElementById("inClientContact").value = PHONE;
            itiPhone.setNumber(PHONE);
            document.getElementById("inClientEmail").value = EMAIL;
            document.getElementById("inClientAddr").value = ADDRESS;

            // Disable Buttons first
            document.getElementById("inClientName").removeAttribute('readonly');
            document.getElementById("inClientContact").setAttribute('readonly', true);
            document.getElementById("btnEditClientModalUpdate").removeAttribute('disabled');
            document.getElementById("btnEditClientModalUpdate").textContent = "Confirm";

          });
        } else {
          console.log('Client Not Found')
        }
      })
    }

    //---------- Init All Admin's Student details ----------//
    // Lesson Load More Button - Init
    const stuAdminLoadmore = document.querySelector('#btnAddAdminStudentModalLoadMore');
    stuAdminLoadmore.style.visibility='hidden';

    const stuAdminLoadMoreHandleClick = () =>{
      loadAllAdminStudents();
    }
    stuAdminLoadmore.addEventListener('click', stuAdminLoadMoreHandleClick );

    // Load All Admin's Students that owned by class admin.
    var allStuModuleDoc = []; // Reset all students doc
    var allParentListDoc = []; // Get all the unique parents
    function loadAllAdminStudents(){

      // STUDENT Module
      let docRef = db.collection("Class")
          .doc("v1")
          .collection("Student")
          .where(STU_ADMIN_ID, "==", ent_id)
          .where(STU_STATUS_ADMIN, "==", true)
          .orderBy(STU_GUR_NAME, 'asc')
          .startAfter(latestAdminStuDoc)
          .limit(25);

      docRef
      .get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {

          allStuModuleDoc.push(doc.data());
          // console.log(doc.data());
          renderAllAdminGuardian(doc);

        });

        // console.log("allStuModuleDoc")
        // console.log(allStuModuleDoc)

        latestAdminStuDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
        // console.log(querySnapshot.docs.length)
        // Handle Lesson Load more btn
        if (querySnapshot.empty){
          stuAdminLoadmore.removeEventListener('click', stuAdminLoadMoreHandleClick );
        }

        if (querySnapshot.docs.length == 25){
          stuAdminLoadmore.style.visibility='visible';
        }else{
          stuAdminLoadmore.style.visibility='hidden';
        }

      }).catch((error) => {
          console.log("Error getting document:", error);
      });


    }


    // Render all admin's students in Add Student Modal
    function renderAllAdminGuardian(doc){

      let gurPhone_p = document.createElement('p');
      gurPhone_p.className = "student-item";
      gurPhone_p.textContent = doc.data()[STU_GUR_PHONE];
      let gurPhone_div = document.createElement('div');
      gurPhone_div.className = "col-md-3";
      gurPhone_div.appendChild(gurPhone_p);

      let gurName_p = document.createElement('p');
      gurName_p.className = "student-item";
      gurName_p.textContent = doc.data()[STU_GUR_NAME];
      let gurName_div = document.createElement('div');
      gurName_div.className = "col-md-3";
      gurName_div.appendChild(gurName_p);

      let stuName_p = document.createElement('p');
      stuName_p.className = "student-item";
      stuName_p.textContent = doc.data().childName;
      let stuName_div = document.createElement('div');
      stuName_div.className = "col-md-3";
      stuName_div.appendChild(stuName_p);

      // let stuGender_p = document.createElement('p');
      // stuGender_p.className = "student-item";
      // stuGender_p.textContent = (doc.data().childGender === 0) ? 'Male' : 'Female';
      // let stuGender_div = document.createElement('div');
      // stuGender_div.className = "col-md-3";
      // stuGender_div.appendChild(stuGender_p);

      let sel_btn = document.createElement('button');
      sel_btn.className = "btn btn-primary btn-sm";
      sel_btn.textContent = 'Select';
      sel_btn.setAttribute('data-dismiss','modal');
      sel_btn.setAttribute('data-toggle','modal');
      sel_btn.setAttribute('data-target','#editClientModal');
      sel_btn.setAttribute('type','button')
      // sel_btn.setAttribute('onclick',"AddNewStudentsToDB('"+doc.data().id+"')");
      sel_btn.setAttribute('data-gurid',doc.data()[STU_GUR_ID]);
      sel_btn.setAttribute('data-gurname',doc.data()[STU_GUR_NAME]);
      sel_btn.setAttribute('data-gurphone',doc.data()[STU_GUR_PHONE]);
      sel_btn.setAttribute('data-guremail',doc.data()[STU_GUR_EMAIL]);
      sel_btn.setAttribute('data-guraddr',doc.data()[STU_GUR_ADDR]);
      let sel_div = document.createElement('div');
      sel_div.className = "col-md-3 text-center";
      sel_div.appendChild(sel_btn);

      let stuDetail_div = document.createElement('div');
      stuDetail_div.className = 'row student-wrapper';
      stuDetail_div.appendChild(gurName_div);
      stuDetail_div.appendChild(gurPhone_div);
      stuDetail_div.appendChild(stuName_div);
      stuDetail_div.appendChild(sel_div);

      const add_student_modal_container = document.getElementById("add-student-modal-container");
      add_student_modal_container.appendChild(stuDetail_div)
    }

    // Load client's active classes
    function loadAllClientClassInfo(clientId){

      // Clear the existing invoice tables
      clearItems();

      var docRef = db.collection("Class")
          .doc("v1")
          .collection("Class")
          .where(CLASS_VIEWER_ID_ARR, "array-contains", clientId)
          .where(CLASS_ADMIN_ID, "==", ent_id)
          .where(STATUS_KEY, "==", true)
          .where(CLASS_STATUS, "==", CLASS_STATUS_ACTIVE)
          .orderBy(CLASS_NAME, 'asc');
          // .startAfter(latestClassDoc)
          // .limit(10);

      docRef
      .get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          console.log("Load Client's Class")
          console.log(doc.data())

          if (doc.data()[CLASS_FEES_TYPE_KEY] === FEES_TYPE_PER_MONTH_KEY){
            // Per month
            // renderAllInvoiceItems(doc);

            renderAllInvoiceItems2(doc, clientId);
          }else{
            // Per Hour

            LoadLessonInfo(doc, clientId);
          }

        });
        // Assign draggle feature to all items
        // assignDraggable();
        // Calculate the amount
        calculateAmount2();
        // Update preview
        printPreview();
      });

    };

    // Load Lesson Details
    function LoadLessonInfo( classDoc, clientId ){
      let invIssueDate = document.getElementById("invIssueDate").value;
      // console.log("invIssueDate: "+invIssueDate)
      // let today = new Date();
      let issueDate = invIssueDate.split("/");
      let today = new Date( issueDate[2], issueDate[1] - 1, issueDate[0]);
      let month = today.getUTCMonth() + 1; //months from 1-12
      let day = today.getUTCDate();
      let year = today.getUTCFullYear();
      // Prepend a 0 to all month
      let formattedMonth = ("0" + month).slice(-2);
      // console.log(''+year+month);
      console.log(''+year+formattedMonth);

      // Get all lessons of this month
      let docRef = db.collection("Class")
          .doc("v1")
          .collection("Lesson")
          .where("classId", "==", classDoc.data()[CLASS_ID])
          .where(LESSON_MONTH_TYPE, "==", parseInt(''+year+formattedMonth))
          .where("status", "==", true)
          .orderBy('lesDate', 'asc');

      docRef
      .get()
      .then((querySnapshot) => {
        console.log('Total Lessons Found: '+querySnapshot.docs.length);

        renderAllInvoiceItems2(classDoc, clientId);

        querySnapshot.forEach((doc) => {
          // console.log(doc.data());

          renderAllLessonItems(doc, classDoc.data()[CLASS_FEES_KEY], classDoc.data()[CLASS_ID]);

        });
        // renderAllInvoiceItems(classDoc);

        // Assign draggle feature to all items
        // assignDraggable();

        // Calculate the amount
        calculateAmount2();

        // Update preview
        printPreview();

      }).catch((error) => {
          console.log("Error getting document:", error);
      });

    }

    // Render class components
    function renderAllInvoiceItems(doc){
    // <tr class="item">
    //   <td><i class="fas fa-grip-vertical"></i></td>
    //   <td><input type="text" class="form-control" style="border: solid #2e74b6 thin;" placeholder=" Enter item and description"></td>
    //   <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="1" oninput="calculateAmount()"></td>
    //   <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="0" oninput="calculateAmount()"></td>
    //   <td style="text-align: right;"></td>
    //   <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeRow(this)"></i></td>
    // </tr>

      let td1_html = '';
      td1_html = "<i class='fas fa-grip-vertical'></i>";
      let td1 = document.createElement('td');
      td1.innerHTML = td1_html;

      let td2_html = '';
      let className = doc.data()[CLASS_NAME];
      td2_html = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; padding-left: 0.5rem;' placeholder='Enter item and description' value='"+ className +"' onclick='printPreview();'>";
      let td2 = document.createElement('td');
      td2.innerHTML = td2_html;

      let td3_html = '';
      let quantity = doc.data()[CLASS_FEES_TYPE_KEY] === FEES_TYPE_PER_MONTH_KEY ? 1 : '-';
      td3_html = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' oninput='calculateAmount(); printPreview();' value='"+ quantity +"'>";
      let td3 = document.createElement('td');
      td3.innerHTML = td3_html;

      let td4_html = '';
      let classFee = doc.data()[CLASS_FEES_TYPE_KEY] === FEES_TYPE_PER_MONTH_KEY ? doc.data()[CLASS_FEES_KEY] : '-';
      td4_html = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' oninput='calculateAmount(); printPreview();' value='"+ classFee +"'>";
      let td4 = document.createElement('td');
      td4.innerHTML = td4_html;

      let td5 = document.createElement('td');
      td5.setAttribute('style', "text-align: right;");

      let td6_html = '';
      td6_html = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeRow(this); printPreview();'></i>";
      let td6 = document.createElement('td');
      td6.innerHTML = td6_html;

      // Tr top
      let tr = document.createElement('tr');
      tr.className = 'item';
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);
      tr.appendChild(td5);
      tr.appendChild(td6);

      const itemBody = document.getElementById('itemBody');
      itemBody.insertBefore(tr, itemBody.children[0])
      // itemBody.appendChild(tr);
    }

    // Render class components
    function renderAllInvoiceItems2(doc, clientId){
      // className = className
      // classId = classId / 'new' for New Item - use to differentiate invoice item
      // classQuantity = quantity (default: 1). For new item, assign '-'
      // classFee = class fee
      // refId = cat id - made up of classId / 'new' - used to classify class.
      // cat = cat name - made up of classId / 'uncategorized' / 'tax' / 'other'
      // tag = tag name - separated by comma ', '

      if (doc.data()[CLASS_FEES_TYPE_KEY] === FEES_TYPE_PER_MONTH_KEY){
        addItem(doc.data()[CLASS_NAME], doc.data()[CLASS_ID], 1, doc.data()[CLASS_FEES_KEY], doc.data()[CLASS_ID], doc.data()[CLASS_ID], doc.data()[CLASS_TAG] );

      }else{
        addItem(doc.data()[CLASS_NAME], doc.data()[CLASS_ID], '-', '-', doc.data()[CLASS_ID], doc.data()[CLASS_ID], doc.data()[CLASS_TAG]);

      }


    // <tr class="item">
    //   <td><i class="fas fa-grip-vertical"></i></td>
    //   <td><input type="text" class="form-control" style="border: solid #2e74b6 thin;" placeholder=" Enter item and description"></td>
    //   <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="1" oninput="calculateAmount()"></td>
    //   <td><input type="number" class="form-control" style="border: solid #2e74b6 thin; text-align: right;" value="0" oninput="calculateAmount()"></td>
    //   <td style="text-align: right;"></td>
    //   <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeRow(this)"></i></td>
    // </tr>

      // let td1_html = '';
      // td1_html = "<i class='fas fa-grip-vertical'></i>";
      // let td1 = document.createElement('td');
      // td1.innerHTML = td1_html;

      // let td2_html = '';
      // let className = doc.data()[CLASS_NAME];
      // td2_html = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; padding-left: 0.5rem;' placeholder='Enter item and description' value='"+ className +"' onclick='printPreview();'>";
      // let td2 = document.createElement('td');
      // td2.innerHTML = td2_html;

      // let td3_html = '';
      // let quantity = doc.data()[CLASS_FEES_TYPE_KEY] === FEES_TYPE_PER_MONTH_KEY ? 1 : '-';
      // td3_html = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' oninput='calculateAmount(); printPreview();' value='"+ quantity +"'>";
      // let td3 = document.createElement('td');
      // td3.innerHTML = td3_html;

      // let td4_html = '';
      // let classFee = doc.data()[CLASS_FEES_TYPE_KEY] === FEES_TYPE_PER_MONTH_KEY ? doc.data()[CLASS_FEES_KEY] : '-';
      // td4_html = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' oninput='calculateAmount(); printPreview();' value='"+ classFee +"'>";
      // let td4 = document.createElement('td');
      // td4.innerHTML = td4_html;

      // let td5 = document.createElement('td');
      // td5.setAttribute('style', "text-align: right;");

      // let td6_html = '';
      // td6_html = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeRow(this); printPreview();'></i>";
      // let td6 = document.createElement('td');
      // td6.innerHTML = td6_html;

      // // Tr top
      // let tr = document.createElement('tr');
      // tr.className = 'item';
      // tr.appendChild(td1);
      // tr.appendChild(td2);
      // tr.appendChild(td3);
      // tr.appendChild(td4);
      // tr.appendChild(td5);
      // tr.appendChild(td6);

      // const itemBody = document.getElementById('itemBody');
      // itemBody.insertBefore(tr, itemBody.children[0])
    }

    // Render Lesson components
    function renderAllLessonItems(doc, classPerHourFee, classId){

      let td1_html = '';
      td1_html = "<i class='fas fa-grip-vertical'></i>";
      let td1 = document.createElement('td');
      td1.innerHTML = td1_html;

      let td2_html = '';
      let date = doc.data()[LESSON_DATE].toDate().toLocaleDateString("en-GB");

      // Timeslot
      let timeslot = '';
      let startTime, endTime = '';

      startTime = doc.data()[LESSON_START];
      endTime = doc.data()[LESSON_END];
      startTime = tConvert (startTime);
      endTime = tConvert (endTime);

      timeslot = '  -  Lesson on '+ date+ ', '+startTime+'-'+endTime;

      td2_html = "<input type='text' class='form-control' placeholder='Enter item and description' value='"+ timeslot +"'>";
      let td2 = document.createElement('td');
      td2.innerHTML = td2_html;

      let td3_html = '';
      //create date format
      var timeStart = new Date("01/01/2007 " + doc.data()[LESSON_START]);
      var timeEnd = new Date("01/01/2007 " + doc.data()[LESSON_END]);
      let timeEllapsed = (timeEnd - timeStart)/1000/60/60; // Convert from ms to Hour

      let quantity = isNaN(timeEllapsed) ? 1 : timeEllapsed;
      td3_html = "<input type='number' class='form-control' text-align: right;' oninput='calculateAmount2(); printPreview();' value='"+ quantity +"'>";
      let td3 = document.createElement('td');
      td3.innerHTML = td3_html;

      let td4_html = '';
      let classFee = isNaN(classPerHourFee) ? 0 : classPerHourFee;
      td4_html = "<input type='number' class='form-control' oninput='calculateAmount2(); printPreview();' value='"+ classFee +"'>";
      let td4 = document.createElement('td');
      td4.innerHTML = td4_html;

      let td5 = document.createElement('td');
      td5.className = "td-amount";

      let td6_html = '';
      td6_html = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeItem(this); printPreview();'></i>";
      let td6 = document.createElement('td');
      td6.innerHTML = td6_html;

      let td7 = document.createElement('td');
      td7.className = "td-hidden";
      td7.setAttribute('name', 'amount');

      // Tr top
      let tr = document.createElement('tr');
      tr.className = 'item';
      // tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);
      tr.appendChild(td5);
      tr.appendChild(td6);
      tr.appendChild(td7);

      let item = document.getElementById('table-top').querySelectorAll("div[name='"+classId+"']");
      const itemBody =item[0].getElementsByTagName('tbody')[0];

      // console.log(itemBody)
      // const itemBody = document.getElementById('itemBody');
      itemBody.insertBefore(tr, itemBody.children[1])

      // itemBody.appendChild(tr);
    }

    // Clear all items, reset items preview. Used when client change
    function clearItems(){
      let itemBody = document.getElementById('table-top');
      itemBody.querySelectorAll('.table-item-top').forEach(function (row, index) {
        row.remove();

      });
    }

    // Get all the items, subtotal, additional items and total. Used when save.
    function getAllItems(){

      allItemsArr = [];

      allItemsArr.push('ITEM');
      table.querySelectorAll('tr').forEach(function (row, index) {
        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
          return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // Get the value of each item row
        let desc = row.children[1].getElementsByTagName("input")[0].value;
        let quantity = row.children[2].getElementsByTagName("input")[0].value;
        let price = row.children[3].getElementsByTagName("input")[0].value;
        let amount = row.children[4].textContent;
        allItemsArr.push(desc+'; '+ quantity+'; '+  price+'; '+  amount)

      });
      allItemsArr.push('SUBTOTAL');
      let subTotal = calculateSubtotal();
      let total = calculateTotal(subTotal);
      allItemsArr.push(subTotal);
      allItemsArr.push('ADDITIONAL_ITEM');
      tableAdditionalItem.querySelectorAll('tr').forEach(function (row, index) {
        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
          return;
        }
        // Ignore row with certain class name
        else if(row.className != 'additional'){
          return;
        }

        // Get the value of each additional item row
        let additionalSelector = row.children[1].getElementsByTagName("a")[0].textContent;
        let additionalItem = row.children[2].getElementsByTagName("input")[0].value;
        let additionalItemValue = row.children[3].getElementsByTagName("input")[0].value;
        let amount = row.children[4].textContent;

        if (additionalSelector === 'Select one'){
          // Do nothing
        }
        else if (additionalSelector === 'Discount ( - )'){
          allItemsArr.push(additionalSelector+'; '+ additionalItem+'; '+  additionalItemValue+'; '+  amount)
          // printAdditionalItem(additionalItem, amount);

        }
        else if (additionalSelector === 'Tax Rate (%)'){
          allItemsArr.push(additionalSelector+'; '+ additionalItem+'; '+  additionalItemValue+'; '+  amount)

          // printAdditionalItem(additionalItem+' ('+additionalItemValue +'%)', amount);
        }
        else
        {
          // Do nothing
        }

      });

      allItemsArr.push('TOTAL');
      allItemsArr.push(total);

    }


    function getAllItems2(){

      // Format:
      // [0]: ITEMLIST
      // [1]: ITEM
      // [2]: <name, item display name>
      // [3]: <refId - usually [classId] / uncategorized / <predefined category slug>>
      // [4]: <cat - usually [classId] / Uncategorized / <predefined category name> >
      // [5]: <tag, deliminator - ','>
      // [6]: [desc, quantity, price, amount] - deliminator = ';; '
      // [7]: ...
      // [8]: [desc, quantity, price, amount]
      // [9]: SUBTOTAL (Unused)
      // [10]: <subtotal> (Unused)
      // [11]: ITEM
      // [...]: ...
      // [m]: ADDITIONAL_ITEM
      // [n]: [selector, item, price, amount]
      // [...]: ...
      // [p]: TOTAL
      // [q]: <total>

      let allItemsArr = [];

      allItemsArr.push('ITEMLIST');

      let table_item_top = document.getElementById("table-top").querySelectorAll('.table-item-top');
      // Calculate the amount of each item.
      table_item_top.forEach((tableItem) =>{

        let subTotal = 0;
        let subTotalText = '';

        allItemsArr.push('ITEM');
        // Get the name, refId, cat, and tag
        let name_temp = tableItem.querySelectorAll("td[name=name]")[0].textContent;
        let name = (name_temp== null || name_temp == "") ? "" : name_temp;
        allItemsArr.push(name);
        let refId_temp = tableItem.querySelectorAll("td[name=refId]")[0].textContent;
        let refId = (refId_temp == null || refId_temp == "") ? "" : refId_temp;
        allItemsArr.push(refId);
        let cat_temp = tableItem.querySelectorAll("td[name=cat]")[0].textContent;
        let cat = (cat_temp == null || cat_temp == "") ? "" : cat_temp;
        allItemsArr.push(cat);
        let tag_temp = tableItem.querySelectorAll("td[name=tag]")[0].textContent;
        let tag = (tag_temp == null || tag_temp == "") ? "" : tag_temp;
        allItemsArr.push(tag);


        // Calculate the amount of each row in an item.
        let subtotal = 0;
        tableItem.querySelectorAll('tr[class=item]').forEach(function (row) {

          // Ignore the header
          // We don't want user to change the order of header
          if (row.className != 'item') {
            return;
          }

          // console.log(row.querySelectorAll('input'));

          let inputEleList = row.querySelectorAll('input')
          // Calculate the subtotal amount
          let desc = inputEleList[0].value;
          let quantity = inputEleList[1].value;
          let price = inputEleList[2].value;
          let amount = row.children[3].textContent;

          // console.log(desc, quantity, price,amount)
          allItemsArr.push(desc+';; '+ quantity+';; '+  price+';; '+  amount)

        });


      });

      // allItemsArr.push('SUBTOTAL');
      let subTotal = calculateSubtotal2();
      let total = calculateTotal2(subTotal);

      // allItemsArr.push(subTotal);
      allItemsArr.push('ADDITIONAL_ITEM');

      tableAdditionalItem.querySelectorAll('tr[class=additional]').forEach(function (row, index) {
        // Ignore the header
        // We don't want user to change the order of header
        if (row.className != 'additional'){
          return;
        }

        // Get the value of each additional item row
        let additionalSelector = row.children[0].getElementsByTagName("a")[0].textContent;
        let additionalItem = row.children[1].getElementsByTagName("input")[0].value;
        let additionalItemValue = row.children[2].getElementsByTagName("input")[0].value;
        let amount = row.children[3].textContent;
        // console.log(additionalSelector, additionalItem, additionalItemValue,amount)

        if (additionalSelector === 'Select one'){
          // Do nothing
        }
        else if (additionalSelector === 'Discount ( - )'){
          allItemsArr.push(additionalSelector+';; '+ additionalItem+';; '+  additionalItemValue+';; '+  amount)
          // printAdditionalItem(additionalItem, amount);

        }
        else if (additionalSelector === 'Tax Rate (%)'){
          allItemsArr.push(additionalSelector+';; '+ additionalItem+';; '+  additionalItemValue+';; '+  amount)

          // printAdditionalItem(additionalItem+' ('+additionalItemValue +'%)', amount);
        }
        else
        {
          // Do nothing
        }

      });

      allItemsArr.push('TOTAL');
      allItemsArr.push(total);

      return allItemsArr;

    }

    //-------- Item Table Handling Start-----------------/
    const table = document.getElementById('table');
    const tableAdditionalItem = document.getElementById('tableAdditionalItem');
    let draggingEle;
    let draggingRowIndex;
    let placeholder;
    let list;
    let isDraggingStarted = false;

    // The current position of mouse relative to the dragging element
    let x = 0;
    let y = 0;

    // Swap two nodes
    const swap = function (nodeA, nodeB) {
        const parentA = nodeA.parentNode;
        const siblingA = nodeA.nextSibling === nodeB ? nodeA : nodeA.nextSibling;

        // Move `nodeA` to before the `nodeB`
        nodeB.parentNode.insertBefore(nodeA, nodeB);

        // Move `nodeB` to before the sibling of `nodeA`
        parentA.insertBefore(nodeB, siblingA);
    };

    // Check if `nodeA` is above `nodeB`
    const isAbove = function (nodeA, nodeB) {
        // Get the bounding rectangle of nodes
        const rectA = nodeA.getBoundingClientRect();
        const rectB = nodeB.getBoundingClientRect();

        return rectA.top + rectA.height / 2 < rectB.top + rectB.height / 2;
    };

    const cloneTable = function () {
      const rect = table.getBoundingClientRect();
      const width = parseInt(window.getComputedStyle(table).width);

      list = document.createElement('div');
      list.classList.add('clone-list');
      list.style.position = 'fixed';
      list.style.left = `${rect.left}px`;
      list.style.top = `${rect.top}px`;
      table.parentNode.insertBefore(list, table);

      // Hide the original table
      table.style.visibility = 'hidden';

      table.querySelectorAll('tr').forEach(function (row) {
        // Create a new table from given row
        const item = document.createElement('div');
        item.classList.add('draggable');

        const newTable = document.createElement('table');
        // newTable.setAttribute('class', 'clone-table');
        newTable.setAttribute('class', 'table-light table-sm');
        newTable.setAttribute('cellspacing', "0");
        newTable.setAttribute('width',"100%");
        newTable.style.width = `${width}px`;

        const newRow = document.createElement('tr');
        const cells = [].slice.call(row.children);
        cells.forEach(function (cell) {
          const newCell = cell.cloneNode(true);
          newCell.style.width = `${parseInt(window.getComputedStyle(cell).width)}px`;
          newRow.appendChild(newCell);
        });

        newTable.appendChild(newRow);
        item.appendChild(newTable);
        list.appendChild(item);
      });
    };

    const mouseDownHandler = function (e) {
        // Get the original row
        // Layer 1
        let originalRow = e.target.parentNode;
        if (originalRow.nodeName.toLowerCase() === 'tr'){
          // Correct parents node. Do nothing
        }else {
          // Layer 2
          originalRow = originalRow.parentNode;
          if (originalRow.nodeName.toLowerCase() === 'tr'){
          // Correct parents node. Do nothing
          }else {
            // Layer 3
            originalRow = originalRow.parentNode;
            if (originalRow.nodeName.toLowerCase() === 'tr'){
            // Correct parents node. Do nothing
            }else {
              // Layer 4
              // Impossible to  reach here
              originalRow = originalRow.parentNode;
              if (originalRow.nodeName.toLowerCase() === 'tr'){
              // Correct parents node. Do nothing
              }else {
                // Layer 5
                // Impossible to  reach here
                originalRow = originalRow.parentNode;
                if (originalRow.nodeName.toLowerCase() === 'tr'){
                  // Correct parents node. Do nothing
                }else {
                  // Layer 6
                  // Impossible to  reach here
                  originalRow = originalRow.parentNode;
                  if (originalRow.nodeName.toLowerCase() === 'tr'){
                    // Correct parents node. Do nothing
                  }else {
                    // There must be so many nested tag inside a cell.
                    // Technically, it is impossible to reach here.
                    // In case you are here, just add more layers.
                  }
                }
              }
            }
          }

        }

        draggingRowIndex = [].slice.call(table.querySelectorAll('tr')).indexOf(originalRow);
        // Determine the mouse position
        x = e.clientX;
        y = e.clientY;

        // Attach the listeners to `document`
        // document.addEventListener('mousemove', mouseMoveHandler);
        // document.addEventListener('mouseup', mouseUpHandler);
        document.addEventListener('pointermove', mouseMoveHandler);
        document.addEventListener('pointerup', mouseUpHandler);
    };

    const mouseMoveHandler = function (e) {
      if (!isDraggingStarted) {
        isDraggingStarted = true;

        cloneTable();
        // console.log(draggingRowIndex);
        // console.log([].slice.call(list.children));
        draggingEle = [].slice.call(list.children)[draggingRowIndex];
        draggingEle.classList.add('dragging');

        // Let the placeholder take the height of dragging element
        // So the next element won't move up
        placeholder = document.createElement('div');
        placeholder.classList.add('placeholder');
        draggingEle.parentNode.insertBefore(placeholder, draggingEle.nextSibling);
        placeholder.style.height = `${draggingEle.offsetHeight}px`;
      }

      // Set position for dragging element
      draggingEle.style.position = 'absolute';
      draggingEle.style.top = `${draggingEle.offsetTop + e.clientY - y}px`;
      draggingEle.style.left = `${draggingEle.offsetLeft + e.clientX - x}px`;

      // Reassign the position of mouse
      x = e.clientX;
      y = e.clientY;

      // The current order
      // prevEle
      // draggingEle
      // placeholder
      // nextEle
      const prevEle = draggingEle.previousElementSibling;
      const nextEle = placeholder.nextElementSibling;

      // The dragging element is above the previous element
      // User moves the dragging element to the top
      // We don't allow to drop above the header
      // (which doesn't have `previousElementSibling`)
      if (prevEle && prevEle.previousElementSibling && isAbove(draggingEle, prevEle)) {
        // The current order    -> The new order
        // prevEle              -> placeholder
        // draggingEle          -> draggingEle
        // placeholder          -> prevEle
        swap(placeholder, draggingEle);
        swap(placeholder, prevEle);
        return;
      }

      // The dragging element is below the next element
      // User moves the dragging element to the bottom
      if (nextEle && isAbove(nextEle, draggingEle)) {
        // The current order    -> The new order
        // draggingEle          -> nextEle
        // placeholder          -> placeholder
        // nextEle              -> draggingEle
        swap(nextEle, placeholder);
        swap(nextEle, draggingEle);
      }
    };

    const mouseUpHandler = function () {
        // Remove the placeholder
        placeholder && placeholder.parentNode.removeChild(placeholder);

        draggingEle.classList.remove('dragging');
        draggingEle.style.removeProperty('top');
        draggingEle.style.removeProperty('left');
        draggingEle.style.removeProperty('position');

        // Get the end index
        const endRowIndex = [].slice.call(list.children).indexOf(draggingEle);

        isDraggingStarted = false;

        // Remove the `list` element
        list.parentNode.removeChild(list);

        // Move the dragged row to `endRowIndex`
        let rows = [].slice.call(table.querySelectorAll('tr'));
        draggingRowIndex > endRowIndex
            ? rows[endRowIndex].parentNode.insertBefore(rows[draggingRowIndex], rows[endRowIndex])
            : rows[endRowIndex].parentNode.insertBefore(
                  rows[draggingRowIndex],
                  rows[endRowIndex].nextSibling
              );

        // Bring back the table
        table.style.removeProperty('visibility');

        // Remove the handlers of `mousemove` and `mouseup`
        // document.removeEventListener('mousemove', mouseMoveHandler);
        // document.removeEventListener('mouseup', mouseUpHandler);
        document.removeEventListener('pointermove', mouseMoveHandler);
        document.removeEventListener('pointerup', mouseUpHandler);
    };

    // Run first
    const assignDraggable = function(){
      table.querySelectorAll('tr').forEach(function (row, index) {
        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
            return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // console.log(row)
        // console.log(row.className)
        const firstCell = row.firstElementChild;
        firstCell.classList.add('draggable');
        // firstCell.addEventListener('mousedown', mouseDownHandler);
        firstCell.addEventListener('pointerdown', mouseDownHandler);

      });
    }

    // Find the parents node through while loops
    // ref: https://www.jsdiaries.com/how-to-loop-through-parent-nodes-in-javascript/
    const findAscendingTag = (el, tag) => {
        while (el.parentNode) {
          el = el.parentNode;
          // console.log(el.tagName)
          if (el.tagName === tag)
            return el;
          else{

          }
          // return el.tagName === tag ? el : null;
        }
      }

    // Discount Selected
    function calculateDiscount(elem){
      let selectedNode = elem.parentNode.parentNode.children[0];
      selectedNode.value = elem.textContent;
      selectedNode.textContent = elem.textContent;

      var trParent = findAscendingTag(elem, "TR");
      // TODO: Assign discount function to the cell next to this element
      console.log(trParent);
    }

    // Tax Rate Selected
    function calculateRate(elem){
      let selectedNode = elem.parentNode.parentNode.children[0];
      selectedNode.value = elem.textContent;
      selectedNode.textContent = elem.textContent;

      var trParent = findAscendingTag(elem, "TR");
      // TODO: Assign tax rate function to the cell next to this element

      // Calculate Subtotal of Item
      let subTotal = calculateSubtotal();

      // console.log(trParent);
    }

    // Calculate the amount for Normal Items based on quantity and unit price
    function calculateAmount(){
      // // Get the value of Quantity at 3rd cell
      // let itemParent = findAscendingTag(elem, "TR");
      // let quantity = itemParent.children[2].getElementsByTagName("input")[0].value;
      // // Get the value of Price at 4th cell
      // let price = itemParent.children[3].getElementsByTagName("input")[0].value;
      // // Set the value of Amount at 5th cell
      // if (isNaN(quantity) ||isNaN(price) ){
      //   itemParent.children[4].textContent = 'INVALID';
      // }else {
      //   let amount = quantity * price;
      //   itemParent.children[4].textContent = (amount >= 0) ? 'RM'+amount.toFixed(2) : '- RM'+ Math.abs(amount).toFixed(2)
      // }

      let subTotal = calculateSubtotal();
      let total = calculateTotal(subTotal);

    }


    // Calculate the subtotal for all Normal Items
    function calculateSubtotal(){

      let subTotal = 0;
      let subTotalText = ''
      table.querySelectorAll('tr').forEach(function (row, index) {

        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
          return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // console.log(row)
        // Calculate the subtotal amount
        let quantity = row.children[2].getElementsByTagName("input")[0].value;
        let price = row.children[3].getElementsByTagName("input")[0].value;

        // Set the value of Amount at 5th cell
        if (isNaN(quantity) ||isNaN(price) ){
          row.children[4].textContent = 'INVALID';
        }
        else if (quantity== '' && price== ''){
          // If no input to quantity and value, clear the amount.
          row.children[4].textContent = '';
        }
        else {
          let amount = quantity * price;
          subTotal += amount;
          row.children[4].textContent = (amount >= 0) ? 'RM'+amount.toFixed(2) : '- RM'+ Math.abs(amount).toFixed(2)
        }
      });

      if (isNaN(subTotal) ){
        subTotalText = 'INVALID';
        // console.log(subTotalText)
        document.getElementById("subtotalItem").textContent = subTotalText;
        return 0;
      }else {

        subTotalText = (subTotal >= 0) ? 'RM'+subTotal.toFixed(2) : '- RM'+ Math.abs(subTotal).toFixed(2)
        // console.log(subTotalText)
        document.getElementById("subtotalItem").textContent = subTotalText;
        return subTotal;

      }

    }

    // Calculate the subtotal for all Normal + Additional Items
    function calculateTotal(subTotal){

      let total = subTotal;
      let temp_amount = 0;
      let totalText = '';
      tableAdditionalItem.querySelectorAll('tr').forEach(function (row, index) {

        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
          return ;
        }
        // Ignore row with certain class name
        else if(row.className != 'additional'){
          return ;
        }

        // console.log(row)
        // Get the Action: 2rd TF tag cell > div tag > first A tag
        let action = row.children[1].children[0].children[0].textContent;

        // Get input value
        let input = parseFloat(row.children[3].getElementsByTagName("input")[0].value);

        // console.log(action);
        // console.log(input);

        if (action === 'Discount ( - )'){
          temp_amount = -input;
          total = total - input;

        }else if(action === 'Tax Rate (%)'){
          temp_amount = total * (input) / 100;
          total = total * (100 + input) / 100;

        }else{
          // No change
          temp_amount = 0;
          total = total;

        }
        // console.log('Total: '+total);
        // Set the value of Amount at 5th cell
        if (isNaN(temp_amount)){
          row.children[4].textContent = 'INVALID';
        }
        else {
          row.children[4].textContent = (temp_amount >= 0) ? '+ RM'+temp_amount.toFixed(2) : '- RM'+ Math.abs(temp_amount).toFixed(2)
        }
        // if (isNaN(total)){
        //   row.children[4].textContent = 'INVALID';
        // }else {
        //   row.children[4].textContent = (total >= 0) ? 'RM'+total.toFixed(2) : '- RM'+ Math.abs(total).toFixed(2)
        // }

      });

      // Set the grand total.
      if (isNaN(total) ){
          totalText = 'INVALID';
          // console.log(totalText)
          document.getElementById("grandTotal").textContent = totalText;
          return 0;
        }
      else
      {
        totalText = (total >= 0) ? 'RM'+total.toFixed(2) : '- RM'+ Math.abs(total).toFixed(2)
        // console.log(totalText)
        document.getElementById("grandTotal").textContent = totalText;
        return total;
      }

    }

    // Calculate the amount for Normal Items based on quantity and unit price
    function calculateAmount2(){

      let subTotal = calculateSubtotal2();
      // document.getElementById('grandTotal').textContent = "RM"+subTotal;
      let total = calculateTotal2(subTotal);

    }

    // Calculate the subtotal for all Normal Items
    function calculateSubtotal2(){

      let subTotalFinal = 0;
      let subTotalFinalText = '';


      let table_item_top = document.getElementById("table-top").querySelectorAll('.table-item-top');

      // console.log(table_item_top)

      // Calculate the amount of each item.
      table_item_top.forEach((tableItem) =>{

        let subTotal = 0;
        let subTotalText = '';

        // Calculate the amount of each row in an item.
        tableItem.querySelectorAll('tr').forEach(function (row) {

          // Ignore the header
          // We don't want user to change the order of header
          if (row.className != 'item') {
            return;
          }

          // console.log(row.querySelectorAll('input'));

          let inputEleList = row.querySelectorAll('input')
          // Calculate the subtotal amount
          // let desc = inputEleList[0].value;
          let quantity = inputEleList[1].value;
          let price = inputEleList[2].value;
          // console.log(desc, quantity, price)

          // Get amount display
          let amountEle = row.getElementsByClassName("td-amount");
          // Get amount value (hidden)
          let amountValueEle = row.querySelectorAll('td[name=amount]');
          // Set the value of Amount at 5th cell
          if (isNaN(quantity) ||isNaN(price) ){
            amountEle[0].textContent = 'INVALID';
            amountValueEle[0].textContent = 0;
          }
          else if (quantity== '' && price== ''){
            // If no input to quantity and value, clear the amount.
            amountEle[0].textContent = '';
            amountValueEle[0].textContent = 0;
          }
          else {
            let amount = quantity * price;
            subTotal += amount;
            amountEle[0].textContent = (amount >= 0) ? 'RM'+amount.toFixed(2) : '- RM'+ Math.abs(amount).toFixed(2)
            amountValueEle[0].textContent = amount;
          }


          // Get the subtotal ele of the items
          let subTotalEle = row.parentNode.getElementsByClassName("subtotal");

          if (isNaN(subTotal) ){
            subTotalText = 'INVALID';
            // console.log(subTotalText)
            // document.getElementById("subtotalItem").textContent = subTotalText;

            subTotalEle[0].querySelectorAll(".td-subtotal")[1].textContent = subTotalText;
            subTotal = 0;
            // // Update Subtotal
            // subTotalFinal = subTotalFinal + 0;
          }else {

            subTotalText = (subTotal >= 0) ? 'RM'+subTotal.toFixed(2) : '- RM'+ Math.abs(subTotal).toFixed(2)
            // console.log(subTotalText)
            // document.getElementById("subtotalItem").textContent = subTotalText;
            subTotalEle[0].querySelectorAll(".td-subtotal")[1].textContent = subTotalText;


          }

        });

        // Update Subtotal
        // console.log('Subtotal: '+ subTotal)
        subTotalFinal = subTotalFinal + subTotal;
        // console.log('Subtotal Final: '+ subTotalFinal)


      });

      if (isNaN(subTotalFinal) ){
        subTotalFinalText = 'INVALID';
        // // console.log(subTotalText)
        // document.getElementById("subtotalItem").textContent = subTotalText;
        document.getElementById('grandTotal').textContent = subTotalFinalText;
        return 0;
      }else {

        subTotalFinalText = (subTotalFinal >= 0) ? 'RM'+subTotalFinal.toFixed(2) : '- RM'+ Math.abs(subTotalFinal).toFixed(2)
        // console.log(subTotalText)
        // document.getElementById("subtotalItem").textContent = subTotalText;
        document.getElementById('grandTotal').textContent = "RM"+subTotalFinal;
        return subTotalFinal;
      }


    }

    // Calculate the subtotal for all Normal + Additional Items
    function calculateTotal2(subTotal){

      let total = subTotal;
      let temp_amount = 0;
      let totalText = '';

      let table_item_top = document.getElementById("table-top").querySelectorAll('.table-subtotal')[0];


      // table_item_top

      table_item_top.querySelectorAll('tr').forEach(function (row, index) {

        // Ignore the header
        // We don't want user to change the order of header
        if (row.className != 'additional') {
          return ;
        }

        // console.log(row)
        // Get the Action: 2rd TF tag cell > div tag > first A tag
        let action = row.querySelectorAll('a')[0].textContent;

        // Get input value
        let input = parseFloat(row.getElementsByTagName("input")[1].value);

        // console.log(action);
        // console.log(input);

        if (action === 'Discount ( - )'){
          temp_amount = -input;
          total = total - input;

        }else if(action === 'Tax Rate (%)'){
          temp_amount = total * (input) / 100;
          total = total * (100 + input) / 100;

        }else{
          // No change
          temp_amount = 0;
          total = total;

        }
        // console.log('Total: '+total);
        // Set the value of Amount at 5th cell
        if (isNaN(temp_amount)){
          row.children[3].textContent = 'INVALID';
        }
        else {
          row.children[3].textContent = (temp_amount >= 0) ? '+ RM'+temp_amount.toFixed(2) : '- RM'+ Math.abs(temp_amount).toFixed(2)
        }

      });

      // Set the grand total.
      if (isNaN(total) ){
          totalText = 'INVALID';
          // console.log(totalText)
          document.getElementById("grandTotal").textContent = totalText;
          return 0;
        }
      else
      {
        totalText = (total >= 0) ? 'RM'+total.toFixed(2) : '- RM'+ Math.abs(total).toFixed(2)
        // console.log(totalText)
        document.getElementById("grandTotal").textContent = totalText;
        return total;
      }

    }



    // Enable / Disable the first additional item when 'Select One' is picked
    function enabledAdditionalItem(elem, itemName){
      // let selectedNode = elem.parentNode.parentNode.children[0];
      // selectedNode.value = elem.textContent;
      // selectedNode.textContent = elem.textContent;

      // Get the TR parents node
      var trParent = findAscendingTag(elem, "TR");

      // Setup 2nd cell: dropdown menu - find the first A tag
      trParent.children[0].getElementsByTagName("a")[0].value = elem.textContent;
      trParent.children[0].getElementsByTagName("a")[0].textContent = elem.textContent;

      // Setup 3rd cell: itemName input
      // document.getElementById("firstAddItemName").removeAttribute("readonly");
      trParent.children[1].getElementsByTagName("input")[0].removeAttribute("readonly");
      // document.getElementById("firstAddItemName").value = itemName;
      trParent.children[1].getElementsByTagName("input")[0].value = itemName;

      // Setup 4th cell: itemAmount input
      // document.getElementById("firstAddItemPrice").removeAttribute("readonly");
      trParent.children[2].getElementsByTagName("input")[0].removeAttribute("readonly");
    }


    function disabledAdditionalItem(elem){
      // let selectedNode = elem.parentNode.parentNode.children[0];
      // selectedNode.value = elem.textContent;
      // selectedNode.textContent = elem.textContent;

      // Get the TR parents node
      var trParent = findAscendingTag(elem, "TR");

      // Setup 2nd cell: dropdown menu - find the first A tag
      trParent.children[0].getElementsByTagName("a")[0].value = elem.textContent;
      trParent.children[0].getElementsByTagName("a")[0].textContent = elem.textContent;

      // Setup 3rd cell: itemName input
      // document.getElementById("firstAddItemName").setAttribute("readonly", true);
      trParent.children[1].getElementsByTagName("input")[0].setAttribute("readonly", true);
      // document.getElementById("firstAddItemName").value = '';
      trParent.children[1].getElementsByTagName("input")[0].value = '';

      // Setup 4th cell: itemAmount input
      // document.getElementById("firstAddItemPrice").setAttribute("readonly", true);
      trParent.children[2].getElementsByTagName("input")[0].setAttribute("readonly", true);
      // document.getElementById("firstAddItemPrice").value = 0;
      trParent.children[2].getElementsByTagName("input")[0].value = 0;

    }

    // Add a new row
    function addRow(elem){

      // console.log(id)

      // Get the tbody tag
      // let table_temp = document.getElementById("body_"+id);
      let table_temp = elem.parentNode.parentNode.parentNode;
      // console.log(table_temp);

      // Get the number of tr[class=item] in tbody
      // let draggableRowLastIndex = document.getElementById("body_"+id).querySelectorAll("tr[class=item]").length;
      let draggableRowLastIndex = elem.parentNode.parentNode.parentNode.querySelectorAll("tr[class=item]").length;
      // console.log(draggableRowLastIndex);

      // Create an empty <tr> element and add it to the last position of draggable items.
      var row = table_temp.insertRow(draggableRowLastIndex);


      // <td><input type="text" class="form-control" placeholder=" Enter item and description" oninput="//printPreview();"></td>
      // <td><input type="number" class="form-control" value="-" oninput="//calculateAmount(); printPreview();"></td>
      // <td><input type="number" class="form-control" value="-" oninput="//calculateAmount(); printPreview();"></td>
      // <td class="td-amount"></td>
      // <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeRow(this); //printPreview();"></i></td>
      // <td class="td-hidden" name="refid">crsathwer3dsef</td>
      // <td class="td-hidden" name="cat">aaa</td>
      // <td class="td-hidden" name="tag">seremban, grade1, home_tuition</td>

      // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      var cell3 = row.insertCell(2);
      var cell4 = row.insertCell(3);
      var cell5 = row.insertCell(4);
      var cell6 = row.insertCell(5);
      // var cell7 = row.insertCell(6);
      // var cell8 = row.insertCell(7);

      row.className = 'item'
      // Add some text to the new cells:
      cell1.innerHTML = "<input type='text' class='form-control'placeholder=' Enter item and description' oninput='printPreview();'>";
      cell2.innerHTML = "<input type='number' class='form-control' value='1' oninput='calculateAmount2(); printPreview();'>";
      cell3.innerHTML = "<input type='number' class='form-control' value='0' oninput='calculateAmount2(); printPreview();'>";
      cell4.className = "td-amount";
      cell5.innerHTML = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeItem(this); calculateAmount2(); printPreview();'></i>";
      cell6.className = "td-hidden";
      cell6.setAttribute("name", "amount");
      // cell6.className = "td-hidden";
      // cell6.setAttribute("name", "refid");
      // cell7.className = "td-hidden";
      // cell7.setAttribute("name", "cat");
      // cell8.className = "td-hidden";
      // cell8.setAttribute("name", "tag");

      // assignDraggable();
    }


    // Add an item (DEPRECIATED)
    function addItem_BU(){
      let draggableRowLastIndex = document.getElementById("table").querySelectorAll('.draggable').length;
      // Create an empty <tr> element and add it to the last position of draggable items.
      var row = table.insertRow(draggableRowLastIndex + 1);
      // console.log(draggableRowLastIndex);

      // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      var cell3 = row.insertCell(2);
      var cell4 = row.insertCell(3);
      var cell5 = row.insertCell(4);
      var cell6 = row.insertCell(5);

      row.className = 'item'
      // Add some text to the new cells:
      cell1.innerHTML = "<i class='fas fa-grip-vertical'></i>";
      cell2.innerHTML = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; padding-left: 0.5rem;' placeholder=' Enter item and description' oninput='printPreview();'>";
      cell3.innerHTML = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='1' oninput='calculateAmount(this); printPreview();'>";
      cell4.innerHTML = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='0' oninput='calculateAmount(this); printPreview();'>";
      cell5.setAttribute('style', 'text-align: right;');
      cell6.innerHTML = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeRow(this); printPreview();'></i>";

      assignDraggable();
    }

    // Add an item
    function addItem(className, classId, classQuantity, classFee, refId, cat, tag){
      // className = className
      // classId = classId / uuid for New Item - use to differentiate invoice item
      // refId = cat id - made up of classId / 'new' - used to classify class.
      // cat = cat name - made up of classId / 'uncategorized' / 'tax' / 'other'
      // tag = tag name - separated by comma ', '
      // classQuantity = quantity (default: 1). For new item, assign '-'
      // classFee = class fee

      let table_item_topLength = document.getElementById("table-top").querySelectorAll('.table-item-top').length;

      // console.log(table_item_topLength)
      // Create an empty <tr> element and add it to the last position of draggable items.
      let table_top = document.getElementById("table-top");

      let btn_a = document.createElement('div');

      // <div class="row table-item-top" name="uncategorized">
      //   <div class="col-md-12 table-item">
      //     <span class="table-title" style="font-size: small; font-weight: 300; color: gray; margin-bottom: 0;">New Design</span>
      //     <span class="table-tag">area_subangjaya</span>
      //     <span class="table-tag">area_kl</span>
      //     <span class="table-cat">Deposit</span>
      //     <span>
      //       <a href="javascript:;" data-toggle="modal" data-target="#editItemModal" data-edititemtitle="New Design" data-edititemrefid="uncategorized" data-edititemcat="Uncategorized" data-edititemtag="selangor_kl, ksie, aksjdak,2342">
      //         <i class="fas fa-pen" style="margin-left: 8px;"></i>
      //       </a>
      //     </span>
      //     <table name="table_uncategorized" class="table-light table-sm" cellspacing="0" width="100%">
      //       <thead style="visibility: collapse;">
      //         <tr>
      //           <th class="th-item"></th>
      //           <th class="th-quantity"></th>
      //           <th class="th-price"></th>
      //           <th class="th-amount"></th>
      //           <th class="th-action"></th>
      //           <th class="th-hidden"></th>
      //           <th class="th-hidden">uncategorized</th>
      //           <th class="th-hidden"></th>
      //         </tr>
      //       </thead>
      //       <tbody name="body_uncategorized">
      //         <tr class="item">
      //           <td><input type="text" class="form-control" placeholder=" Enter item and description" oninput="//printPreview();"></td>
      //           <td><input type="number" class="form-control" value="-" oninput="//calculateAmount(); printPreview();"></td>
      //           <td><input type="number" class="form-control" value="-" oninput="//calculateAmount(); printPreview();"></td>
      //           <td class="td-amount"></td>
      //           <td><i class="fas fa-minus-circle" style="color: red; cursor: pointer;" onclick="removeItem(this); //removeRow(this); //calculateAmount(); printPreview();"></i></td>
      //           <td class="td-hidden" name="amount">2325.034</td>
      //         </tr>
      //         <tr class="subtotal">
      //           <td>
      //             <a class="addrow" href="javascript:;" id="addRow" onclick="addRow(this);">Add new row</a>
      //           </td>
      //           <td></td>
      //           <td class="td-subtotal">Subtotal</td>
      //           <td class="td-subtotal" id="subtotalItem_aaa"></td>
      //           <td></td>
      //           <td class="td-hidden" name="subtotal">7675.096324</td>
      //         </tr>
      //       </tbody>
      //     </table>
      //   </div>
      // </div>

      let table= document.createElement("table");
      table.className = "table-light table-sm";
      table.setAttribute("name","" );
      table.setAttribute("cellspacing", "0");
      table.setAttribute("width", "100%");
      table.setAttribute("style", "border-bottom: solid thin #eeeeee;");

      // Create body
      let row = table.insertRow(0);
      row.className = 'item';

      let rowSubtotal = table.insertRow(1);
      rowSubtotal.className = 'subtotal';

      // Insert new empty input cells
      let cell1 = row.insertCell(0);
      let cell2 = row.insertCell(1);
      let cell3 = row.insertCell(2);
      let cell4 = row.insertCell(3);
      let cell5 = row.insertCell(4);
      let cell6 = row.insertCell(5);

      let inputText = (classId == 'new')? '' : className;
      let inputQuantity = (classId == 'new')? '-' : classQuantity;
      let inputPrice = (classId == 'new')? '-' : classFee;
      // Add some text to the new cells:
      cell1.innerHTML = "<input type='text' class='form-control' value='"+inputText+"' placeholder=' Enter item and description' oninput='printPreview();'>";
      cell2.innerHTML = "<input type='number' class='form-control' value='"+inputQuantity+"' oninput='calculateAmount2(); printPreview();'>";
      cell3.innerHTML = "<input type='number' class='form-control' value='"+inputPrice+"' oninput='calculateAmount2(); printPreview();'>";
      cell4.className = "td-amount";
      cell5.innerHTML = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeItem(this); calculateAmount2(); printPreview();'></i>";
      cell6.className = "td-hidden";
      cell6.setAttribute("name", "amount");

      // Insert new subtotal cells
      let cellSub1 = rowSubtotal.insertCell(0);
      let cellSub2 = rowSubtotal.insertCell(1);
      let cellSub3 = rowSubtotal.insertCell(2);
      let cellSub4 = rowSubtotal.insertCell(3);
      let cellSub5 = rowSubtotal.insertCell(4);
      let cellSub6 = rowSubtotal.insertCell(5);

      // Add some text to the new cells:
      cellSub1.innerHTML = "<a class='addrow' href='javascript:;' onclick='addRow(this);'>Add new row</a>";
      cellSub2.innerHTML = "";
      cellSub3.innerHTML = "Subtotal";
      cellSub3.className = "td-subtotal"
      cellSub4.innerHTML = "";
      cellSub4.className = "td-subtotal"
      cellSub5.innerHTML = "";
      cellSub6.className = "td-hidden";
      cellSub6.setAttribute("name", "subtotal");

      // Create header. This action must be done at the last.
      let header = table.createTHead();
      header.setAttribute('style', "visibility: collapse;")
      let hrow = header.insertRow(0);
      let hcell1 = hrow.insertCell(0);
      let hcell2 = hrow.insertCell(1);
      let hcell3 = hrow.insertCell(2);
      let hcell4 = hrow.insertCell(3);
      let hcell5 = hrow.insertCell(4);
      let hcell6 = hrow.insertCell(5);
      let hcell7 = hrow.insertCell(6);
      let hcell8 = hrow.insertCell(7);
      let hcell9 = hrow.insertCell(8);

      // hcell1.outerHTML = "<th></th>"
      hcell1.className = 'th-item';
      hcell2.className = 'th-quantity';
      hcell3.className = 'th-price';
      hcell4.className = 'th-amount';
      hcell5.className = 'th-action';
      hcell6.className = 'th-hidden';
      hcell6.setAttribute("name", "refId");
      hcell6.innerHTML = (refId == null || refId == "") ? "" : refId;
      hcell7.className = 'th-hidden';
      hcell7.setAttribute("name", "cat");
      hcell7.innerHTML = (cat == null || cat == "") ? "" : cat;
      hcell8.className = 'th-hidden';
      hcell8.setAttribute("name", "tag");
      hcell8.innerHTML = (tag == null || tag == "") ? "" : tag;
      hcell9.className = 'th-hidden';
      hcell9.setAttribute("name", "name");
      hcell9.innerHTML = (className == null || className == "") ? "" : className;

      // Create Title
      let classNameSpan = document.createElement('span');
      classNameSpan.className = "table-title";
      classNameSpan.textContent = className;

      // table item top
      let tableItemCol = document.createElement('div');
      tableItemCol.className = "col-md-12 table-item";
      tableItemCol.appendChild(classNameSpan);

      // Attach Category for Non-class item
      if ((cat  === refId  || cat == "") && cat != 'Uncategorized'){
        // Class Item
      }else {
        // New Item
        let catSpan = document.createElement('span');
        catSpan.className = "table-cat";
        catSpan.textContent = cat;
        tableItemCol.appendChild(catSpan);
      }

      // Attach Tags
      if (tag == null || tag == '' || tag.length == 0){

      }else{
        tag.forEach((item) => {
          let tagSpan = document.createElement('span');
          tagSpan.className = "table-tag";
          tagSpan.textContent = item;
          tableItemCol.appendChild(tagSpan);
        });
      }

      // Attach Edit button
      let edit_a =  document.createElement('a');
      edit_a.innerHTML = "<i class='fas fa-pen' style='margin-left: 8px'></i>";
      edit_a.name = "btnEdit";
      edit_a.href = "javascript:;";
      edit_a.setAttribute('data-toggle', 'modal');
      edit_a.setAttribute('data-target', '#editItemModal');
      edit_a.setAttribute('data-edititemid', classId);
      // edit_a.setAttribute('data-edititemtitle', className);
      // edit_a.setAttribute('data-edititemrefid', refId);
      // edit_a.setAttribute('data-edititemcat', cat);
      // edit_a.setAttribute('data-edititemtag', tag);
      let editSpan = document.createElement('span');
      editSpan.appendChild(edit_a);
      editSpan.className = "table-edit-btn";
      tableItemCol.appendChild(editSpan);

      tableItemCol.appendChild(table);

      let tableItemTopRow = document.createElement('div');
      tableItemTopRow.className = "row table-item-top";
      tableItemTopRow.setAttribute("name", classId);
      tableItemTopRow.appendChild(tableItemCol);

      // Insert the row at the second last item, before additional items table. +1 because the first item is dedicated for table header.
      table_top.insertBefore(tableItemTopRow, table_top.children[table_item_topLength+1]);
      // console.log(draggableRowLastIndex);

    }


    // Add an additional
    function addAdditionalRow(){

      let draggableRowLastIndex = document.getElementById("tableAdditionalItem").querySelectorAll('.additional').length;
      // Create an empty <tr> element and add it to the last position of draggable items.
      var row = tableAdditionalItem.insertRow(draggableRowLastIndex + 1);
      row.className = 'additional'
      console.log(draggableRowLastIndex);

      // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
      // var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(0);
      var cell3 = row.insertCell(1);
      var cell4 = row.insertCell(2);
      var cell5 = row.insertCell(3);
      var cell6 = row.insertCell(4);

      // Add some text to the new cells:
      // cell1.innerHTML = "";

      let dropdown_discount = document.createElement('a');
      dropdown_discount.className = 'dropdown-item';
      dropdown_discount.textContent = 'Discount ( - )';
      dropdown_discount.setAttribute('href', 'javascript:;');
      dropdown_discount.setAttribute('style', 'text-transform: none;');
      dropdown_discount.setAttribute('onclick', "enabledAdditionalItem(this, 'Discount'); calculateAmount2(); printPreview();");
      let dropdown_tax = document.createElement('a');
      dropdown_tax.className = 'dropdown-item';
      dropdown_tax.textContent = 'Tax Rate (%)';
      dropdown_tax.setAttribute('href', 'javascript:;');
      dropdown_tax.setAttribute('style', 'text-transform: none;');
      dropdown_tax.setAttribute('onclick', "enabledAdditionalItem(this, 'Tax'); calculateAmount2(); printPreview();");
      let dropdown = document.createElement('div');
      dropdown.className = 'dropdown-menu';
      dropdown.appendChild(dropdown_discount);
      dropdown.appendChild(dropdown_tax);
      let dropdown_btn = document.createElement('a');
      dropdown_btn.className = 'btn btn-primary dropdown-toggle bg-white text-dark text-right';
      dropdown_btn.type = 'Button';
      dropdown_btn.textContent = 'Select one';
      dropdown_btn.setAttribute('style', 'text-transform: none; padding: 0.6rem; margin: 0;');
      dropdown_btn.setAttribute('data-toggle', 'dropdown');
      dropdown_btn.setAttribute('aria-haspopup', 'true');
      dropdown_btn.setAttribute('aria-expanded', 'false');
      let dropdown_top = document.createElement('div');
      dropdown_top.className = 'dropdown';
      dropdown_top.appendChild(dropdown_btn);
      dropdown_top.appendChild(dropdown);

      cell2.setAttribute('style', "text-align: right");
      cell2.appendChild(dropdown_top);

      cell3.innerHTML = "<input type='text' class='form-control' style='border: solid #2e74b6 thin; text-align: right; padding-right: 1rem;' oninput='printPreview();'placeholder='Item' readonly>";

      cell4.innerHTML = "<input type='number' class='form-control' style='border: solid #2e74b6 thin; text-align: right;' value='0' oninput='calculateAmount2(); printPreview();' readonly>";
      cell5.setAttribute('style', 'text-align: right;');
      cell6.innerHTML = "<i class='fas fa-minus-circle' style='color: red; cursor: pointer;' onclick='removeRow(this); printPreview();'></i>";

      // assignDraggable();
    }

    // Remove a row
    function removeRow(elem){

      // console.log(elem)
      // Get the original row
      // Layer 1
      let originalRow = elem.parentNode;
      if (originalRow.nodeName.toLowerCase() === 'tr'){
        // Correct parents node. Do nothing
      }else {
        // Layer 2
        originalRow = originalRow.parentNode;
        if (originalRow.nodeName.toLowerCase() === 'tr'){
        // Correct parents node. Do nothing
        }else {
          // Layer 3
          originalRow = originalRow.parentNode;
          if (originalRow.nodeName.toLowerCase() === 'tr'){
          // Correct parents node. Do nothing
          }else {
            // Layer 4
            // Impossible to  reach here
            originalRow = originalRow.parentNode;
            if (originalRow.nodeName.toLowerCase() === 'tr'){
            // Correct parents node. Do nothing
            }else {
              // Layer 5
              // Impossible to  reach here
              originalRow = originalRow.parentNode;
              if (originalRow.nodeName.toLowerCase() === 'tr'){
                // Correct parents node. Do nothing
              }else {
                // Layer 6
                // Impossible to  reach here
                originalRow = originalRow.parentNode;
                if (originalRow.nodeName.toLowerCase() === 'tr'){
                  // Correct parents node. Do nothing
                }else {
                  // There must be so many nested tag inside a cell.
                  // Technically, it is impossible to reach here.
                  // In case you are here, just add more layers.
                }
              }
            }
          }
        }

      }


      // $( "#timeSlot-"+id ).remove();
      originalRow.parentNode.removeChild(originalRow);

      // After removing item, recalculate total
      calculateAmount2();
    }

    // Remove an item if no more row inside.
    function removeItem(elem){

      // let itemLength = document.getElementById("body_"+id).querySelectorAll("tr[class=item]").length;
      // Go 3 layers upper to the tbody tag
      let itemParentNode = elem;//.querySelectorAll("tr[class=item]").length;

      for (i = 0; i< 3; i++){
        itemParentNode = itemParentNode.parentNode;
      }
      let itemLength = itemParentNode.querySelectorAll("tr[class=item]").length;

      // console.log(itemLength)
      // console.log(itemParentNode)

      if (itemLength > 1){
        // Remove only that row.
        removeRow(elem);
      }else{

        // Get the table-item-top class and remove the item
        itemParentNode.parentNode.parentNode.parentNode.remove();

        // After removing item, recalculate total
        calculateAmount2();
      }

    }

    const tablePreview = document.getElementById('tablePreview');
    const tableAdditionalItemPreview = document.getElementById('tableAdditionalItemPreview');
    // Print Preview
    function printPreview(){

      // init the preview template size
      document.getElementById('invTemplate').style.height = 'auto';

      // clear all spaces details in preview
      let totalPreviewItem = tablePreview.querySelectorAll('.item').length;
      // console.log('totalPreviewItem ' + totalPreviewItem);
      tablePreview.querySelectorAll('.item').forEach(function (row, index) {
        row.remove();
      });

      tablePreview.querySelectorAll('.subtotal').forEach(function (row, index) {
        row.remove();
      });

      let totalAdditionalItemPreview = tableAdditionalItemPreview.querySelectorAll('.additional').length;
      // console.log('totalPreviewItem ' + totalPreviewItem);
      tableAdditionalItemPreview.querySelectorAll('.additional').forEach(function (row, index) {
        row.remove();
      });

      // document.getElementById('previewSubtotalItem').textContent='';
      document.getElementById('previewGrandTotal').textContent='';


      // Get the inv data
      let invData = getAllItems2();
      // console.log('invData')
      // console.log(invData)


      // Step 2: Print Items & Additional Items
      let itemStartIndex= invData.indexOf('ITEMLIST');
      let itemIndex= invData.indexOf('ITEM');
      let additionalItemStartIndex= invData.indexOf('ADDITIONAL_ITEM');
      let totalStartIndex= invData.indexOf('TOTAL');

      // console.log(itemStartIndex, additionalItemStartIndex, subtotalStartIndex, totalStartIndex)

      // let type = payslipDataArr[0];
      let itemList = invData.slice(itemStartIndex+1, additionalItemStartIndex); //+1 to ignore the first indentifier, ITEMLIST
      // let subTotal = payslipDataArr[subtotalStartIndex+1];
      let additionalItem = invData.slice(additionalItemStartIndex+1, totalStartIndex); //+1 to ignore the first indentifier
      let total = invData[totalStartIndex+1];

      var itemIndexArr = [];
      itemList.filter(function(item, index) {
      if(item === 'ITEM'){
        itemIndexArr.push(index)
      }
      });
      // console.log(itemIndexArr)



      // console.log(itemList)
      // console.log(itemIndex)
      // console.log(additionalItem)
      // console.log(total)

      // Loop through each 'ITEM' index
      itemIndexArr.forEach((item, index) => {
        // Get the printable row. Skip the unused rows.
        // +1 is the header identifier, 'ITEM'
        // +4 is the name, refId, cat and tag rows
        let itemSingleList = itemList.slice(item + 1 + 4, itemIndexArr[index+1]);
        // console.log(itemSingleList);

        let subtotalItem = 0;
        let component = [];
        itemSingleList.forEach((item, index) => {

          component = item.split(";; ")
          printItem(component[0], component[1], component[2], component[3]);

          subtotalItem = isNaN(component[1] * component[2]) ? subtotalItem+ 0 : subtotalItem + component[1] * component[2];

        });

        printItemSubtotal(subtotalItem);

      })

      // Print Items
      // Print Additional Items
      additionalItem.forEach((item) => {
        let component = item.split(";; ")
        let additionalSelector = component[0];
        let additionalItem = component[1];
        let additionalItemValue = component[2];
        let amount = component[3];

        if (additionalSelector === 'Select one'){
          // Do nothing
        }
        else if (additionalSelector === 'Discount ( - )'){
          printAdditionalItem(additionalItem, amount);
        }
        else if (additionalSelector === 'Tax Rate (%)'){
          printAdditionalItem(additionalItem+' ('+additionalItemValue +'%)', amount);
        }
        else
        {
          // Do nothing
        }
      });


      // document.getElementById('previewSubtotalItem').textContent = document.getElementById('subtotalItem').textContent;
      document.getElementById('previewGrandTotal').textContent = document.getElementById('grandTotal').textContent;

      let bounderies = document.getElementById('invTemplate').getBoundingClientRect();
      // console.log('item dim (h x w): '+ bounderies.height, bounderies.width );

      let width = document.getElementById('invTemplate').offsetWidth;
      let height = document.getElementById('invTemplate').offsetHeight;
      // console.log('item dim in cm (h x w): '+ height*0.02645833, width*0.02645833 );

      if ( height*0.02645833 >= 29.7 && height*0.02645833 < 59.4){
        document.getElementById('invTemplate').style.height = '59.35cm'; // Slightly smaller than 59.4 - 2page
      }
      else if ( height*0.02645833 >= 59.4 && height*0.02645833 < 89.1){
        document.getElementById('invTemplate').style.height = '89.05cm';
      }
      else if ( height*0.02645833 >= 89.1 && height*0.02645833 < 118.8){
        document.getElementById('invTemplate').style.height = '118.75cm';
      }
      else if ( height*0.02645833 >= 118.8 && height*0.02645833 < 148.5){
        document.getElementById('invTemplate').style.height = '148.45cm';
      }
      else{
        // document.getElementById('invTemplate').style.height = 'auto';
      }


    }

    // Print Item
    function printItem_BU(desc, quantity, price, amount){
      // <tr class="item">
      //   <td style="font-size: small;"></td>
      //   <td style="text-align: right; font-size: small;"></td>
      //   <td style="text-align: right; font-size: small;"></td>
      //   <td style="text-align: right; font-size: small;"></td>
      // </tr>

      let td1 = document.createElement('td');
      td1.setAttribute('style', "font-size: small;");
      td1.textContent = desc

      let td2 = document.createElement('td');
      td2.setAttribute('style', "text-align: right; font-size: small;");
      td2.textContent = quantity

      let td3 = document.createElement('td');
      td3.setAttribute('style', "text-align: right; font-size: small;");
      td3.textContent = price

      let td4 = document.createElement('td');
      td4.setAttribute('style', "text-align: right; font-size: small;");
      td4.textContent = amount

      // Tr top
      let tr = document.createElement('tr');
      tr.className = 'item';
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);

      const previewItemBody = document.getElementById('previewItemBody');
      const previewItemSubtotal = document.getElementById('previewItemSubtotal');
      previewItemBody.insertBefore(tr, previewItemSubtotal)
      // previewItemBody.insertBefore('#previewItemBody tr:nth-last-child(2)')
      // $( "#previewItemBody tr:nth-last-child(2)" ).append(tr);

      // previewItemBody.appendChild(tr);
    }

    // Print Item
    function printItem(desc, quantity, price, amount){
      // <tr class="item">
      //   <td style="font-size: small;"></td>
      //   <td style="text-align: right; font-size: small;"></td>
      //   <td style="text-align: right; font-size: small;"></td>
      //   <td style="text-align: right; font-size: small;"></td>
      // </tr>

      let td1 = document.createElement('td');
      td1.setAttribute('style', "font-size: small;");
      td1.textContent = desc

      let td2 = document.createElement('td');
      td2.setAttribute('style', "text-align: right; font-size: small;");
      td2.textContent = quantity

      let td3 = document.createElement('td');
      td3.setAttribute('style', "text-align: right; font-size: small;");
      td3.textContent = price

      let td4 = document.createElement('td');
      td4.setAttribute('style', "text-align: right; font-size: small;");
      td4.textContent = amount

      // Tr top
      let tr = document.createElement('tr');
      tr.className = 'item';
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);

      const previewItemBody = document.getElementById('previewItemBody');
      // const previewItemSubtotal = document.getElementById('previewItemSubtotal');
      // previewItemBody.insertBefore(tr, previewItemSubtotal)
      previewItemBody.appendChild(tr)



      // previewItemBody.insertBefore('#previewItemBody tr:nth-last-child(2)')
      // $( "#previewItemBody tr:nth-last-child(2)" ).append(tr);

      // previewItemBody.appendChild(tr);
    }


    // Print Subtotal
    function printItemSubtotal(amount){
      // <td></td>
      // <td></td>
      // <td style="text-align: right; font-weight: 500; font-size: small;">Subtotal</td>
      // <td style="text-align: right; font-weight: 500; font-size: small;" id="previewSubtotalItem">RM50.00</td>

      let td1 = document.createElement('td');

      let td2 = document.createElement('td');

      let td3 = document.createElement('td');
      td3.setAttribute('style', "text-align: right; font-weight: 500; font-size: small;");
      td3.textContent = 'Subtotal'

      let td4 = document.createElement('td');
      td4.setAttribute('style', "text-align: right; font-weight: 500; font-size: small;");
      let amountText = (amount >= 0) ? 'RM'+amount.toFixed(2) : '- RM'+ Math.abs(amount).toFixed(2)
      td4.textContent = amountText;

      // Tr top
      let tr = document.createElement('tr');
      tr.className = 'subtotal';
      tr.setAttribute("style", "border-bottom: solid #eeeeee thin;");
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);

      const previewItemBody = document.getElementById('previewItemBody');
      previewItemBody.appendChild(tr);
    }



    function printAdditionalItem(additionalItem, amount){
    // <tr class="additional">
    //   <td></td>
    //   <td></td>
    //   <td style="text-align: right; font-size: small;"></td>
    //   <td style="text-align: right; font-size: small;"></td>
    // </tr>

      let td1 = document.createElement('td');
      let td2 = document.createElement('td');
      let td3 = document.createElement('td');
      td3.setAttribute('style', "text-align: right; font-size: small;");
      td3.textContent = additionalItem

      let td4 = document.createElement('td');
      td4.setAttribute('style', "text-align: right; font-size: small;");
      td4.textContent = amount

      // Tr top
      let tr = document.createElement('tr');
      tr.className = 'additional';
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);

      const previewAdditionalItemBody = document.getElementById('previewAdditionalItemBody');
      // const previewItemSubtotal = document.getElementById('previewItemSubtotal');
      previewAdditionalItemBody.appendChild(tr);
    }


    // Rich Text Editor
    function invNotesOnChangeHandler() {
      // alert("Some one modified something");
      // alert("The HTML is now:" + inst.getBody().innerHTML);

      document.getElementById("previewInvNotes").innerHTML = tinymce.get("invNotes").getContent();
      let invNotesContent = tinymce.get("invNotes").getContent({ format: "text" });
      document.getElementById("countNotes").textContent = invNotesContent.length + '/400';

    }

    function invFooterNotesOnChangeHandler(inst) {
      // alert("Some one modified something");
      // alert("The HTML is now:" + inst.getBody().innerHTML);
      document.getElementById("previewInvFooterNotes").innerHTML = tinymce.get("invFooterNotes").getContent();
      let invFooterNotesContent = tinymce.get("invFooterNotes").getContent({ format: "text" });
      document.getElementById("countFooterNotes").textContent = invFooterNotesContent.length + '/200';

    }


    //-------- Save and Create Invoice-----------------/
    function CreateInvoice() {

      var invDocRef = db.collection("Financial")
        .doc("v1")
        .collection("Invoice")
        .doc();

      var transDocRef = db.collection("Financial")
        .doc("v1")
        .collection("Transaction")
        .doc();

      let invDocId = invDocRef.id;
      let transDocId = transDocRef.id;
      // Issue date
      let issueDate = document.getElementById("invIssueDate").value;
      issueDate = issueDate.split("/");
      let newIssueDate = new Date( issueDate[2], issueDate[1] - 1, issueDate[0]);
      let issueDateFinal = firebase.firestore.Timestamp.fromDate(newIssueDate);

      // Payment Due
      let dueDate = document.getElementById("invPaymentDue").value;
      dueDate = dueDate.split("/");
      let newDueDate = new Date( dueDate[2], dueDate[1] - 1, dueDate[0]);
      let dueDateFinal = firebase.firestore.Timestamp.fromDate(newDueDate);

      // Get all items, subtotal, additional items and grand total
      let allItemsArr = getAllItems2();
      console.log("allItemsArr")

      // Get Total
      let subTotal = calculateSubtotal2();
      let total = calculateTotal2(subTotal);
      console.log("tutorImgUrl");
      console.log(document.getElementById("tutorImgUrl").src);
      console.log(firebase.firestore.Timestamp.fromDate(new Date()))
      let invData = {
        [INV_ID]: invDocId,
        [INV_TRANS_ID]: transDocId,
        [INV_SENDER_ID]: ent_id,
        [INV_RECEIVER_ID]: document.getElementById("invClientId").getAttribute('value'),
        [INV_SENDER_NAME]: document.getElementById("invBizName").textContent,
        [INV_SENDER_DETAILS]: document.getElementById("invBizDetails").textContent,
        [INV_SENDER_IMG_URL]: (document.getElementById("tutorImgUrl").src == null || document.getElementById("tutorImgUrl").src == '') ? '' : document.getElementById("tutorImgUrl").src,

        [INV_RECEIVER_NAME]: document.getElementById("invClientName").textContent,
        [INV_RECEIVER_DETAILS]: document.getElementById("invClientDetails").textContent,
        [INV_TITLE]: document.getElementById("invTitle").value,
        [INV_NUMBER]: document.getElementById("invNum").value,
        [INV_ISSUE_DATE]: issueDateFinal,
        [INV_DUE_DATE]: dueDateFinal,
        [INV_INV_STATUS]: INV_STATUS_DRAFT,

        // Inv Contents
        [INV_ITEMS_ARR]: allItemsArr,
        [INV_TOTAL]: total,
        [INV_NOTES]: tinymce.get("invNotes").getContent(),
        [INV_FOOTER_NOTES]: tinymce.get("invFooterNotes").getContent(),

        [INV_PAYMENT_DATE]: '',
        [INV_PAYMENT_AMOUNT]: '',
        [INV_PAYMENT_NOTE]: '',

        [INV_DATE_ADD]: firebase.firestore.Timestamp.fromDate(new Date()), // This is a hack to allow the "Create:" in invoice > view to show correct value
        [INV_DATE_EDIT]: '',
        [INV_DATE_DEL]: '',
        [INV_STATUS]: true,
      }

      console.log("*Invoice Data...")
      console.log(invData)

      var transData = {
        [TRANS_ID]: transDocId,
        [TRANS_DOC_ID]: invDocId,
        [TRANS_DOC_NUM]: document.getElementById("invNum").value,
        [TRANS_SENDER_ID]: ent_id,
        [TRANS_RECEIVER_ID]: document.getElementById("invClientId").getAttribute('value'),
        [TRANS_SENDER_NAME]: document.getElementById("invBizName").textContent,
        [TRANS_RECEIVER_NAME]: document.getElementById("invClientName").textContent,
        [TRANS_VIEWER_ARR]: [ent_id, document.getElementById("invClientId").getAttribute('value')],
        [TRANS_DATE]: issueDateFinal,
        [TRANS_TYPE]: TRANS_TYPE_INV,
        [TRANS_DOC_STATUS] : TRANS_INV_STATUS_DRAFT,
        [TRANS_TITLE]: document.getElementById("invTitle").value,
        [TRANS_TOTAL]: total,
        [TRANS_DATE_EDIT]: new Date(),
        [TRANS_STATUS]: true,
      }

      console.log("Transaction Data...")
      console.log(transData)


      // Store in session storage to be used in view-invoice.html
      sessionStorage.setItem(SESSION_STORAGE_INVOICE_CURRENT_DOC_KEY, JSON.stringify(invData));
      sessionStorage.setItem(SESSION_STORAGE_TRANSACTION_CURRENT_DOC_KEY, JSON.stringify(transData));

      // Set the value of 'Invoice'
      batch.set(invDocRef, invData, { merge: true });

      // Set the value of 'Transaction'
      batch.set(transDocRef, transData, { merge: true });


      let reportList = getReportList2(allItemsArr);
      // let reportList = getReportList();

      // Defaulted to false.
      if (false){

        // Get the documents with the similar invoice id, and
        // remove the corresponding id in REV_DOC_ID_ARR and REV_DOC_TOTAL_ARR.
        // Update the doc with new value
        var reportDocRef = db.collection("Report")
          .doc("v1")
          .collection("Revenue")
          .where(REV_DOC_ID_ARR, "array-contains", invDocId)
          .where(REV_STATUS, "==", true);

        reportDocRef
          .get()
          .then((querySnapshot) => {
            //   { "name": "<className> / tag", "refId":"<classId1>/uncategorized"  , "type": "cat / tag / org"  , "total": 100 },

            // get all the data in json array
            let docItemJsonList = [];
            querySnapshot.forEach((doc) => {
              let docItemJson = {};

              // console.log(doc.data());

              // Remove the invId from the REV_DOC_ID_ARR and REV_DOC_TOTAL_ARR
              let invDocIdIndex = doc.data()[REV_DOC_ID_ARR].indexOf(invDocId);
              let invDocIdArr = doc.data()[REV_DOC_ID_ARR];
              let invDocTotalArr = doc.data()[REV_DOC_TOTAL_ARR];

              invDocIdArr.splice(invDocIdIndex, 1);
              invDocTotalArr.splice(invDocIdIndex, 1);

              // Construct the new data
              let revData ={
                // [REV_ID]: ,
                // [REV_ADMIN_ID]: ,
                // [REV_NAME]: document.getElementById("invBizDetails").textContent,
                // [REV_REF_ID]: document.getElementById("invClientName").textContent,
                // [REV_TYPE]: ,
                // [REV_MONTH]: document.getElementById("invTitle").value,
                // [REV_TOTAL]: document.getElementById("invNum").value,
                [REV_DOC_ID_ARR]: invDocIdArr,
                [REV_DOC_TOTAL_ARR]: invDocTotalArr,
                [REV_DATE_EDIT]: new Date(),
                // [REV_STATUS]: true
              }

              // Update it through batch
              let revenueDocRef = db.collection("Report")
                .doc("v1")
                .collection("Revenue")
                .doc(doc.id);
              batch.set(revenueDocRef, revData, { merge: true });


            });

            // Commit the batch
            batch.commit().then(() => {
              // window.location.href='./view.html'
              // $('#loadingModal').modal('hide');

              // TODO:
              // Step 1: Get the ID of revDoc based on issuedDate, refId
              // Step 2: Update the revDoc.

              updateRevenueDoc(reportList, invDocId);


            });

          }).catch((error) => {
              console.log("Error getting document:", error);
          });

        console.log(item.refId, item.type, item.total);
      }

      else {
        // Commit the batch
        batch.commit().then(() => {
          window.location.href='./view.html?url=' + orgUrl + "&ent=" + orgEnt + "&iid=" + invDocId;
          // $('#loadingModal').modal('hide');
        });

      }

    }

    function updateRevenueDoc(reportList, invDocId){

      // Step 1: Get the ID of revDoc based on issuedDate, refId
      // Step 1: Get all the revDoc based on 'month'
      let issuedDate = document.getElementById("invIssueDate").value;
      let issuedDateComponent = issuedDate.split('/');
      let month = issuedDateComponent[2]+""+issuedDateComponent[1]
      // console.log(issuedDate)
      // console.log(month)

      let revenueDocList = []
      let reportDocRef = db.collection("Report")
        .doc("v1")
        .collection("Revenue")
        // .where(REV_REF_ID, "==", item.refId)
        .where(REV_MONTH, "==", month)// YYYYMM
        // .limit(1);

      reportDocRef
        .get()
        .then((querySnapshot) => {

          // Step 1: Compare the array of refId from revenueDoc in firestore to refId in reportlist in current inv
          // Get the difference.

          // Example:
          // arr1 =["1","2","3","4","5","6"]; // new Array
          // arr2 = ["3","4","5" ,"7"]; // Array from db
          // Ref: https://stackoverflow.com/questions/1187518/how-to-get-the-difference-between-two-arrays-in-javascript
          // let difference = arr1.filter(x => !arr2.includes(x));
          // console.log(difference); // => [1, 2, 6]
          let refIdRevenueDocList = [];

          querySnapshot.forEach((doc) => {
            refIdRevenueDocList.push(doc.data()[REV_REF_ID]);
          });
          console.log(refIdRevenueDocList);

          let refIdReportList = [];
          reportList.forEach((item) => {
            refIdReportList.push(item.refId);
          })
          console.log(refIdReportList);

          let differenceList = refIdReportList.filter(x => !refIdRevenueDocList.includes(x));
          console.log(differenceList);

          // Step 2.1 Update the existed reportDoc in batch
          querySnapshot.forEach((doc) => {
            // console.log(doc.data());

            // Check if the ID in local invoice items match with the one in revenueDoc.
            // If match create a new data and push to new batch for update.
            // reportList json format:
            // {
            //   "name": "<className1> / tagname1",
            //   "refId": "<classId1> / uncategorized",
            //   "type": "cat / tag / org",
            //   "total": 100
            // }
            reportList.forEach((item) => {

              if (item.refId === doc.data()[REV_REF_ID]){

                let newInvDocIdArr = doc.data()[REV_DOC_ID_ARR];
                newInvDocIdArr.push(invDocId);
                let newInvDocTotalArr = doc.data()[REV_DOC_TOTAL_ARR];
                newInvDocTotalArr.push(item.total);

                let newTotal = newInvDocTotalArr.reduce((a, b) => a + b, 0);

                // Get all the revDoc based on 'month'
                let reportDocRef = db.collection("Report")
                  .doc("v1")
                  .collection("Revenue")
                  .doc(doc.data()[REV_ID]);

                // Construct the new data
                let revData ={
                  // [REV_ID]: ,
                  // [REV_ADMIN_ID]: ,
                  [REV_NAME]: item.name,   // Class name may changed
                  // [REV_REF_ID]: item.refId,
                  // [REV_TYPE]: item.type,
                  // [REV_MONTH]: ,
                  [REV_TOTAL]: newTotal,
                  [REV_DOC_ID_ARR]: newInvDocIdArr,
                  [REV_DOC_TOTAL_ARR]: newInvDocTotalArr,
                  [REV_DATE_EDIT]: new Date(),
                  [REV_STATUS]: true
                }

                batchUpdate.set(reportDocRef, revData, { merge: true });

              } else{
                // Do nothing
              }


            });

          });

          // Step 2.2 Create a new reportDoc for each item in differenceList
          if (differenceList.length>0){
            differenceList.forEach((diffItem) => {
              reportList.forEach((item) => {

                if (item.refId === diffItem){

                  let newInvDocIdArr = [];
                  newInvDocIdArr.push(invDocId);
                  let newInvDocTotalArr = [];
                  newInvDocTotalArr.push(item.total);

                  let newTotal = newInvDocTotalArr.reduce((a, b) => a + b, 0);

                  // Get all the revDoc based on 'month'
                  let reportDocRef = db.collection("Report")
                    .doc("v1")
                    .collection("Revenue")
                    .doc();

                  // Construct the new data
                  let revData ={
                    [REV_ID]: reportDocRef.id,
                    [REV_ADMIN_ID]: ent_id,
                    [REV_NAME]: item.name,
                    [REV_REF_ID]: item.refId,
                    [REV_TYPE]: item.type,
                    [REV_MONTH]: month,
                    [REV_TOTAL]: newTotal,
                    [REV_DOC_ID_ARR]: newInvDocIdArr,
                    [REV_DOC_TOTAL_ARR]: newInvDocTotalArr,
                    [REV_DATE_EDIT]: new Date(),
                    [REV_STATUS]: true
                  }

                  reportDocRef.set(revData, { merge: true });


                } else{
                  // Do nothing
                }


              });


            })
          }


        }).catch((error) => {
            console.log("Error getting document:", error);
        });



      // Construct the new data

      let revData ={
        // [REV_ID]: ,
        // [REV_ADMIN_ID]: ,
        // [REV_NAME]: document.getElementById("invBizDetails").textContent,
        // [REV_REF_ID]: document.getElementById("invClientName").textContent,
        // [REV_TYPE]: ,
        // [REV_MONTH]: document.getElementById("invTitle").value,
        // [REV_TOTAL]: document.getElementById("invNum").value,
        [REV_DOC_ID_ARR]: invDocIdArr,
        [REV_DOC_TOTAL_ARR]: invDocTotalArr,
        [REV_DATE_EDIT]: new Date(),
        // [REV_STATUS]: true
      }

      batchUpdate.set(revenueDocRef, revData, { merge: true })


    }


    function getReportList(){
      // Get the 'Revenue' array of json
      // [
      //   { "name": "<className1> / tagname1" , "refId": "<classId1> / uncategorized"   , "type": "cat / tag / org"   , "total": 100 },
      //   { "name": "Std 6 Math"    , "refId": "pdiejsawafasw"   , "type": "cat"   , "total": 300 },
      //   { "name": "Uncategorized" , "refId": "uncategorized"   , "type": "cat"   , "total": 300 },
      //   { "name": "Deposit 1"     , "refId": "deposit_1"       , "type": "cat"   , "total": 20 }, // New Item, with a category
      //   { "name": "Tax"           , "refId": "tax"             , "type": "cat"   , "total": 20.352s },
      //   { "name": "Others"        , "refId": "other"           , "type": "cat"   , "total": 100 },

      //   { "name": "selangor"      , "refId": "selangor"        , "type": "tag"   , "total": 300 },
      //   { "name": "bm"            , "refId": "bm"              , "type": "tag"   , "total": 320 },
      //   ...
      // ]

      let ReportList = [];

      // Get Items' Report
      let table_item_top = document.getElementById("table-top").querySelectorAll('.table-item-top');
      // Calculate the amount of each item.
      table_item_top.forEach((tableItem) =>{


        let itemJson = {};


        // Calculate the subtotal of each item.
        let subTotal = 0;
        tableItem.querySelectorAll('tr[class=item]').forEach(function (row) {

          // Ignore the header
          // We don't want user to change the order of header
          if (row.className != 'item') {
            return;
          }

          // console.log(row.querySelectorAll('input'));

          let inputEleList = row.querySelectorAll('input')
          // Calculate the subtotal amount
          let desc = inputEleList[0].value;
          let quantity = inputEleList[1].value;
          let price = inputEleList[2].value;
          let amount = row.children[3].textContent;
          // console.log(desc, quantity, price,amount)

          subTotal = isNaN(quantity * price) ? subTotal + 0 : subTotal + quantity * price;

        });

        // Get the refId, cat and tag
        let refId_temp = tableItem.querySelectorAll("td[name=refId]")[0].textContent;
        let refId = (refId_temp == null || refId_temp == "") ? "" : refId_temp;

        let cat_temp = tableItem.querySelectorAll("td[name=cat]")[0].textContent;
        let cat = (cat_temp == null || cat_temp == "") ? "" : cat_temp;
        //   { "name": "Uncategorized" , "refId": "uncategorized"   , "type": "cat"   , "total": 300 },
        //   { "name": "Tax"           , "refId": "tax"             , "type": "cat"   , "total": 20.352s },
        //   { "name": "Others"        , "refId": "other"           , "type": "cat"   , "total": 100 },

        let title = tableItem.querySelectorAll("span[class=table-title]")[0].textContent;

        let itemCatJson = {};
        if (refId === 'uncategorized') // New item
        itemCatJson = {
            "name": "Uncategorized",
            "refId": refId,
            "type": "cat",
            "total": subTotal
          };
        else if (refId != 'tax' && refId != 'other')
        itemCatJson = {
            "name": title,
            "refId": refId,
            "type": "cat",
            "total": subTotal
          };
        else{
          // Not suppose to have tax or other category here
          // Do nothing
          // itemJson = {
          //   "name": "Tax",
          //   "refId": "tax",
          //   "type": "cat",
          //   "total": subTotal
          // };
        }

        ReportList.push(itemCatJson);

        let itemTagJson = {};
        let tag_temp = tableItem.querySelectorAll("td[name=tag]")[0].textContent;
        let tag = (tag_temp == null || tag_temp == "") ? "" : tag_temp;
        let tagArray = (tag_temp == null || tag_temp == "") ? [] : tag_temp.split(",");

        if (tagArray.length >= 1){
          tagArray.forEach((item) => {
            itemTagJson = {
              "name": item,
              "refId": item,
              "type": "tag",
              "total": subTotal
            };
            ReportList.push(itemTagJson)

          });
        }
        else {
          // No tag found.
        }

        // console.log(ReportList);

      });

      // console.log(ReportList);


      // Get Subtotal Report
      let table_subtotal_top = document.getElementById("table-top").querySelectorAll('.table-subtotal')[0];

      // let total = subTotal;
      let subTotal = calculateSubtotal2();
      let addItemOtherTotal = 0;
      let addItemTaxTotal = 0;

      let temp_amount = 0;
      let totalText = '';

      table_subtotal_top.querySelectorAll('tr[class=additional]').forEach(function (row, index) {

        // Ignore the header
        // We don't want user to change the order of header
        if (row.className != 'additional') {
          return ;
        }

        // console.log(row)
        // Get the Action: 2rd TF tag cell > div tag > first A tag
        let action = row.querySelectorAll('a')[0].textContent;

        // Get input value
        let input = parseFloat(row.getElementsByTagName("input")[1].value);

        // console.log(action);
        // console.log(input);

        if (action === 'Discount ( - )'){
          temp_amount = -input;

          addItemOtherTotal = isNaN(temp_amount) ? addItemOtherTotal + 0 : addItemOtherTotal + temp_amount;

          subTotal = subTotal - input;

        }else if(action === 'Tax Rate (%)'){
          temp_amount = subTotal * (input) / 100;

          addItemTaxTotal = isNaN(temp_amount) ? addItemTaxTotal + 0 : addItemTaxTotal + temp_amount;

          subTotal = subTotal * (100 + input) / 100;

        }else{
          // No change
          temp_amount = 0;

          subTotal = subTotal;

        }

      });


      //   { "name": "Tax"           , "refId": "tax"             , "type": "cat"   , "total": 20.352s },
      //   { "name": "Others"        , "refId": "other"           , "type": "cat"   , "total": 100 },
      let addItemOtherJson = {
        "name": 'Others',
        "refId": 'other',
        "type": "cat",
        "total": addItemOtherTotal
      };
      ReportList.push(addItemOtherJson)

      let addItemTaxJson = {
        "name": 'Tax',
        "refId": 'tax',
        "type": "cat",
        "total": addItemTaxTotal
      };
      ReportList.push(addItemTaxJson)


      // console.log(ReportList);

      // Ref: https://www.codegrepper.com/code-examples/javascript/pick+the+duplicate+objects+from+json+array+javascript
      var ids = [];
      var clean = [];

      $.each(ReportList, function(index, value) {
          if($.inArray(value.refId, ids) == -1)
          {
            ids.push(value.refId);
            clean.push(value);
          }else{
            let idIndex = ids.indexOf(value.refId);
            clean[idIndex].total = clean[idIndex].total + value.total;

            // ids.push(value.id);
            // clean.push(value);
          }
      });

      console.log(ids)
      console.log(clean)

      return clean;

    }

    function getReportList2(allItemsArr){

      // Get the 'Revenue' array of json
      // [
      //   { "name": "<className1> / tagname1" , "refId": "<classId1> / uncategorized"   , "type": "cat / tag / org"   , "total": 100 },
      //   { "name": "Std 6 Math"    , "refId": "pdiejsawafasw"   , "type": "cat"   , "total": 300 },
      //   { "name": "Uncategorized" , "refId": "uncategorized"   , "type": "cat"   , "total": 300 },
      //   { "name": "Deposit 1"     , "refId": "deposit_1"       , "type": "cat"   , "total": 20 }, // New Item, with a category
      //   { "name": "Tax"           , "refId": "tax"             , "type": "cat"   , "total": 20.352s },
      //   { "name": "Others"        , "refId": "other"           , "type": "cat"   , "total": 100 },

      //   { "name": "selangor"      , "refId": ""                , "type": "tag"   , "total": 300 },
      //   { "name": "bm"            , "refId": ""                , "type": "tag"   , "total": 320 },
      //   ...
      // ]


      // Items & Additional Items
      let itemStartIndex= allItemsArr.indexOf('ITEMLIST');
      // let itemIndex= allItemsArr.indexOf('ITEM');
      let additionalItemStartIndex= allItemsArr.indexOf('ADDITIONAL_ITEM');
      let totalStartIndex= allItemsArr.indexOf('TOTAL');

      // console.log(itemStartIndex, additionalItemStartIndex, subtotalStartIndex, totalStartIndex)

      // let type = payslipDataArr[0];
      let itemList = allItemsArr.slice(itemStartIndex+1, additionalItemStartIndex); //+1 to ignore the first indentifier, ITEMLIST
      // let subTotal = payslipDataArr[subtotalStartIndex+1];
      let additionalItem = allItemsArr.slice(additionalItemStartIndex+1, totalStartIndex); //+1 to ignore the first indentifier
      let total = allItemsArr[totalStartIndex+1];

      var itemIndexArr = [];
      itemList.filter(function(item, index) {
      if(item === 'ITEM'){
        itemIndexArr.push(index)
      }
      });
      // console.log(itemIndexArr)
      // console.log(itemList)
      // console.log(itemIndex)
      // console.log(additionalItem)
      // console.log(total)

      let ReportList = [];

      // let title = tableItem.querySelectorAll("span[class=table-title]")[0].textContent;

      let subTotal = 0; // Used to get the subtotal.
      // Loop through each 'ITEM' index
      itemIndexArr.forEach((item, index) =>
      {
        // Calculate the subtotal of each item.
        // Get the printable row. Skip the unused rows.
        // +1 is the header identifier, 'ITEM'
        // +3 is the refId, cat and tag rows
        let itemSingleList = itemList.slice(item + 1 + 4, itemIndexArr[index+1]);
        // console.log(itemSingleList);

        let subtotalItem = 0;
        let component = [];
        itemSingleList.forEach((item, index) => {
          component = item.split(";; ")
          subtotalItem = isNaN(component[1] * component[2]) ? subtotalItem + 0 : subtotalItem + component[1] * component[2];

        });

        // Get the refId, tag and cat
        let className = itemList.slice(item + 1, item + 2)[0];
        let refId = itemList.slice(item + 2, item + 3)[0];
        let cat = itemList.slice(item + 3, item + 4)[0];
        let tag_temp = itemList.slice(item + 4, item + 5)[0];
        // console.log(className, refId, cat, tag_temp)
        // let tag = (tag_temp == null || tag_temp == "") ? "" : tag_temp;
        let tagArray = (tag_temp == null || tag_temp == "") ? [] : tag_temp.split(",");

        let itemCatJson = {};

        if ( cat  === refId  ||  cat == "" ){
          // Class Item
          itemCatJson = {
            "name": className,
            "refId": refId,
            "type": "cat",
            "total": subtotalItem
          };
        }else {
          // New Item with 'Uncategorized' or unique category
          itemCatJson = {
            "name": cat,
            "refId": refId,
            "type": "cat",
            "total": subtotalItem
          };
        }
        // if (refId === 'uncategorized') // New item
        // itemCatJson = {
        //     "name": className, //"Uncategorized",
        //     "refId": refId,
        //     "type": "cat",
        //     "total": subtotalItem
        //   };
        // else if (refId != 'tax' && refId != 'other')
        //   itemCatJson = {
        //     "name": className,
        //     "refId": refId,
        //     "type": "cat",
        //     "total": subtotalItem
        //   };
        // else{
        //   // Not suppose to have tax or other category here. They will be done later
        //   // Do nothing
        // }

        ReportList.push(itemCatJson);

        let itemTagJson = {};
        if (tagArray.length >= 1){
          tagArray.forEach((item) => {
            itemTagJson = {
              "name": item,
              "refId": item,
              "type": "tag",
              "total": subtotalItem
            };
            ReportList.push(itemTagJson)

          });
        }
        else {
          // No tag found.
        }

        subTotal = subTotal + subtotalItem;

        console.log(ReportList);



      });


      // console.log(ReportList);

      // Get Additional Items
      let addItemOtherTotal = 0;
      let addItemTaxTotal = 0;

      let temp_amount = 0;
      let totalText = '';

      additionalItem.forEach((item) => {
        // console.log("")
        // console.log(item)
        // console.log("")
        let component = item.split(";; ")

        let additionalSelector = component[0];
        let additionalItem = component[1];
        let additionalItemValue = parseFloat(component[2]);
        let amount = component[3];

        if (additionalSelector === 'Select one'){
          // Do nothing
          temp_amount = 0;
          subTotal = subTotal;
        }
        else if (additionalSelector === 'Discount ( - )'){
          // console.log(additionalItem, amount);
          temp_amount = -additionalItemValue;

          addItemOtherTotal = isNaN(temp_amount) ? addItemOtherTotal + 0 : addItemOtherTotal + temp_amount;

          subTotal = subTotal - additionalItemValue;

        }
        else if (additionalSelector === 'Tax Rate (%)'){
          // console.log(additionalItem+' ('+additionalItemValue +'%)', amount);
          temp_amount = subTotal * (additionalItemValue) / 100;
          console.log("Tax Rate (%):");
          console.log("temp_amount: "+ temp_amount);
          addItemTaxTotal = isNaN(temp_amount) ? addItemTaxTotal + 0 : addItemTaxTotal + temp_amount;
          console.log("addItemTaxTotal: "+ addItemTaxTotal);
          subTotal = subTotal * (100 + additionalItemValue) / 100;
          console.log("subTotal after Tax: "+ subTotal);
        }
        else
        {
          // Do nothing
          temp_amount = 0;
          subTotal = subTotal;
        }

        console.log("subTotal: "+ subTotal);
      });

      let addItemOtherJson = {
        "name": 'Others',
        "refId": 'other',
        "type": "cat",
        "total": addItemOtherTotal
      };
      ReportList.push(addItemOtherJson)

      let addItemTaxJson = {
        "name": 'Tax',
        "refId": 'tax',
        "type": "cat",
        "total": addItemTaxTotal
      };
      ReportList.push(addItemTaxJson)


      console.log('row ReportList: ');
      console.log(ReportList);
      // Ref: https://www.codegrepper.com/code-examples/javascript/pick+the+duplicate+objects+from+json+array+javascript
      var ids = [];
      var clean = [];

      $.each(ReportList, function(index, value) {
          if($.inArray(value.refId, ids) == -1)
          {
            ids.push(value.refId);
            clean.push(value);
          }else{
            let idIndex = ids.indexOf(value.refId);
            clean[idIndex].total = clean[idIndex].total + value.total;

            // ids.push(value.id);
            // clean.push(value);
          }
      });

      // console.log(ids)
      // console.log(clean)
      console.log('clean ReportList: ');
      console.log(clean);


      return clean;
    }


    function validateForm(id) {

      const parentElement = document.getElementById(id);

      // This function deals with validation of the form fields with data-compulsory = 'true'
      var x, y, i, valid = true;
      // x = document.getElementsByClassName("multitabs-form__panel");
      // y = x[activePanelNum].getElementsByTagName("input") && x[activePanelNum].querySelectorAll('[type="text"]');
      y =parentElement.querySelectorAll('[data-compulsory="true"]');

      // A loop that checks every input field in the current tab:
      for (i = 0; i < y.length; i++) {
        // console.log(y[i].value)
        // If a field is empty...
        if (y[i].value == "") {
          // add an "invalid" class to the field:
          y[i].className += " invalid";
          // and set the current valid status to false:
          valid = false;
        }
      }
      // If the valid status is true, mark the step as finished and valid:
      if (valid) {
        // document.getElementsByClassName("step")[activePanelNum].className += " finish";
      }
      return valid; // return the valid status
    }

    // Enable / Disable save modal
    function enableSaveModal(){
      let invBizName = document.getElementById("invBizName").textContent;
      let invClientName = document.getElementById("invClientName").textContent;
      let invNum = document.getElementById("invNum").value;
      let invIssueDate = document.getElementById("invIssueDate").value;
      let invPaymentDue = document.getElementById("invPaymentDue").value;

      // console.log('invBizName: ' + invBizName)
      // console.log('invClientName: ' + invClientName)
      // console.log('invNum: ' + invNum)
      // console.log('invIssueDate: ' + invIssueDate)
      // console.log('invPaymentDue: ' + invPaymentDue)
      if (invBizName == null || invBizName =='' ||
        invClientName == null || invClientName =='' ||
        invNum == null || invNum =='' ||
        invIssueDate == null || invIssueDate =='' ||
        invPaymentDue == null || invPaymentDue =='' ){
          document.getElementById("btnSave").setAttribute('data-toggle', '');
      }
      else{
        document.getElementById("btnSave").setAttribute('data-toggle', 'modal');
      }
    }

    function fieldChecker(){
      let invBizName = document.getElementById("invBizName").textContent;
      let invClientName = document.getElementById("invClientName").textContent;
      let invNum = document.getElementById("invNum").value;
      let invIssueDate = document.getElementById("invIssueDate").value;
      let invPaymentDue = document.getElementById("invPaymentDue").value;

      if (invBizName == null || invBizName =='' ||
        invClientName == null || invClientName =='' ||
        invNum == null || invNum =='' ||
        invIssueDate == null || invIssueDate =='' ||
        invPaymentDue == null || invPaymentDue =='' ){
        func.showNotification('top','center', 'warning', 'error_outline', "Please ensure all the compulsory fields are filled up." );
      }
    }

    function tConvert (time) {
      // Check correct time format and split into components
      // 18:00:00 => "6:00:00PM"
      // 18:00 => "6:00PM"
      // 00:00 => "12:00AM"
      // 11:59:01 => "11:59:01AM"
      // 12:00:00 => "12:00:00PM"
      // 13:01:57 => "1:01:57PM"
      // 24:00 => "24:00"
      // sdfsdf => "sdfsdf"
      // 12:61:54 => "12:61:54"

      time = time.toString ().match (/^([01]\d|2[0-3])(:)([0-5]\d)(:[0-5]\d)?$/) || [time];

      if (time.length > 1) { // If time format correct
        time = time.slice (1);  // Remove full string match value
        time[5] = +time[0] < 12 ? 'AM' : 'PM'; // Set AM/PM
        time[0] = +time[0] % 12 || 12; // Adjust hours
      }
      return time.join (''); // return adjusted time or original string
    }

    // Generate uuid
    function create_UUID(){
      var dt = new Date().getTime();
      var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = (dt + Math.random()*16)%16 | 0;
          dt = Math.floor(dt/16);
          return (c=='x' ? r :(r&0x3|0x8)).toString(16);
      });
      return uuid;
    }

  </script>

  <script>
      var ID = ""; // Extract info from data-* attributes
      var NAME = ""; // Extract info from data-* attributes
      var PHONE = ""; // Extract info from data-* attributes
      var EMAIL = ""; // Extract info from data-* attributes
      var ADDRESS = ""; // Extract info from data-* attributes
		$( document ).ready(function() {

      // Active Register Class Modal
      // $('#loadingModal').modal({
      //   backdrop:'static',
      //   keyboard:false,
      //   show: false
      // });

      // Invoice Body specific
      $('#addItem').on( 'click', function () {
        // className = className
        // classId = classId / 'new' for New Item - use to differentiate invoice item
        // classQuantity = quantity (default: 1). For new item, assign '-'
        // classFee = class fee
        // refId = cat id - made up of classId / 'new' - used to classify class.
        // cat = cat name - made up of classId / 'uncategorized' / 'tax' / 'other'
        // tag = tag name - separated by comma ', '


        // className, classId, classQuantity, classFee, refId, cat, tag

        let uuid = create_UUID();

        addItem("New Item", uuid, 1, 0,  'uncategorized', 'Uncategorized', []);
        // addItem("New Item", 'new', 1, 0,  'uncategorized', 'Uncategorized', []);
      });

      $('#addAdditionalRow').on( 'click', function () {
        addAdditionalRow();
      });

      // Populate the fields
      $('#addBusinessDetailModal').on('show.bs.modal', function (event) {
        let inName = document.getElementById("invBizName").textContent;
        document.getElementById("inName").value = inName;
        document.getElementById("inDetails").textContent = document.getElementById("invBizDetails").textContent;

        if (inName.length >= 0){
          document.getElementById("btnAddBusinessDetailModalUpdate").removeAttribute("disabled");
        }
        else{
          document.getElementById("btnAddBusinessDetailModalUpdate").setAttribute("disabled", true);
        }
      });

      // Edit Business Details
      $('#btnAddBusinessDetailModalUpdate').on('click', function(){
        document.getElementById("invBizName").textContent =  document.getElementById("inName").value;
        let inPhone = document.getElementById("inContact").value;
        let inEmail = document.getElementById("inEmail").value;
        let inAddr = document.getElementById("inAddr").value;
        let invBizDetails = ''
        invBizDetails += (inPhone == null || inPhone == '')? '' : inPhone;
        invBizDetails += (inEmail == null || inEmail == '')? '' : ', <br>'+ inEmail;
        invBizDetails += (inAddr == null || inAddr == '')? '' : ', <br>'+ inAddr;

        document.getElementById("invBizDetails").innerHTML = invBizDetails;

        // Update preview
        document.getElementById("previewInvBizName").textContent = document.getElementById("inName").value;
        document.getElementById("previewInvBizDetails").innerHTML = invBizDetails;


      });

      // Counter, Autofiller
      $('#invTitle').on('input', function(){
        document.getElementById("countTitle").textContent = this.value.length + '/40'
        document.getElementById("previewInvTitle").textContent = this.value;
      });

      $('#invNum').on('input', function(){
        document.getElementById("previewInvNum").textContent = this.value;
      });
      // $('#invIssueDate').on('input', function(){
      //   document.getElementById("previewInvIssueDate").textContent = this.value;
      // });
      // $('#invPaymentDue').on('input', function(){
      //   document.getElementById("previewInvPaymentDue").textContent = this.value;
      // });
      $('#invStatus').on('input', function(){
        document.getElementById("previewStatus").textContent = this.value;
      });

      $('#inName').on('input', function(event){
        document.getElementById("countName").textContent = this.value.length + '/400'
        if (this.value.length > 0){
          document.getElementById("btnAddBusinessDetailModalUpdate").removeAttribute("disabled");
        }
        else{
          document.getElementById("btnAddBusinessDetailModalUpdate").setAttribute("disabled", true);
        }
      });

      // $('#invFooterNotes').on('input', function(){
      //   document.getElementById("countFooterNotes").textContent = this.value.length + '/250'
      //   document.getElementById("previewInvFooterNotes").textContent = this.value;
      // });

      // Load all Admin Students
      $('#addStudentModal').on('show.bs.modal', function (event) {
        latestAdminStuDoc = null;
        allStuModuleDoc = []; // Init All Students Doc array
        stuAdminLoadmore.addEventListener('click', stuAdminLoadMoreHandleClick );
        loadAllAdminStudents();
      });

      // Remove all Admin Students when the Add Student Modal close
      $('#addStudentModal').on('hidden.bs.modal', function (event) {
        // NOTE: div:gt(4) - get the 5th div child in the parent node.
        $('#add-student-modal-container div:gt(4)').remove();
        allStuModuleDoc = []; // Init All Students Doc array

      });

      // Edit Client Modal on Load
      $('#editClientModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) // Button/Components that triggered the modal
        if (button.length > 0){
          // This happens when a client is choosen manually. Gurdian info exists.
          ID = button.data('gurid') // Extract info from data-* attributes
          NAME = button.data('gurname') // Extract info from data-* attributes
          PHONE = button.data('gurphone') // Extract info from data-* attributes
          EMAIL = button.data('guremail') // Extract info from data-* attributes
          ADDRESS = button.data('guraddr') // Extract info from data-* attributes
          // Load Desription
          document.getElementById("inClientId").setAttribute('value', ID);
          document.getElementById("inClientName").value = NAME;
          // document.getElementById("inClientContact").value = PHONE;
          itiPhone.setNumber(PHONE);
          document.getElementById("inClientEmail").value = EMAIL;
          document.getElementById("inClientAddr").value = ADDRESS;
        }
        else {
          // This happens when cid exists through redirection from summary.
          console.log("Button doest not exists")
        }

        if (ID == null || ID == ''){
          document.getElementById("inClientName").removeAttribute('readonly');
          document.getElementById("inClientContact").removeAttribute('readonly');
          // Disable Button Update
          document.getElementById("btnEditClientModalUpdate").setAttribute('disabled', true);

        }else{
          document.getElementById("inClientName").setAttribute('readonly', true);
          document.getElementById("inClientContact").setAttribute('readonly', true);
          // Enable Button Update
          document.getElementById("btnEditClientModalUpdate").removeAttribute('disabled');
        }

      });

      // Check input in editClientModal
      $('#inClientName').on('change', function(){
        if( $(this).val().length === 0 || inputPhone.value.length === 0 || !itiPhone.isValidNumber()) {
          $('#btnEditClientModalUpdate').prop('disabled', true);
        }else{
          $('#btnEditClientModalUpdate').prop('disabled', false);
        }
      });

      $('#inClientContact').on('change', function(){

        // Enable or disable btnEditClientModalUpdate Button
        if( $(this).val().length === 0 || !itiPhone.isValidNumber() || $('#inClientName').val().length === 0) {
          $('#btnEditClientModalUpdate').prop('disabled', true);
        }
        else{
          $('#btnEditClientModalUpdate').prop('disabled', false);
        }

        // Set inClientId (do not depend on client name)
        if( $(this).val().length === 0 || !itiPhone.isValidNumber()) {
        }
        else{
          document.getElementById("inClientId").setAttribute('value', itiPhone.getNumber() );
        }

      });


      // Clear key and fields in modal when modal dismiss
      $('#editClientModal').on('hide.bs.modal', function (event) {
        ID = "";
        NAME = "";
        PHONE = "";
        EMAIL = "";
        ADDRESS = "";
        document.getElementById("inClientId").setAttribute('value', '');
        document.getElementById("inClientName").value = '';
        document.getElementById("inClientContact").value = '';
        document.getElementById("inClientEmail").value = '';
        document.getElementById("inClientAddr").value = '';

        // Init Phone Message
        document.getElementById("valid-msg").className = 'hide';
        document.getElementById("error-msg").className = 'hide';

        // Button
        document.getElementById("btnEditClientModalUpdate").textContent = "Confirm";

      });

      // Once confirmed, update the client view in Invoice
      $('#btnEditClientModalUpdate').on('click', function (e) {

        let clientName = document.getElementById("inClientName").value;
        let ClientId = document.getElementById("inClientId").getAttribute('value');
        // let clientContact = document.getElementById("inClientContact").value;
        let clientContact = itiPhone.getNumber();
        let ClientEmail = document.getElementById("inClientEmail").value;
        let ClientAddr = document.getElementById("inClientAddr").value;

        document.getElementById("invClientId").setAttribute('value', ClientId);
        document.getElementById("invClientName").textContent = clientName;


        let clientDetails = '';
        clientDetails += (clientContact == null || clientContact == '')? '' : clientContact;
        clientDetails += (ClientEmail == null || ClientEmail == '')? '' : ', <br>' + ClientEmail;
        clientDetails += (ClientAddr == null || ClientAddr == '')? '' : ', <br>' + ClientAddr;
        document.getElementById("invClientDetails").innerHTML = clientDetails;


        // Update preview
        document.getElementById("previewInvClientName").textContent = clientName;
        document.getElementById("previewInvClientDetails").innerHTML = clientDetails;

        // Validate fields in editClientModal modal
        validateForm('editClientModal');

        // Enable save modal
        enableSaveModal();

        console.log(ClientId)
        // Load all client's active class of this month.
        if (ClientId == null || ClientId == ''){
          // Do nothing
        }else
        // Load all the client's classes of the month
          loadAllClientClassInfo(ClientId);

		  });

      var EDIT_ITEM_ID = '';
      var EDIT_ITEM_TITLE = '';
      var EDIT_ITEM_REF_ID = '';
      var EDIT_ITEM_CATEGORY = '';
      var EDIT_ITEM_TAG = '';

      // Edit Item Modal
      $('#editItemModal').on('show.bs.modal', function (event) {

        var button = $(event.relatedTarget) // Button/Components that triggered the modal

        EDIT_ITEM_ID = button.data('edititemid') // Item Id
        // EDIT_ITEM_TITLE = button.data('edititemtitle') // Item Title
        // EDIT_ITEM_REF_ID = button.data('edititemrefid') // Item RefId
        // EDIT_ITEM_CATEGORY = button.data('edititemcat') // Item Cat
        // EDIT_ITEM_TAG = button.data('edititemtag') // Item Tag

        var itemSelected = document.getElementsByName(EDIT_ITEM_ID)[0];
        EDIT_ITEM_REF_ID = itemSelected.querySelector('td[class=th-hidden][name=refId]').textContent;
        EDIT_ITEM_CATEGORY = itemSelected.querySelector('td[class=th-hidden][name=cat]').textContent;
        EDIT_ITEM_TAG = itemSelected.querySelector('td[class=th-hidden][name=tag]').textContent;
        EDIT_ITEM_TITLE = itemSelected.querySelector('td[class=th-hidden][name=name]').textContent;
        // console.log(EDIT_ITEM_ID);
        // console.log(EDIT_ITEM_TITLE);
        // console.log(EDIT_ITEM_REF_ID);
        // console.log(EDIT_ITEM_CATEGORY);
        // console.log(EDIT_ITEM_TAG);

        // Load Item Details
        document.getElementById("inItemId").setAttribute('value', EDIT_ITEM_ID);

        document.getElementById("inItemTitle").value = EDIT_ITEM_TITLE;

        let category_select = document.getElementById("category_drop");
        let el = document.createElement("option");

        // For Class item, both cat and refId is set to classId. For newer version, cat was set to "".
        // For Non-class item, always have 'uncategorized', or other category slug
        if ((EDIT_ITEM_CATEGORY  === EDIT_ITEM_REF_ID   || EDIT_ITEM_CATEGORY == "") && EDIT_ITEM_CATEGORY != 'Uncategorized'){
          category_select.setAttribute('disabled', true);

          el.textContent = EDIT_ITEM_TITLE;
          el.value = EDIT_ITEM_REF_ID;

        }else {
          category_select.removeAttribute('disabled');
          el.textContent = EDIT_ITEM_CATEGORY;
          el.value = EDIT_ITEM_REF_ID;
        }
        category_select.appendChild(el);

        // Always add 'Uncategorized' as option if the exisitng category is not 'Uncategorized'
        if (EDIT_ITEM_CATEGORY != 'Uncategorized') {
          let el2 = document.createElement("option");
          el2.textContent = 'Uncategorized';
          el2.value = 'uncategorized';
          category_select.appendChild(el2);
        }


        // document.getElementById("inItemTag").value = EDIT_ITEM_TAG;
        let tagList = EDIT_ITEM_TAG.split(',')
        tagList.forEach((item) => {
          $('#inItemTag').tagsinput('add', item, {preventPost: true});
        })

        // Load & populate all category
        var docRef = db.collection("Settings")
          .doc("v1")
          .collection("category")
          .doc(ent_id)

        docRef.get().then((doc) => {

          if (doc.exists){
            // console.log(doc.data());

            // ------Pupulate Category Dropdown ------- //
            let categoryArr= doc.data()[SET_CAT_NAME_ARR]
            let categoryIdArr= doc.data()[SET_CAT_ID_ARR]

            categoryArr.forEach((category, index) => {

              let el = document.createElement("option");
              el.textContent = category;
              el.value = categoryIdArr[index];

              // Update State
              if (categoryIdArr[index] === EDIT_ITEM_REF_ID) {
                el.selected = true;
              }
              category_select.appendChild(el);
            })


          }else {
            console.log('No settings document found')
          }


        })


      });

      // Clear all values
      $('#editItemModal').on('hide.bs.modal', function (event) {
        EDIT_ITEM_ID = "";
        EDIT_ITEM_TITLE = "";
        EDIT_ITEM_REF_ID = "";
        EDIT_ITEM_CATEGORY = "";
        EDIT_ITEM_TAG = "";

        document.getElementById("inItemId").setAttribute('value', "");
        document.getElementById("inItemTitle").value = "";

        // Clear all options
        let optionList = document.getElementById("category_drop").querySelectorAll('option');
        optionList.forEach((row) => {
          row.remove();
        })

        $('#inItemTag').tagsinput('removeAll');
        document.getElementById("inItemTag").value = "";

      });

      // Update the selected item
      $('#btnEditItemModalUpdate').on('click', function (e) {

        let itemId = document.getElementById("inItemId").getAttribute('value')
        // console.log(itemId);
        let itemTitle = document.getElementById("inItemTitle").value;
        // console.log(itemTitle);
        let itemCategorySlug = $('#category_drop').val()
        // console.log(itemCategorySlug);
        let select_category = document.getElementById("category_drop")
        let itemCategory = select_category.options[select_category.selectedIndex].text
        // console.log(itemCategory);
        // console.log(document.getElementById("inItemTag").value);

        let itemTag = $("#inItemTag").val();
        // console.log(itemTag)

        var itemSelected = document.getElementsByName(itemId)[0];

        if (itemSelected != null) {
          // Clear all tags
          itemSelected.querySelectorAll('span[class=table-tag]').forEach((tagRow) => {
            tagRow.remove();
          });

          // Clear all categories
          itemSelected.querySelectorAll('span[class=table-cat]').forEach((catRow) => {
            catRow.remove();
          });

          // Assign Values
          itemSelected.querySelector('span[class=table-title]').textContent = itemTitle;

          itemSelected.querySelector('td[class=th-hidden][name=refId]').textContent = itemCategorySlug;
          itemSelected.querySelector('td[class=th-hidden][name=cat]').textContent = itemCategory;
          itemSelected.querySelector('td[class=th-hidden][name=tag]').textContent = itemTag;
          itemSelected.querySelector('td[class=th-hidden][name=name]').textContent = itemTitle;

          let btnEditItem = itemSelected.querySelector('a[name=btnEdit]');
          btnEditItem.setAttribute('data-edititemtitle', itemTitle);
          btnEditItem.setAttribute('data-edititemrefid', itemCategorySlug);
          btnEditItem.setAttribute('data-edititemcat', itemCategory);
          btnEditItem.setAttribute('data-edititemtag', itemTag);

          let tableItem = itemSelected.querySelector('.table-item')

          // Attach Tag
          if (itemTag == null || itemTag == ""){
            // Empty tag, do nothing
          }else {
            let itemTagList = itemTag.split(',');
            itemTagList.forEach((tag) => {

              let tagSpan = document.createElement('span');
              tagSpan.className = "table-tag";
              tagSpan.textContent = tag;
              tableItem.insertBefore(tagSpan, tableItem.children[1]);
            })
          }

          // Attach Category
          if ((itemCategory  === itemCategorySlug   || itemCategory == "") && itemCategory != 'uncategorized'){
            // Class item
          }else {
            // Non Class Item
            let catSpan = document.createElement('span');
            catSpan.className = "table-cat";
            catSpan.textContent = itemCategory;
            tableItem.insertBefore(catSpan, tableItem.children[1]);
          }

        }
        else
        {
          // Do nothing
          console.log("No such item.")
        }

		  });

      // Create New Category Confirm
      $('#btnCategoryCreateConfirmModalUpdate').on('click', function (e) {
        let inCategoryName = document.getElementById("inCategoryName").value;
        let inCategorySlug = document.getElementById("inCategorySlug").value;
        let inCategoryDesc = document.getElementById("inCategoryDesc").value;

        console.log(inCategoryName, inCategorySlug, inCategoryDesc);

        var promiseAll = [];

        // Create a new category
        var setDocRef = db.collection("Settings")
            .doc("v1")
            .collection("category")
            .doc(ent_id)
            .get();

        promiseAll.push(setDocRef);

        var singleSetdocRef = db.collection("Settings")
          .doc("v1")
          .collection("category_single")
          .where(SET_CAT_SINGLE_TUTOR_ID, "==", ent_id)
          .get();

        promiseAll.push(singleSetdocRef);

        Promise.all(promiseAll)
        .then((snapshots) => {
          var promiseLayer1 = [];
          var nameArr = [];
          var idArr = [];
          var slugArr = [];

          var categorySettingExist = false;
          var categoryExist = false;

          // Check if Setting > v1 > category > <ent_id> exists
          if (snapshots != null && snapshots[0] != null ){

            if (snapshots[0].exists) {
              console.log(snapshots[0].data());

              categorySettingExist = true;
              nameArr = snapshots[0].data()[SET_CAT_NAME_ARR];
              idArr = snapshots[0].data()[SET_CAT_ID_ARR];
              slugArr = snapshots[0].data()[SET_CAT_SLUG_ARR];

            }else {

              console.log("Setting > v1 > category > <ent_id> does not")

            }
          }else {
            console.log("snapshots[0] is null")
          }

          // Check if Setting > v1 > category_single > <categoryDocId> exists
          if (snapshots != null && snapshots[1] != null && snapshots[1].size != 0){

            snapshots[1].forEach((doc) => {

              console.log(doc.data())

              if(doc.data()[SET_CAT_SINGLE_NAME] == inCategoryName){
                // Exist. Ignore
                categoryExist = true;
              }

            });
          }
          else {
            console.log("Setting > v1 > category_single > <categoryDocId> does not")
          }

          // Update the settings
          // If the category does not exist, update/create the existing settings
          if (!categoryExist){

            var newCatSingleDocRef = db.collection("Settings")
              .doc("v1")
              .collection("category_single")
              .doc();

            let categorySingleId = newCatSingleDocRef.id
            let data_single = {
              [SET_CAT_SINGLE_ID] : categorySingleId,
              [SET_CAT_SINGLE_TUTOR_ID] : ent_id,
              [SET_CAT_SINGLE_NAME] : inCategoryName,
              [SET_CAT_SINGLE_SLUG] : inCategorySlug,
              [SET_CAT_SINGLE_DESC] : inCategoryDesc,
              [SET_CAT_SINGLE_DATE_EDIT] : new Date(),
            }
            console.log('category_single')
            console.log(data_single)
            promiseLayer1.push(newCatSingleDocRef.set(data_single, {merge : true}))


            var newCatDocRef = db.collection("Settings")
            .doc("v1")
            .collection("category")
            .doc(ent_id);

            nameArr.push(inCategoryName);
            idArr.push(categorySingleId);
            slugArr.push(inCategorySlug);
            let data_all = {
              [SET_CAT_ID] : newCatDocRef.id,
              [SET_CAT_TUTOR_ID] : ent_id,
              [SET_CAT_NAME_ARR] : nameArr,
              [SET_CAT_ID_ARR] : idArr,
              [SET_CAT_SLUG_ARR] : slugArr,
              [SET_CAT_DATE_EDIT] : new Date(),
            }
            console.log('data_all')
            console.log(data_all)
            promiseLayer1.push(newCatDocRef.set(data_all, {merge : true}))

            return Promise.all(promiseLayer1);

          }
          else {
            console.log("Category already exists. Ignore")

            return null;
          }



        })
        .then((snapshot) => {

          if (snapshot == null){
            func.showNotification('top','center', 'warning', 'error_outline', inCategoryName + " already exists" );

          }else {
            func.showNotification('top','center', 'success', 'check_circle', inCategoryName + " is successfully created!" );
          }

          // Hide the modals
          $('#categoryCreateConfirmModal').modal('hide');
          $('#addCategoryModal').modal('hide');

        })
        .catch((error) => {
          func.showNotification('top','center', 'danger', 'error_outline', "Error happened. Please try again." );

          console.log("Transaction failed: ", error);
        });

		  });


      // Clear New Category Add Value
      $('#addCategoryModal').on('hide.bs.modal', function (event) {
        document.getElementById("inCategoryName").value = "";
        document.getElementById("inCategorySlug").value = "";
        document.getElementById("inCategoryDesc").value = "";
        document.getElementById("countCatName").textContent = '0/40';
        document.getElementById("countCatSlug").textContent = '0/40';
        document.getElementById("btnAddCategoryModalUpdate").setAttribute("disabled", true);
      })

      $('#inCategoryName').on('input', function(event){
        document.getElementById("countCatName").textContent = this.value.length + '/40'
        if (this.value.length > 0){
          document.getElementById("btnAddCategoryModalUpdate").removeAttribute("disabled");
        }
        else{
          document.getElementById("btnAddCategoryModalUpdate").setAttribute("disabled", true);
        }
      });

      $('#inCategorySlug').on('input', function(event){
        document.getElementById("countCatSlug").textContent = this.value.length + '/40'
      });


      // Save and Proceed - Save btn clicked
      $('#btnSaveModalUpdate').on('click', function (event) {
        $('#loadingModal').modal('show');
        // Validate fields in editClientModal modal
        let accordionFieldsValid =  validateForm('accordionExample');

        CreateInvoice();
      });

		});


  </script>

  <!-- More functions -->
  <script>

    // Dealing with Textarea Height
    function calcHeight(value) {
      let numberOfLineBreaks = (value.match(/\n/g) || []).length;
      // min-height + lines x line-height + padding + border
      let newHeight = 20 + numberOfLineBreaks * 20 + 12 + 2;
      return newHeight;
    }

  </script>

  <!-- Table Handler -->
  <script>
    // https://htmldom.dev/drag-and-drop-table-row/
    document.addEventListener('DOMContentLoaded', function () {
      table.querySelectorAll('tr').forEach(function (row, index) {
        // Ignore the header
        // We don't want user to change the order of header
        if (index === 0) {
            return;
        }
        // Ignore row with certain class name
        else if(row.className != 'item'){
          return;
        }

        // console.log(row)
        // console.log(row.className)
        const firstCell = row.firstElementChild;
        firstCell.classList.add('draggable');
        // firstCell.addEventListener('mousedown', mouseDownHandler);
        firstCell.addEventListener('pointerdown', mouseDownHandler);

      });
      assignDraggable();
    });
  </script>

  <!-- Datepicker -->
  <script>
      // Date picker
      // Source: https://mcdatepicker.netlify.app/docs/
      const calendarTheme = {
        theme_color: '#2e74b6', //#19212b
        main_background: '#FBFBFB',
        active_text_color: 'rgba(62,85,110,0.85)',
        inactive_text_color: '#cfe6ff',
        picker_header: {
          active: '#8ea5bd'
        },
        weekday: {
          foreground: '#2e74b6' //rgba(35,68,97,0.8)
        },
        display: {
          foreground: '#8ea5bd'
        },
        date: {
          active: {
            picked: {
              background: '#2e74b6'
            }
          },
          marcked: {
            foreground: '#53a6fa'
          }
        },
        button: {
          danger: {
            foreground: '#af002a'
          },
          success: {
            foreground: '#2e74b6'
          }
        }
      };

      const issueDateDatePicker = MCDatepicker.create({
        el: '#invIssueDate',
        bodyType: 'inline',
        dateFormat: 'dd/mm/yyyy',
        selectedDate: new Date(),
        firstWeekday: 1,
        minDate: new Date(2020, 0, 1),
        theme: calendarTheme
      });

      issueDateDatePicker.onClose(() => {
        // Remove invalid background if the user input smt
        document.getElementById("previewInvIssueDate").textContent = document.getElementById("invIssueDate").value;

        if ( document.getElementById("invIssueDate").value.length > 0){
          document.getElementById("invIssueDate").className = 'form-control';
        }
        enableSaveModal();
      });

      const paymentDueDatePicker = MCDatepicker.create({
        el: '#invPaymentDue',
        bodyType: 'inline',
        dateFormat: 'dd/mm/yyyy',
        selectedDate: new Date(),
        firstWeekday: 1,
        minDate: new Date(2020, 0, 1),
        theme: calendarTheme
      });

      paymentDueDatePicker.onClose(() => {

        document.getElementById("previewInvPaymentDue").textContent =document.getElementById("invPaymentDue").value;

        // Remove invalid background if the user input smt

        if ( document.getElementById("invPaymentDue").value.length > 0){
          document.getElementById("invPaymentDue").className = 'form-control';
        }
        enableSaveModal();
      });

      var inputPhone = document.querySelector("#inClientContact");
      var itiPhone = intlTelInput(inputPhone, {
      // allowDropdown: false,
      autoHideDialCode: false,
      // autoPlaceholder: "off",
      // dropdownContainer: document.body,
      // excludeCountries: ["my"],
      // formatOnDisplay: false,
      // geoIpLookup: function(callback) {
      //   $.get("http://ipinfo.io", function() {}, "jsonp").always(function(resp) {
      //     var countryCode = (resp && resp.country) ? resp.country : "";
      //     callback(countryCode);
      //   });
      // },
      // hiddenInput: "full_number",
      // initialCountry: "auto",
      // localizedCountries: { 'de': 'Deutschland' },
      nationalMode: false,
      // onlyCountries: ['MY', 'SG', 'TH', 'ID', 'VN', 'PH', 'BN', 'US', 'GB', 'SA'],
      // placeholderNumberType: "MOBILE",
      preferredCountries: ['MY', 'SG'],
      separateDialCode: true,
      utilsScript: "../../assets/js/plugins/intlTelInput/utils.js",
    });

    var errorMsg = document.querySelector("#error-msg");
    var validMsg = document.querySelector("#valid-msg");

    // here, the index maps to the error code returned from getValidationError - see readme
    var errorMap = ["Invalid number", "Invalid country code", "Too short", "Too long", "Invalid number"];

    var reset = function() {
      inputPhone.classList.remove("error");
      errorMsg.innerHTML = "";
      errorMsg.classList.add("hide");
      validMsg.classList.add("hide");
    };

    // on blur: validate

    inputPhone.addEventListener('blur', function() {
      reset();

      if (inputPhone.value.trim()) {
        if (itiPhone.isValidNumber()) {
          validMsg.classList.remove("hide");
        } else {
          inputPhone.classList.add("error");
          var errorCode = itiPhone.getValidationError();
          errorMsg.innerHTML = errorMap[errorCode];
          errorMsg.classList.remove("hide");
        }
      }
    });

    // on keyup / change flag: reset
    inputPhone.addEventListener('change', reset);
    inputPhone.addEventListener('keyup', reset);
  </script>

  </script>

  <!-- Generate PDF -->
  <script>

    // https://ekoopmans.github.io/html2pdf.js/
    function generatePDFeKoopmans(id){

      element = document.getElementById(id);

      var opt = {
        margin:       [0, 0, 0, 0],
        filename:     'myfile.pdf',
        pagebreak:    { before: '.beforeClass', after: ['#after1', '#after2'], avoid: 'img' },
        image:        { type: 'jpeg', quality: 0.95 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(element).save();
    }


    function getBase64Image(img) {
      // Create an empty canvas element
      var canvas = document.createElement("canvas");
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;

      // Copy the image contents to the canvas
      var ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);

      // Get the data-URL formatted image
      // Firefox supports PNG and JPEG. You could check img.src to
      // guess the original format, but be aware the using "image/jpg"
      // will re-encode the image.
      var dataURL = canvas.toDataURL("image/jpg");
      console.log(dataURL)
      return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
      // return dataURL;

  }

  </script>
  <!-- Tag input  -->
  <script>

    var substringMatcher = function(strs) {
      return function findMatches(q, cb) {
        var matches, substringRegex;

        // an array that will be populated with substring matches
        matches = [];

        // regex used to determine if a string contains the substring `q`
        substrRegex = new RegExp(q, 'i');

        // iterate through the pool of strings and for any string that
        // contains the substring `q`, add it to the `matches` array
        $.each(strs, function(i, str) {
          if (substrRegex.test(str)) {
            matches.push(str);
          }
        });

        cb(matches);
      };
    };

    // reference:
    // http://twitter.github.io/typeahead.js/examples/
    // http://bootstrap-tagsinput.github.io/bootstrap-tagsinput/examples/
    $('#inItemTag').tagsinput({
      allowDuplicates: false,
      trimValue: true,
      maxTags: 5,
      maxChars: 20,
      typeaheadjs: {
        name: 'citynames',
        // displayKey: 'name',
        // valueKey: 'name',
        source: substringMatcher(ClassTag) // ClassTag in const.js
        // name: 'cities',
        // source: states2.ttAdapter()
        // source :  ['Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado']
      },
    });

  </script>


</body>

</html>